/**
 * Copyright 2012-2013 Echo.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Version: 3.0.15 (2013-11-18 11:09:48 UTC)
 */

(function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.Submit");if(Echo.Control.isDefined(n))return;n.init=function(){if(!this.checkAppKey())return;var e=this;this.addPostValidator(function(){var n=!0;return t.each(["name","text"],function(t,r){return n=!e.highlightMandatory(e.view.get(r)),n}),n},"low"),this.render(),this.ready()},n.config={targetURL:document.location.href,markers:[],source:{},tags:[],requestMethod:"GET",itemURIPattern:undefined,actionString:"Type your comment here...",postingTimeout:30,type:undefined,errorPopup:{minHeight:70,maxHeight:150,width:390},targetQuery:undefined},n.vars={validators:[]},n.dependencies=[{loaded:function(){return!!Echo.GUI},url:"{config:cdnBaseURL.sdk}/gui.pack.js"},{url:"{config:cdnBaseURL.sdk}/gui.pack.css"}],n.labels={markers:"Markers:",markersHint:"Marker1, marker2, marker3, ...",post:"Post",posting:"Posting...",postingFailed:'There was a server error while trying to submit your item. Please try again in a few minutes. <b>Error: "{error}"</b>.',postingTimeout:"There was a network issue while trying to submit your item. Please try again in a few minutes.",tagsHint:"Tag1, tag2, tag3, ...",tags:"Tags:",yourName:"Your Name (required)",yourWebsiteOptional:"Your website (optional)"},n.templates.main='<div class="{class:container}"><div class="{class:header}"><div class="{class:userInfoWrapper}"><div class="{class:avatar}"></div><div class="{class:fields}"><div class="{class:fieldsWrapper}"><div class="{class:nameContainer} {class:border}"><input type="text" class="{class:name} echo-primaryFont echo-primaryColor" /></div><div class="{class:urlContainer} {class:border}"><input type="text" class="{class:url} echo-primaryFont echo-primaryColor" /></div></div></div><div class="echo-clear"></div></div></div><div class="{class:body}"><div class="{class:content} {class:border}"><textarea class="{class:text} {class:textArea} echo-primaryFont echo-primaryColor"></textarea></div><div class="{class:markersContainer} {class:metadataContainer} echo-primaryFont echo-primaryColor"><div class="{class:metadataLabel}">{label:markers}</div><div class="{class:metadataWrapper}"><div class="{class:metadataSubwrapper} {class:border} "><input type="text" class="{class:markers} echo-primaryFont" /></div></div><div class="echo-clear"></div></div><div class="{class:tagsContainer} {class:metadataContainer} echo-primaryFont echo-primaryColor"><div class="{class:metadataLabel}">{label:tags}</div><div class="{class:metadataWrapper}"><div class="{class:metadataSubwrapper} {class:border} "><input type="text" class="{class:tags} {class:border} echo-primaryFont" /></div></div><div class="echo-clear"></div></div></div><div class="{class:controls}"><div class="{class:postContainer}"><div class="btn echo-primaryFont {class:postButton}"></div></div><div class="echo-clear"></div></div></div>',n.renderers.tagsContainer=function(e){return this.user.is("admin")?e.show():e.hide()},n.renderers.markersContainer=n.renderers.tagsContainer,n.renderers.markers=function(e){return this.view.render({name:"_metaFields",target:e,extra:{type:"markers"}})},n.renderers.tags=function(e){return this.view.render({name:"_metaFields",target:e,extra:{type:"tags"}})},n.renderers.text=function(e){var t=this.get("data.object.content");return t&&e.val(t),e.iHint({text:this.config.get("actionString"),className:"echo-secondaryColor"})},n.renderers.avatar=function(e){return this.placeImage({container:e,image:this.user.get("avatar"),defaultImage:this.config.get("defaultAvatar")}),e},n.renderers.name=function(e){return e.val(this.user.get("name","")).iHint({text:this.labels.get("yourName"),className:"echo-secondaryColor"})},n.renderers.url=function(e){return e.val(this.user.get("domain","")).iHint({text:this.labels.get("yourWebsiteOptional"),className:"echo-secondaryColor"})},n.renderers.postButton=function(e){var t=this,r={normal:{target:e,icon:!1,disabled:!1,label:this.labels.get("post")},posting:{target:e,icon:this.config.get("cdnBaseURL.sdk-assets")+"/images/loading.gif",disabled:!0,label:this.labels.get("posting")}},i=new Echo.GUI.Button(r.normal);this.posting=this.posting||{},this.posting.subscriptions=this.posting.subscriptions||[];var s=function(e,r,s){var o=n.name+".onPost"+e,u=t.posting.subscriptions;u[o]&&t.events.unsubscribe({topic:o,handlerId:u[o]}),u[o]=t.events.subscribe({topic:o,handler:function(e,t){i.setState(r),s&&s(t)}})};return s("Init",r.posting),s("Complete",r.normal,function(){t.view.get("text").val("").trigger("blur"),t.view.render({name:"tags"}),t.view.render({name:"markers"})}),s("Error",r.normal,function(e){var n=e.request||{};n.state&&n.state.critical&&t._showError(e)}),this.posting.action=this.posting.action||function(){t._isPostValid()&&t.post()},e.off("click",this.posting.action).on("click",this.posting.action),e},n.renderers._metaFields=function(e,n){var r=n.type,i=this.get("data.object."+r,this.config.get(r)),s=t.trim(Echo.Utils.stripTags(i.join(", ")));return this.view.get(r).iHint({text:this.labels.get(r+"Hint"),className:"echo-secondaryColor"}).val(s).blur()},n.methods.post=function(){var e=this,t=function(t,n,r,i){var s={topic:"onPost"+t,data:{postData:n}};if(i||r)s.data.request={state:i,response:r};e.events.publish(s)},n=this.config.get("type",this._getASURL("comment")),r=[].concat(e._getActivity("post",n,e.view.get("text").val()),e._getActivity("tag",this._getASURL("marker"),e.view.get("markers").val()),e._getActivity("tag",this._getASURL("tag"),e.view.get("tags").val())),i={content:r,appkey:this.config.get("appkey"),sessionID:this.user.get("sessionID","")};this.config.get("targetQuery")&&(i["target-query"]=this.config.get("targetQuery"));var s={onData:function(e,n){t("Complete",i,e,n),Echo.Events.publish({topic:"Echo.Control.onDataInvalidate",context:"global",data:{}})},onError:function(e,n){t("Error",i,e,n)}};t("Init",i),Echo.StreamServer.API.request({endpoint:"submit",method:this.config.get("requestMethod"),itemURIPattern:this.config.get("itemURIPattern"),submissionProxyURL:this.config.get("submissionProxyURL"),timeout:this.config.get("postingTimeout"),secure:this.config.get("useSecureAPI"),data:i,onData:s.onData,onError:s.onError}).send()},n.methods.highlightMandatory=function(e){if(e&&!t.trim(e.val())){var n=this.cssPrefix+"mandatory";return e.parent().addClass(n),e.focus(function(){t(this).parent().removeClass(n)}),!0}return!1},n.methods.addPostValidator=function(e,t){this.validators[t==="low"?"push":"unshift"](e)},n.methods.refresh=function(){var e=this;this.config.set("data.object.content",this.view.get("text").val()),t.map(["tags","markers"],function(t){var n=e.view.get(t).val().split(", ");e.config.set("data.object."+t,n||[])});var n=Echo.Utils.getComponent("Echo.StreamServer.Controls.Submit");n.parent.refresh.call(this)},n.methods._getActivity=function(e,t,n){return n?{actor:{objectTypes:[this._getASURL("person")],name:this.user.get("name",this.user.is("logged")?"":this.view.get("name").val()),avatar:this.user.get("avatar","")},object:{objectTypes:[t],content:n},source:this.config.get("source"),verbs:[this._getASURL(e)],targets:[{id:this.config.get("targetURL")}]}:[]},n.methods._getASURL=function(e){return"http://activitystrea.ms/schema/1.0/"+e},n.methods._showError=function(e){var n=this;e=e||{};var r=e.request&&e.request.response||{},i=t.inArray(r.errorCode,["network_timeout","connection_failure"])>=0?this.labels.get("postingTimeout"):this.labels.get("postingFailed",{error:r.errorMessage||r.errorCode}),s=this._assembleErrorPopup(i);new Echo.GUI.Modal({data:{body:s.content},width:s.width,footer:!1,fade:!0,show:!0})},n.methods._assembleErrorPopup=function(e){var n=this.config.get("errorPopup"),r=this.substitute({template:'<div class="{data:css}">{data:message}</div>',data:{message:e,css:this.cssPrefix+"error"}}),i={content:t(r).css({"min-height":n.minHeight,"max-height":n.maxHeight}),width:n.width};return i},n.methods._isPostValid=function(){var e=this,n=!0;return t.each(this.validators,function(e,t){return n=t(),n}),n},n.methods._prepareEventParams=function(e){return t.extend(e,{data:this.get("data"),target:this.config.get("target").get(0),targetURL:this.config.get("targetURL")})},n.css='.{class:header} { margin-bottom: 3px; }.{class:avatar} { float: left; margin-right: -48px; width: 48px; height: 48px; }.{class:fields} { width: 100%; float: left; }.{class:fields} input { width: 100%; }.{class:fieldsWrapper} { margin-left: 53px; }.{class:nameContainer} { margin: 1px 0px 4px 0px; padding: 0px 2px 1px 3px; background-color: #fff; }.{class:nameContainer} input.{class:name} { font-size: 14px; font-weight: bold; border: none; width: 100%;}.{class:fieldsWrapper} input.{class:name}[type="text"] { width: 100%; margin-bottom: 0px; border: none; padding: 0px; outline: 0; box-shadow: none; }.{class:fieldsWrapper} input.{class:name}[type="text"]:focus { outline: 0; box-shadow: none;  }.{class:urlContainer} { padding: 0px 2px 1px 3px; background-color: #fff; }.{class:urlContainer} input.{class:url} { height: 19px; border: none; width: 100%; margin-bottom: 0px;}.{class:fieldsWrapper} input.{class:url}[type="text"] { width: 100%; margin-bottom: 0px; border: none; padding: 0px; outline: 0; box-shadow: none;  }.{class:fieldsWrapper} input.{class:url}[type="text"]:focus { outline: 0; box-shadow: none; }.{class:fieldsWrapper} input.{class:url}[type="text"].echo-secondaryColor,.{class:fieldsWrapper} input.{class:name}[type="text"].echo-secondaryColor,.{class:content} textarea.{class:textArea}.echo-secondaryColor,.{class:container} .{class:metadataSubwrapper} input.echo-secondaryColor[type="text"] { color: #C6C6C6 }.{class:author} { font-weight: bold; }.{class:content} { padding: 5px 5px 5px 6px; background-color: #fff; }.{class:content} textarea.{class:textArea} { width: 100%; height: 102px; padding: 0px; margin: 0px; border: none; resize:none; box-shadow: none; outline: 0; }.{class:content} textarea.{class:textArea}:focus { outline: 0; box-shadow: none; }.{class:text} input { width: 100%; border: none; }.{class:metadataContainer} { margin-top: 6px; }.{class:metadataLabel} { float: left; width: 50px; margin-right: -50px; text-align: right; line-height: 22px; }.{class:metadataWrapper} { float: left; width: 100%; }.{class:metadataSubwrapper} { margin-left: 55px; padding: 2px 2px 2px 3px; background-color: #fff; }.{class:container} .{class:metadataSubwrapper} input[type="text"] { width: 100%; border: 0; padding: 0px; outline: 0; box-shadow: none; margin-bottom: 0px; }.{class:container} .{class:metadataSubwrapper} input[type="text"]:focus { outline: 0; box-shadow: none; }.{class:controls} { margin-top: 5px; }.{class:postContainer} { float: right; }.{class:border} { border: 1px solid #d2d2d2; }.{class:mandatory} { border: 1px solid red; }.{class:queriesViewOption} { padding-right: 5px; }.{class:error} { color: #444444; font: 14px Arial; line-height: 150%; padding-left: 85px; background: no-repeat url({config:cdnBaseURL.sdk-assets}/images/info70.png); }',Echo.Control.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.FacePile");if(Echo.Control.isDefined(n))return;n.init=function(){if(!this.checkAppKey())return;var e=this.config.get("liveUpdates.timeout");typeof e!="undefined"&&this.config.set("liveUpdates.polling.timeout",e),t.isEmptyObject(this.get("data"))?this._request():(this.set("data.itemsPerPage",this.get("data.itemsPerPage",2)),this.config.set("liveUpdates.enabled",!1),this._initialResponseHandler(this.data))},n.config={data:undefined,initialUsersCount:undefined,totalUsersCount:undefined,query:"",suffixText:"",item:{avatar:!0,text:!0},liveUpdates:{transport:"polling",enabled:!0,polling:{timeout:10},websockets:{maxConnectRetries:3,serverPingInterval:30}},infoMessages:{layout:"compact"}},n.vars={users:[],uniqueUsers:{},isViewComplete:!1,moreRequestInProgress:!1,count:{total:0,visible:0}},n.labels={and:"and",more:"more"},n.templates.main='<span class="{class:container}"><span class="{class:actors}"></span><span class="{class:more}"></span><span class="{class:suffixText}"></span></span>',n.renderers.more=function(e){var t=this;if(!this._isMoreButtonVisible())return e.hide();e.empty().show();var n=this.get("count.total")-this.get("count.visible"),r=(n>0?n+" ":"")+this.labels.get("more"),i=!this._fromExternalData()||this.get("count.visible")<this.get("users").length;if(i){var s=Echo.Utils.hyperlink({caption:r});e.addClass("echo-linkColor").append(s)}else e.removeClass("echo-linkColor").append(r);return this.set("moreRequestInProgress",!1),i&&e.one("click",function(){t._getMoreUsers()}),e},n.renderers.actors=function(e){var n=this,r=[],i=this.get("cssPrefix"),s=this.config.get("item");if(!this.get("users").length||!s.avatar&&!s.text)return e.empty();var o=s.avatar&&!s.text?"addClass":"removeClass";e[o](i+"only-avatars");var u=function(e,t){return n.substitute({template:"<span {data:classAttr}>{data:text}</span>",data:{classAttr:t?'class="'+i+t+'"':"",text:e}})};t.map(this.get("users").slice(0,this.get("count.visible")),function(e){r.push(e.instance.render())});var a,f=this.config.get("item.text")?", ":"";return this._isMoreButtonVisible()||(a=r.pop()),r.length&&(r=f?this._intersperse(r,u(f,"delimiter")):r,r.push(u("&nbsp;"+this.labels.get("and")+" ","and"))),this._isMoreButtonVisible()||r.push(a),t.map(r,function(t){e.append(t)}),e},n.renderers.suffixText=function(e){return e.empty().append(this.config.get("suffixText",""))},n.methods.getVisibleUsersCount=function(){return this.count.visible},n.methods._isMoreButtonVisible=function(){return!this._fromExternalData()&&!this.isViewComplete||this.count.visible<this.count.total},n.methods._fromExternalData=function(){return!this.config.get("query")&&!!this.data},n.methods._request=function(){var e=this,n=this.get("request");n||(n=Echo.StreamServer.API.request({endpoint:"search",data:{q:this.config.get("query"),appkey:this.config.get("appkey")},liveUpdates:t.extend(this.config.get("liveUpdates"),{onData:function(t){e._secondaryResponseHandler(t)}}),secure:this.config.get("useSecureAPI"),apiBaseURL:this.config.get("apiBaseURL"),onError:function(t,n){var r=typeof n.critical=="undefined"||n.critical||n.requestType==="initial";r&&e.showError(t,{critical:n.critical})},onData:function(t,n){e._initialResponseHandler(t)}}),this.set("request",n)),n.send()},n.methods._requestMoreItems=function(){var e=this,t=this.config.get("query"),n=this.get("nextPageAfter");typeof n!="undefined"&&(t='pageAfter:"'+n+'" '+t);var r=Echo.StreamServer.API.request({endpoint:"search",secure:this.config.get("useSecureAPI"),apiBaseURL:this.config.get("apiBaseURL"),data:{q:t,appkey:this.config.get("appkey")},onError:function(t){e.showMessage({type:"error",data:t})},onData:function(t){e._initialResponseHandler(t)}});r.send()},n.methods._initialResponseHandler=function(e){e.itemsPerPage&&e.itemsPerPage!==this.config.get("itemsPerPage")&&this.config.set("itemsPerPage",+e.itemsPerPage),this._fromExternalData()&&this.set("count.total",this.config.get("totalUsersCount",0)),this.set("nextPageAfter",e.nextPageAfter);if(!e.entries.length){this.get("isViewComplete")||(this.set("isViewComplete",!0),this.render(),this.ready());return}this.get("count.visible")||this.set("count.visible",this._fromExternalData()?this.config.get("initialUsersCount",this.config.get("itemsPerPage")):this.config.get("itemsPerPage")),this._processResponse(e)},n.methods._secondaryResponseHandler=function(e){this._processResponse(e,!0)},n.methods._processResponse=function(e,n){var r=this,i=!0,s=t.map(e.entries,function(e){return function(t){if(r._isRemoveAction(e))r._maybeRemoveItem(e),t();else{r._isUniqueUser(e)&&(i=!1);var n=r.get("uniqueUsers."+e.actor.id);n?(n.itemsCount++,t()):r._initItem(e,function(){r._updateStructure(this),t()})}}});Echo.Utils.parallelCall(s,function(){r._output(n,i)})},n.methods._isRemoveAction=function(e){return e.verbs&&e.verbs[0]==="http://activitystrea.ms/schema/1.0/delete"},n.methods._output=function(e,t){this._fromExternalData()?this.set("count.total",Math.max(this.get("users").length,this.get("count.total"))):(this.set("count.total",this.get("users").length),this.set("count.visible",this.get("users").length)),this.set("count.visible",Math.min(this.get("count.visible"),this.get("users").length)),this.get("count.total")||this.set("isViewComplete",!1),!e&&t?this._getMoreUsers():(this.render(),this.ready())},n.methods._isUniqueUser=function(e){return!this.get("uniqueUsers."+e.actor.id)},n.methods._initItem=function(e,n){var r=t.extend({apiBaseURL:this.config.get("apiBaseURL"),submissionProxyURL:this.config.get("submissionProxyURL"),target:t("<div>"),appkey:this.config.get("appkey"),parent:this.config.getAsHash(),plugins:this.config.get("plugins"),context:this.config.get("context"),useSecureAPI:this.config.get("useSecureAPI"),data:e.actor,user:this.user,ready:n},this.config.get("item"));return new Echo.StreamServer.Controls.FacePile.Item(r)},n.methods._updateStructure=function(e){this.set("uniqueUsers."+e.get("data.id"),{itemsCount:1,instance:e});var t=this.get("uniqueUsers."+e.get("data.id"));this.get("users")[t.instance.isYou()?"unshift":"push"](t)},n.methods._maybeRemoveItem=function(e){var n=this.get("uniqueUsers."+e.actor.id);if(!n||--n.itemsCount)return;var r;t.each(this.get("users"),function(t,n){if(n.instance.data.id===e.actor.id)return r=t,!1}),this.get("users").splice(r,1),this.remove("uniqueUsers."+e.actor.id)},n.methods._getMoreUsers=function(){if(this._fromExternalData()){var e=this.get("users").length,t=this.get("count.visible");this.set("count.visible",t+=this.config.get("itemsPerPage")),this.get("count.visible")>e&&this.set("count.visible",e),this.render()}else this.get("moreRequestInProgress")||(this.showMessage({type:"loading",target:this.view.get("more")}),this.set("moreRequestInProgress",!0)),this._requestMoreItems()},n.methods._intersperse=function(e,t){return Echo.Utils.foldl([],e,function(e,n,r){n.length&&n.push(t),n.push(e)})},n.css=".{class:container} { line-height: 20px; vertical-align: middle; }.{class:more} { white-space: nowrap; }.{class:more}.echo-linkColor a, .{class:more}.echo-linkColor a:hover { color: #476CB8; text-decoration: underline; }.{class:more} .echo-control-message-icon { display: inline; margin: 0px 5px; }",Echo.Control.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.FacePile.Item");if(Echo.Control.isDefined(n))return;n.config={infoMessages:{enabled:!1}},n.labels={you:"You"},n.templates.main='<span class="{class:container}"><span class="{class:avatar}"></span><span class="{class:title}">{data:title}</span></span>',n.renderers.avatar=function(e){var t=this;return this.config.get("avatar")?(this.placeImage({container:e,image:this.get("data.avatar"),defaultImage:this.config.get("defaultAvatar")}),this.config.get("text")||e.attr("title",this.get("data.title"))):e.hide(),e},n.renderers.title=function(e){return this.config.get("text")?e.empty().append(this.isYou()?this.labels.get("you"):this.get("data.title")):e.hide(),e},n.methods.isYou=function(){var e=this.get("data.id");return e&&e===this.user.get("identityUrl")},n.css=".{class:avatar} { display: inline-block; width: 16px; height: 16px; margin: 0px 3px 0px 0px; vertical-align: text-top; }.{class:only-avatars} .{class:avatar} { margin: 0px 2px; }.{class:container}, .{class:container} span { white-space: nowrap; display: inline-block; }.{class:only-avatars} .{class:container} { white-space: normal; }",Echo.Control.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.Stream");if(Echo.Control.isDefined(n))return;n.init=function(){var e=this;if(!this.checkAppKey())return;var n=this.config.get("liveUpdates.timeout");typeof n!="undefined"&&this.config.set("liveUpdates.polling.timeout",n),this._recalcEffectsTimeouts(),this.request=this._getRequestObject({liveUpdates:t.extend(this.config.get("liveUpdates"),{onData:function(t){e._handleLiveUpdatesResponse(t)}}),onOpen:function(t,n){n.requestType==="initial"&&e.showError({},{retryIn:0,request:e.request})},onError:function(n,r){(typeof r.critical=="undefined"||r.critical||r.requestType==="initial")&&e.showError(n,t.extend(r,{request:e.request}))},onData:function(t,n){e._handleInitialResponse(t)}});var r=this.config.get("state.layout")==="full"?"paused":this.config.get("liveUpdates.enabled")?"live":"paused";this.activities.state=r;var i=this.config.get("data");i?(this._handleInitialResponse(i),this.request&&this.request.send({skipInitialRequest:!0,data:{q:this.config.get("query"),appkey:this.config.get("appkey"),since:i.nextSince}})):this.request.send()},n.config={query:"",children:{additionalItemsPerPage:5,displaySortOrder:"chronological",sortOrder:"reverseChronological",moreButtonSlideTimeout:600,itemsSlideTimeout:600,maxDepth:1},fadeTimeout:2800,flashColor:"#ffff99",item:{},itemsPerPage:15,itemsRefreshInterval:10,itemsComparator:undefined,liveUpdates:{transport:"polling",enabled:!0,polling:{timeout:10},websockets:{maxConnectRetries:3,serverPingInterval:30}},openLinksInNewWindow:!1,slideTimeout:700,sortOrder:"reverseChronological",state:{label:{icon:!0,text:!0},toggleBy:"mouseover",layout:"compact"},submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity",asyncItemsRendering:!1},n.config.normalizer={showFlags:function(e){return"off"!==e},state:function(e){return e.toggleBy=e.toggleBy==="mouseover"&&Echo.Utils.isMobileDevice()?"button":e.toggleBy,e.layout=e.toggleBy==="button"?e.layout:n.config.state.layout,e}},n.vars={activities:{queue:[],state:undefined,lastState:"",animations:0},itemParentConfig:undefined,hasInitialData:!1,items:{},threads:[],lastRequest:null,request:null,moreRequest:null,itemsRenderingComplete:!0},n.labels={guest:"Guest",live:"Live",paused:"Paused",more:"More",emptyStream:"No items at this time...","new":"new",newItem:"new item",newItems:"new items"},n.events={"Echo.StreamServer.Controls.Stream.onItemsRenderingComplete":function(){this.view.render({name:"more"}),this._executeNextActivity()},"Echo.StreamServer.Controls.Stream.Item.onAdd":function(e,t){var n=this,r=this.items[t.item.data.unique];return r.config.get("target").hide(),this.queueActivity({action:"animation",item:r,priority:"highest",handler:function(){r.render(),r.set("added",!1),n._animateSpotUpdate("add",r,t.config)}}),{stop:["bubble"]}},"Echo.StreamServer.Controls.Stream.Item.onDelete":function(e,t){var n=this,r=this.items[t.item.data.unique];return this.queueActivity({action:"animation",item:r,priority:"highest",handler:function(){r.set("deleted",!1),n._animateSpotUpdate("remove",r,t.config)}}),{stop:["bubble"]}},"Echo.StreamServer.Controls.Stream.Item.onChildrenExpand":function(e,t){return this._requestChildrenItems(t.data.unique),{stop:["bubble"]}}},n.templates.main='<div class="{class:container} echo-primaryFont echo-primaryBackgroundColor"><div class="{class:header}"><div class="{class:state}"></div><div class="echo-clear"></div></div><div class="{class:content}"><div class="{class:body}"></div><div class="{class:more}"></div></div></div>',n.renderers.body=function(e){var t=this,n=this.lastRequest;return n?(n.data.length?(n.initial&&e.empty(),this._appendRootItems(n.data,e)):this.showMessage({type:"info",message:this.labels.get("emptyStream"),target:e}),e):e},n.renderers.content=function(e){var t=this,n=this.lastRequest;return n&&n.initial&&this.config.get("liveUpdates.enabled")&&this.config.get("state.toggleBy")==="mouseover"&&e.hover(function(){t.setState("paused")},function(){t.setState("live")}),e},n.renderers.state=function(e){var t=this,n=this.config.get("state.label"),r=this.config.get("state.layout");if(!n.icon&&!n.text||!this.config.get("liveUpdates.enabled"))return e;var i=this.getState(),s=0;i==="paused"&&(s=Echo.Utils.foldl(0,this.activities.queue,function(e,t){if(e.affectCounter)return++t}));var o=i+s;if(o===this.activities.lastState)return e;e.empty().show(),e.addClass(this.cssPrefix+r+"StateLayout"),r==="compact"&&e.addClass("echo-secondaryColor"),!this.activities.lastState&&this.config.get("state.toggleBy")==="button"&&(r==="compact"&&e.addClass("echo-linkColor echo-clickable"),e.click(function(){t.setState(t.getState()==="paused"?"live":"paused")}));var u={picture:'<span class="{class:state-picture} {class:state-picture}-'+i+'"></span>',message:this.config.get("state.toggleBy")==="button"?'<a href="javascript:void(0)" class="{class:state-message}">{label:'+i+"}"+"</a>":'<span class="{class:state-message}">{label:'+i+"}</span>",count:' <span class="{class:state-count}">({data:count} {label:new})</span>',button:'<span class="{class:state-message}">{data:count} {data:label}</span>'};return r==="full"?s?e.append(this.substitute({template:u.button,data:{count:s,label:this.labels.get(s===1?"newItem":"newItems")}})):e.hide():(n.icon&&e.append(this.substitute({template:u.picture})),n.text&&(e.append(this.substitute({template:u.message})),s&&i==="paused"&&e.append(this.substitute({template:u.count,data:{count:s}})))),this.activities.lastState=o,e},n.renderers.more=function(e){var t=this;return this.isViewComplete||!this.threads.length?e.empty().hide():(this.itemsRenderingComplete?e.show():e.hide(),e.empty().append(this.labels.get("more")).off("click").one("click",function(){t.events.publish({topic:"onMoreButtonPress"}),e.html(t.labels.get("loading")),t._requestMoreItems(e)}))},n.methods.getState=function(){return this.activities.state},n.methods.setState=function(e){this.activities.state=e,e==="live"&&this._executeNextActivity(),this.view.render({name:"state"})},n.methods.queueActivity=function(e){if(!e.item)return;var t=e.item.get("data.actor.id"),n=e.item.blocked||t&&this.user.has("identity",t),r=this._getActivityProjectedIndex(n,e),i={action:e.action,item:e.item,affectCounter:e.action==="add"&&!n,priority:e.priority,byCurrentUser:n,handler:e.handler};typeof r!="undefined"?this.activities.queue.splice(r,0,i):this.activities.queue.push(i)},n.methods._requestChildrenItems=function(e){var n=this,r=this.items[e],i=r.view.get("expandChildren"),s=this._getRequestObject({data:{q:this._constructChildrenSearchQuery(r)},onOpen:function(){n.showError({},{retryIn:0,target:i,request:s})},onError:function(e,r){n.showError(e,t.extend(r,{target:i,request:s}))},onData:function(e){var i={};r.set("data.nextPageAfter",e.nextPageAfter),r.set("data.hasMoreChildren",e.hasMoreChildren),e.entries=n._actualizeChildrenList(r,e.entries),n._onDataReceive(e,"children",function(i){var s=[];t.map(e.entries,function(e){var t=i[e.unique];n._applyStructureUpdates("add",t),e.parentUnique===r.get("data.unique")&&s.push(t)}),n._placeChildItems(r,s)})}});s.send()},n.methods._requestInitialItems=function(){var e=this;this.request||(this.request=Echo.StreamServer.API.request({endpoint:"search",apiBaseURL:this.config.get("apiBaseURL"),liveUpdates:t.extend(this.config.get("liveUpdates"),{onData:function(t){e._handleLiveUpdatesResponse(t)}}),data:{q:this.config.get("query"),appkey:this.config.get("appkey")},onOpen:function(t,n){n.requestType==="initial"&&e.showError({},{retryIn:0,request:e.request})},onError:function(n,r){(typeof r.critical=="undefined"||r.critical||r.requestType==="initial")&&e.showError(n,t.extend(r,{request:e.request}))},onData:function(t,n){e._handleInitialResponse(t)}})),this.request.send()},n.methods._requestMoreItems=function(e){var n=this;this.lastRequest={initial:!1},this.moreRequest||(this.moreRequest=this._getRequestObject({onOpen:function(){n.showError({},{retryIn:0,target:e,request:n.moreRequest})},onError:function(r,i){n.showError(r,t.extend(i,{target:e,request:n.moreRequest}))},onData:function(t){n._handleInitialResponse(t,function(t){t.length?(n.lastRequest.data=t,n.view.render({name:"body"}),n.view.render({name:"more"})):e.html(n.labels.get("emptyStream")).delay(1e3).fadeOut(1e3)})}})),this.moreRequest.requestType="initial",this.moreRequest.send({data:{q:this.config.get("query")+" pageAfter:"+'"'+this.get("nextPageAfter","0")+'"',appkey:this.config.get("appkey")}})},n.methods._onDataReceive=function(e,n,r){var i=this,s={};this.events.publish({topic:"onDataReceive",data:{entries:e.entries,type:n},propagation:!1});var o=t.map(e.entries,function(e){return function(t){i._initItem(e,!1,function(){s[this.get("data.unique")]=this,t()})}});Echo.Utils.parallelCall(o,function(){r(s)})},n.methods._prepareEventParams=function(e){return t.extend(e,{target:this.config.get("target").get(0),query:this.config.get("query")})},n.methods._applyLiveUpdates=function(e,n){var r=this,i={};i.entries=t.map(e||[],function(e){return r._normalizeEntry(e)}),this.events.publish({topic:"onDataReceive",data:{entries:i.entries,type:"live"},propagation:!1});var s=t.map(i.entries,function(e){return function(t){var n=r.items[e.unique],i=r._classifyAction(e);if(!n&&i!=="post"){t();return}if(i==="post"){if(n){r._applySpotUpdates("replace",r._updateItem(e)),t();return}r._initItem(e,!0,function(){n=this;var e=n.isRoot()?r._withinVisibleFrame(n):r._withinVisibleChildrenFrame(n);!e&&!n.isRoot()&&r.user.has("identity",n.data.actor.id)&&n.set("byCurrentUser",!0);if(e||n.get("byCurrentUser"))r.events.publish({topic:"onItemReceive",data:{item:{data:n.data}},propagation:!1}),r._applySpotUpdates("add",n);t()});return}i==="delete"&&(r._applySpotUpdates("remove",n),t())}});Echo.Utils.sequentialCall(s,function(){r._recalcEffectsTimeouts(),n&&n.call(r)})},n.methods._actualizeChildrenList=function(e,n){var r=this;return t.map(n,function(n){n.targets=t.map(n.targets,function(t){return t.conversationID=e.get("data.target.conversationID"),t}),n=r._normalizeEntry(n);var i=r.items[n.unique];return i&&i.get("byCurrentUser")&&r._applyStructureUpdates("delete",i),n})},n.methods._createChildrenItemsDomWrapper=function(e,n){var r=this,i=t('<div class="'+this.get("cssPrefix")+'children-wrapper"></div>'),s=function(e){return r._getItemListIndex(e,n.get("children"))};return t.each(e,function(t,n){var r=t>0&&s(e[t-1])<s(n)?"append":"prepend";i[r](n.config.get("target")),n.render()}),i},n.methods._extractPresentationConfig=function(e){var t=["sortOrder","itemsPerPage","safeHTML","showFlags"];return Echo.Utils.foldl({},t,function(t,n){typeof e[t]!="undefined"&&(n[t]=e[t])})},n.methods._extractTimeframeConfig=function(e){var t=function(e){var t=e.match(/^(<|>)(.*)$/),n=t[1],e=t[2].match(/^'([0-9]+) seconds ago'$/),r=e?function(){return Math.floor((new Date).getTime()/1e3)-e[1]}:function(){return t[2]};if(n==="<")return function(e){return e<r()};if(n===">")return function(e){return e>r()}},n=Echo.Utils.foldl([],["before","after"],function(n,r){if(!e[n])return;var i=t(e[n]);i&&r.push(i)});return{timeframe:n}},n.methods._getRespectiveAccumulator=function(e,t){var n={likesDescending:"likesCount",flagsDescending:"flagsCount",repliesDescending:"repliesCount"};return e.getAccumulator(n[t])},n.methods._appendRootItems=function(e,n){var r=this;if(!e||!e.length)return;this.itemsRenderingComplete=!1,function i(s){s=s||0,n.append(e[s].config.get("target")),e[s].render(),e.length>++s?r.config.get("asyncItemsRendering")?setTimeout(t.proxy(i,r,s),0):i(s):(r.itemsRenderingComplete=!0,r.events.publish({topic:"onItemsRenderingComplete",global:!1,propagation:!1}))}()},n.methods._constructChildrenSearchQuery=function(e){var t=this.config.get("children.maxDepth")-e.get("depth")-1,n=parseInt(this.config.get("children.additionalItemsPerPage")),r=e.getNextPageAfter(),i=this.config.get("children.filter"),s=!i||i==="()"?"":i+" ";return s+Echo.Utils.foldl("",{childrenof:e.get("data.object.id"),children:t,childrenItemsPerPage:t?parseInt(this.config.get("children.itemsPerPage")):0,itemsPerPage:n,sortOrder:this.config.get("children.sortOrder"),childrenSortOrder:this.config.get("children.sortOrder"),pageAfter:r?'"'+(r||0)+'"':undefined,safeHTML:this.config.get("safeHTML")},function(e,t,n){return t+=typeof e!="undefined"?n+":"+e+" ":""})+s},n.methods._handleInitialResponse=function(e,n){var r=this,i={},s=[];this.config.get("target").show(),this.nextSince=e.nextSince||0,this.nextPageAfter=e.nextPageAfter;var o=this._extractPresentationConfig(e);o.itemsPerPage=+o.itemsPerPage,this.config.extend(o),e.entries=e.entries||[],e.children.itemsPerPage=+e.children.itemsPerPage,e.children.maxDepth=+e.children.maxDepth,this.config.set("children",t.extend(this.config.get("children"),e.children)),this.config.extend(this._extractTimeframeConfig(e));var u=this.config.get("sortOrder");e.entries=t.map(e.entries,function(e){return r._normalizeEntry(e)});var a=this.hasInitialData?"more":"initial";this._onDataReceive(e,a,function(i){t.map(e.entries,function(e){var t=i[e.unique];r._applyStructureUpdates("add",t),t.isRoot()&&r._addItemToList(s,t,u)}),r.hasInitialData=!0,r.isViewComplete=e.hasMoreChildren?e.hasMoreChildren==="false":s.length!==r.config.get("itemsPerPage"),(n||function(e){r.lastRequest={initial:!0,data:e},r.render(),r.ready()})(s),r.itemsRefreshInterval&&clearInterval(r.itemsRefreshInterval),r.itemsRefreshInterval=setInterval(function(){r._refreshItemsDate(),r._checkTimeframeSatisfy()},r.config.get("itemsRefreshInterval")*1e3)})},n.methods._checkTimeframeSatisfy=function(){var e=this,n=this.config.get("timeframe");if(!n||!n.length)return;var r=Echo.Utils.foldl([],this.threads,function(e,t){var r=Echo.Utils.foldl(!0,n,function(t,n){return n?t(e.get("timestamp")):!1});r||t.push(e)});t.map(r,function(t){e._applySpotUpdates("remove",t)})},n.methods._handleLiveUpdatesResponse=function(e){var t=this;e=e||{},this._applyLiveUpdates(e.entries,function(){t.view.render({name:"state"}),t._executeNextActivity()})},n.methods._getRequestObject=function(e){var n=t.extend(!0,{endpoint:"search",secure:this.config.get("useSecureAPI"),apiBaseURL:this.config.get("apiBaseURL"),data:{q:this.config.get("query"),appkey:this.config.get("appkey")}},e);return Echo.StreamServer.API.request(n)},n.methods._recalcEffectsTimeouts=function(){var e=this,t={fade:e.config.get("fadeTimeout"),slide:e.config.get("slideTimeout")};e.timeouts=e.timeouts||{fade:t.fade,slide:t.slide};if(!t.fade&&!t.slide)return;e.timeouts.coeff=e.timeouts.coeff||{fade:e.timeouts.fade/(t.fade+t.slide),slide:e.timeouts.slide/(t.fade+t.slide)};var n=function(n,r){return r=Math.round(r*e.timeouts.coeff[n]),r<100?0:r>t[n]?t[n]:r},r=e.config.get("liveUpdates.polling.timeout")*1e3*.8,i=e.activities.queue.length?r/e.activities.queue.length:r;e.timeouts.fade=n("fade",i),e.timeouts.slide=n("slide",i)},n.methods._refreshItemsDate=function(){t.map(this.threads,function(e){e.view.render({name:"date"}),e.traverse(e.get("children"),function(e){e.view.render({name:"date"})})})},n.methods._executeNextActivity=function(){var e=this.activities;!e.queue.length&&this.config.get("state.layout")==="full"&&(e.state="paused");if(e.animations>0||!this.itemsRenderingComplete||!e.queue.length||this.config.get("liveUpdates.enabled")&&e.state==="paused"&&e.queue[0].action!=="replace"&&!e.queue[0].byCurrentUser)return;e.queue.shift().handler()},n.methods._spotUpdates={animate:{}},n.methods._spotUpdates.add=function(e,t){var n=this.items[e.get("data.unique")];if(n&&n.view.rendered()&&t.priority!="high"){this._applySpotUpdates("replace",e,{priority:"highest"});return}this._applyStructureUpdates("add",e),e.set("added",!0);if(e.isRoot())this._placeRootItem(e);else{var r=this._getParentItem(e);r&&r.view.rendered()&&(r.view.render({name:"container"}),r.view.render({name:"children"}),r.view.render({name:"childrenByCurrentActorLive"}))}},n.methods._spotUpdates.replace=function(e,n){e.unblock();if(this._maybeMoveItem(e)){var r=this._getParentItem(e),i=this.config.get(r?"children.sortOrder":"sortOrder"),s=r?r.get("children"):this.threads,o=this._getItemListIndex(e,s),u=t.extend([],s);u.splice(o,1);var a=this._getItemProjectedIndex(e,u,i);o!=a&&(this._applySpotUpdates("remove",e,{keepChildren:!0,priority:"high"}),this._applySpotUpdates("add",e,{priority:"high"}))}e&&e.view.rendered()&&(e.view.render({name:"container",recursive:!0}),e.events.publish({topic:"onRerender"}))},n.methods._spotUpdates.remove=function(e,t){e.set("deleted",!0);if(e.isRoot())e.events.publish({topic:"onDelete",data:{config:t},global:!1,propagation:!1}),this._applyStructureUpdates("delete",e,t);else{var n=this._getParentItem(e);n&&(n.view.render({name:"children",target:n.view.get("children"),extra:t}),n.view.render({name:"childrenByCurrentActorLive",target:n.view.get("childrenByCurrentActorLive"),extra:t}),this._applyStructureUpdates("delete",e,t),n.view.render({name:"container"}))}},n.methods._spotUpdates.animate.fade=function(e){var t=this;if(this.timeouts.fade){var n=Math.round(this.timeouts.fade/2),r=e.view.get("container"),i=Echo.Utils.getVisibleColor(r),s="background-color "+n+"ms linear";r.css("background-color",this.config.get("flashColor")),setTimeout(function(){r.css({transition:s,"-o-transition":s,"-ms-transition":s,"-moz-transition":s,"-webkit-transition":s,"background-color":i}),r.css("background-color",""),t.activities.animations--,t._executeNextActivity()},n)}else this.activities.animations--,this._executeNextActivity()},n.methods._spotUpdates.animate.add=function(e){var t=this;this.activities.animations++;if(this.timeouts.slide){var n=e.config.get("target").show().css("height");e.config.get("target").css("overflow","hidden"),e.view.get("content").css("margin-top","-"+n).animate({"margin-top":"0px"},this.timeouts.slide,function(){e.config.get("target").css("overflow",""),e.view.get("content").css("margin-top",""),t._spotUpdates.animate.fade.call(t,e)})}else e.config.get("target").show(),t._spotUpdates.animate.fade.call(t,e)},n.methods._spotUpdates.animate.remove=function(e,n){var r=this;this.activities.animations++,n=n||{};var i=t.isFunction(n)?n:n.callback||function(){if(!e.config.get("target").length)return;e.config.get("target")[n.keepChildren?"detach":"remove"](),e.set("vars",{});var t=Echo.Utils.foldl(0,r.items,function(e,t){return t+1});t||r.showMessage({type:"info",message:r.labels.get("emptyStream"),target:r.view.get("body")}),r.activities.animations--,r._executeNextActivity()};this.timeouts.slide?e.config.get("target").slideUp(this.timeouts.slide,i):i()},n.methods._applySpotUpdates=function(e,t,n){var r=this;n=n||{},this.queueActivity({action:e,item:t,priority:n.priority,handler:function(){r._spotUpdates[e].call(r,t,n),r._executeNextActivity()}})},n.methods._animateSpotUpdate=function(e,t,n){this._spotUpdates.animate[e].call(this,t,n)},n.methods._getActivityProjectedIndex=function(e,n){var r={highest:0,high:10,medium:20,low:30,lowest:40};n.priority=n.priority==="highest"&&"highest"||e&&"high"||n.action==="replace"&&"medium"||n.priority||"lowest";var i;return n.action==="replace"&&t.each(this.activities.queue,function(e,t){if(t.action==="add"&&t.itemUnique===n.itemUnique)return n.priority=t.priority,!1}),t.each(this.activities.queue,function(e,t){if(r[n.priority]<r[t.priority])return i=e,!1}),i},n.methods._classifyAction=function(e){return e.verbs[0]==="http://activitystrea.ms/schema/1.0/delete"?"delete":"post"},n.methods._maybeMoveItem=function(e){return e.get("forceInject")},n.methods._withinVisibleFrame=function(e,t,n,r){return t=t||this.threads,n=typeof n=="undefined"?this.isViewComplete:n,r=r||this.config.get("sortOrder"),n||!t.length?!0:this._itemsComparator(t[t.length-1],e,r)===1},n.methods._withinVisibleChildrenFrame=function(e){var t=this._getParentItem(e)||this._getParentItemFromActivityQueue(e);return t?this._withinVisibleFrame(e,t.get("children"),!t.hasMoreChildren(),this.config.get("children.sortOrder")):!1},n.methods._getParentItemFromActivityQueue=function(e){if(e.isRoot())return;return Echo.Utils.safelyExecute(function(n){var r;return t.each(n,function(t,n){if(n.action==="add"&&n.item.get("data.unique")===e.get("data.parentUnique"))return r=n.item,!1}),r},[this.activities.queue])},n.methods._getParentItem=function(e){return e.isRoot()?undefined:this.items[e.get("data.parentUnique")]},n.methods._itemsComparator=function(e,n,r){var i=this,s,o=this.config.get("itemsComparator");if(o&&t.isFunction(o))return o(e,n,r);switch(r){case"chronological":s=e.get("timestamp")>n.get("timestamp");break;case"reverseChronological":s=e.get("timestamp")<=n.get("timestamp");break;case"likesDescending":case"repliesDescending":case"flagsDescending":var u=function(e){return i._getRespectiveAccumulator(e,r)};s=u(e)<u(n)||u(e)===u(n)&&this._itemsComparator(e,n,"reverseChronological")===1}return s?1:typeof s=="undefined"?0:-1},n.methods._placeRootItem=function(e){var t=e.config.get("target");if(this.threads.length>1){var n=this._getItemListIndex(e,this.threads),r=this.threads[n+1],i=this.threads[n-1];r?r.config.get("target").before(t):i.config.get("target").after(t)}else this.view.get("body").empty().append(t);e.events.publish({topic:"onAdd",global:!1,propagation:!1})},n.methods._placeChildItems=function(e,n){var r=this,i=this._createChildrenItemsDomWrapper(n,e),s=-1;t.each(e.get("children"),function(e,t){if(r._isItemInList(t,n))return s=e-1,!1});var o=s>=0?e.get("children")[s].config.get("target"):e.view.get("children"),u=s>=0?"insertAfter":this.config.get("children.sortOrder")!="chronological"?"prependTo":"appendTo";i[u](t(o)),e.view.render({name:"childrenByCurrentActorLive"}),i.css("height",i.show().css("height")).hide().animate({height:"show",marginTop:"show",marginBottom:"show",paddingTop:"show",paddingBottom:"show"},{duration:this.config.get("children.itemsSlideTimeout"),complete:function(){i.css("height",""),e.view.render({name:"expandChildren"}),e.view.render({name:"expandChildrenLabel"}),i.children().unwrap()}})},n.methods._getItemListIndex=function(e,n){var r=-1;return t.each(n||[],function(t,n){if(n.get("data.unique")===e.get("data.unique"))return r=t,!1}),r},n.methods._isItemInList=function(e,t){return this._getItemListIndex(e,t)>=0},n.methods._initItem=function(e,n,r){this.itemParentConfig||(this.itemParentConfig=this.config.getAsHash());var i=t.extend({target:t("<div>"),appkey:this.config.get("appkey"),plugins:this.config.get("plugins"),context:this.config.get("context"),useSecureAPI:this.config.get("useSecureAPI"),apiBaseURL:this.config.get("apiBaseURL"),submissionProxyURL:this.config.get("submissionProxyURL"),user:this.user,live:n,ready:r},this.itemParentConfig.item);i.parent=this.itemParentConfig,i.data=this._normalizeEntry(e);var s=function(){new Echo.StreamServer.Controls.Stream.Item(i)};this.config.get("asyncItemsRendering")?setTimeout(s,0):s()},n.methods._updateItem=function(e){var n=this.items[e.unique],r=this.config.get(n.isRoot()?"sortOrder":"children.sortOrder"),i=r.match(/replies|likes|flags/),s=i&&this._getRespectiveAccumulator(n,r);return n.data.object.published!==e.object.published&&(n.set("timestamp",Echo.Utils.timestampFromW3CDTF(e.object.published)),n.set("forceInject",!0)),t.extend(n.data,e),i&&this._getRespectiveAccumulator(n,r)!==s&&n.set("forceInject",!0),n},n.methods._getItemProjectedIndex=function(e,n,r){var i=this,s;return(e.config.get("live")||e.get("forceInject"))&&t.each(n||[],function(t,n){if(i._itemsComparator(n,e,r)===1)return s=t,!1}),typeof s!="undefined"?s:n.length},n.methods._addItemToList=function(e,t,n){this.config.get("itemsComparator")&&t.set("forceInject",!0),e.splice(this._getItemProjectedIndex(t,e,n),0,t),t.set("forceInject",!1),this.items[t.get("data.unique")]=t},n.methods._applyStructureUpdates=function(e,t,n){var r=this;n=n||{};switch(e){case"add":this.items[t.get("data.unique")]=t;if(!t.isRoot()){var i=this._getParentItem(t);if(!i){delete this.items[t.get("data.unique")];return}t.set("depth",i.get("depth")+1),i.set("threading",!0),t.set("forceInject",!0),this._addItemToList(i.get("children"),t,this.config.get("children.displaySortOrder"))}else this._addItemToList(this.threads,t,this.config.get("sortOrder"));break;case"delete":var s=t.isRoot()?this.threads:this.items[t.get("data.parentUnique")].get("children");if(!t.isRoot()&&s.length===1){var i=this._getParentItem(t);i&&i.set("threading",!1)}s.splice(this._getItemListIndex(t,s),1),n.keepChildren||(t.traverse(t.get("children"),function(e){delete r.items[e.get("data.unique")]}),t.set("children",[])),delete this.items[t.get("data.unique")]}},n.methods._normalizeEntry=function(e){if(e.normalized)return e;var n=this;return e.normalized=!0,t.each(e.targets||[],function(t,r){if(r.id===r.conversationID||r.id===e.object.id||n.items[r.id+r.conversationID])e.target=r}),e.object.content_type=e.object.content_type||"text",e.object.accumulators=e.object.accumulators||{},t.each(["repliesCount","flagsCount","likesCount"],function(t,n){e.object.accumulators[n]=parseInt(e.object.accumulators[n]||"0")}),e.object.context=e.object.context||[],e.object.flags=e.object.flags||[],e.object.likes=e.object.likes||[],e.target=e.target||e.targets[0]||{},e.target.conversationID=e.target.conversationID||e.object.id,e.source=e.source||{},e.provider=e.provider||{},e.unique=e.object.id+e.target.conversationID,e.parentUnique=e.target.id+e.target.conversationID,e},n.css=".{class:message-wrapper} { padding: 15px 0px; text-align: center; -moz-border-radius: 0.5em; -webkit-border-radius: 0.5em; border: 1px solid #E4E4E4; }.{class:message-empty}, .{class:message-loading}, .{class:message-error} { display: inline-block; height: 16px; padding-left: 21px; background: no-repeat left center; }.{class:message-empty} { background-image: url({config:cdnBaseURL.sdk-assets}/images/information.png); }.{class:message-loading} { background-image: url({config:cdnBaseURL.sdk-assets}/images/loading.gif); }.{class:message-error} { background-image: url({config:cdnBaseURL.sdk-assets}/images/warning.gif); }.{class:header} { margin: 10px 0px 10px 0px; }.{class:compactStateLayout} { float: right; }.{class:fullStateLayout} { text-align: center; }.{class:state-picture} { display: inline-block; height: 9px; width: 8px; }.{class:state-picture-paused} { background: url({config:cdnBaseURL.sdk-assets}/images/control_pause.png) no-repeat center center; }.{class:state-picture-live} { background: url({config:cdnBaseURL.sdk-assets}/images/control_play.png) no-repeat center center; }.{class:state-message} { margin-left: 5px; text-decoration: none; }.echo-clickable a.{class:state-message}:hover { text-decoration: underline; }.{class:more}:hover, .{class:fullStateLayout}:hover { background-color: #E4E4E4; }.{class:more}, .{class:fullStateLayout} { text-align: center; border: solid 1px #E4E4E4; margin-top: 10px; padding: 10px; -moz-border-radius: 0.5em; -webkit-border-radius: 0.5em; cursor: pointer; font-weight: bold; }.{class:more} .echo-app-message { padding: 0; border: none; border-radius: 0; }",Echo.Control.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.Stream.Item");if(Echo.Control.isDefined(n))return;n.init=function(){this.timestamp=Echo.Utils.timestampFromW3CDTF(this.get("data.object.published")),this.ready()},n.config={aggressiveSanitization:!1,buttonsOrder:undefined,contentTransformations:{text:["smileys","urls","newlines"],html:["smileys","urls","newlines"],xhtml:["smileys","urls"]},infoMessages:{enabled:!1},limits:{maxBodyCharacters:undefined,maxBodyLines:undefined,maxBodyLinkLength:50,maxMarkerLength:16,maxReLinkLength:30,maxReTitleLength:143,maxTagLength:16},optimizedContext:!0,providerIcon:Echo.Loader.getURL("images/favicons/comments.png",!1),reTag:!0,viaLabel:{icon:!1,text:!1}},n.config.normalizer={contentTransformations:function(e){return t.each(e,function(t,n){e[t]=Echo.Utils.foldl({},n||[],function(e,t){t[e]=!0})}),e}},n.vars={children:[],depth:0,threading:!1,textExpanded:!1,timestamp:undefined,blocked:!1,buttonsOrder:[],buttonSpecs:{},buttons:{}},n.labels={defaultModeSwitchTitle:"Switch to metadata view",guest:"Guest",metadataModeSwitchTitle:"Return to default view",sharedThisOn:"I shared this on {service}...",userID:"User ID:",userIP:"User IP:",textToggleTruncatedMore:"more",textToggleTruncatedLess:"less",fromLabel:"from",viaLabel:"via",childrenMoreItems:"View more items",re:"Re"},n.templates.metadata={userID:'<div class="{class:metadata-userID}"><span class="{class:metadata-title} {class:metadata-icon}">{label:userID}</span><span class="{class:metadata-value}">{data:actor.id}</span></div>',userIP:'<div class="{class:metadata-userIP}"><span class="{class:metadata-title} {class:metadata-icon}">{label:userIP}</span><span class="{class:metadata-value}">{data:ip}</span></div>'},n.templates.mainHeader='<div class="{class:content}"><div class="{class:container}"><div class="{class:avatar-wrapper}"><div class="{class:avatar}"></div></div><div class="{class:wrapper}"><div class="{class:subwrapper}"><div class="{class:subcontainer}"><div class="{class:frame}"><div class="{class:modeSwitch} echo-clickable"></div><div class="{class:authorName} echo-linkColor"></div><div class="echo-clear"></div><div class="{class:data}"><div class="{class:re}"></div><div class="{class:body} echo-primaryColor"> <span class="{class:text}"></span><span class="{class:textEllipses}">...</span><span class="{class:textToggleTruncated} echo-linkColor echo-clickable"></span></div><div class="{class:markers} echo-secondaryFont echo-secondaryColor"></div><div class="{class:tags} echo-secondaryFont echo-secondaryColor"></div></div><div class="{class:metadata}"></div><div class="{class:footer} echo-secondaryColor echo-secondaryFont"><img class="{class:sourceIcon} echo-clickable"><div class="{class:date}"></div><div class="{class:from}"></div><div class="{class:via}"></div><div class="{class:buttons}"></div><div class="echo-clear"></div></div></div></div><div class="echo-clear"></div></div></div><div class="echo-clear"></div><div class="{class:childrenMarker}"></div></div>',n.templates.mainFooter='<div class="{class:childrenByCurrentActorLive}"></div></div>',n.templates.childrenTop='<div class="{class:children}"></div><div class="{class:expandChildren} {class:container-child} echo-trinaryBackgroundColor echo-clickable"><span class="{class:expandChildrenLabel} echo-message-icon"></span></div>',n.templates.childrenBottom='<div class="{class:expandChildren} {class:container-child} echo-trinaryBackgroundColor echo-clickable"><span class="{class:expandChildrenLabel} echo-message-icon"></span></div><div class="{class:children}"></div>',n.methods.template=function(){return this.templates.mainHeader+(this.config.get("parent.children.sortOrder")==="chronological"?this.templates.childrenTop:this.templates.childrenBottom)+this.templates.mainFooter},n.renderers.authorName=function(e){var t=this.get("data.actor.title")||this.labels.get("guest");return Echo.Utils.safelyExecute(e.html,t,e)||e},n.renderers.markers=function(e){return this.view.render({name:"_extraField",target:e,extra:{type:"markers"}})},n.renderers.tags=function(e){return this.view.render({name:"_extraField",target:e,extra:{type:"tags"}})},n.renderers.container=function(e){var n=this;e.removeClass(t.map(["child","root","child-thread","root-thread"],function(e){return n.cssPrefix+"container-"+e}).join(" "));var r=this.threading?"-thread":"",i=this.depth?"container-child"+r+" echo-trinaryBackgroundColor":"container-root"+r;e.addClass(this.cssPrefix+"depth-"+this.depth+" "+this.cssPrefix+i);var s=function(e){t.map(n.buttonsOrder,function(t){var r=n.get("buttons."+t+".clickableElements");if(!n.get("buttons."+t+".element")||!r)return;r[e+"Class"]("echo-linkColor")})};return Echo.Utils.isMobileDevice()||e.off(["mouseleave","mouseenter"]).hover(function(){n.user.is("admin")&&n.view.get("modeSwitch").show(),s("add")},function(){n.user.is("admin")&&n.view.get("modeSwitch").hide(),s("remove")}),e},n.renderers.metadata=function(e){e.empty();if(this.user.is("admin")){var t=this.view.fork(),r=function(r){e.append(t.render({template:n.templates.metadata[r]}))};r("userID"),this.get("data.ip")&&r("userIP")}return e.hide()},n.renderers.modeSwitch=function(e){var t=this;e.hide();if(!this.user.is("admin"))return e;var n="default",r=function(r){e.attr("title",t.labels.get(n+"ModeSwitchTitle"))};return r(),e.click(function(){n=n==="default"?"metadata":"default",r(),t.view.get("data").toggle(),t.view.get("metadata").toggle()}),Echo.Utils.isMobileDevice()&&e.show(),e},n.renderers.wrapper=function(e){return e.addClass(this.cssPrefix+"wrapper"+(this.depth?"-child":"-root"))},n.renderers.avatar=function(e){return this.placeImage({container:e,image:this.get("data.actor.avatar"),defaultImage:this.config.get("defaultAvatar")}),e},n.renderers.children=function(e,t){return this.view.render({name:"_childrenContainer",target:e,extra:{filter:function(e){return!e.byCurrentUser},keepChildren:t&&t.keepChildren}})},n.renderers.childrenByCurrentActorLive=function(e,t){return this.view.render({name:"_childrenContainer",target:e,extra:{filter:function(e){return e.byCurrentUser},keepChildren:t&&t.keepChildren}})},n.renderers.buttons=function(e){var n=this;return this._assembleButtons(),this._sortButtons(),e.empty(),t.map(this.buttonsOrder,function(t){var r=n.get("buttons."+t);if(!r||!r.name||!r.visible())return;n.view.render({name:"_buttonsDelimiter",target:e}),n.view.render({name:"_button",target:e,extra:r})}),e},n.renderers.re=function(e){var n=this;if(!this.config.get("reTag")||this.depth)return e.hide();var r=document.location.href,i=this.get("data.object.context"),s=this.get("data.object.permalink");if(s===r||!i||!i.length)return e.hide();var o=!1;t.map(i,function(e){if(e.uri===r)return o=!0,!1});if(o)return e.hide();var u,a={limits:this.config.get("limits"),openLinksInNewWindow:this.config.get("parent.openLinksInNewWindow")},f=this._getDomain(r);if(this.config.get("optimizedContext")){var l;t.map(i,function(e){if(n._getDomain(e.uri)===f)return l=e,!1}),u=this._reOfContext(l||i[0],a)}else u=t.map(i,function(e){return n._reOfContext(e,a)});return e.empty().append(u).show()},n.renderers.sourceIcon=function(e){if(!this.config.get("viaLabel.icon")||this.get("data.source.name")==="jskit"||this.get("data.source.name")==="echo")return e.hide();var t=this.get("data.source.icon",this.config.get("providerIcon")),n={href:this.get("data.source.uri",this.get("data.object.permalink"))},r={openInNewWindow:this.config.get("parent.openLinksInNewWindow")};return e.hide().attr("src",Echo.Utils.htmlize(t)).one("error",function(){e.hide()}).one("load",function(){e.show().wrap(Echo.Utils.hyperlink(n,r))}),e},n.renderers.via=function(e){var t=this,n=function(e){return(t.data[e].name||"").toLowerCase()};return n("source")===n("provider")?e:this.view.render({name:"_viaText",target:e,extra:{label:"via",field:"provider"}})},n.renderers.from=function(e){return this.view.render({name:"_viaText",target:e,extra:{label:"from",field:"source"}})},n.renderers.textToggleTruncated=function(e){var t=this;return e.off("click").click(function(){t.textExpanded=!t.textExpanded,t.view.render({name:"body"}),t.view.render({name:"textToggleTruncated"})}),e.empty().append(this.labels.get("textToggleTruncated"+(this.textExpanded?"Less":"More")))},n.renderers.body=function(e){var n=this,r=[this.get("data.object.content"),{source:this.get("data.source.name"),limits:this.config.get("limits"),contentTransformations:this.config.get("contentTransformations."+this.get("data.object.content_type"),{}),openLinksInNewWindow:this.config.get("parent.openLinksInNewWindow")}];t.each(this._getBodyTransformations(),function(e,t){r=t.apply(n,r);if(!/\S/.test(r[0]))return r[0]=n.labels.get("sharedThisOn",{service:r[1].source}),!1});var i=r[0],s=r[1].truncated,o=this.view.get("text").empty();return Echo.Utils.safelyExecute(o.append,i,o),this.view.get("textEllipses")[!s||this.textExpanded?"hide":"show"](),this.view.get("textToggleTruncated")[s||this.textExpanded?"show":"hide"](),e},n.renderers.date=function(e){return this.age=this.getRelativeTime(this.timestamp),e.html(this.age)},n.renderers.expandChildrenLabel=function(e,t){if(!this.children.length||!this.hasMoreChildren())return e;t=t||{},t.state=t.state||"regular";var n={loading:{css:this.cssPrefix+"message-loading",label:"loading"},regular:{css:"echo-linkColor echo-message-icon",label:"childrenMoreItems"}};return e.removeClass(n[t.state==="loading"?"regular":"loading"].css).addClass(n[t.state].css).html(this.labels.get(n[t.state].label))},n.renderers.expandChildren=function(e,t){var n=this;return this.children.length?this.hasMoreChildren()?(t=t||{},e.addClass(this.cssPrefix+"depth-"+(this.depth+1)).show().off("click").one("click",function(){n.view.render({name:"expandChildrenLabel",target:n.view.get("expandChildrenLabel"),extra:{state:"loading"}}),n.events.publish({topic:"onChildrenExpand",data:{data:n.data},global:!1,propagation:!1})})):(e.slideUp(this.config.get("children.moreButtonSlideTimeout")),e):e},n.renderers._childrenContainer=function(e,n){return t.each(e.children(),function(e,n){t(n).detach()}),t.map(this.children,function(t){if(n&&n.filter&&!n.filter(t))return;e.append(t.config.get("target")),!t.view.rendered()&&!t.added&&t.render(),(t.deleted||t.added)&&t.events.publish({topic:t.deleted?"onDelete":"onAdd",data:{config:n},global:!1,propagation:!1})}),e},n.renderers._extraField=function(e,t){var n=this,r=(t||{}).type;if(!this.data.object[r]||!this.user.is("admin"))return e.hide();var i=r==="markers"?"maxMarkerLength":"maxTagLength",s=this.config.get("limits."+i),o=Echo.Utils.foldl([],this.data.object[r],function(e,t){var r=e.length>s?'<span title="{data:item}">{data:truncatedItem}</span>':"<span>{data:item}</span>",i=Echo.Utils.htmlTextTruncate(e,s,"...");t.push(n.substitute({template:r,data:{item:e,truncatedItem:i}}))});return(Echo.Utils.safelyExecute(e.prepend,o.sort().join(", "),e)||e).show()},n.renderers._button=function(e,n){var r=n.template||'<a class="{class:button} {class:button}-{data:name}">{data:label}</a>',i={label:n.label||"",name:n.name},s=t(this.substitute({template:r,data:i}));if(!n.clickable)return e.append(s);var o=t(".echo-clickable",s);o.length||(o=s,s.addClass("echo-clickable")),o[n.once?"one":"on"]({click:function(e){e.stopPropagation(),n.callback&&n.callback()}});var i=this.get("buttons."+n.plugin+"."+n.name);return i.element=s,i.clickableElements=o,Echo.Utils.isMobileDevice()&&o.addClass("echo-linkColor"),e.append(s)},n.renderers._buttonsDelimiter=function(e){return e.append('<span class="'+this.cssPrefix+'button-delim"> \u00b7 </span>')},n.renderers._viaText=function(e,t){t=t||{};var n=this.data[t.field];if(!this.config.get("viaLabel.text")||!n.name||n.name==="jskit"||n.name==="echo")return e;var r=Echo.Utils.hyperlink({"class":"echo-secondaryColor",href:n.uri||this.get("data.object.permalink"),caption:n.name},{openInNewWindow:this.config.get("parent.openLinksInNewWindow")});return e.html("&nbsp;"+this.labels.get(t.label+"Label")+"&nbsp;").append(r)},n.methods.hasMoreChildren=function(){return this.get("data.hasMoreChildren")==="true"},n.methods.getNextPageAfter=function(){var e=t.grep(this.children,function(e){return!e.config.get("live")}),n=this.config.get("parent.children.sortOrder")==="chronological"?e.length-1:0;return e.length?e[n].data.pageAfter:undefined},n.methods.traverse=function(e,n,r){var i=this;return t.each(e||[],function(e,t){r=i.traverse(t.children,n,n(t,r))}),r},n.methods.block=function(e){if(this.blocked)return;this.blocked=!0;var n=this.view.get("container"),r=n.width(),i=n.outerHeight();this.blockers={backdrop:t('<div class="'+this.cssPrefix+'blocker-backdrop"></div>').css({width:r,height:i}),message:t(this.substitute({template:'<div class="{class:blocker-message}">{data:label}</div>',data:{label:e}})).css({left:(parseInt(r)-200)/2+"px",top:(parseInt(i)-20)/2+"px"})},n.addClass("echo-relative").prepend(this.blockers.backdrop).prepend(this.blockers.message)},n.methods.unblock=function(){if(!this.blocked)return;this.blocked=!1,this.blockers.backdrop.remove(),this.blockers.message.remove(),this.view.get("container").removeClass("echo-relative")},n.methods.getAccumulator=function(e){return this.data.object.accumulators[e]},n.methods.isRoot=function(){return!this.config.get("parent.children.maxDepth")||this.get("data.object.id")===this.get("data.target.conversationID")},n.methods.addButtonSpec=function(e,t){this.buttonSpecs[e]||(this.buttonSpecs[e]=[]),this.buttonSpecs[e].push(t)},n.methods._getDomain=function(e){var t=Echo.Utils.parseURL(e);return t&&t.domain?t.domain:e},n.methods._reOfContext=function(e,n){var r=e.title||e.uri.replace(/^https?:\/\/(.*)/ig,"$1"),i=n.limits[r?"maxReTitleLength":"maxReLinkLength"];r.length>i&&(r=r.substring(0,i)+"...");var s=Echo.Utils.hyperlink({"class":"echo-primaryColor",href:e.uri,caption:this.labels.get("re")+": "+Echo.Utils.stripTags(r)},{openInNewWindow:n.openLinksInNewWindow});return t(this.substitute({template:'<div class="{class:re-container}">{data:hyperlink}</div>',data:{hyperlink:s}}))},n.methods._prepareEventParams=function(e){return t.extend(e,{target:this.config.get("parent.target").get(0),query:this.config.get("parent.query"),item:{data:this.data,target:this.config.get("target").get(0)}})};var r={codes:[],regexps:[],hash:{":)":{file:"smile.png",title:"Smile"},":-)":{file:"smile.png",title:"Smile"},";)":{file:"wink.png",title:"Wink"},";-)":{file:"wink.png",title:"Wink"},":(":{file:"unhappy.png",title:"Frown"},":-(":{file:"unhappy.png",title:"Frown"},"=-O":{file:"surprised.png",title:"Surprised"},":-D":{file:"grin.png",title:"Laughing"},":-P":{file:"tongue.png",title:"Tongue out"},"=)":{file:"happy.png",title:"Happy"},"B-)":{file:"evilgrin.png",title:"Evil grin"}}};n.methods._initSmileysConfig=function(){var e=this;if(r.codes.length)return r;var n=function(e){return e.replace(/([\W])/g,"\\$1")},i=[];return t.each(r.hash,function(e){var t=n(e);i.push(t),r.codes.push(e),r.regexps[e]=new RegExp(t,"g")}),r.regexps.test=new RegExp(i.join("|")),r.tag=function(t){return e.substitute({template:'<img class="{class:smiley-icon}" src="{config:cdnBaseURL.sdk-assets}/images/smileys/emoticon_'+t.file+'" title="'+t.title+'" alt="'+t.title+'">'})},r},n.methods._assembleButtons=function(){var e=this,n=[];t.each(this.buttonSpecs,function(r,i){t.map(i,function(i){var s=t.isFunction(i)?i.call(e):t.extend({},i);if(!s.name)return;var o=s.callback||function(){};s.callback=function(){o.call(e),e.events.publish({topic:"onButtonClick",data:{name:s.name,plugin:r,item:{data:e.data,target:e.config.get("target")}}})},s.label=s.label||s.name,s.plugin=r,typeof s.clickable=="undefined"&&(s.clickable=!0),typeof s.visible=="undefined"&&(s.visible=!0);var u=s.visible;s.visible=t.isFunction(u)?u:function(){return u};var a=r+"."+s.name;e.set("buttons."+a,s),t.inArray(a,e.buttonsOrder)<0&&n.push(a)})}),e.buttonsOrder=n.concat(e.buttonsOrder)},n.methods._sortButtons=function(){var e=this,n=this.buttonsOrder,r=this.config.get("buttonsOrder");if(!r)this.config.set("buttonsOrder",n);else if(r!=n){var i=function(r,i,s){if(!e.get("buttons."+r))return;i.push(r),s=s||t.inArray(r,n),s>=0&&delete n[s]},s=Echo.Utils.foldl([],r,function(e,r){if(/^(.*)\./.test(e))i(e,r);else{var s=new RegExp("^"+e+".");t.map(n,function(e,t){e&&e.match(s)&&i(e,r,t)})}});this.buttonsOrder=s,this.config.set("buttonsOrder",s)}else r.length||(this.buttonsOrder=[])},function(){n.methods._getBodyTransformations=function(){return[i,s,u,o,l,c,h,a,f,p]};var e="((?:http|ftp|https):\\/\\/(?:[a-z0-9#:\\/\\;\\?\\-\\.\\+,@&=%!\\*\\'(){}\\[\\]$_|^~`](?!gt;|lt;))+)",r=function(e,t){var n=e.length>t.maxTagLength?'<span class="{class:tag}" title="{data:tag}">{data:truncatedTag}</span>':'<span class="{class:tag}">{data:tag}</span>',r=e.substring(0,t.maxTagLength)+"...";return this.substitute({template:n,data:{tag:e,truncatedTag:r}})},i=function(e,t){return t.source&&t.source==="Twitter"&&this.config.get("aggressiveSanitization")&&(e=""),[e,t]},s=function(e,t){var n=this;return t.contentTransformations.hashtags&&(e=e.replace(/(?:#|\uff03)(<a[^>]*>[^<]*<\/a>)/ig,function(e,i,s){return r.call(n,i,t.limits)})),[e,t]},o=function(e,t){var n=this;return t.contentTransformations.hashtags&&(e=e.replace(/(^|[^\w&\/])(?:#|\uff03)([^\s\.,;:'"#@\$%<>!\?\(\)\[\]]+)/ig,function(e,i,s){return i+r.call(n,s,t.limits)})),[e,t]},u=function(e,t){var n=this,r=[];return e=e.replace(/((<a\s+[^>]*>)(.*?)(<\/a>))|<.*?>/ig,function(e,i,s,f,l){if(i){var c=u.call(n,f,t);c=o.apply(n,c),c=a.apply(n,c),e=s+c[0]+l}return r.push(e)," %%HTML_TAG%% "}),t.tags=r,[e,t]},a=function(e,n){return t.each(n.tags,function(t,n){e=e.replace(" %%HTML_TAG%% ",n)}),[e,n]},f=function(t,n){return t=t.replace(/(<a\s+[^>]*>)(.*?)(<\/a>)/ig,function(t,r,i,s){return(new RegExp("^"+e+"$","i")).test(i)&&(i=i.length>n.limits.maxBodyLinkLength?i.substring(0,n.limits.maxBodyLinkLength)+"...":i),n.openLinksInNewWindow&&!/\s+target=("[^<>"]*"|'[^<>']*'|\w+)/.test(r)&&(r=r.replace(/(^<a\s+[^>]*)(>$)/,'$1 target="_blank"$2')),r+i+s}),[t,n]},l=function(t,n){n.textBeforeAutoLinking=t;var r=this,i;return n.source&&n.source!=="jskit"&&n.source!=="echo"&&(i=this.depth?this.get("data.target.id"):this.config.get("reTag")?this.get("data.object.permalink")||this.get("data.target.id"):undefined),t=t.replace(new RegExp(e,"ig"),function(e,t){return i===t?"":n.contentTransformations.urls?Echo.Utils.hyperlink({href:t,caption:t},{skipEscaping:!0,openInNewWindow:n.openLinksInNewWindow}):e}),[t,n]},c=function(e,n){if(n.contentTransformations.smileys){if(e!==n.textBeforeAutoLinking){var r=a.call(this,e,n);r=u.apply(this,r),e=r[0],n=r[1]}var i=this._initSmileysConfig();e.match(i.regexps.test)&&t.each(i.codes,function(t,n){e=e.replace(i.regexps[n],i.tag(i.hash[n]))})}return[e,n]},h=function(e,t){return t.contentTransformations.newlines&&(e=e.replace(/\n\n+/g,"\n\n"),e=e.replace(/\n/g,"&nbsp;<br>")),[e,t]},p=function(e,t){var n=!1;if((t.limits.maxBodyCharacters||t.limits.maxBodyLines)&&!this.textExpanded){if(t.limits.maxBodyLines){var r=t.contentTransformations.newlines?"<br>":"\n",i=e.split(r);i.length>t.limits.maxBodyLines&&(e=i.splice(0,t.limits.maxBodyLines).join(r),n=!0)}var s=t.limits.maxBodyCharacters&&e.length>t.limits.maxBodyCharacters?t.limits.maxBodyCharacters:n?e.length:undefined,o=Echo.Utils.htmlTextTruncate(e,s,"",!0);o.length!==e.length&&(n=!0),e=o}return t.truncated=n,[e,t]}}();var i=[];for(var s=0;s<=20;s++)i.push(".{class:depth}-"+s+" { margin-left: "+(s?68+(s-1)*44:0)+"px; }");n.css='.{class:content} { word-wrap: break-word; }.{class:container-root} { padding: 10px 0px 10px 10px; }.{class:container-root-thread} { padding: 10px 0px 0px 10px; }.{class:container-child} { padding: 10px; margin: 0px 20px 2px 0px; }.{class:container-child-thread} { padding: 10px; margin: 0px 20px 2px 0px; }.{class:avatar-wrapper} { margin-right: -58px; float: left; position: relative; }.{class:children} .{class:avatar-wrapper}, .{class:childrenByCurrentActorLive} .{class:avatar-wrapper} { margin-right: -34px; }.{class:children} .{class:subwrapper}, .{class:childrenByCurrentActorLive} .{class:subwrapper} { margin-left: 34px; }.{class:wrapper} { float: left; width: 100%; }.{class:subwrapper} { margin-left: 58px; }.{class:subcontainer} { float: left; width: 100%; }.{class:markers} { line-height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/marker.png") no-repeat; padding: 0px 0px 4px 21px; margin-top: 7px; }.{class:tags} { line-height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/tag_blue.png") no-repeat; padding: 0px 0px 4px 21px; }.{class:metadata-title} { font-weight: bold; line-height: 25px; height: 25px; margin-right: 5px; }.{class:metadata-icon} { display: inline-block; padding-left: 26px; }.{class:metadata-userID} { border-bottom: 1px solid #e1e1e1; border-top: 1px solid #e1e1e1;}.{class:metadata-userID} .{class:metadata-icon} { background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/user.png") no-repeat left center; }.{class:metadata-userIP} { border-bottom: 1px solid #e1e1e1; }.{class:metadata-userIP} .{class:metadata-icon} { background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/computer.png") no-repeat left center; }.{class:modeSwitch} { float: right; width: 16px; height: 16px; background:url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/flip.png") no-repeat 0px 3px; }.{class:childrenMarker} { border-color: transparent transparent #ECEFF5; border-width: 0px 11px 11px; border-style: solid; margin: 3px 0px 0px 77px; height: 1px; width: 0px; display: none; }.{class:container-root-thread} .{class:childrenMarker} { display: block; }.{class:avatar} { width: 48px; height: 48px; }.{class:children} .{class:avatar}, .{class:childrenByCurrentActorLive} .{class:avatar} { width: 24px; height: 24px; }.{class:authorName} { float: left; font-size: 15px; font-family: Arial, sans-serif; font-weight: bold; }.{class:re} { font-weight: bold; }.{class:re} a:link, .{class:re} a:visited, .{class:re} a:active { text-decoration: none; }.{class:re} a:hover { text-decoration: underline; }.{class:body} { padding-top: 4px; }.{class:buttons} { float: left; margin-left: 3px; }.{class:buttons} a.{class:button} { color: #C6C6C6; }.{class:buttons} a.{class:button}.echo-linkColor, .{class:buttons} a.{class:button}:hover { color: #476CB8; text-decoration: none; }.{class:sourceIcon} { float: left; height: 16px; width: 16px; margin-right: 5px; border: 0px; }.{class:date}, .{class:from}, .{class:via} { float: left; }.{class:from} a, .{class:via} a { text-decoration: none; color: #C6C6C6; }.{class:from} a:hover, .{class:via} a:hover { color: #476CB8; }.{class:tag} { display: inline-block; height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/tag_blue.png") no-repeat; padding-left: 18px; }.{class:smiley-icon} { border: 0px; }.{class:textToggleTruncated} { margin-left: 5px; }.{class:blocker-backdrop} { position: absolute; left: 0px; top: 0px; background: #FFFFFF; opacity: 0.7; z-index: 100; }.{class:blocker-message} { position: absolute; z-index: 200; width: 200px; height: 20px; line-height: 20px; text-align: center; background-color: #FFFF99; border: 1px solid #C6C677; opacity: 0.7; -moz-border-radius: 0.5em 0.5em 0.5em 0.5em; }.{class:expandChildren} { display:none; text-align: center; padding:4px; }.{class:expandChildren} .{class:expandChildrenLabel} { display: inline-block; padding-left: 22px; }.{class:expandChildren} .echo-message-icon { background: url("{config:cdnBaseURL.sdk-assets}/images/whirlpool.png") no-repeat 5px 4px; }.{class:expandChildren} .{class:message-loading} { background: no-repeat left top url("{config:cdnBaseURL.sdk-assets}/images/loading.gif"); }.{class:expandChildren} .echo-app-message { padding: 0; border:none; border-radius: 0; }'+i.join("\n"),Echo.Control.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.StreamServer.Controls.Counter");if(Echo.Control.isDefined(n))return;n.init=function(){if(!this.checkAppKey())return;var e=this.config.get("liveUpdates.timeout");typeof e!="undefined"&&this.config.set("liveUpdates.polling.timeout",e),this.request=this._getRequestObject(),t.isEmptyObject(this.get("data"))?this.request.send():(this.render(),this.ready(),this.request&&this.request.send({skipInitialRequest:!0}))},n.config={data:undefined,liveUpdates:{enabled:!0,polling:{timeout:10}},infoMessages:{layout:"compact"}},n.templates.main="<span>{data:count}</span>",n.methods._getRequestObject=function(e){return Echo.StreamServer.API.request(t.extend(!0,{endpoint:"count",data:{q:this.config.get("query"),appkey:this.config.get("appkey")},liveUpdates:this.config.get("liveUpdates"),secure:this.config.get("useSecureAPI"),apiBaseURL:this.config.get("apiBaseURL"),onError:t.proxy(this._error,this),onData:t.proxy(this._handleResponse,this)},e))},n.methods._maybeUpdate=function(e){if(t.isEmptyObject(this.data)||this.data.count!=e.count)this.events.publish({topic:"onUpdate",data:{data:e,query:this.config.get("query"),target:this.config.get("target").get(0)}}),this.set("data",e),this.render()},n.methods._handleResponse=function(e,t){this._maybeUpdate(e),t.requestType==="initial"&&this.ready()},n.methods._error=function(e,t){this.events.publish({topic:"onError",data:{data:e,query:this.config.get("query"),target:this.config.get("target").get(0)}}),e.errorCode==="more_than"?(this.set("data.count",e.errorMessage+"+"),this.render()):(typeof t.critical=="undefined"||t.critical||t.requestType==="initial")&&this.showMessage({type:"error",data:e,message:e.errorMessage}),this.ready()},Echo.Control.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Like","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertAsLastChild","data",n.templates.main),this.component.addButtonSpec("Like",this._assembleButton("Like")),this.component.addButtonSpec("Like",this._assembleButton("Unlike"))},n.config={asyncFacePileRendering:!1},n.labels={likeThis:" like this.",likesThis:" likes this.",likeControl:"Like",unlikeControl:"Unlike",likeProcessing:"Liking...",unlikeProcessing:"Unliking..."},n.dependencies=[{control:"Echo.StreamServer.Controls.FacePile",url:"{config:cdnBaseURL.sdk}/streamserver.pack.js"}],n.events={"Echo.StreamServer.Controls.FacePile.Item.Plugins.Like.onUnlike":function(e,t){return this._sendActivity("Unlike",this.component,t.actor),{stop:["bubble"]}}},n.templates.main='<div class="{plugin.class:likedBy}"></div>',n.renderers.likedBy=function(e){var n=this,r=this.component;if(!r.get("data.object.likes").length)return e.hide();var i=5,s=n.get("facePile")?n.get("facePile").getVisibleUsersCount():i,o=!1,u=r.user.get("identityUrl"),a=r.get("data.object.likes");t.each(a,function(e,t){if(t.actor.id===u)return o=!0,!1});var f=n.config.assemble({target:e.get(0),data:{itemsPerPage:i,entries:a},initialUsersCount:s,totalUsersCount:r.get("data.object.accumulators.likesCount"),suffixText:n.labels.get(a.length>1||o?"likeThis":"likesThis")});return f.plugins.push({name:"Like"}),r.user.is("admin")&&e.addClass(n.cssPrefix+"highlight"),this.config.get("asyncFacePileRendering")?setTimeout(t.proxy(this._initFacePile,this,f),0):this._initFacePile(f),e.show()},n.methods._initFacePile=function(e){this.set("facePile",new Echo.StreamServer.Controls.FacePile(e))},n.methods._sendRequest=function(e,t,n){Echo.StreamServer.API.request({endpoint:"submit",secure:this.config.get("useSecureAPI",!1,!0),submissionProxyURL:this.component.config.get("submissionProxyURL"),onData:t,onError:n,data:e}).send()},n.methods._sendActivity=function(e,t,n){var r=this,i={verbs:["http://activitystrea.ms/schema/1.0/"+e.toLowerCase()],targets:[{id:t.get("data.object.id")}]};n&&n.id&&(i.author=n.id),this._sendRequest({content:i,appkey:t.config.get("appkey"),sessionID:t.user.get("sessionID"),"target-query":t.config.get("parent.query")},function(t){r._publishEventComplete({name:e,state:"Complete",response:t}),r.requestDataRefresh()},function(t){r._publishEventComplete({name:e,state:"Error",response:t})})},n.methods._publishEventComplete=function(e){var t=this.component;this.events.publish({topic:"on"+e.name+e.state,data:{item:{data:t.get("data"),target:t.config.get("target")},response:e.response}})},n.methods._assembleButton=function(e){var n=this,r=function(){var t=this;t.get("buttons."+n.name+"."+e+".element").empty().append(n.labels.get(e.toLowerCase()+"Processing")),n._sendActivity(e,t)};return function(){var i=this,s=t.map(i.get("data.object.likes"),function(e){if(i.user.has("identity",e.actor.id))return e}).length>0?"Unlike":"Like";return{name:e,label:n.labels.get(e.toLowerCase()+"Control"),visible:i.user.is("logged")&&s===e,once:!0,callback:r}}},n.css=".{plugin.class:likedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/likes.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }.{plugin.class:highlight} { line-height: 23px; }",Echo.Plugin.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Like","Echo.StreamServer.Controls.FacePile.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertAsLastChild","container",n.templates.main)},n.labels={unlikeOnBehalf:"Unlike on behalf of this user"},n.templates.main='<img class="{plugin.class:adminUnlike}" src="{config:cdnBaseURL.sdk-assets}/images/container/closeWindow.png"" title="{plugin.label:unlikeOnBehalf}" width="10" height="9">',n.component.renderers.container=function(e){this.parentRenderer("container",arguments),this.component.user.is("admin")&&e.addClass(this.cssPrefix+"highlight")},n.renderers.adminUnlike=function(e){var t=this,n=this.component;return n.user.is("admin")?e.one("click",function(){n.view.get("container").css("opacity",.3),t.events.publish({topic:"onUnlike",data:{actor:n.get("data"),target:n.config.get("parent.target").get(0)},global:!1,propagation:!1})}):e.remove()},n.css=".{plugin.class:adminUnlike} { cursor: pointer; margin-left: 3px; }.{plugin.class:highlight} { display: inline-block; line-height: 16px; background-color: #EEEEEE; padding: 1px 3px; border: 1px solid #D2D2D2; border-radius: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; margin: 0px 2px; }",Echo.Plugin.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("JanrainAuth","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){this._userStatus()==="forcedLogin"&&this.extendTemplate("replace","header",n.templates.forcedLogin),this.extendTemplate("insertBefore","header",n.templates.auth),this.component.addPostValidator(this._validator())},n.config={appId:"",buttons:["login"],title:"",height:260,width:420,signinWidgetConfig:{},submitPermissions:"allowGuest"},n.enabled=function(){return this.component.user&&this.component.user.get("sessionID")&&this.config.get("appId")&&this.config.get("buttons").length},n.labels={youMustBeLoggedIn:"You must be logged in to comment"},n.dependencies=[{control:"Echo.IdentityServer.Controls.Auth",url:"{config:cdnBaseURL.sdk}/identityserver.pack.js"}],n.templates.auth='<div class="{plugin.class:auth}"></div>',n.templates.forcedLogin='<div class="echo-primaryFont {class:header}"><span class="echo-secondaryColor {plugin.class:forcedLoginMessage}">{plugin.label:youMustBeLoggedIn}</span></div>',n.component.renderers.header=function(e){var t=this;return t._userStatus()==="logged"?e.empty():t.parentRenderer("header",arguments)},n.component.renderers.container=function(e){var n=this;n.parentRenderer("container",arguments);var r=function(e){return n.cssPrefix+e};return e.removeClass(t.map(["logged","anonymous","forcedLogin"],r).join(" ")).addClass(r(n._userStatus()))},n.renderers.auth=function(e){var t=this,n=["appId","title","width","height","buttons","signinWidgetConfig"],r=Echo.Utils.foldl({name:"JanrainConnector"},n,function(e,n){return t.config.get(e)&&(n[e]=t.config.get(e)),n});return new Echo.IdentityServer.Controls.Auth(t.config.assemble({target:e,plugins:[r]})),e},n.methods._validator=function(){var e=this,t=this.component;return function(){return!t.user.is("logged")&&e._permissions()==="forceLogin"?(e.view.get("forcedLoginMessage").addClass(e.cssPrefix+"error"),!1):!0}},n.methods._permissions=function(){return this.config.get("submitPermissions")},n.methods._userStatus=function(){return this.component.user.is("logged")?"logged":this._permissions()==="forceLogin"?"forcedLogin":"anonymous"},n.css=".{plugin.class:forcedLoginMessage} { font-size: 14px; font-weight: bold; }.{plugin.class:error} { color: red; }",Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Moderation","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this,r=this.component,i=this.config.get("itemActions").concat(this.config.get("userActions"));this.extendTemplate("insertAfter","avatar",n.templates.status),t.each(i,function(i,s){var o=n.actionButtons[s];o&&t.isArray(o)?t.each(o,function(t,n){r.addButtonSpec("Moderation",e["_assemble"+Echo.Utils.capitalize(s)+"Button"](n))}):r.addButtonSpec("Moderation",e._assembleButton(Echo.Utils.capitalize(s)))})},n.config={removePersonalItemsAllowed:!1,userActions:["ban","permissions"],itemActions:["approve","spam","delete"]},n.events={"Echo.StreamServer.Controls.Stream.Plugins.Moderation.onUserUpdate":function(e,t){var n=this.component,r=t.item;if(n.get("data.actor.id")!==r.data.actor.id)return;return n.set("data.actor."+(t.field==="state"?"status":t.field),t.value),n.render(),{stop:["bubble"]}}},n.labels={approveButton:"Approve",deleteButton:"Delete",spamButton:"Spam",untouchButton:"Untouch",changingStatusToCommunityFlagged:"Flagging...",changingStatusToModeratorApproved:"Approving...",changingStatusToModeratorDeleted:"Deleting...",changingStatusToUserDeleted:"Deleting...",changingStatusToUntouched:"Untouching...",changingStatusToModeratorFlagged:"Marking as spam...",statusCommunityFlagged:"Flagged by Community",statusModeratorApproved:"Approved by Moderator",statusModeratorDeleted:"Deleted by Moderator",statusUserDeleted:"Deleted by User",statusModeratorFlagged:"Flagged by Moderator",statusSystemFlagged:"Flagged by System",banUser:"Ban User",unbanUser:"Unban",userBanned:"Banned User",processingAction:"Setting up '{state}' user state...",moderatorRole:"Moderator",administratorRole:"Administrator",userButton:"Demote to User",moderatorButton:"Promote to Moderator",administratorButton:"Promote to Admin",setRoleAction:"Setting up '{role}' role...",unsetRoleAction:"Removing '{role}' role...",statusUntouched:"New"},n.templates.buttonLabels={banned:'<span class="{plugin.class:button-state} {plugin.class:button-state-banned}">{plugin.label:userBanned}</span>(<span class="echo-clickable">{plugin.label:unbanUser}</span>)',unbanned:'<span class="echo-clickable">{plugin.label:banUser}</span>'},n.templates.status='<div class="{plugin.class:status}"><div class="{plugin.class:statusIcon}"></div><div class="echo-clear"></div></div>',n.renderers.status=function(e){var t=this.component;if(!t.user.is("admin"))return e.hide(),e;t.get("depth")&&e.addClass(this.cssPrefix+"status-child");var n=t.get("data.object.status")||"Untouched";return e.addClass(this.cssPrefix+"status-"+n)},n.renderers.statusIcon=function(e){var t=this.component;if(!t.user.is("admin"))return e;var n=t.get("data.object.status")||"Untouched",r=this.labels.get("status"+n);return e.addClass(this.cssPrefix+"status-icon-"+n).attr("title",r)},n.statuses=["Untouched","ModeratorApproved","ModeratorDeleted","UserDeleted","CommunityFlagged","ModeratorFlagged","SystemFlagged"],n.button2status={Spam:"ModeratorFlagged",Delete:"ModeratorDeleted",Approve:"ModeratorApproved",Untouch:"Untouched"},n.actionButtons={ban:["Ban","UnBan"],permissions:["UserPermissions"]},n.roles=["","moderator","administrator"],n.methods._changeItemStatus=function(e){var t=this.component;this.set("selected",!1),t.set("data.object.status",e),t.view.render({name:"buttons"}),this.view.render({name:"status",recursive:!0})},n.methods._sendRequest=function(e,t,n){Echo.StreamServer.API.request({endpoint:"submit",secure:this.config.get("useSecureAPI",!1,!0),submissionProxyURL:this.component.config.get("submissionProxyURL"),onData:t,onError:n,data:e}).send()},n.methods._publishCompleteActionEvent=function(e){this.events.publish({topic:"on"+e.name+e.state,data:{item:{data:this.component.get("data"),target:this.component.get("view.content")},response:e.response}})},n.methods._assembleButton=function(e){var t=this,r=function(r){var i=n.button2status[e];return!r.user.is("admin")&&e==="Delete"&&t.config.get("removePersonalItemsAllowed")&&r.user.has("identity",r.data.actor.id)&&(i="UserDeleted"),i},i=function(){var n=this,i=r(n);n.block(t.labels.get("changingStatusTo"+i));var s={verbs:["http://activitystrea.ms/schema/1.0/update"],targets:[{id:n.get("data.object.id")}],actor:{title:n.get("data.actor.id")},object:{state:i}};t._sendRequest({content:s,appkey:n.config.get("appkey"),sessionID:n.user.get("sessionID"),"target-query":n.config.get("parent.query")},function(n){t._publishCompleteActionEvent({name:e,state:"Complete",response:n}),t._changeItemStatus(i),t.requestDataRefresh()},function(r){t._publishCompleteActionEvent({name:e,state:"Error",response:r}),n.unblock()})};return function(){var n=this,s=r(n);return{name:e,label:t.labels.get(e.toLowerCase()+"Button"),visible:n.get("data.object.status")!==s&&(n.user.is("admin")||s==="UserDeleted"),callback:i}}},n.methods._sendUserUpdate=function(e){var t=this.component;Echo.IdentityServer.API.request({endpoint:"update",submissionProxyURL:this.component.config.get("submissionProxyURL"),secure:this.config.get("useSecureAPI",!1,!0),data:{content:{field:e.field,value:e.value,identityURL:t.get("data.actor.id"),username:t.get("data.actor.title")},appkey:t.config.get("appkey"),sessionID:t.user.get("sessionID",""),"target-query":t.config.get("parent.query","")},onData:e.onData,onError:function(){t.render()}}).send()},n.methods._assembleBanButton=function(e){var t=this,r=function(){var r=this,i=e==="Ban"?"ModeratorBanned":"Untouched";r.get("buttons."+n.name+"."+e+".element").empty().append(t.labels.get("processingAction",{state:i})),t._sendUserUpdate({field:"state",value:i,onData:function(n){t._publishCompleteActionEvent({name:e,state:"Complete",response:n}),t._publishUserUpdateEvent({item:r,field:"state",value:i})},onError:function(n){t._publishCompleteActionEvent({name:e,state:"Error",response:n})}})};return function(){var i=this,s=t._isUserBanned(),o=i.get("data.actor.id")!==i.user.config.get("fakeIdentityURL")&&s^e==="Ban";return{name:e,label:t.substitute({template:n.templates.buttonLabels[s?"banned":"unbanned"]}),visible:o&&i.user.is("admin"),callback:r,once:!0}}},n.methods._assemblePermissionsButton=function(e){var r=this,i=function(){var i=this,s=r._getRole(),o=r._getNextRole(s),u=o!==""?(i.get("data.actor.roles")||[]).concat(o):Echo.Utils.foldl([],i.get("data.actor.roles")||[],function(e,r){t.inArray(e,n.roles)<0&&r.push(e)}),a=o===""?"unset":"set";i.get("buttons."+n.name+"."+e+".element").empty().append(r.labels.get(a+"RoleAction",{role:o||s})),r._sendUserUpdate({field:"roles",value:u.length?u.join(","):"-",onData:function(t){r._publishCompleteActionEvent({name:e,state:"Complete",response:t}),r._publishUserUpdateEvent({item:i,field:"roles",value:u})},onError:function(t){r._publishCompleteActionEvent({name:e,state:"Error",response:t})}})};return function(){var t=this,n=r._getRole(),s=n?'<span class="{plugin.class:button-role} {plugin.class:button-role}-{data:role}">{data:label}</span>(<span class="echo-clickable">{data:button}</span>)':'<span class="echo-clickable">{data:button}</span>',o=r.substitute({template:s,data:{role:n,label:n?r.labels.get(n+"Role"):"",button:r.labels.get((r._getNextRole(n)||"user")+"Button")}});return{name:e,label:o,visible:t.get("data.actor.id")!==t.user.config.get("fakeIdentityURL")&&t.user.any("roles",["administrator"]),callback:i,once:!0}}},n.methods._publishUserUpdateEvent=function(e){this.events.publish({topic:"onUserUpdate",data:{item:e.item,field:e.field,value:e.value},global:!1,propagation:!1}),this.requestDataRefresh()},n.methods._isUserBanned=function(){return this.component.get("data.actor.status")==="ModeratorBanned"},n.methods._getRole=function(){var e="";return t.each(this.component.get("data.actor.roles")||[],function(r,i){if(t.inArray(i,n.roles)>0){e=i;if(i==="administrator")return!1}}),e},n.methods._getNextRole=function(e){return n.roles[(t.inArray(e,n.roles)+1)%n.roles.length]},n.css=function(){return".{plugin.class:status} { width: 48px; height: 24px; }.{plugin.class:status-child} { width: 24px; height: 24px; }.{plugin.class:statusIcon} { float: right; margin: 4px; width: 16px; height: 16px; }.{plugin.class:status-Untouched} { background: #00aaff; }.{plugin.class:status-ModeratorApproved} { background: #bdfb6d; }.{plugin.class:status-ModeratorDeleted} { background: #f20202; }.{plugin.class:status-UserDeleted} { background: #ff8e8e; }.{plugin.class:status-SystemFlagged}, .{plugin.class:status-CommunityFlagged}, .{plugin.class:status-ModeratorFlagged} { background: #ff9e00; }.{plugin.class:button-state} { margin-right: 3px; }.{plugin.class:button-state-banned} { color: #FF0000; }.{plugin.class:button-role} { margin-right: 3px; }.{plugin.class:button-role-moderator} { color: #0000FF; }.{plugin.class:button-role-administrator} { color: #008000; }"+t.map(n.statuses,function(e){return".{plugin.class:status-icon-"+e+"} { background: url({config:cdnBaseURL.sdk-assets}/images/curation/status/"+e.toLowerCase()+".png) no-repeat; }"}).join("")}(),Echo.Plugin.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Moderation","Echo.StreamServer.Controls.Stream");n.events={"Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onUserUpdate":function(e,t){return this.events.publish({topic:"onUserUpdate",data:t,global:!1}),{stop:["bubble"]}}},Echo.Plugin.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("TextCounter","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertAfter","content",n.templates.counter)},n.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(e,t){this.view.render({name:"counterLabel"})}},n.labels={limited:"{typed}/{left} characters",unlimited:"{typed} characters"},n.templates.counter='<div class="{plugin.class:counterLabel} echo-primaryFont echo-primaryColor"></div>',n.component.renderers.text=function(e){var t=this;t.parentRenderer("text",arguments);var n=t.config.get("limit",0),r=function(){if(n){var r=e.val();if(r.length<=n)t.set("text",r);else if(r.length>n){e.val(t.get("text"));return}}t.view.render({name:"counterLabel"})};return e.on("blur focus keyup keypress",r)},n.renderers.counterLabel=function(e){var t=this,n=this.component,r=t.config.get("limit",0),i=n.view.get("text").val().length,s=t.labels.get(t.config.get("label",r?"limited":"unlimited"),{typed:i,left:Math.max(r-i,0),limit:r});return e.text(s)},Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Edit","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.component.addButtonSpec("Edit",this._assembleButton())},t.map(["Complete","Error"],function(e){n.events["Echo.StreamServer.Controls.Submit.Plugins.Edit.onEdit"+e]=function(e,t){this.component.render()}}),n.labels={editButton:"Edit"},n.dependencies=[{control:"Echo.StreamServer.Controls.Submit",url:"{config:cdnBaseURL.sdk}/streamserver.pack.js"}],n.methods._submitConfig=function(e,t){return this.config.assemble({target:t,data:e.get("data"),targetURL:e.get("data.object.id")})},n.methods._assembleButton=function(){var e=this;return function(){var t=this;return{name:"Edit",label:e.labels.get("editButton"),visible:t.user.is("admin")||t.user.has("identity",t.get("data.actor.id")),callback:function(){var n=e._submitConfig(t,t.view.get("subcontainer"));n.parent=e.component.config.getAsHash(),n.targetQuery=e.config.get("query",""),n.plugins.push({name:"Edit"}),new Echo.StreamServer.Controls.Submit(n),t.config.get("target").get(0).scrollIntoView(!0)}}}},Echo.Plugin.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Edit","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertAfter","postContainer",n.templates.cancel),this.extendTemplate("replace","header",n.templates.header),this.component.labels.set({post:this.labels.get("post"),posting:this.labels.get("posting")})},n.labels={createdBy:"Created by",edit:"Edit",on:"on",post:"Update",posting:"Updating...",cancel:"cancel"},t.map(["Init","Complete","Error"],function(e){n.events["Echo.StreamServer.Controls.Submit.onPost"+e]=function(t,n){e==="Init"&&(n.postData.content=this._prepareContent()),this.events.publish({data:n,topic:"onEdit"+e})}}),n.templates.header='<div class="{plugin.class:header} echo-primaryFont echo-primaryFont echo-primaryColor">{plugin.label:createdBy} <span class="{plugin.class:author}"></span> {plugin.label:on} <span class="{plugin.class:editedDate}"></span></div>',n.templates.cancel='<div class="{plugin.class:cancelButtonContainer}"><a href="javascript:void(0);" class="{plugin.class:cancelButton} echo-primaryFont echo-clickable echo-linkColor">{plugin.label:cancel}</a></div>',n.renderers.author=function(e){var t=this.component;return e.text(t.get("data.actor.title")||t.labels.get("guest"))},n.renderers.editedDate=function(e){var t=this.component.get("data.object.published");if(!t)return e.empty();var n=new Date(Echo.Utils.timestampFromW3CDTF(t)*1e3);return e.text(n.toLocaleDateString()+", "+n.toLocaleTimeString())},n.renderers.cancelButton=function(e){var t=this;return e.click(function(){t.events.publish({topic:"onEditError"})})},n.methods._prepareContent=function(){var e=this.component,t=function(t){return e.view.get(t).val()};return[].concat(this._getMetaDataUpdates("tag","tag",t("tags")),this._getMetaDataUpdates("mark","marker",t("markers")),this._prepareActivity("update","comment",t("text")))},n.methods._prepareActivity=function(e,t,n){return n?{object:{objectTypes:["http://activitystrea.ms/schema/1.0/"+t],content:n},source:this.component.config.get("source"),verbs:["http://activitystrea.ms/schema/1.0/"+e],targets:[{id:this.component.get("data.object.id")}]}:[]},n.methods._getMetaDataUpdates=function(e,n,r){var i=this,s=this.component,o=function(e){return t.map(e||[],function(e){return t.trim(e)})},u={modified:o(r.split(",")),current:o(s.get("data.object."+n+"s"))},a=[],f=function(e,r,s){t.map(e,function(e){e&&!~t.inArray(e,r)&&a.push(i._prepareActivity(s,n,e))})};return f(u.current,u.modified,"un"+e),f(u.modified,u.current,e),a},n.css=".{plugin.class:cancelButtonContainer} { float: right; margin: 6px 15px 0px 0px; }",Echo.Plugin.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this,r=this.component;this.extendTemplate("insertAsLastChild","content",n.templates.form);var i=Echo.Utils.get(Echo.Variables,this._getSubmitKey());t.each(i||{},function(t,n){e.set(t,n)}),r.addButtonSpec("Reply",this._assembleButton()),this.set("documentClickHandler",this._getClickHandler()),t(document).on("click",this.get("documentClickHandler"))},n.config={actionString:"Write a reply..."},n.labels={replyControl:"Reply"},n.dependencies=[{control:"Echo.StreamServer.Controls.Submit",url:"{config:cdnBaseURL.sdk}/streamserver.pack.js"}],n.events={"Echo.StreamServer.Controls.Stream.Plugins.Reply.onFormExpand":function(e,t){var n=this.component,r=n.config.get("context");this.get("expanded")&&r&&r!==t.context&&this._hideSubmit()},"Echo.StreamServer.Controls.Submit.onPostComplete":function(e,t){this._hideSubmit()},"Echo.StreamServer.Controls.Stream.Item.onRender":function(e,t){this.get("expanded")&&this._showSubmit()}},n.templates.form='<div class="{plugin.class:replyForm}"><div class="{plugin.class:submitForm}"></div><div class="{plugin.class:compactForm}"><div class="{plugin.class:compactContent} {plugin.class:compactBorder}"><input type="text" class="{plugin.class:compactField} echo-primaryFont echo-secondaryColor"></div></div></div>',n.component.renderers.container=function(e){var t=this.component,n=t.threading;return this.get("expanded")&&(t.threading=!0),t.parentRenderer("container",arguments),t.threading=n,e},n.component.renderers.children=function(e){var t=this.component;if(t.get("children").length===1){var n=t.get("children")[0];if(n.get("added")||n.get("deleted"))this._itemCSS("remove",t,this.view.get("compactForm")),this.view.render({name:"compactForm"})}return t.parentRenderer("children",arguments)},n.renderers.submitForm=function(e){return e.click(function(e){e.stopPropagation()}),this.get("expanded")?e.show():e.empty().hide()},n.renderers.compactForm=function(e){var t=this.component,n=!!t.children.length;return!t.get("depth")&&n&&!this.get("expanded")&&!t.get("children")[0].get("deleted")?(this._itemCSS("add",t,e),e.show()):(this._itemCSS("remove",t,this.view.get("compactForm")),e.hide())},n.renderers.compactField=function(e){var t=this,n=this.component;return e.focus(function(){t._showSubmit()}).val(this.config.get("actionString"))},n.methods.destroy=function(){this.get("submit")&&Echo.Utils.set(Echo.Variables,this._getSubmitKey(),{expanded:this.get("expanded"),data:{object:this._getSubmitData()}}),t(document).off("click",this.get("documentClickHandler"))},n.methods._submitConfig=function(e){var t=this,n=this.component;return t.config.assemble({target:e,targetURL:n.get("data.object.id"),parent:n.config.getAsHash(),data:t.get("data")||{},targetQuery:n.config.get("query",""),ready:function(){t.set("submit",this),t._expand()}})},n.methods._showSubmit=function(){var e=this.component,t=this.view.get("submitForm");this._itemCSS("add",e,this.view.get("submitForm"));var n=this.get("submit");if(n)return n.config.set("target",t),n.render(),this._expand(),t;var r=this._submitConfig(t);return r.plugins.push({name:"Reply",inReplyTo:e.get("data")}),new Echo.StreamServer.Controls.Submit(r),t},n.methods._hideSubmit=function(){var e=this.component,t=this.get("submit");t&&t.set("data",undefined),this.set("expanded",!1),this._itemCSS("remove",e,this.view.get("submitForm")),this.view.get("submitForm").empty(),this.view.render({name:"compactForm"}),e.view.render({name:"container"}),this.events.publish({topic:"onCollapse"})},n.methods._expand=function(){var e=this.component;this.set("expanded",!0),this.view.render({name:"submitForm"}),this.view.render({name:"compactForm"}),this.events.publish({topic:"onExpand",data:{context:e.config.get("context")}}),e.view.render({name:"container"})},n.methods._getClickHandler=function(){var e=this;return function(){var t=e.get("submit");e.get("expanded")&&t&&!t.view.get("text").val()&&e._hideSubmit()}},n.methods._assembleButton=function(){var e=this,t=this.component,n=function(){e._showSubmit()};return function(){var t=this;return{name:"Reply",label:e.labels.get("replyControl"),visible:t.get("depth")<t.config.get("parent.children.maxDepth"),callback:n}}},n.methods._itemCSS=function(e,n,r){t.each(["container","container-child","depth-"+(n.get("depth")+1)],function(t,i){r[e+"Class"](n.get("cssPrefix")+i)}),r[e+"Class"]("echo-trinaryBackgroundColor")},n.methods._getSubmitKey=function(){var e=this.component,t=e.config.get("context").split("/")[0];return"forms."+e.data.unique+"-"+t},n.methods._getSubmitData=function(){var e={},n=this.get("submit");return e.content=n.view.get("text").val(),t.map(["tags","markers"],function(t){var r=n.view.get(t).val().split(", ");e[t]=r||[]}),e},n.css=".{plugin.class:compactContent} { padding: 5px 5px 5px 6px; background-color: #fff; }.{plugin.class:compactBorder} { border: 1px solid #d2d2d2; }.{plugin.class:compactContent} input.{plugin.class:compactField}[type='text'].echo-secondaryColor { color: #C6C6C6 }.{plugin.class:compactContent} input.{plugin.class:compactField}[type='text'].echo-primaryFont { font-size: 12px; line-height: 16px; }.{plugin.class:compactContent} input.{plugin.class:compactField}[type='text'] { width: 100%; height: 16px; border: none; margin: 0px; padding: 0px; box-shadow: none; vertical-align: middle; }.{plugin.class:compactContent} input.{plugin.class:compactField}[type='text']:focus { outline: 0; box-shadow: none; }",Echo.Plugin.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(n))return;n.events={"Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onExpand":function(e,t){this.events.publish({topic:"onFormExpand",data:{context:t.context}})}},Echo.Plugin.create(n)}(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this,t=e.component,n=t._prepareEventParams;t._prepareEventParams=function(r){var i=n.call(t,r);return i.inReplyTo=e.config.get("inReplyTo"),i}},t.map(["onRender","onRerender"],function(e){n.events["Echo.StreamServer.Controls.Submit."+e]=function(){var e=this.component;e.config.get("target").show(),e.view.get("text").focus()}}),Echo.Plugin.create(n)}(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("ItemAccumulatorDisplay","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertBefore","modeSwitch",n.templates.main)},n.config={countTickTimeout:1,accumulator:"repliesCount"},n.templates.main='<div class="{plugin.class:accumulatorContainer}"></div>',n.renderers.accumulatorContainer=function(e){var t=this.component,n=this.config.get("accumulator"),r=t.get("data.object.accumulators")[n],i=this.get("count")||{};if(typeof i.current=="undefined")return this.set("count",{actual:r,current:r}),e.append(r);this._stopTimer();var s=t.view.get("container");s.stop(!0,!0),i.actual!==r&&(i.actual=r,this.set("count",i)),e.append(i.current);if(i.current!==i.actual){var o=this.get("originalBGColor");typeof o=="undefined"&&(o=Echo.Utils.getVisibleColor(s),this.set("originalBGColor",o)),s.css({backgroundColor:t.config.get("parent.flashColor")}),this._animateCounter(o)}return e},n.methods._stopTimer=function(){var e=this.get("timer");e&&clearTimeout(e),this.set("timer",undefined)},n.methods._animateCounter=function(e){this._stopTimer();var t=this,n=this.get("count"),r=this.component;if(typeof n.current!="undefined"&&n.current===n.actual&&!this.get("animationInProgress")){var i=r.view.get("container");this.set("animationInProgress",!0),i.animate({backgroundColor:e},r.config.get("parent.fadeTimeout"),"linear",function(){i.css("backgroundColor",""),t.set("animationInProgress",!1)});return}this.set("timer",setTimeout(function(){var n=t.get("count");n.current!==n.actual&&(n.current<n.actual?n.current++:n.current--,t.set("count.current",n.current),t.view.get("accumulatorContainer").html(n.current),t._animateCounter(e))},this.config.get("countTickTimeout")*1e3))},n.css=".{plugin.class:accumulatorContainer} { float: right; margin-right: 7px; }",Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("CommunityFlag","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.extendTemplate("insertAsLastChild","data",n.templates.main),this.component.addButtonSpec("CommunityFlag",this._assembleButton("Flag")),this.component.addButtonSpec("CommunityFlag",this._assembleButton("Unflag"))},n.config={showUserList:!0},n.labels={flagged:"Flagged",flaggedThis:" flagged this.",flagControl:"Flag",unflagControl:"Unflag",flagProcessing:"Flagging...",unflagProcessing:"Unflagging..."},n.dependencies=[{control:"Echo.StreamServer.Controls.FacePile",url:"{config:cdnBaseURL.sdk}/streamserver.pack.js"}],n.templates.main='<div class="{plugin.class:flaggedBy}"></div>',n.renderers.flaggedBy=function(e){var t=this,n=this.component,r=n.get("data.object.flags",[]);if(!r.length||!n.user.is("admin")||!t.config.get("showUserList"))return e.hide();var i=5,s=t.get("facepile")?t.get("facepile").getVisibleUsersCount():i,o=t.config.assemble({target:e,data:{entries:r,itemsPerPage:i},initialUsersCount:s,suffixText:t.labels.get("flaggedThis")});return t.set("facepile",new Echo.StreamServer.Controls.FacePile(o)),e.show()},n.methods._assembleButton=function(e){var t=this,n=this.component,r=function(){var n=this;n.get("buttons."+t.name+"."+e+".element").empty().append(t.labels.get(e.toLowerCase()+"Processing"));var r={verbs:["http://activitystrea.ms/schema/1.0/"+e.toLowerCase()],targets:[{id:n.get("data.object.id")}]},i=Echo.StreamServer.API.request({endpoint:"submit",secure:t.config.get("useSecureAPI",!1,!0),submissionProxyURL:t.config.get("submissionProxyURL","",!0),data:{content:r,appkey:n.config.get("appkey"),sessionID:n.user.get("sessionID"),"target-query":n.config.get("parent.query")},onData:function(r){t._publishEventComplete({name:e,state:"Complete",response:r}),e==="Flag"&&!n.config.get("parent.showFlags")&&(t.set("flagged",!0),n.view.render({name:"buttons"})),t.requestDataRefresh()},onError:function(r){t._publishEventComplete({name:e,state:"Error",response:r}),n.render()}});i.send()};return function(){var n=this,i=n.get("data.object.flags"),s=t.labels.get(e.toLowerCase()+"Control"),o=t._myFlags(i).length>0?"Unflag":"Flag",u=e==="Flag"&&!n.config.get("parent.showFlags")&&t.get("flagged"),a={name:e,label:u?t.labels.get("flagged"):'<span class="echo-clickable">'+s+"</span>"+(n.user.is("admin")&&i.length?" ("+i.length+")":""),visible:n.user.is("logged")&&o===e,clickable:!u,once:!0,callback:r};return u&&(a.template="<span>{data:label}</span>"),a}},n.methods._publishEventComplete=function(e){var t=this.component;this.events.publish({topic:"on"+e.name+e.state,data:{item:{data:t.get("data"),target:t.config.get("target")},response:e.response}})},n.methods._myFlags=function(e){var n=this.component;return t.map(e,function(e){if(n.user.has("identity",e.actor.id))return e})},n.css=".{plugin.class:flaggedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/curation/status/communityflagged.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }",Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("FormAuth","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){this._userStatus()==="forcedLogin"&&this.extendTemplate("replace","header",n.templates.forcedLogin),this.extendTemplate("insertBefore","header",n.templates.auth),this.component.addPostValidator(this._validator())},n.config={identityManager:{},submitPermissions:"allowGuest"},n.enabled=function(){return this.component.user&&this.component.user.get("sessionID")&&this.config.get("identityManager.login")&&this.config.get("identityManager.signup")},n.labels={youMustBeLoggedIn:"You must be logged in to comment"},n.dependencies=[{control:"Echo.IdentityServer.Controls.Auth",url:"{config:cdnBaseURL.sdk}/identityserver.pack.js"}],n.templates.auth='<div class="{plugin.class:auth}"></div>',n.templates.forcedLogin='<div class="{class:header} echo-primaryFont"><span class="{plugin.class:forcedLoginMessage} echo-secondaryColor">{plugin.label:youMustBeLoggedIn}</span></div>',n.component.renderers.header=function(e){var t=this;return t._userStatus()==="logged"?e.empty():t.parentRenderer("header",arguments)},n.component.renderers.container=function(e){var n=this;n.parentRenderer("container",arguments);var r=function(e){return n.cssPrefix+e};return e.removeClass(t.map(["logged","anonymous","forcedLogin"],r).join(" ")).addClass(r(n._userStatus()))},n.renderers.auth=function(e){var t=this;return new Echo.IdentityServer.Controls.Auth(t.config.assemble({target:e,identityManager:t.config.get("identityManager")})),e},n.methods._validator=function(){var e=this,t=this.component;return function(){return!t.user.is("logged")&&e._permissions()==="forceLogin"?(e.view.get("forcedLoginMessage").addClass(e.cssPrefix+"error"),!1):!0}},n.methods._permissions=function(){return this.config.get("submitPermissions")},n.methods._userStatus=function(){return this.component.user.is("logged")?"logged":this._permissions()==="forceLogin"?"forcedLogin":"anonymous"},n.css=".{plugin.class:forcedLoginMessage} { font-size: 14px; font-weight: bold; }.{plugin.class:error} { color: red; }",Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("MetadataManager","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this,n=this.component;t.each(this.config.get("controls"),function(t,r){n.addButtonSpec("MetadataManager",e._assembleButton("Mark",r)),n.addButtonSpec("MetadataManager",e._assembleButton("Unmark",r))})},n.labels={markProcessing:"Adding {type} {marker}...",unmarkProcessing:"Removing {type} {marker}..."},n.methods._assembleButton=function(e,t){var r=this,i=t.marker?"marker":"tag",s=t.marker||t.tag,o=e+"As"+Echo.Utils.capitalize(s.replace(/[^a-z0-9_-]/ig,"")),u=function(){var t=this,u=e.toLowerCase();t.get("buttons."+n.name+"."+o+".element").empty().append(r.labels.get(u+"Processing",{type:i,marker:s}));var a=i==="tag"?u.replace(/mark/g,"tag"):u,f={verbs:["http://activitystrea.ms/schema/1.0/"+a],targets:[{id:t.get("data.object.id")}],object:{objectTypes:["http://activitystrea.ms/schema/1.0/"+i],content:s}},l=r._prepareCompleteEventPublish({name:o,type:i,action:e});Echo.StreamServer.API.request({endpoint:"submit",secure:this.config.get("useSecureAPI",!1,!0),submissionProxyURL:t.config.get("submissionProxyURL"),onData:function(e){l("Complete",e),r.requestDataRefresh()},onError:function(e){l("Error",e)},data:{appkey:t.config.get("appkey"),content:f,"target-query":t.config.get("parent.query",""),sessionID:t.user.get("sessionID","")}}).send()};return function(){var n=this;return{name:o,label:t["label"+e],visible:r._isButtonVisible(t,s,e,i),once:!0,callback:u}}},n.methods._prepareCompleteEventPublish=function(e){var n=this,r=this.component,i={data:{item:{data:r.get("data"),target:r.get("view.content")},type:e.type,name:e.name}};return function(r,s){n.events.publish(t.extend(!0,i,{topic:"on"+e.action+r,data:{response:s}}))}},n.methods._isButtonVisible=function(e,n,r,i){var s=this.component,o=!~t.inArray(n,s.get("data.object."+i+"s")||[])^r==="Unmark";if(!o||!s.user.is("logged"))return!1;if(s.user.is("admin"))return!0;var u=s.config.get("submissionProxyURL");if(i==="marker"&&!u)return!1;e.visible=s.invoke(e.visible);if(t.isEmptyObject(e.visible))return!1;var a=!0;return t.each(["state","roles","markers"],function(t,n){var r=e.visible["user."+n];if(r){r=typeof r=="string"?[r]:r;if(!s.user.any(n,r))return a=!1,!1}}),!!a},Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("TweetDisplay","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this.component,r=e.config.get("contentTransformations");t.map(["text","html","xhtml"],function(e){r[e].hashtags=!1}),e.config.set("contentTransformations",r),e.config.set("plugins.Like.enabled",!1),e.config.set("plugins.Reply.enabled",!1),e.config.set("viaLabel.icon",!0),this.extendTemplate("insertBefore","authorName",n.templates.date),this.extendTemplate("insertAfter","authorName",n.templates.username),e.addButtonSpec(this.name,this._assembleButton("tweet")),e.addButtonSpec(this.name,this._assembleButton("retweet")),e.addButtonSpec(this.name,this._assembleButton("favorite"))},n.labels={tweet:"Reply",retweet:"Retweet",favorite:"Favorite",comment:"Comment",secondsAgo:"{seconds}s",minutesAgo:"{minutes}m",hoursAgo:"{hours}h",monthsAgo:"{day} {month}",yearsAgo:"{day} {month} {year}",fullDate:"{time} - {date}",month1:"Jan",month2:"Feb",month3:"Mar",month4:"Apr",month5:"May",month6:"Jun",month7:"Jul",month8:"Aug",month9:"Sep",month10:"Oct",month11:"Nov",month12:"Dec"},n.dependencies=[{loaded:function(){return!!window.twttr},url:"http://platform.twitter.com/widgets.js"}],n.enabled=function(){return this._isTweet()},n.events={"Echo.StreamServer.Controls.Stream.Item.onRender":function(e,n){var r=this.cssPrefix+"activeButton",i=this.component;t.map(i.buttons[this.name],function(e){e.element.unbind("click").unbind("mouseover mouseout").hover(function(){e.element.addClass(r)},function(){e.element.removeClass(r)})}),window.twttr&&window.twttr.widgets&&window.twttr.widgets.load()}},n.templates={username:'<div class="{plugin.class:tweetUserName}"></div>',date:'<div class="{plugin.class:tweetDate} echo-secondaryFont"></div>'},n.component.renderers.authorName=function(e){var t=this.component;return t.parentRenderer("authorName",arguments).removeClass("echo-linkColor").addClass(this.cssPrefix+"tweetScreenName").wrapInner(Echo.Utils.hyperlink({href:t.get("data.actor.id")},{openInNewWindow:t.config.get("openLinksInNewWindow"),skipEscaping:!0}))},n.component.renderers.avatar=function(e){var t=this.component;return t.parentRenderer("avatar",arguments).wrap(Echo.Utils.hyperlink({href:t.get("data.actor.id")},{openInNewWindow:t.config.get("openLinksInNewWindow"),skipEscaping:!0}))},n.component.renderers.date=function(e){var t=this.component;return this.view.render({name:"tweetDate"}),t.parentRenderer("date",arguments)},n.component.renderers._buttonsDelimiter=function(e){var t=this.component,n=t.buttonSpecs[this.name].length;return t.parentRenderer("_buttonsDelimiter",arguments).find("span[class*='button-delim']").eq(n).text(" | ")},n.renderers.tweetUserName=function(e){var t=this.component;return e.html(Echo.Utils.hyperlink({href:t.get("data.actor.id"),caption:"@"+this._extractTwitterID(),"class":"echo-secondaryFont echo-secondaryColor"},{openInNewWindow:t.config.get("openLinksInNewWindow"),skipEscaping:!0}))},n.renderers.tweetDate=function(e){var t=this.component;return e.html(Echo.Utils.hyperlink({caption:this._getTweetTime(),href:t.get("data.object.id"),"class":"echo-secondaryFont echo-secondaryColor",title:this._getTweetTime(!0)},{openInNewWindow:t.config.get("openLinksInNewWindow"),skipEscaping:!0}))},n.methods._assembleButton=function(e){var t=this,n=this.component,r=n.get("data.object.id").match(/\/(\d+)$/),i=r&&r[1];return function(){return{name:e,label:t.labels.get(e),template:Echo.Utils.hyperlink({href:"https://twitter.com/intent/"+e+"?in_reply_to="+i+"&tweet_id="+i,"class":"echo-clickable "+t.cssPrefix+"intentControl echo-secondaryColor",caption:'<span class="'+t.cssPrefix+"icon "+t.cssPrefix+'icon-{data:name}">&nbsp;</span>'+"<span>{data:label}</span>"},{openInNewWindow:n.config.get("openLinksInNewWindow"),skipEscaping:!0}),visible:i&&t._isTweet()}}},n.methods._isTweet=function(){var e=this.component;return e.get("data.source.name")==="Twitter"},n.methods._getTweetTime=function(e){var t=this.component,n=new Date(t.timestamp*1e3),r=(new Date).getTime(),i=Math.floor((r-n.getTime())/1e3),s;return e?s=this.labels.get("fullDate",{time:n.toLocaleTimeString(),date:n.toLocaleDateString()}):i<60?s=this.labels.get("secondsAgo",{seconds:i}):i<3600?s=this.labels.get("minutesAgo",{minutes:Math.floor(i/60)}):i<86400?s=this.labels.get("hoursAgo",{hours:Math.floor(i/3600)}):i<31536e3?s=this.labels.get("monthsAgo",{day:n.getDate(),month:this.labels.get("month"+(n.getMonth()+1))}):s=this.labels.get("yearsAgo",{day:n.getDate(),month:this.labels.get("month"+(n.getMonth()+1)),year:n.getFullYear()}),s},n.methods._extractTwitterID=function(){var e=this.component,t=e.get("data.actor.id").match(/twitter.com\/(.*)/);return t?t[1]:e.get("data.actor.id")},n.css=".{plugin.class} .{class:avatar} a img { border: 0px; }.{plugin.class} .{class:date} { display: none; }.{plugin.class} .{class:buttons} .{class:button-delim}:first-child { display: none; }.{plugin.class} .{class:data} a { text-decoration: none; }.{plugin.class} .{class:data} a:hover { text-decoration: underline; }.{plugin.class} .{class:footer} { padding-top: 5px; }.{plugin.class} .{class:modeSwitch} { margin-left: 6px; }.{plugin.class:userName} { float: left; font-size: 15px; font-weight: bold; }.{plugin.css:screenName} { margin-left: 4px; font-size: 11px; font-weight: normal; padding-top: 1px; }.{plugin.class:userName} a, .{plugin.class:tweetUserName} a, .{plugin.class:intentControl} { text-decoration: none; }.{plugin.class:icon} { width: 15px; height: 15px; display: inline-block; margin-right: 3px; background: url(https://si0.twimg.com/images/dev/cms/intents/icons/sprites/everything-spritev2.png) no-repeat; }.{plugin.class:icon-tweet} { background-position: 0px -2px; }.{plugin.class:icon-retweet} { background-position: -80px -2px; }.{plugin.class:icon-favorite} { background-position: -32px -2px; }.{plugin.class:activeButton} .{plugin.class:icon-tweet} { background-position: -16px -2px; }.{plugin.class:activeButton} .{plugin.class:icon-retweet} { background-position: -96px -2px; }.{plugin.class:activeButton} .{plugin.class:icon-favorite} { background-position: -48px -2px; }.{plugin.class:tweetUserName} { margin-left: 4px; font-size: 15px; float: left; }.{plugin.class:twitterIcon} { float: left; margin-right: 3px; }.{plugin.class:date} { text-decoration: none; color: #C6C6C6; }.{plugin.class:tweetScreenName} a { text-decoration: none; color: #333333; }.{plugin.class:tweetDate} a { text-decoration: none; }.{plugin.class:tweetDate} a:hover { text-decoration: underline;  }.{plugin.class:tweetDate} { float: right; }",Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("InfiniteScroll","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(n))return;n.init=function(){var e=this,n=function(n){var r=e.component.view.get("more");r&&!e.get("requestInProgress")&&t.inviewport(r,{threshold:0})&&(e.set("requestInProgress",!0),r.click())};e.set("scrollHandler",n),t(window).on("scroll",n)},n.events={"Echo.StreamServer.Controls.Stream.onDataReceive":function(e,t){this.set("requestInProgress",!1)}},n.methods.destroy=function(){t(window).off("scroll",this.get("scrollHandler"))},Echo.Plugin.create(n)})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Plugin.manifest("JanrainSharing","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(n))return;n.init=function(){!this._isLegacy()&&!this.config.get("alwaysShare")&&this.extendTemplate("insertBefore","postButton",n.templates.share)},n.config={appId:"",alwaysShare:!1,sharingWidgetConfig:{},maxLength:120,reducedLength:30,maxImagesCount:5},n.enabled=function(){return this.config.get("appId")},n.dependencies=[{loaded:function(){return!!Echo.GUI},url:"{config:cdnBaseURL.sdk}/gui.pack.js"},{url:"{config:cdnBaseURL.sdk}/gui.pack.css"}],n.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(e,t){if(this._isLegacy())return;this.set("needShare",this.config.get("alwaysShare")||this.view.get("shareCheckbox").prop("checked"))},"Echo.StreamServer.Controls.Submit.onPostComplete":function(e,t){var n=this;if(n._isLegacy()){this._shareLegacy(t);return}if(!this.get("needShare"))return;this._share(this._prepareData(t))}},n.labels={share:"Share this comment",sharePrompt:"Share your comment:"},n.templates.share='<div class="echo-secondaryFont {plugin.class:shareContainer}"><input type="checkbox" class="{plugin.class:shareCheckbox}"><span class="{plugin.class:shareLabel}">{plugin.label:share}</span></div>',n.methods._share=function(e){var n,r=this,i=function(){r.set("foreignConfig",t.extend(!0,{},janrain.engage.share.getState())),r._showPopup(e)};if(window.janrain&&janrain.engage&&janrain.engage.share||r.get("janrainInitialized")){i();return}r.set("janrainInitialized",!0),typeof window.janrain!="object"&&(window.janrain={}),typeof janrain.settings!="object"&&(janrain.settings={}),typeof janrain.settings.share!="object"&&(janrain.settings.share={}),typeof janrain.settings.packages!="object"&&(janrain.settings.packages=[]),janrain.settings.packages.push("share"),janrain.ready=!0;var s=window.janrainShareOnload;window.janrainShareOnload=function(){s&&(s(),window.janrainShareOnload=s),i()},n="https:"===document.location.protocol?"https://rpxnow.com/js/lib/"+r.config.get("appId")+"/widget.js":"http://widget-cdn.rpxnow.com/js/lib/"+r.config.get("appId")+"/widget.js",Echo.Loader.download([{url:n}])},n.methods._showPopup=function(e){var n,r=this,i=janrain.engage.share,s=janrain.events.onModalClose.addHandler(function(){janrain.events.onModalClose.removeHandler(s),i.reset(),i.setState(r.get("foreignConfig")),r.remove("foreignConfig")}),o=r.config.get("sharingWidgetConfig");i.reset(),i.setState(o),i.setTitle(o.title||t('meta[property="og:title"]').attr("content")||document.title),i.setDescription(o.description||t('meta[property="og:description"]').attr("content")||""),i.setMessage(o.message||Echo.Utils.stripTags(e.object.content)),i.setUrl(o.url||t('meta[property="og:url"]').attr("content")||location.href.replace(/([#\?][^#\?]*)+$/,"")),n=o.image||t('meta[property="og:image"]').attr("content")||"",n&&i.setImage(n),i.show()},n.methods._prepareData=function(e){var t=e.postData.content[0];return{origin:"submit",actor:{id:this.component.user.get("identityUrl"),name:t.actor.name,avatar:t.actor.avatar},object:{id:e.request.response.objectID,content:t.object.content},source:t.source,target:e.targetURL}},n.methods._isLegacy=function(){return this.config.get("xdReceiver")},n.methods._shareLegacy=function(e){var t=this;Echo.Loader.download([{loaded:function(){return!!window.RPXNOW},url:("https:"===document.location.protocol?"https://":"http://static.")+"rpxnow.com/js/lib/rpx.js"}],function(){RPXNOW.init({appId:t.config.get("appId"),xdReceiver:t.config.get("xdReceiver")}),RPXNOW.loadAndRun(["Social"],function(){var n=new RPXNOW.Social.Activity(t.config.get("activity.sharePrompt",t.labels.get("sharePrompt")),t._prepareContentLegacy(e),t.config.get("activity.itemURL",e.targetURL));RPXNOW.Social.publishActivity(t._prepareActivityLegacy(n))})})},n.methods._prepareActivityLegacy=function(e){var n=this,r=e,i={"activity.pageDescription":function(e){r.setDescription(e)},"activity.pageTitle":function(e){r.setTitle(e)},"activity.pageImages":function(e){var i=0,s=n.config.get("maxImagesCount"),o=new RPXNOW.Social.ImageMediaCollection;t.each(e,function(e,t){if(i===s)return!1;t.src&&t.href&&(o.addImage(t.src,t.href),i++)}),r.setMediaItem(o)}};return t.each(i,function(e,t){n.config.get(e)&&t(n.config.get(e))}),r},n.methods._prepareContentLegacy=function(e){var t=this,n=Echo.Utils.stripTags(e.postData.content[0].object.content),r=t.config.get("activity.shareContent");if(r)return t.labels.get(r,{domain:window.location.host,content:t._truncate(n,t.config.get("reducedLength"))});var i=e.inReplyTo,s=t.config.get("maxLength");if(t._isReplyToTweet(i)){var o=t._getTweetAuthor(i);return t.labels.get("@{author} {content}",{author:o,content:t._truncate(n,s-o.length-2)})}return t._truncate(n,s)},n.methods._truncate=function(e,t){return t>0&&e.length>t?e.substring(0,t)+"...":e},n.methods._isReplyToTweet=function(e){return!!e&&!!e.source&&e.source.name==="Twitter"},n.methods._getTweetAuthor=function(e){return e.actor.id.replace(/https?\:\/\/twitter\.com\//,"")},n.css=".{plugin.class:shareContainer} { display: inline-block; margin: 0px 15px 0px 0px; }.echo-sdk-ui .{plugin.class:shareContainer} input.{plugin.class:shareCheckbox} { margin: 0px; margin-right: 3px; padding: 0px; }",Echo.Plugin.create(n)})(Echo.jQuery),function(e){"use strict";var t=e,n=Echo.Plugin.manifest("JanrainSharing","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(n))return;n.init=function(){this.component.addButtonSpec("Share",this._assembleButton())},n.config={appId:"",sharingWidgetConfig:{}},n.enabled=function(){return this.config.get("appId")},n.dependencies=[{loaded:function(){return!!Echo.GUI},url:"{config:cdnBaseURL.sdk}/gui.pack.js"},{url:"{config:cdnBaseURL.sdk}/gui.pack.css"}],n.labels={shareButton:"Share"},n.methods._share=Echo.StreamServer.Controls.Submit.Plugins.JanrainSharing.prototype._share,n.methods._showPopup=Echo.StreamServer.Controls.Submit.Plugins.JanrainSharing.prototype._showPopup,n.methods._prepareData=function(e){return{origin:"item",actor:{id:e.actor.id,name:e.actor.title,avatar:e.actor.avatar},object:{id:e.object.id,content:e.object.content},source:e.source,target:e.target.id}},n.methods._assembleButton=function(){var e=this,t=this.component,n=function(){e._share(e._prepareData(t.get("data")))};return function(){var t=this;return{name:"Share",label:e.labels.get("shareButton"),callback:n}}},Echo.Plugin.create(n)}(Echo.jQuery);