/**
 * Copyright 2012-2013 Echo.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Version: 3.0.15 (2013-11-18 11:09:48 UTC)
 */

(function(e){"use strict";var t=e;window.Echo||(window.Echo={});if(Echo.Utils)return;Echo.Variables||(Echo.Variables={}),Echo.Utils={},Echo.Utils.cache={},Echo.Utils.regexps={templateSubstitution:"{([0-9a-z\\.]+)(?:\\:((?:[0-9a-z_-]+\\.)*[0-9a-z_-]+))?}",mobileUA:/mobile|midp-|opera mini|iphone|ipad|blackberry|nokia|samsung|docomo|symbian|windows ce|windows phone|android|up\.browser|ipod|netfront|skyfire|palm|webos|audiovox/i,w3cdtf:/^(\d{4})(?:-(\d\d)(?:-(\d\d))?(?:(?:T(\d\d):(\d\d):(\d\d))(?:\.(\d{1,3}))?(?:Z|(?:(\+|-)(\d\d):(\d\d))))?)?$/,parseURL:/^(?:(?:([^:\/\?#]+):)?\/\/)?([^:\/\?#]*)?(?::(\d+))?([^\?#]*)(?:\?([^#]*))?(?:#(.*))?/},Echo.Utils.addCSS=function(e,n){typeof this.cache.cssStyles=="undefined"&&(this.cache.cssStyles={anchor:undefined,index:1,processed:{}});var r=this.cache.cssStyles;if(n){if(Echo.Utils.hasCSS(n))return!1;r.processed[n]=!0}var i="",s=r.anchor;s&&s.length&&(i=s.html()),i.length+e.length>1e5&&(r.index++,s=null,i="");var o=t('<style id="echo-css-rules-'+r.index+'" type="text/css">'+i+e+"</style>");return s&&s.length?s.replaceWith(o):r.anchor?r.anchor.after(o):t(document.getElementsByTagName("head")[0]||document.documentElement).prepend(o),r.anchor=o,!0},Echo.Utils.hasCSS=function(e){return this.cache.cssStyles?!!this.cache.cssStyles.processed[e]:!1},Echo.Utils.foldl=function(e,n,r){var i;return t.each(n,function(t,n){i=r(n,e,t),i!==undefined&&(e=i)}),e},Echo.Utils.get=function(e,t,n,r){var i=Echo.Utils._prepareFieldAccessKey(t);if(!i||!e)return n;var s=!0,o=function(e,t){r&&r(t,e);if(typeof t[e]!="undefined")return t[e];s=!1},u=i.length===1?o(i.pop(),e):Echo.Utils.foldl(e,i,o);return s?u:n},Echo.Utils.remove=function(e,t){var n=Echo.Utils._prepareFieldAccessKey(t);if(!n||!e)return!1;var r=n.pop(),i=Echo.Utils.get(e,n,e);return i===null||typeof i[r]=="undefined"?!1:delete i[r]},Echo.Utils.set=function(e,t,n){var r=Echo.Utils._prepareFieldAccessKey(t);if(!r||!e)return!1;var i=r.pop(),s=e;return r.length>0&&(s=Echo.Utils.get(e,r,undefined,function(e,t){typeof e[t]=="undefined"&&(e[t]={})})),s[i]=n,!0},Echo.Utils._prepareFieldAccessKey=function(e){return e?typeof e=="string"?e.split("."):e instanceof Array&&e.length?e:!1:!1},Echo.Utils.htmlize=function(e){return typeof e=="string"?t("<div>").text(e).html():e},Echo.Utils.objectToJSON=function(e){if(window.JSON&&JSON.stringify)return JSON.stringify(e);var n,r=function(e){var t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return e.replace(/[\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff\\]/g,function(e){return t.hasOwnProperty(e)?t[e]:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})},i;switch(typeof e){case"number":i=isFinite(e)?e:"null";break;case"string":i='"'+r(e)+'"';break;case"boolean":i=e.toString();break;default:if(e instanceof Array)n=t.map(e,function(e){return Echo.Utils.objectToJSON(e)}),i="["+n.join(",")+"]";else if(e instanceof Object){var s=e.exportProperties||e;n=Echo.Utils.foldl([],s,function(t,n,r){s instanceof Array&&(r=t,t=e[r]),n.push('"'+r+'":'+Echo.Utils.objectToJSON(t))}),i="{"+n.join(",")+"}"}else i="null"}return i},Echo.Utils.htmlTextTruncate=function(e,t,n,r){if(!t||e.length<t)return e;var i=[],s=0,o=0,u=/(\w)+/,a=/^(\S)+;/;this.cache.standaloneTags||(this.cache.standaloneTags=Echo.Utils.foldl({},"br hr input img area param base link meta option".split(" "),function(e,t,n){t[e]=!0}));for(var f=0;f<e.length;f++){var l=e.charAt(f);if(l==="<"){var c=e.indexOf(">",f);if(c<0)return e;var h=e.substring(f+1,c),p="",d=!1;h.charAt(0)==="/"&&(d=!0,h=h.substring(1)),p=h.match(u)[0];if(d){var v=i.pop();if(!v||v!==p)return e}else this.cache.standaloneTags[p]||i.push(p);f=c}else if(l==="&"&&e.substring(f).match(a))f=e.indexOf(";",f),s++;else{if(s>=t){o=f;break}s++}}if(o||r){if(o){var m=e.substring(o-1,e.length-1).match(/^\w+/);m&&(o+=m[0].length-1),o!==e.length-1&&(e=e.substring(0,o)+(n||""))}for(var f=i.length-1;f>=0;f--)e+="</"+i[f]+">"}return e},Echo.Utils.stripTags=function(e){return typeof e=="string"?t("<div>").html(e).text():e},Echo.Utils.parseURL=function(e){typeof this.cache.parsedURLs=="undefined"&&(this.cache.parsedURLs={});var t=this.cache.parsedURLs;if(!t.hasOwnProperty(e)){var n=e.match(Echo.Utils.regexps.parseURL);t[e]=n?{scheme:n[1]||"",domain:n[2]||"",port:n[3]||"",path:n[4]||"/",query:n[5]||"",fragment:n[6]||""}:undefined}return t[e]},Echo.Utils.getVisibleColor=function(e){var n;do{n=e.css("backgroundColor");if(n!==""&&n!=="transparent"&&!/rgba\((0,\s*){3}0\)/.test(n)||t.nodeName(e.get(0),"body"))break}while(e=e.parent());return n||"transparent"},Echo.Utils.timestampFromW3CDTF=function(e){var t=Date.parse(e);if(isNaN(t)){var n=["year","month","day","hours","minutes","seconds","milliseconds"],r=e.match(Echo.Utils.regexps.w3cdtf);if(!r)return undefined;var i=Echo.Utils.foldl({},n,function(e,t,n){t[e]=+r[n+1]||0}),s=r.slice(n.length+1);return s[0]&&(i.hours=i.hours-(s[0]+s[1]),i.minutes=i.minutes-(s[0]+s[2])),t=Date.UTC(i.year,i.month?i.month-1:i.month,i.day||1,i.hours,i.minutes,i.seconds,i.milliseconds),isNaN(t)?undefined:t/1e3}return t/1e3},Echo.Utils.isMobileDevice=function(){return typeof this.cache.isMobileDevice=="undefined"&&(this.cache.isMobileDevice=this.regexps.mobileUA.test(navigator.userAgent)),this.cache.isMobileDevice},Echo.Utils.getUniqueString=function(){return(new Date).valueOf()+Math.random().toString().substr(2)},Echo.Utils.inherit=function(e,t){var n=function(){};return t=t||function(){},n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.parent=e.prototype,t},Echo.Utils.getComponent=function(e){return Echo.Utils.get(window,e)},Echo.Utils.isComponentDefined=function(e){return!!Echo.Utils.getComponent(e)},Echo.Utils.loadImage=function(e){var n=e.image||e.defaultImage,r=t("<img>");return r.one({error:e.onerror||function(){e.defaultImage&&n!==e.defaultImage&&r.attr("src",e.defaultImage)},load:e.onload||t.noop}),r.attr("src",n)},Echo.Utils.hyperlink=function(e,n){e=t.extend({},e),n=t.extend({},n);var r=e.caption||"";delete e.caption,n.openInNewWindow&&!e.target&&(e.target="_blank"),n.skipEscaping||(e.href=Echo.Utils.htmlize(e.href)),e.href=e.href||"javascript:void(0)";var i=Echo.Utils.foldl([],e,function(e,t,n){t.push(n+'="'+e+'"')});return"<a "+i.join(" ")+">"+r+"</a>"},Echo.Utils.log=function(e){if(!(window.console&&console.log&&e&&e.message))return;console.log("["+(e.component||"Echo SDK")+"]",e.type||"info",":",e.message," | args: ",e.args)},Echo.Utils.parallelCall=function(e,n){if(!e||!e.length){n&&n();return}var r=e.length;t.map(e,function(e){e(function(){--r||n&&n()})})},Echo.Utils.sequentialCall=function(e,t){if(!e||!e.length){t&&t();return}e.shift()(function(){Echo.Utils.sequentialCall(e,t)})},Echo.Utils.capitalize=function(e){return e.replace(/\b[a-z]/g,function(e){return e.toUpperCase()})},Echo.Utils.substitute=function(e){var n=this,r=e.template,i={data:function(t,r){return n.get(e.data,t,r)}},s=e.instructions?t.extend(i,e.instructions):i;if(typeof n.cache.regexps=="undefined"){var o=n.regexps.templateSubstitution;n.cache.regexps={strict:new RegExp("^"+o+"$","i"),single:new RegExp(o,"i"),multiple:new RegExp(o,"ig")}}if(e.strict&&n.cache.regexps.strict.test(r)){var u=n.cache.regexps.single.exec(r);if(u&&u[1]&&s[u[1]])return s[u[1]](u[2])}return r.replace(n.cache.regexps.multiple,function(e,t,n){if(!s[t])return e;var r=s[t](n,""),i={number:!0,string:!0,"boolean":!0};return i[typeof r]?r:""})},Echo.Utils.invoke=function(e,n){return t.isFunction(e)?n?e.call(n):e():e},Echo.Utils.safelyExecute=function(e,n,r){r=r||null,n=t.isArray(n)?n:typeof n=="undefined"?[]:[n];try{return e.apply(r,n)}catch(i){Echo.Utils.log({type:"error",message:i.message||i,component:r instanceof Echo.Control?r.name:""})}},Echo.Utils.random=function(e,t){return e+Math.floor(Math.random()*(t-e+1))},document.compatMode==="BackCompat"&&Echo.Utils.log({type:"error",message:"Quirks mode is not supported by JS SDK. Please make sure that the page has a valid doctype."})})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.Events"))return;Echo.Events={},Echo.Events.subscribe=function(e){var t=Echo.Utils.getUniqueString(),n=i(e.topic,e.context);if(e.once){var o=e.handler;e.handler=function(){Echo.Events.unsubscribe({handlerId:t}),o.apply(this,arguments)}}return s(e.topic,n,function(n,r){n[r].handlers.push({id:t,handler:e.handler})}),r[t]={context:n,topic:e.topic},t},Echo.Events.unsubscribe=function(e){var n=!1;if(e.handlerId){if(!r[e.handlerId])return!1;e.topic=r[e.handlerId].topic,e.context=r[e.handlerId].context}else e.context=i(e.topic,e.context);if(e.handlerId||e.topic)var o=s(e.topic,e.context,function(i,s){e.handlerId?t.each(i[s].handlers,function(t,o){if(o.id===e.handlerId)return i[s].handlers.splice(t,1),delete r[o.id],n=!0,!1}):(t.each(i[s].handlers,function(e,t){delete r[t.id]}),delete i[s],n=!0)});else t.each(Echo.Events._subscriptions,function(i,o){s(i,e.context,function(e,i){t.each(e[i].handlers,function(e,t){delete r[t.id]}),delete e[i],n=!0})});return n},Echo.Events.publish=function(e){e=t.extend({bubble:!0,propagation:!0,global:!0},e),delete n[e.topic],e.context=i(e.topic,e.context),s(e.topic,e.context,function(t,n,r){u(t[n],e,r)}),e.global&&e.context!=="global"&&(e.context="global",Echo.Events.publish(e))},Echo.Events.newContextId=function(e){return(e?e+"/":"")+Echo.Utils.getUniqueString()};var n={},r={};Echo.Events._subscriptions={};var i=function(e,n){n=n||"global";if(e){var r=Echo.Events._subscriptions[e]=Echo.Events._subscriptions[e]||{};t.each(n.split("/"),function(e,t){r[t]||(r[t]={contexts:{},handlers:[]}),r=r[t].contexts})}return n},s=function(e,n,r){var i=n.split("/"),s=i.pop(),o=Echo.Events._subscriptions[e];t.each(i,function(e,t){o=o[t].contexts}),o[s]&&r(o,s,i)},o=function(e,r){var i=n[r]&&n[r].stop;return i?e==="bubble"?~t.inArray("bubble",i):~t.inArray("propagation",i)||~t.inArray(e,i):!1},u=function(e,r,i){var s,a=(e.handlers||[]).slice(0);t.each(a,function(e,t){n[r.topic]=t.handler(r.topic,r.data);if(o("propagation.siblings",r.topic))return!1}),r.bubble&&i.length&&!o("bubble",r.topic)&&(s=t.extend({},r),s.context=i.join("/"),s.global=!1,s.propagation=!1,Echo.Events.publish(s)),r.propagation&&!o("propagation.children",r.topic)&&(s=t.extend({},r),s.global=!1,s.bubble=!1,t.each(e.contexts,function(e,t){u(t,s,[]);if(o("propagation.siblings",s.topic))return!1}))}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.Labels"))return;Echo.Labels=function(e,n){var r=this;this.storage={},this.namespace=n,t.each(e,function(e,t){r.storage[Echo.Labels._key(e,r.namespace)]=t})},Echo.Labels.prototype.get=function(e,t){var n=Echo.Labels._key(e,this.namespace);return this.storage[n]?Echo.Labels._substitute(this.storage[n],t):Echo.Labels.get(e,this.namespace,t)},Echo.Labels.prototype.set=function(e){var n=this;t.each(e,function(e,t){var r=Echo.Labels._key(e,n.namespace);n.storage[r]=t})},Echo.Labels.set=function(e,n,r){t.each(e,function(e,t){var i=Echo.Labels._key(e,n);Echo.Labels._storage[r?"general":"custom"][i]=t})},Echo.Labels.get=function(e,t,n){var r=Echo.Labels._key(e,t),i=Echo.Labels._storage.custom[r]||Echo.Labels._storage.general[r]||e;return Echo.Labels._substitute(i,n)},Echo.Labels._storage={general:{},custom:{}},Echo.Labels._key=function(e,t){return(t?t+".":"")+e},Echo.Labels._substitute=function(e,n){return t.each(n||{},function(t,n){e=e.replace(new RegExp("{"+t+"}","g"),n)}),e}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.Configuration"))return;Echo.Configuration=function(e,n,r,i){this.data={},this.cache={},this.normalize=r||function(e,t){return t},t.each(this._merge(e,n,i),t.proxy(this._set,this))},Echo.Configuration.prototype.get=function(e,t){return typeof e!="string"&&(e=e.join(".")),this.cache.hasOwnProperty(e)||(this.cache[e]=Echo.Utils.get(this.data,e)),typeof this.cache[e]=="undefined"?t:this.cache[e]},Echo.Configuration.prototype.set=function(e,t){delete this.cache[e],typeof t=="object"&&this._clearCacheByPrefix(e),this._set(e,t)},Echo.Configuration.prototype.remove=function(e){var t=e.split("."),n=t.pop(),r=Echo.Utils.get(this.data,t,this.data);Echo.Utils.set(this.cache,e,undefined),delete this.cache[e],delete r[n]},Echo.Configuration.prototype.extend=function(e){t.each(e,t.proxy(this.set,this))},Echo.Configuration.prototype.getAsHash=function(){return t.extend({},this.data)},Echo.Configuration.prototype._set=function(e,t){Echo.Utils.set(this.data,e,this.normalize(e.split(".").pop(),t))},Echo.Configuration.prototype._clearCacheByPrefix=function(e){var n=this;e+=".",t.each(this.cache,function(t,r){t.indexOf(e)||delete n.cache[t]})},Echo.Configuration.prototype._merge=function(e,n,r){var i=this,s,o,u,a=[e,n];for(var f=0;f<a.length;f++)u=a[f],t.isPlainObject(u)?(s=s||{},t.each(u,function(e,n){o=s[e],r&&r[e]?s.hasOwnProperty(e)||(s[e]=n):t.isPlainObject(o)?s[e]=i._merge(o,n):s.hasOwnProperty(e)||(s[e]=i._merge(n))})):t.isArray(u)?s=t.map(u,function(e){return i._merge(e)}):typeof s=="undefined"&&typeof u!="undefined"&&(s=u);return s}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.API&&Echo.API.Transport)return;Echo.API={Transports:{},Request:{}};var n=Echo.Utils;Echo.API.Transport=function(e){this.config=new Echo.Configuration(e,{data:{},uri:"",secure:!1,settings:{crossDomain:!0,dataType:"json"},onData:function(){},onOpen:function(){},onClose:function(){},onError:function(){}}),this._connect()},Echo.API.Transport.prototype._connect=function(){this.transportObject=this._getTransportObject()},Echo.API.Transport.prototype._wrapErrorResponse=function(e){return{result:"error",errorCode:"connection_failure",errorMessage:"",transportError:e||""}},Echo.API.Transport.prototype._prepareURL=function(){return this._getScheme()+"//"+this.config.get("uri")},Echo.API.Transports.WebSockets=n.inherit(Echo.API.Transport,function(e){if(!e||!e.uri){Echo.Utils.log({type:"error",component:"Echo.API.Transports.WebSockets",message:"Unable to initialize WebSockets transport, config is invalid",args:{config:e}});return}e=t.extend(!0,{settings:{maxConnectRetries:3,serverPingInterval:30,protocols:["liveupdate.ws.echoenabled.com"]}},e||{}),this.timers={},this.subscriptionIds={},this.unique=Echo.Utils.getUniqueString(),Echo.API.Transports.WebSockets.parent.constructor.call(this,e)}),Echo.API.Transports.WebSockets.socketByURI={},Echo.API.Transports.WebSockets.prototype.connecting=function(){return this.transportObject&&this.transportObject.readyState===0},Echo.API.Transports.WebSockets.prototype.connected=function(){return this.transportObject&&this.transportObject.readyState===1},Echo.API.Transports.WebSockets.prototype.closing=function(){return this.transportObject&&this.transportObject.readyState===2},Echo.API.Transports.WebSockets.prototype.closed=function(){return this.transportObject&&this.transportObject.readyState===3},Echo.API.Transports.WebSockets.prototype.subscribe=function(e,n){var r=Echo.Events.subscribe(t.extend(!0,{topic:"Echo.API.Transports.WebSockets."+e,context:this._context(this.unique)},n));return this.subscriptionIds[e]=this.subscriptionIds[e]||[],this.subscriptionIds[e].push(r),r},Echo.API.Transports.WebSockets.prototype.unsubscribe=function r(e){var n,i=this;typeof e=="string"?(n=this.subscriptionIds[e],n?(t.map(n,function(e){Echo.Events.unsubscribe({handlerId:e})}),this.subscriptionIds[e]=[]):t.each(this.subscriptionIds,function(t,n){i.subscriptionIds[t]=Echo.Utils.foldl([],n,function(t,n){t.toString()===e.toString()?Echo.Events.unsubscribe({handlerId:t}):n.push(t)})})):(t.each(this.subscriptionIds,t.proxy(r,this)),this.subscriptionIds={})},Echo.API.Transports.WebSockets.prototype.abort=function(e){var n=this,r=Echo.API.Transports.WebSockets.socketByURI[this.config.get("uri")];t.map(["onData","onOpen","onError"],t.proxy(this.unsubscribe,this)),r&&(delete r.subscribers[this.unique],(t.isEmptyObject(r.subscribers)||e)&&this.connected()&&this.transportObject.close())},Echo.API.Transports.WebSockets.prototype.send=function(e){return e.subscription=e.subscription||this.unique,this.transportObject.send(Echo.Utils.objectToJSON(e))},Echo.API.Transports.WebSockets.prototype.keepConnection=function(){var e=this.config.get("settings.serverPingInterval")*1e3;this.timers.ping=setInterval(t.proxy(this._ping,this),e)},Echo.API.Transports.WebSockets.prototype.publish=function(e,t){this._publish(e,t,this.unique)},Echo.API.Transports.WebSockets.prototype._getScheme=function(){return this.config.get("secure")?"wss:":"ws:"},Echo.API.Transports.WebSockets.prototype._context=function(e){return this.config.get("uri").replace(/\//g,"-")+(e?"/"+e:"")},Echo.API.Transports.WebSockets.prototype._getTransportObject=function(){var e=this,n=this.config.get("uri"),r=Echo.API.Transports.WebSockets.socketByURI;return t.map(["onOpen","onClose","onError","onData"],function(t){e.subscribe(t,{handler:function(n,r){e.config.get(t)(r)},context:e._context(t==="onData"?e.unique:undefined)})}),r[n]||(r[n]={socket:this._prepareTransportObject(),subscribers:{}}),r[n].subscribers[this.unique]=!0,r[n].socket},Echo.API.Transports.WebSockets.prototype._prepareTransportObject=function(){var e=this;if(this.connecting()||this.connected())return;this._clearTimers();var n=new(window.WebSocket||window.MozWebSocket)(this._prepareURL(),this.config.get("settings.protocols"));return n.onopen=function(){e._ping(function(){e._publish("onOpen")}),e.keepConnection()},n.onmessage=function(n){if(!n||!n.data)return;var r=t.parseJSON(n.data);e._publish("onData",r,r&&r.subscription)},n.onclose=function(){e._publish("onClose"),e._clear()},n.onerror=function(t){e._publish("onError",e._wrapErrorResponse(t))},n},Echo.API.Transports.WebSockets.prototype._resetRetriesAttempts=function(){this.attemptsRemaining=this.config.get("settings.maxConnectRetries")},Echo.API.Transports.WebSockets.prototype._clearTimers=function(){this.timers.ping&&clearInterval(this.timers.ping),this.timers.pong&&clearTimeout(this.timers.pong),this.timers={}},Echo.API.Transports.WebSockets.prototype._clear=function(){var e=this,n=Echo.API.Transports.WebSockets.socketByURI[this.config.get("uri")],r=this.config.get("uri").replace(/\//g,"-");this._clearTimers(),this.unsubscribe(),t.map(["onData","onOpen","onClose","onError"],function(e){Echo.Events.unsubscribe({topic:"Echo.API.Transports.WebSockets."+e,context:r})}),delete Echo.API.Transports.WebSockets.socketByURI[this.config.get("uri")]},Echo.API.Transports.WebSockets.prototype._publish=function(e,t,n){Echo.Events.publish({topic:"Echo.API.Transports.WebSockets."+e,data:t||{},propagation:!n,global:!1,context:this._context(n)})},Echo.API.Transports.WebSockets.prototype._ping=function(e){var t=this,n=Echo.Events.subscribe({topic:"Echo.API.Transports.WebSockets.onData",handler:function(r,i){if(!i||i.event!=="pong")return;clearTimeout(t.timers.pong),Echo.Events.unsubscribe({handlerId:n}),t._resetRetriesAttempts(),e&&e()},context:this._context()});this.send({event:"ping"}),this.timers.pong=setTimeout(function(){Echo.Events.unsubscribe({handlerId:n}),t._tryReconnect()},this.config.get("settings.serverPingInterval")*1e3)},Echo.API.Transports.WebSockets.prototype._tryReconnect=function(){this.attemptsRemaining--,this.attemptsRemaining===0&&this._reconnect()},Echo.API.Transports.WebSockets.prototype._reconnect=function(){this.abort(!0),this._connect()},Echo.API.Transports.WebSockets.available=function(){return!!window.WebSocket||!!window.MozWebSocket},Echo.API.Transports.AJAX=n.inherit(Echo.API.Transport,function(e){return e=t.extend({method:"get"},e||{}),Echo.API.Transports.AJAX.parent.constructor.call(this,e)}),Echo.API.Transports.AJAX.prototype._getScheme=function(){return this.config.get("secure")?"https:":"http:"},Echo.API.Transports.AJAX.prototype._getTransportObject=function(){var e=this;return t.extend(!0,{url:this._prepareURL(),type:this.config.get("method"),error:function(t,n){t=e._wrapErrorResponse(t),t.transportError&&t.transportError.statusText==="abort"&&(t.errorCode="connection_aborted"),e.config.get("onError")(t,n)},success:this.config.get("onData"),complete:this.config.get("onClose"),beforeSend:this.config.get("onOpen")},this.config.get("settings"))},Echo.API.Transports.AJAX.prototype._wrapErrorResponse=function(e){var n=Echo.API.Transports.AJAX.parent._wrapErrorResponse.apply(this,arguments);if(e&&e.responseText){var r;try{r=t.parseJSON(e.responseText)}catch(i){}return r||n}return n},Echo.API.Transports.AJAX.prototype.send=function(e){var n=this.config.get("data");e=typeof e=="string"?e:typeof n=="string"?n:t.extend({},n,e||{}),typeof this.transportObject.status=="undefined"?(this.transportObject=this._getTransportObject(),this.transportObject.data=e,this.transportObject=t.ajax(this.transportObject)):t.ajax(t.extend(this._getTransportObject(),{data:e}))},Echo.API.Transports.AJAX.prototype.abort=function(){this.transportObject&&this.transportObject.abort&&this.transportObject.abort()},Echo.API.Transports.AJAX.available=function(){return t.support.cors},Echo.API.Transports.XDomainRequest=n.inherit(Echo.API.Transports.AJAX,function(){return Echo.API.Transports.XDomainRequest.parent.constructor.apply(this,arguments)}),Echo.API.Transports.XDomainRequest.prototype._getTransportObject=function(){var r=Echo.API.Transports.XDomainRequest.parent._getTransportObject.call(this),i=n.parseURL(document.location.href).domain,s=n.parseURL(this.config.get("uri")).domain;if(i===s)return r;if(!e.support.cors&&window.XDomainRequest){var o=/\/json/i,u=/\/xml/i;e.ajaxTransport("text html xml json",function(e,n,r){var i=null,s=(n.dataType||"").toLowerCase();return{send:function(r,a){i=new XDomainRequest,/^\d+$/.test(n.timeout)&&(i.timeout=n.timeout),i.ontimeout=function(){a(500,"timeout")},i.onload=function(){var e="Content-Length: "+i.responseText.length+"\r\nContent-Type: "+i.contentType,n={code:200,message:"success"},r={text:i.responseText};try{if(s==="json"||s!=="text"&&o.test(i.contentType))try{r.json=t.parseJSON(i.responseText)}catch(f){n.code=500,n.message="parseerror"}else if(s==="xml"||s!=="text"&&u.test(i.contentType)){var l=new ActiveXObject("Microsoft.XMLDOM");l.async=!1;try{l.loadXML(i.responseText)}catch(f){l=undefined}if(!l||!l.documentElement||l.getElementsByTagName("parsererror").length)throw n.code=500,n.message="parseerror","Invalid XML: "+i.responseText;r.xml=l}}catch(c){throw c}finally{a(n.code,n.message,r,e)}},i.onerror=function(){a(500,"error",{text:i.responseText})};var f=typeof n.data=="string"?n.data:t.param(n.data||"");i.open(e.type,e.url),i.send(f)},abort:function(){i&&i.abort()}}})}return t.extend(r,{cache:!1})},Echo.API.Transports.XDomainRequest.available=function(e){e=e||{method:"",secure:!1};var t=e.secure?"https:":"http:",n=/^get|post$/i.test(e.method)&&/^https?/.test(t)&&document.location.protocol===t;return"XDomainRequest"in window&&n},Echo.API.Transports.JSONP=n.inherit(Echo.API.Transports.AJAX,function(e){return Echo.API.Transports.JSONP.parent.constructor.apply(this,arguments)}),Echo.API.Transports.JSONP.prototype.send=function(e){if(this.config.get("method").toLowerCase()==="get")return Echo.API.Transports.JSONP.parent.send.apply(this,arguments);this._pushPostParameters(t.extend({},this.config.get("data"),e)),this.transportObject.form.submit(),this.config.get("onData")()},Echo.API.Transports.JSONP.prototype.abort=function(){if(this.transportObject.form&&this.transportObject.iframe){this.transportObject.form.remove(),this.transportObject.iframe.remove();return}return Echo.API.Transports.JSONP.parent.abort.call(this)},Echo.API.Transports.JSONP.prototype._getTransportObject=function(){var e=Echo.API.Transports.JSONP.parent._getTransportObject.call(this);return this.config.get("method").toLowerCase()==="post"?this._getPostTransportObject({url:e.url}):(delete e.xhr,e.dataType="jsonp",e)},Echo.API.Transports.JSONP.prototype._getPostTransportObject=function(e){var n="echo-post-"+Math.random(),r=t("#echo-post-request").length?t("#echo-post-request").empty():t('<div id="echo-post-request"/>').css({height:0}).prependTo("body");this.iframe=this.iframe||t('<iframe id="'+n+'" name="'+n+'" width="0" height="0" frameborder="0" border="0"></iframe>').appendTo(r);var i=t("<form/>",{target:n,method:"POST",enctype:"application/x-www-form-urlencoded",acceptCharset:"UTF-8",action:e.url}).appendTo(r);return this._pushPostParameters(e.data),{form:i,iframe:this.iframe}},Echo.API.Transports.JSONP.prototype._pushPostParameters=function(e){var n=this;return t.each(e||{},function(e,r){t("<input/>",{type:"hidden",name:e,value:r}).appendTo(n.transportObject.form)}),n.transportObject},Echo.API.Transports.JSONP.available=function(){return!0},Echo.API.Request=function(e){var n=this;if(!e||!e.endpoint)return Echo.Utils.log({type:"error",component:"Echo.API",message:"Unable to initialize API request, config is invalid",args:{config:e}}),{};this.config=new Echo.Configuration(e,{apiBaseURL:"//api.echoenabled.com/v1/",data:{},onOpen:t.noop,onData:t.noop,onError:t.noop,onClose:t.noop,transport:"ajax",method:"GET",secure:!1,timeout:30},function(e,t){return n._configNormalizers[e]?n._configNormalizers[e].call(n,t):t}),this.deferred={transport:t.Deferred()},this.transport=this._getTransport()},Echo.API.Request.prototype._configNormalizers={transport:function(e){return typeof e=="string"?this._normalizeTransportName(e)||this._normalizeTransportName("ajax"):this._normalizeTransportName("ajax")}},Echo.API.Request.prototype._isSecureRequest=function(e){var t,r=this.config.get("secure"),i=/https|wss/;return r?r:(t=n.parseURL(e),i.test(window.location.protocol)||i.test(t.scheme))},Echo.API.Request.prototype.send=function(e){var t=!1;e&&(t=e.force,delete e.force,this.config.extend(e),this.transport.config.extend(e));var n=this["_"+this.config.get("endpoint")];return n&&n.call(this,t),this.deferred.transport.promise()},Echo.API.Request.prototype.request=function(e){var n=this,r=this.config.get("timeout");return this.transport&&(this.transport.config.extend(t.extend(!0,this.transport.config.getAsHash(),this._getTransportConfig())),this.transport.send(e),r&&this.config.get("onError")&&(this._timeoutId=setTimeout(function(){n.config.get("onError")({result:"error",errorCode:"network_timeout"},{critical:!0}),n.transport.abort()},r*1e3))),this.deferred.transport.promise()},Echo.API.Request.prototype.abort=function(){this.transport&&this.transport.abort(),this.deferred.transport&&this.deferred.transport.state()==="pending"&&this.deferred.transport.resolve()},Echo.API.Request.prototype._normalizeTransportName=function(e){return n.foldl("",Echo.API.Transports,function(t,n,r){if(e.toLowerCase()===r.toLowerCase())return r})},Echo.API.Request.prototype._getTransport=function(){var e=this,n=this._isSecureRequest(this._prepareURL()),r=this.config.get("transport"),i=Echo.API.Transports[r]&&Echo.API.Transports[r].available()?r:function(){var r;return t.each(["WebSockets","AJAX","XDomainRequest","JSONP"],function(t,i){var s=Echo.API.Transports[i].available({secure:n,method:e.config.get("method")});if(s)return r=i,!1}),r}();return new Echo.API.Transports[i](this._getTransportConfig())},Echo.API.Request.prototype._getTransportConfig=function(){var e=this._prepareURL();return t.extend(this._getHandlersByConfig(),{uri:e.replace(/^(?:(?:http|ws)s?:)?\/\//,""),data:this.config.get("data"),method:this.config.get("method"),secure:this._isSecureRequest(e),settings:this.config.get("settings")})},Echo.API.Request.prototype._getHandlersByConfig=function(){var e=this;return n.foldl({},this.config.getAsHash(),function(n,r,i){var s;/^on[A-Z]/.test(i)&&t.isFunction(n)&&(s=i!=="onOpen"?function(){var r=Array.prototype.slice.call(arguments);clearTimeout(e._timeoutId),n.apply(null,arguments),(e.deferred.transport[{onData:"notifyWith",onError:"rejectWith",onClose:"resolveWith"}[i]]||t.noop).call(e.deferred.transport,null,r);if(i==="onClose"||i==="onError")e.deferred.transport=t.Deferred()}:n,r[i]=s)})},Echo.API.Request.prototype._prepareURL=function(){return this.config.get("apiBaseURL")+this.config.get("endpoint")}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.StreamServer&&Echo.StreamServer.API)return;Echo.StreamServer||(Echo.StreamServer={}),Echo.StreamServer.API={},Echo.StreamServer.API.Request=Echo.Utils.inherit(Echo.API.Request,function(e){var n=e&&e.liveUpdates&&e.liveUpdates.timeout||e.liveUpdatesTimeout,r=e&&e.liveUpdates&&e.liveUpdates.enabled||e.recurring;e=t.extend(!0,{liveUpdates:{transport:"polling",enabled:r,polling:{timeout:n||10},websockets:{maxConnectRetries:3,serverPingInterval:30,resetPeriod:60,maxResetsPerPeriod:2,fallback:{timeout:10,divergence:5},URL:"//live.echoenabled.com/v1/"}},recurring:!1,skipInitialRequest:!1,itemURIPattern:undefined,onData:function(){},onError:function(){},onOpen:function(){},submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity"},e),e=this._wrapTransportEventHandlers(e),this.requestType="initial",Echo.StreamServer.API.Request.parent.constructor.call(this,e)}),Echo.StreamServer.API.Request.prototype.abort=function(){Echo.StreamServer.API.Request.parent.abort.call(this),this.liveUpdates&&(this.liveUpdates.stop(),delete this.liveUpdates)},Echo.StreamServer.API.Request.prototype._count=Echo.StreamServer.API.Request.prototype._search=function(e){var t=this,n=function(n){t.config.get("liveUpdates.enabled")&&(t.liveUpdates||t._initLiveUpdates(n||{}),t.liveUpdates.start(e)),t.requestType="secondary"};!this.config.get("skipInitialRequest")||this.config.get("skipInitialRequest")&&this.requestType!=="initial"?this.request().progress(n):n()},Echo.StreamServer.API.Request.prototype._submit=function(){this.request(t.extend({},this.config.get("data"),{content:Echo.Utils.objectToJSON(this._AS2KVL(this.config.get("data.content")))}))},Echo.StreamServer.API.Request.prototype._mux=function(){this.request(t.extend({},this.config.get("data"),{requests:Echo.Utils.objectToJSON(this.config.get("data.requests"))}))},Echo.StreamServer.API.Request.prototype._wrapTransportEventHandlers=function(e){var n=this,r=t.extend({},e);return t.extend({},e,{onOpen:function(e,t){r.onOpen(e,{requestType:n.requestType}),clearInterval(n.retryTimer),delete n.retryTimer},onData:function(e,t){n._onData(e,{requestType:n.requestType},r)},onError:function(e,t){n._onError(e,t,r)}})},Echo.StreamServer.API.Request.prototype._onData=function(e,t,n){e=e||{};if(e.result==="error"){this._handleErrorResponse(e,{callback:n.onError});return}n.onData(e,t),this.requestType="secondary",this._cleanupErrorHandlers(!0)},Echo.StreamServer.API.Request.prototype._onError=function(e,t,n){this._handleErrorResponse(e,{callback:n.onError})},Echo.StreamServer.API.Request.prototype._prepareURL=function(){var e=this.config.get("endpoint");if(e==="submit")return this.config.get("submissionProxyURL");var t=this.constructor.parent._prepareURL.call(this);return e==="mux"?t.replace("v1","v2"):t},Echo.StreamServer.API.Request.prototype._initLiveUpdates=function(e){var n,r=this,i=this.liveUpdates=Echo.StreamServer.API.Polling.init(t.extend(!0,this._getLiveUpdatesConfig("polling"),{request:{data:{since:(e||{}).nextSince}}}));this.config.get("liveUpdates.transport")==="websockets"&&Echo.API.Transports.WebSockets.available()&&(n=Echo.StreamServer.API.WebSockets.init(t.extend(!0,this._getLiveUpdatesConfig("websockets"),{request:{data:{since:(e||{}).nextSince}}})),this._liveUpdatesWatcher(i,n))},Echo.StreamServer.API.Request.prototype._getLiveUpdatesConfig=function(e){var t=this,n={polling:{timeout:"liveUpdates.polling.timeout","request.onOpen":"liveUpdates.onOpen","request.onData":"liveUpdates.onData","request.onError":"liveUpdates.onError","request.onClose":"liveUpdates.onClose","request.endpoint":"endpoint","request.data":"data","request.apiBaseURL":"apiBaseURL","request.secure":"secure"},websockets:{"request.onOpen":"liveUpdates.onOpen","request.onData":"liveUpdates.onData","request.onError":"liveUpdates.onError","request.onClose":"liveUpdates.onClose","request.endpoint":"endpoint","request.data":"data","request.secure":"secure","request.apiBaseURL":"liveUpdates.websockets.URL","resubscribe.resetPeriod":"liveUpdates.websockets.resetPeriod","resubscribe.maxResetsPerPeriod":"liveUpdates.websockets.maxResetsPerPeriod","request.settings.maxConnectRetries":"liveUpdates.websockets.maxConnectRetries","request.settings.serverPingInterval":"liveUpdates.websockets.serverPingInterval"}},r=Echo.Utils.foldl({},n[e],function(e,n,r){var i=function s(e){var n,r=t.config.get(e);return typeof r=="undefined"&&e?s(e.split(".").slice(1).join(".")):r}(e);Echo.Utils.set(n,r,i)});return r},Echo.StreamServer.API.Request.prototype._liveUpdatesWatcher=function(e,t){var n=this,r=function(e){return function(){n.liveUpdates.connected()&&n.liveUpdates.stop(),n.liveUpdates=e,n.liveUpdates.start()}};t.on("close",function(){var t,i=n.config.get("liveUpdates.websockets.fallback");n.liveUpdates.closeReason!=="abort"&&(t=Echo.Utils.random(i.timeout-i.divergence,i.timeout+i.divergence)*1e3,setTimeout(r(e),t))}),t.on("quotaExceeded",r(e));if(t.connected()){r(t)();return}t.on("open",r(t))},Echo.StreamServer.API.Request.prototype._isWaitingForData=function(e){var n=["busy","waiting","timeout","view_limit","view_update_capacity_exceeded","connection_failure","network_timeout"];return e&&this.config.get("endpoint")!=="submit"&&~t.inArray(e.errorCode,n)},Echo.StreamServer.API.Request.prototype._handleErrorResponse=function(e,t){var n=this;t=t||{};var r=t.callback,i=function(){return n.waitingTimeoutStep>0?n.waitingTimeoutStep<7&&n.waitingTimeoutStep++:n.waitingTimeoutStep=1,Math.pow(n.waitingTimeoutStep,2)*1e3};if(this._isWaitingForData(e)){var s=i();this.waitingTimer=setInterval(function(){n._cleanupErrorHandlers();var e=function(e){n.liveUpdates||n._initLiveUpdates(e),n.liveUpdates.start()};n.requestType==="initial"?n.request().progress(e):e()},s),r(e,{requestType:n.requestType,critical:!1,retryIn:s})}else this.waitingTimeoutStep=0,this.liveUpdates&&this.liveUpdates.stop(),r(e,{requestType:n.requestType,critical:e.errorCode!=="connection_aborted"});this.error=e},Echo.StreamServer.API.Request.prototype._cleanupErrorHandlers=function(e){e&&(this.waitingTimeoutStep=0,delete this.error),this.waitingTimer&&clearInterval(this.waitingTimer)},Echo.StreamServer.API.Request.prototype._AS2KVL=function(e){var n=this;e=t.isArray(e)?e:[e];var r=function(e){return e.replace("http://activitystrea.ms/schema/1.0/","").replace("http://js-kit.com/spec/e2/v1/","")},i=function(e,r){var i={avatar:e.actor&&e.actor.avatar,content:e.object&&e.object.content,markers:r.markers?t.trim(r.markers):undefined,name:e.actor&&(e.actor.name||e.actor.title),source:e.source,tags:r.tags?t.trim(r.tags):undefined,title:e.object&&e.object.title,target:e.targets[0].id,verb:s(e),type:o(e),itemURIPattern:n.config.get("itemURIPattern"),author:e.author};return s(e)==="update"?(i={verb:s(e),target:e.targets[0].id},t.each(e.object,function(e,t){if(e!=="objectTypes")return i.field=e,i.value=t,!1})):/tag/.test(s(e))?i={tags:e.object&&e.object.content,verb:s(e),target:e.targets[0].id}:/mark/.test(s(e))&&(i={markers:e.object&&e.object.content,verb:s(e),target:e.targets[0].id}),i},s=function(e){return r(e.verbs[0])},o=function(e){return e.object&&e.object.objectTypes?e.object.objectTypes[0]:undefined},u,a={markers:"",tags:""};return t.map(e,function(e){/tag|mark/.test(s(e))&&/tag|marker/.test(o(e))&&(a[r(o(e))+"s"]=e.object.content),s(e)==="post"&&(u=e)}),u?i(u,a):t.map(e,function(e){return i(e,a)})},Echo.StreamServer.API.request=function(e){return new Echo.StreamServer.API.Request(e)}})(Echo.jQuery),function(e){var t=e;if(Echo.StreamServer.API&&Echo.StreamServer.API.Polling)return;Echo.StreamServer.API.Polling=function(e){this.config=new Echo.Configuration(e,{timeout:10,request:{endpoint:"search",onData:t.noop,onOpen:t.noop,onError:t.noop,onClose:t.noop}}),this.timers={},this.timeouts=[],this.closeReason="unknown",this.originalTimeout=this.config.get("timeout"),this.requestObject=this.getRequestObject()},Echo.StreamServer.API.Polling.prototype.getRequestObject=function(){var e=this,n=this.config.get("request"),r=n.onData||t.noop;return t.extend(n,{onData:function(t){t.type!=="error"&&(e._changeTimeout(t),e.config.set("request.data.since",t.nextSince),e.start()),r(t)}}),new Echo.API.Request(n)},Echo.StreamServer.API.Polling.prototype.stop=function(){clearTimeout(this.timers.regular),this.closeReason="abort",this.requestObject.abort()},Echo.StreamServer.API.Polling.prototype.start=function(e){var t=this;this.stop(),e&&(this.timeouts=[0,1,3]);var n=this.timeouts.length?this.timeouts.shift():this.config.get("timeout");this.timers.regular=setTimeout(function(){t.requestObject.request({since:t.config.get("request.data.since")})},n*1e3)},Echo.StreamServer.API.Polling.prototype.on=function(e,n){var e="on"+Echo.Utils.capitalize(e),r=this.requestObject.transport.config.get(e,t.noop);this.requestObject.transport.config.set(e,function(){r.apply(null,arguments),n.apply(null,arguments)})},Echo.StreamServer.API.Polling.prototype.connected=function(){return!0},Echo.StreamServer.API.Polling.prototype._changeTimeout=function(e){var t=this;typeof e=="string"&&(e={liveUpdatesTimeout:e}),e.liveUpdatesTimeout=parseInt(e.liveUpdatesTimeout);var n=function(e){!e&&t.originalTimeout!==t.config.get("timeout")?t.config.set("timeout",t.originalTimeout):e&&e>t.config.get("timeout")&&t.config.set("timeout",e)},r=function(e){return!!e.entries&&!!e.entries.length};if(!this.config.get("request.data.since")){n(e.liveUpdatesTimeout);return}var i=this.config.get("timeout"),s=parseInt(this.config.get("request.data.since")),o=Math.floor((new Date).getTime()/1e3),u=r(e)?o-s>i?Math.min(3,this.originalTimeout):i+1:i+2;u>this.originalTimeout&&(u=this.originalTimeout),this.config.set("timeout",u),u===this.originalTimeout&&n(e.liveUpdatesTimeout)},Echo.StreamServer.API.WebSockets=Echo.Utils.inherit(Echo.StreamServer.API.Polling,function(e){this.config=new Echo.Configuration(e,{resubscribe:{maxResetsPerPeriod:2,resetPeriod:60},request:{apiBaseURL:"//live.echoenabled.com/v1/",transport:"websockets",timeout:null,onOpen:t.noop,onData:t.noop,onError:t.noop,onClose:t.noop,endpoint:"ws"}},function(e,n){if(e==="request"){var r=n.endpoint;return t.extend({},n,{endpoint:"ws",wsMethod:r})}return n}),this.queue=[],this.subscribed=!1,this.subscriptionIds=[],this.subscriptionResets={count:0,time:(new Date).getTime()},this.requestObject=this.getRequestObject(),this.connected()&&this.requestObject.config.get("onOpen")()}),Echo.StreamServer.API.WebSockets.prototype.getRequestObject=function(){var e=this,n=this.config.get("request"),r=t.extend({},n,{onData:function(t){if(!t||!t.event)return;if(!!~t.event.indexOf("failed")){t.errorCode==="quota_exceeded"?(e.closeReason="server_overload",e.requestObject.transport.publish("onQuotaExceeded")):n.onError(t,{critical:!1});return}if(!!~t.event.indexOf("reset")){e.subscribed=!1,t.data&&t.data.nextSince&&e.config.set("request.data.since",t.data.nextSince),e._resubscribeAllowed()?e._updateConnection(e._resubscribe):(e.closeReason="server_overload",e.requestObject.transport.publish("onClose"));return}t.event==="subscribe/confirmed"&&(e.subscribed=!0,e._runQueue()),t.event==="unsubscribe/confirmed"&&(e.subscribed=!1),t.data&&(t.data.nextSince&&e.config.set("request.data.since",t.data.nextSince),n.onData(t.data))},onOpen:function(){e.subscribe(),n.onOpen.apply(null,arguments)},onError:function(t){e.closeReason="unknown",e.requestObject.transport.publish("onClose"),n.onError(t,{critical:!1})}});return new Echo.API.Request(r)},Echo.StreamServer.API.WebSockets.prototype.on=function(e,t,n){var r=this.requestObject.transport.subscribe("on"+Echo.Utils.capitalize(e),{handler:t});return this.subscriptionIds.push(r),r},Echo.StreamServer.API.WebSockets.prototype.start=t.noop,Echo.StreamServer.API.WebSockets.prototype.connected=function(){return this.requestObject.transport.connected()},Echo.StreamServer.API.WebSockets.prototype.stop=function(){var e=this;this._clearSubscriptions(),this.connected()&&(this.queue.push(function(){e.subscribed&&e.requestObject.request({event:"unsubscribe/request"}),e.closeReason="abort",e.requestObject.abort()}),this._runQueue())},Echo.StreamServer.API.WebSockets.prototype.subscribe=function(){var e={method:this.config.get("request.wsMethod")};this.requestObject.request({event:"subscribe/request",data:t.extend(e,this.config.get("request.data"))})},Echo.StreamServer.API.WebSockets.prototype._updateConnection=function(e){var n=this;e=e||t.noop;var r=t.extend(!0,{},this.config.get("request.data"));delete r.since;var i=new Echo.API.Request({endpoint:"search",data:r,secure:this.config.get("request.secure"),onData:function(){e.apply(n,arguments)},onError:function(){n.closeReason="unknown",n.requestObject.transport.publish("onClose")}});i.request()},Echo.StreamServer.API.WebSockets.prototype._reconnect=function(){var e=this,t=function(){e.requestObject=e.getRequestObject(),e.connected()&&e.requestObject.config.get("onOpen")()};this.closeReason="reconnect",this.requestObject.abort(),this._clearSubscriptions();if(this.requestObject.transport.closing())var n=this.on("close",function(){t(),Echo.Events.unsubscribe({handlerId:n})});else t()},Echo.StreamServer.API.WebSockets.prototype._resubscribe=function(){var e=this,t=function(){e.connected()&&e.requestObject.config.get("onOpen")()};if(this.requestObject.transport.closing())var n=this.on("close",function(){t(),Echo.Events.unsubscribe({handlerId:n})});else t()},Echo.StreamServer.API.WebSockets.prototype._resubscribeAllowed=function(){var e=this.subscriptionResets,t=(new Date).getTime(),n=this.config.get("resubscribe"),r=Math.floor((t-e.time)/1e3);if(r>n.resetPeriod)return this.subscriptionResets={count:0,time:(new Date).getTime()},!0;if(r<=n.resetPeriod)return e.count+1<=n.maxResetsPerPeriod?(this.subscriptionResets={count:e.count+1,time:(new Date).getTime()},!0):!1},Echo.StreamServer.API.WebSockets.prototype._clearSubscriptions=function(){t.map(this.subscriptionIds,t.proxy(this.requestObject.transport.unsubscribe,this.requestObject.transport)),this.subscriptionIds=[]},Echo.StreamServer.API.WebSockets.prototype._runQueue=function(){while(this.queue.length)this.queue.shift().call(this)},t.map(["WebSockets","Polling"],function(e){Echo.StreamServer.API[e].init=function(t){return new Echo.StreamServer.API[e](t)}})}(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.IdentityServer&&Echo.IdentityServer.API)return;Echo.IdentityServer||(Echo.IdentityServer={}),Echo.IdentityServer.API={},Echo.IdentityServer.API.Request=Echo.Utils.inherit(Echo.API.Request,function(e){e=t.extend({onData:function(){},onError:function(){},submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity"},e),e=this._wrapTransportEventHandlers(e),Echo.IdentityServer.API.Request.parent.constructor.call(this,e)}),Echo.IdentityServer.API.Request.prototype._prepareURL=function(){return this.config.get("endpoint")==="whoami"?Echo.IdentityServer.API.Request.parent._prepareURL.call(this):this.config.get("submissionProxyURL")},Echo.IdentityServer.API.Request.prototype._wrapTransportEventHandlers=function(e){var n=this,r=t.extend({},e);return t.extend({},e,{onData:function(e,t){n._onData(e,r)}})},Echo.IdentityServer.API.Request.prototype._onData=function(e,t){if(e&&e.result==="error"){t.onError(e);return}t.onData(e)},Echo.IdentityServer.API.Request.prototype._update=function(e){var n=t.extend({},this.config.get("data.content"),{endpoint:"users/update"});this.request(t.extend({},this.config.get("data"),{content:Echo.Utils.objectToJSON(n)}))},Echo.IdentityServer.API.Request.prototype._whoami=function(e){this.request(e)},Echo.IdentityServer.API.request=function(e){return new Echo.IdentityServer.API.Request(e)}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.UserSession"))return;Echo.UserSession=function(e){return Echo.UserSession._construct(e)},Echo.UserSession.set=function(e,t){var n=this;n._maybeDelegate({action:"set",key:e,arg:[t],fallback:function(){n._attrLocation(e)[e]=t}})},Echo.UserSession.get=function(e,t){var n=this,r=n._maybeDelegate({action:"get",key:e,fallback:function(){return n._attrLocation(e)[e]}});return typeof r=="undefined"?t:r},Echo.UserSession.is=function(e){return this._maybeDelegate({action:"is",key:e})},Echo.UserSession.has=function(e,t){var n=this;return n._maybeDelegate({action:"has",key:e,arg:[t],fallback:function(){return n.any(e,[t])}})},Echo.UserSession.any=function(e,n){var r=this;return r._maybeDelegate({action:"any",key:e,arg:[n],fallback:function(){var i=!1;return r.identity?(t.each(n,function(n,s){var o=r.get(e,{});if(typeof o=="string"&&o===s||t.isArray(o)&&t.inArray(s,o)>=0)return i=!0,!1}),i):!1}})},Echo.UserSession.logout=function(e){var t=this;if(!t.is("logged")){t._reset({}),e&&e();return}t._logoutRequest({sessionID:t.get("sessionID")},function(n){t._onInit(e),Backplane.expectMessages("identity/ack")})},Echo.UserSession._construct=function(e){if(!e){Echo.Utils.log({type:"error",component:"Echo.UserSession",message:"Unable to initialize user session, config is invalid",args:{config:e}});return}var t=this,n=function(){e.ready&&e.ready.call(t)};t.state=t.state||"init",!t._sessionID&&t.get("sessionID")&&(t._sessionID=t.get("sessionID"),t.state=t.state==="ready"?"init":t.state);switch(t.state){case"waiting":t._onInit(n);break;case"ready":n();break;default:t.data={},t.cache={},t.config=new Echo.Configuration(e,t._getDefaultConfig()),t._listenEvents(),t._init(n)}return t},Echo.UserSession._maybeDelegate=function(e){var t=this,n=Echo.Utils.capitalize(e.key),r=t["_"+e.action+n];return r?r.apply(this,e.arg||[]):e.fallback?e.fallback():undefined},Echo.UserSession._getDefaultConfig=function(){return{appkey:"",endpoints:{logout:"https://apps.echoenabled.com/v2/",whoami:"https://api.echoenabled.com/v1/users/"},useSecureAPI:!1,fakeIdentityURL:"http://js-kit.com/ECHO/user/fake_user"}},Echo.UserSession._logoutRequest=function(e,t){(new Echo.API.Request({apiBaseURL:this.config.get("endpoints.logout"),secure:this.config.get("useSecureAPI"),endpoint:"logout",transport:"jsonp",onData:t,data:e})).request()},Echo.UserSession._whoamiRequest=function(e){Echo.IdentityServer.API.request({apiBaseURL:this.config.get("endpoints.whoami"),secure:this.config.get("useSecureAPI"),endpoint:"whoami",onData:e.onData,onError:e.onError,data:e.data}).send()},Echo.UserSession._listenEvents=function(){var e=this;if(e.backplaneSubscriptionID)return;e.backplaneSubscriptionID=Backplane.subscribe(function(t){if(t.type!=="identity/ack")return;e._init(function(){Echo.Events.publish({topic:"Echo.UserSession.onInvalidate",data:e.is("logged")?e.data:{}})})})},Echo.UserSession._reset=function(e){var n=this;n.data=n._normalize(t.extend({},e)),n.identity={},n.cache={};var r=n.get("activeIdentities");n.identity=r&&r.length?r[0]:{}},Echo.UserSession._init=function(e){var t=this;t.state="waiting";var n=function(n){if(!n||n.result&&n.result==="session_not_found")n={};t.state="ready",t._reset(n),Echo.Events.publish({topic:"Echo.UserSession.onInit",data:n}),e&&e()};t.get("sessionID")?t._whoamiRequest({data:{appkey:t.config.get("appkey"),sessionID:t.get("sessionID")},onData:n,onError:function(e){Echo.Utils.log({type:"error",component:"Echo.UserSession",args:{response:e},message:"Unable to initialize user session, error response from IdentityServer API received"}),n()}}):n()},Echo.UserSession._normalize=function(e){return e=e||{},e.echo=e.echo||{},e.echo.state=e.echo.state||"Untouched",e.echo.roles=e.echo.roles||[],e.echo.markers=e.echo.markers||[],e.poco=e.poco||{entry:{}},e.identities=e.poco.entry.accounts||[],e},Echo.UserSession._onInit=function(e){if(!e)return;Echo.Events.subscribe({topic:"Echo.UserSession.onInit",once:!0,handler:e})},Echo.UserSession._attrLocation=function(e){return~t.inArray(e,["roles","state","markers"])?this.data.echo:this.identity},Echo.UserSession._extract=function(e,t,n){var r=this;return r.identity[e]=typeof r.identity[e]!="undefined"?r.identity[e]:Echo.Utils.foldl(undefined,r.identity[t]||[],n),r.identity[e]},Echo.UserSession._isLogged=function(){var e=this.get("activeIdentities");return!!e&&!!e.length},Echo.UserSession._isAdmin=function(){return this.any("roles",["administrator","moderator"])},Echo.UserSession._setName=function(e){this.identity.displayName=e},Echo.UserSession._getActiveIdentities=function(){var e=this;if(!e.data.poco||!e.data.poco.entry)return;if(e.cache.activeIdentities)return e.cache.activeIdentities;var n=t.map(e.data.poco.entry.accounts||[],function(e){if(e.loggedIn==="true")return e});return e.cache.activeIdentities=n,n},Echo.UserSession._getAvatar=function(){return this._extract("avatar","photos",function(e){if(e.type==="avatar")return e.value})},Echo.UserSession._getName=function(){var e=this.identity;return e?e.displayName||e.username:undefined},Echo.UserSession._getEmail=function(){return this._extract("email","emails",function(e){if(e.primary==="true")return e.value})},Echo.UserSession._getSessionID=function(){return Backplane.getChannelID()},Echo.UserSession._hasIdentity=function(e){var n=this,r=!1;return t.each(n.data.identities,function(t,n){if(n.identityUrl&&n.identityUrl===e)return r=!0,!1}),r},Echo.UserSession._anyMarker=function(e){return this.any("markers",e)},Echo.UserSession._anyRole=function(e){return this.any("roles",e)}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.View"))return;Echo.View=function(e){e=e||{},this.config=e,this.config.cssPrefix=this.config.cssPrefix||"",this.renderers=e.renderers||{},this._clear()},Echo.View.prototype.get=function(e){return this._elements[this._key(e)]},Echo.View.prototype.set=function(e,n){this._elements[this._key(e)]=t(n)},Echo.View.prototype.remove=function(e){var t=typeof e=="string"?this._key(e):e.echo.name;this._elements[t].remove(),delete this._elements[t]},Echo.View.prototype.rendered=function(){return!!this._rendered},Echo.View.prototype.render=function(e){e=e||{},e.data=e.data||this.config.data||{},e.template=e.template||this.config.template,e.renderers&&t.extend(this.renderers,e.renderers);if(e.name){e.target=e.target||this.get(e.name);if(!e.target)return!1;var n=e.recursive?"recursive":"element";return this._render[n].call(this,e)}if(e.template){this._clear(),this._template=typeof e.template=="string"?e.template:e.template.html();var r=this._render.template.call(this,e);return this._rendered=!0,r}return!1},Echo.View.prototype.fork=function(e){return new Echo.View(t.extend(!0,{},this.config,e))},Echo.View.prototype._render={},Echo.View.prototype._render.element=function(e){return this.config.renderer?this.config.renderer(e):this._hasRenderer(e.name)?this._getRenderer(e.name)(e.target,e.extra):e.target},Echo.View.prototype._render.recursive=function(e){var n=this.get(e.name);e.template=this._template;var r=this._compileTemplate(e);this._applyRenderers(t("."+this._key(e.name),r));var i=this.get(e.name);return n.replaceWith(i),i},Echo.View.prototype._render.template=function(e){var n=this._compileTemplate(e);return n.hasClass("echo-tmp-wrapper")&&(n=t(n.html())),this._applyRenderers(n)},Echo.View.prototype._key=function(e){return this.config.cssPrefix+e},Echo.View.prototype._clear=function(){this._elements={}},Echo.View.prototype._compileTemplate=function(e){if(typeof e.template!="string")return e.template;var n=Echo.Utils.substitute({data:e.data,template:e.template,instructions:this.config.substitutions});return t('<div class="echo-tmp-wrapper"/>').html(n)},Echo.View.prototype._applyRenderers=function(e){var n=this,r=this._getRenderableElements(e);return t.each(r,function(e,t){n._hasRenderer(e)&&n.render({name:e,target:t})}),e},Echo.View.prototype._getRenderer=function(e){return this.renderers[e]},Echo.View.prototype._hasRenderer=function(e){return this.config.renderer?!0:!!this._getRenderer(e)},Echo.View.prototype._getRenderableElements=function(e){var n=this,r={},i=new RegExp(this.config.cssPrefix+"(.*)$");return e.find("*").addBack().each(function(e,s){if(!s.className)return;var o=s.className.split(/[ ]+/);t.each(o,function(e,t){var o=t.match(i),u=o?o[1]:undefined;u&&(n.set(u,s),s=n.get(u),s.echo=s.echo||{},s.echo.name=t,r[u]=s)})}),r}})(Echo.jQuery);
(function(e){"use strict";var t=e;Echo.Control=function(){},Echo.Control.create=function(e){var n=Echo.Utils.getComponent(e.name);if(Echo.Control.isDefined(e))return n;var r=this._merge(e,e.inherits&&e.inherits._manifest),i=Echo.Utils.inherit(this,function(e){if(!e||!e.target)return Echo.Utils.log({type:"error",component:r.name,message:"Unable to initialize control, config is invalid",args:{config:e}}),{};this.data=e.data||{},this.config=e,this._init(this._initializers.get("init"))}),s=i.prototype;return r.methods&&t.extend(s,r.methods),s.templates=r.templates,s.renderers=r.renderers,s.name=r.name,i._manifest=r,e.inherits&&(i.parent=e.inherits.prototype),Echo.Labels.set(r.labels,r.name,!0),s.cssClass=r.name.toLowerCase().replace(/-/g,"").replace(/\./g,"-"),s.cssPrefix=s.cssClass+"-",Echo.Utils.set(window,r.name,t.extend(i,n)),i},Echo.Control.manifest=function(e){return{name:e,vars:{},config:{},labels:{},events:{},methods:{},renderers:{},templates:{},dependencies:[],init:function(){this.render(),this.ready()},destroy:function(){}}},Echo.Control.isDefined=function(e){var t=typeof e=="string"?e:e.name,n=Echo.Utils.get(window,t);return!!n&&!!n._manifest},Echo.Control.prototype.templates={message:{}},Echo.Control.prototype.templates.message.compact='<span class="echo-control-message echo-control-message-icon echo-control-message-{data:type} {class:messageIcon} {class:messageText}" title="{data:message}">&nbsp;</span>',Echo.Control.prototype.templates.message.full='<div class="echo-control-message {class:messageText}"><span class="echo-control-message-icon echo-control-message-{data:type} {class:messageIcon}">{data:message}</span></div>',Echo.Control.prototype.get=function(e,t){return Echo.Utils.get(this,e,t)},Echo.Control.prototype.set=function(e,t){return Echo.Utils.set(this,e,t)},Echo.Control.prototype.remove=function(e){return Echo.Utils.remove(this,e)},Echo.Control.prototype.render=function(){var e=this.view,t=e.rendered()?"onRerender":"onRender";!this.dependent()&&!e.rendered()&&this.config.get("target").addClass("echo-sdk-ui");var n=e.render({template:this._compileTemplate()});return this.config.get("target").empty().append(n),this.events.publish({topic:t}),n},Echo.Control.prototype.substitute=function(e){var n=this._getSubstitutionInstructions();return e.data=e.data||this.get("data"),e.instructions=e.instructions?t.extend(n,e.instructions):n,Echo.Utils.substitute(e)},Echo.Control.prototype.invoke=function(e,t){return Echo.Utils.invoke(e,t||this)},Echo.Control.prototype.refresh=function(){this.destroy({self:!1}),this.set("data",this.config.get("data",{})),this._init(this._initializers.get("refresh"))},Echo.Control.prototype.destroy=function(e){Echo.Events.publish({topic:"Echo.Control.onDestroy",bubble:!1,context:this.config.get("context"),data:t.extend({producer:this,self:!0},e)})},Echo.Control.prototype.dependent=function(){return!!this.config.get("parent")},Echo.Control.prototype.showMessage=function(e){if(!this.config.get("infoMessages.enabled"))return;var t=e.target||this.config.get("target"),n=e.layout||this.config.get("infoMessages.layout"),r=this.view.fork();t.empty().append(r.render({data:e,template:this.templates.message[n]}))},Echo.Control.prototype.showError=function(e,t){var n=this;if(typeof t.retryIn=="undefined"){var r=this.labels.get("error_"+e.errorCode),i=r==="error_"+e.errorCode?"("+e.errorCode+") "+(e.errorMessage||""):r;this.showMessage({type:t.critical?"error":"loading",message:i,target:t.target})}else if(!t.retryIn&&t.request.retryTimer)this.showMessage({type:"loading",message:this.labels.get("retrying"),target:t.target});else{var s=t.retryIn/1e3,o=function(){if(!s)return;var r=n.labels.get("error_"+e.errorCode,{seconds:s--});n.showMessage({type:"loading",message:r,target:t.target})};t.request.retryTimer=setInterval(o,1e3),o()}},Echo.Control.prototype.getPlugin=function(e){return this.plugins[e]},Echo.Control.prototype.template=function(){return this.invoke(this.templates.main)},Echo.Control.prototype.parentRenderer=function(e,t){var n=this.parentRenderers[e];return n?n.apply(this,t):t[0]},Echo.Control.prototype.extendTemplate=function(e,t,n){this.extension.template.push({action:e,anchor:t,html:n})},Echo.Control.prototype.extendRenderer=function(e,t){var n=this,r=this.extension.renderers,i=r[e]||this.renderers[e];r[e]=function(){return n.parentRenderers[e]=i,t.apply(n,arguments)}},Echo.Control.prototype.log=function(e){Echo.Utils.log(t.extend(e,{component:this.name}))},Echo.Control.prototype.getRelativeTime=function(e){if(!e)return;var t=this,n=typeof e=="string"?Echo.Utils.timestampFromW3CDTF(e):e;if(!n)return;var r=new Date(n*1e3),i=(new Date).getTime(),s,o=Math.floor((i-r.getTime())/1e3),u=Math.floor(o/86400),a=function(e,n){return t.labels.get(n+(e===1?"":"s")+"Ago",{number:e})};return isNaN(u)||o<-60||u>=365?s=r.toLocaleDateString()+", "+r.toLocaleTimeString():o<10?s=this.labels.get("justNow"):o<60?s=a(o,"second"):o<3600?(o=Math.floor(o/60),s=a(o,"minute")):o<86400?(o=Math.floor(o/3600),s=a(o,"hour")):o<172800?s=this.labels.get("yesterday"):u<7?s=a(u,"day"):u<14?s=this.labels.get("lastWeek"):u<30?(o=Math.floor(u/7),s=a(o,"week")):u<60?s=this.labels.get("lastMonth"):u<365&&(o=Math.floor(u/31),s=a(o,"month")),s},Echo.Control.prototype.placeImage=function(e){var n=e.position||"fill";e.container.addClass("echo-image-container"),n==="fill"&&e.container.addClass("echo-image-position-fill");var r=Echo.Utils.loadImage({image:e.image,defaultImage:e.defaultImage,onerror:e.onerror,onload:function(){document.compatMode!=="CSS1Compat"&&t(this).addClass(this.width<this.height?"echo-image-stretched-vertically":"echo-image-stretched-horizontally"),t.isFunction(e.onload)&&e.onload.apply(this,arguments)}});e.container.empty().append(r)},Echo.Control.prototype.checkAppKey=function(){return this.config.get("appkey")?!0:(this.showError({errorCode:"incorrect_appkey"},{critical:!0}),!1)},Echo.Control.prototype._init=function(e){var t=this;if(!e||!e.length)return;var n=e.shift(),r=n.split(":"),i={name:r[0],init:t._initializers[r[0]],type:r[1]||"sync"};if(i.type==="sync"){var s=i.init.call(t);typeof s!="undefined"&&(t[i.name]=s),t._init(e)}else i.init.call(t,function(){t._init(e)})},Echo.Control.prototype._initializers={},Echo.Control.prototype._initializers.list=[["vars",["init","refresh"]],["config",["init"]],["css",["init"]],["events",["init"]],["subscriptions",["init"]],["labels",["init"]],["view",["init"]],["loading",["init","refresh"]],["dependencies:async",["init"]],["user:async",["init","refresh"]],["plugins:async",["init","refresh"]],["init:async",["init","refresh"]],["ready",["init"]],["refresh",["refresh"]]],Echo.Control.prototype._initializers.get=function(e){return Echo.Utils.foldl([],this.list,function(n,r){~t.inArray(e,n[1])&&r.push(n[0])})},Echo.Control.prototype._initializers.vars=function(){t.extend(this,t.extend(!0,{},this._manifest("vars")))},Echo.Control.prototype._initializers.config=function(){var e=this,t=this._manifest("config"),n=function(n,r){return t.normalizer&&t.normalizer[n]?t.normalizer[n].call(this,r,e):r};return new Echo.Configuration(this.config,t,n,{data:!0,parent:!0})},Echo.Control.prototype._initializers.events=function(){var e=this,n=function(n){return n.context=n.context||e.config.get("context"),n.handler&&(n.handler=t.proxy(n.handler,e)),n};return{publish:function(r){var i,s;r.data=r.data||{},e._prepareEventParams&&(r.data=e._prepareEventParams(r.data)),r=n(r),r.inherited&&(i=e.constructor.parent,s=function o(e,t){return e&&e.name&&(t.unshift(e.name),o(e.constructor.parent,t)),t}(i,[]),t.map(s,function(e){Echo.Events.publish(t.extend({},r,{topic:e+"."+r.topic,global:!1}))})),r.topic=e.name+"."+r.topic,Echo.Events.publish(r)},subscribe:function(t){var r=Echo.Events.subscribe(n(t));return e.subscriptionIDs[r]=!0,r},unsubscribe:function(t){t&&t.handlerId&&delete e.subscriptionIDs[t.handlerId],Echo.Events.unsubscribe(n(t))}}},Echo.Control.prototype._initializers.subscriptions=function(){var e=this;t.each(e._manifest("events"),function n(r,i){t.isArray(i)&&i.length?(n(r,i.shift()),i.length&&n(r,i)):(i=t.isFunction(i)?{handler:i}:i,e.events.subscribe(t.extend({topic:r},i)))}),t.map(["global",e.config.get("context")],function(t){e.events.subscribe({topic:"Echo.Control.onDataInvalidate",context:t,handler:function(){var t=e.get("request");t&&t.liveUpdates&&t.liveUpdates.start(!0)}})}),e.events.subscribe({topic:"Echo.Control.onDestroy",handler:function(n,r){var i=e.config.get("context")===r.producer.config.get("context");t.map(e.config.get("pluginsOrder"),function(t){var n=e.plugins[t];n&&n.destroy&&n.destroy()}),e._manifest("destroy")&&e._manifest("destroy").call(e,r.producer);var s=e.get("request");s&&(s.abort(),e.remove("request")),(r.self||!i)&&t.each(e.subscriptionIDs,function(t){e.events.unsubscribe({handlerId:t})}),i&&e.config.get("target").empty()}}),e.dependent()||e.events.subscribe({topic:"Echo.UserSession.onInvalidate",context:"global",handler:e.refresh})},Echo.Control.prototype._initializers.labels=function(){return new Echo.Labels(this.config.get("labels"),this.name)},Echo.Control.prototype._initializers.css=function(){var e=this;this.config.get("target").addClass(this.cssClass),t.map(this._manifest("css"),function(t){if(!t.id||!t.code||Echo.Utils.hasCSS(t.id))return;if(t.id!==e.name){var n,r=Echo.Utils.getComponent(t.id);r&&(n=e.substitute({template:t.code,instructions:{"class":function(e){return r.prototype.cssPrefix+e}}}),Echo.Utils.addCSS(n,t.id))}else Echo.Utils.addCSS(e.substitute({template:t.code}),t.id)})},Echo.Control.prototype._initializers.view=function(){var e=this;return new Echo.View({data:this.get("data"),cssPrefix:this.get("cssPrefix"),renderer:function(t){var n=e.extension.renderers[t.name]||e.renderers[t.name];return n?n.call(e,t.target,t.extra):t.target},substitutions:this._getSubstitutionInstructions()})},Echo.Control.prototype._initializers.loading=function(){this.showMessage({type:"loading",message:this.labels.get("loading")})},Echo.Control.prototype._initializers.dependencies=function(e){this._loadScripts(this._manifest("dependencies"),e)},Echo.Control.prototype._initializers.user=function(e){var t=this;if(!this.config.get("appkey")){e.call(t);return}if(this.config.get("user"))this.user=this.config.get("user"),e.call(t);else{var n=function(e,t){if(!e)return;var n=Echo.Utils.parseURL(e);return(n.scheme||"https")+"://"+n.domain+t};Echo.UserSession({appkey:this.config.get("appkey"),useSecureAPI:this.config.get("useSecureAPI"),endpoints:{logout:n(this.config.get("submissionProxyURL"),"/v2/"),whoami:n(this.config.get("apiBaseURL"),"/v1/users/")},ready:function(){t.user=this,e.call(t)}})}},Echo.Control.prototype._initializers.plugins=function(e){var n=this;this._loadPluginScripts(function(){t.map(n.config.get("pluginsOrder"),function(e){var t=Echo.Plugin.getClass(e,n.name);if(t){var r=new t({component:n});r.enabled()&&(r.init(),n.plugins[e]=r)}}),e.call(n)})},Echo.Control.prototype._initializers.init=function(e){this.ready=e,this._manifest("init").call(this)},Echo.Control.prototype._initializers.ready=function(){this.config.get("ready")&&(this.config.get("ready").call(this),this.config.remove("ready")),this.events.publish({topic:"onReady"})},Echo.Control.prototype._initializers.refresh=function(){this.events.publish({topic:"onRefresh"})},Echo.Control._merge=function(e,n){var r=this;n=n||t.extend(!0,Echo.Control.manifest(this._manifest.name),this._manifest);var i=function(e){return e.css=e.css||"",t.isArray(e.css)?e.css:[{id:e.name,code:e.css}]};e.css=i(e),n.css=i(n);var s=Echo.Utils.foldl({},e,function(e,t,i){t[i]=i in n&&r._merge[i]?r._merge[i](n[i],e):e});return t.extend(!0,{},n,s)};var n=function(e,t){return function(){var n=this.parent;this.parent=e;var r=t.apply(this,arguments);return this.parent=n,r}};Echo.Control._merge.methods=function(e,t){return Echo.Utils.foldl({},t,function(t,r,i){r[i]=i in e?n(e[i],t):t})},Echo.Control._merge.dependencies=function(e,t){return e.concat(t)},Echo.Control._merge.css=function(e,t){return e.concat(t)},Echo.Control._merge.events=function(e,t){return Echo.Utils.foldl({},t,function(t,n,r){n[r]=r in e?[t,e[r]]:t})},t.map(["init","destroy"],function(e){Echo.Control._merge[e]=n}),Echo.Control.prototype._getSubstitutionInstructions=function(){var e=this;return{"class":function(t){return t?e.cssPrefix+t:e.cssClass},"inherited.class":function(t){var n,r;return t?(r=e.constructor.parent,n=function i(e,n){return e&&e.cssPrefix&&(n.unshift(e.cssPrefix+t),i(e.constructor.parent,n)),n}(r,[]).join(" ")):n=e.cssClass,n},label:function(t,n){return e.labels.get(t,n)},self:function(t,n){var r=e.invoke(Echo.Utils.get(e,t));return typeof r=="undefined"?Echo.Utils.get(e.data,t,n):r},config:function(t,n){return e.invoke(e.config.get(t,n))}}},Echo.Control.prototype._manifest=function(e){var t=Echo.Utils.getComponent(this.name);return t?e?t._manifest[e]:t._manifest:undefined},Echo.Control.prototype._loadScripts=function(e,n){var r=this;if(!e||!e.length){n.call(r);return}e=t.map(e,function(e){if(!e.loaded){var n=e.app&&"App"||e.control&&"Control"||e.plugin&&"Plugin";n&&(e.loaded=function(){return Echo[n].isDefined(e[n.toLowerCase()])})}return t.extend(e,{url:r.substitute({template:e.url})})}),Echo.Loader.download(e,function(){n.call(r)},{errorTimeout:r.config.get("scriptLoadErrorTimeout")})},Echo.Control.prototype._loadPluginScripts=function(e){var n=this,r=this.config.get("pluginsOrder"),i={plugins:function(e,t){var r="plugins."+e+".url";if(!t&&n.config.get(r))return[{url:n.config.get(r),loaded:function(){return!!Echo.Plugin.getClass(e,n.name)}}]},dependencies:function(e,t){return t&&t.dependencies}},s=function(e){return Echo.Utils.foldl([],r,function(r,s){var o=Echo.Plugin.getClass(r,n.name),u=i[e](r,o);if(t.isArray(u)&&u.length)return s.concat(u)})};n._loadScripts(s("plugins"),function(){n._loadScripts(s("dependencies"),e)})},Echo.Control.prototype._compileTemplate=function(){var e=this,n=this.get("data",{}),r=this.extension.template,i=e.substitute({data:n,template:this.invoke(this.template)}),s=t("<div/>").html(i);return r&&r.length&&t.map(r,function(t){s=e._domTransformer({dom:s,data:n,transformation:t})}),t(s.html())},Echo.Control.prototype._domTransformer=function(e){var n={insertBefore:"before",insertAfter:"after",insertAsFirstChild:"prepend",insertAsLastChild:"append",replace:"replaceWith",remove:"remove"},r=n[e.transformation.action];if(!r)return e.dom;var i,s=e.transformation.html,o="."+this.get("cssPrefix")+e.transformation.anchor;return s&&(i=this.substitute({data:e.data,template:s})),t(o,e.dom)[r](i),e.dom}})(Echo.jQuery),function(e){"use strict";var t=e,n={};n.name="Echo.Control",n.vars={plugins:{},extension:{template:[],renderers:{}},parentRenderers:{},subscriptionIDs:{},parent:function(){}},n.config={target:undefined,appkey:"",labels:{},apiBaseURL:"//api.echoenabled.com/v1/",submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity",useSecureAPI:!1,infoMessages:{enabled:!0,layout:"full"},cdnBaseURL:{sdk:Echo.Loader.getURL(""),"sdk-assets":Echo.Loader.getURL("",!1),apps:Echo.Loader.config.cdnBaseURL+"apps"},plugins:{},context:"",scriptLoadErrorTimeout:5e3,query:"",defaultAvatar:Echo.Loader.getURL("images/avatar-default.png",!1)},n.config.normalizer={target:t,plugins:function(e){var n=Echo.Utils.foldl({hash:{},order:[]},e||[],function(e,n){var r=t.inArray(e.name,n.order);r>=0&&n.order.splice(r,1),n.order.push(e.name),n.hash[e.name]=e});return this.set("pluginsOrder",n.order),n.hash},context:Echo.Events.newContextId,defaultAvatar:Echo.Loader.getURL},n.labels={loading:"Loading...",retrying:"Retrying...",error_busy:"Loading. Please wait...",error_timeout:"Loading. Please wait...",error_waiting:"Loading. Please wait...",error_view_limit:"View creation rate limit has been exceeded. Retrying in {seconds} seconds...",error_view_update_capacity_exceeded:"This stream is momentarily unavailable due to unusually high activity. Retrying in {seconds} seconds...",error_result_too_large:"(result_too_large) The search result is too large.",error_wrong_query:"(wrong_query) Incorrect or missing query parameter.",error_incorrect_appkey:"(incorrect_appkey) Incorrect or missing appkey.",error_internal_error:"(internal_error) Unknown server error.",error_quota_exceeded:"(quota_exceeded) Required more quota than is available.",error_incorrect_user_id:"(incorrect_user_id) Incorrect user specified in User ID predicate.",error_unknown:"(unknown) Unknown error.",today:"Today",justNow:"Just now",yesterday:"Yesterday",lastWeek:"Last Week",lastMonth:"Last Month",secondAgo:"{number} Second Ago",secondsAgo:"{number} Seconds Ago",minuteAgo:"{number} Minute Ago",minutesAgo:"{number} Minutes Ago",hourAgo:"{number} Hour Ago",hoursAgo:"{number} Hours Ago",dayAgo:"{number} Day Ago",daysAgo:"{number} Days Ago",weekAgo:"{number} Week Ago",weeksAgo:"{number} Weeks Ago",monthAgo:"{number} Month Ago",monthsAgo:"{number} Months Ago"},n.inherits=Echo.Control,n.templates={message:{}},n.templates.message.compact='<span class="echo-control-message echo-control-message-icon echo-control-message-{data:type} {class:messageIcon} {class:messageText}" title="{data:message}">&nbsp;</span>',n.templates.message.full='<div class="echo-control-message {class:messageText}"><span class="echo-control-message-icon echo-control-message-{data:type} {class:messageIcon}">{data:message}</span></div>',n.css=".echo-secondaryBackgroundColor { background-color: #F4F4F4; }.echo-trinaryBackgroundColor { background-color: #ECEFF5; }.echo-primaryColor { color: #3A3A3A; }.echo-secondaryColor { color: #C6C6C6; }.echo-primaryFont { font-family: Arial, sans-serif; font-size: 12px; font-weight: normal; line-height: 16px; }.echo-secondaryFont { font-family: Arial, sans-serif; font-size: 11px; }.echo-linkColor, .echo-linkColor a { color: #476CB8; }.echo-clickable { cursor: pointer; }.echo-relative { position: relative; }.echo-clear { clear: both; }.echo-image-container.echo-image-position-fill { text-align: center; overflow: hidden; }.echo-image-container.echo-image-position-fill img { max-width: 100%; max-height: 100%; width: auto; height: auto; vertical-align: top; }.echo-image-container.echo-image-position-fill img.echo-image-stretched-horizontally { width: 100%; height: auto; }.echo-image-container.echo-image-position-fill img.echo-image-stretched-vertically { width: auto; height: 100%; }.echo-control-message { padding: 15px 0px; text-align: center; }.echo-control-message-icon { height: 16px; padding-left: 16px; background: no-repeat left center; }.echo-control-message .echo-control-message-icon { padding-left: 21px; height: auto; }.echo-control-message-info { background-image: url({config:cdnBaseURL.sdk-assets}/images/information.png); }.echo-control-message-loading { background-image: url({config:cdnBaseURL.sdk-assets}/images/loading.gif); }.echo-control-message-error { background-image: url({config:cdnBaseURL.sdk-assets}/images/warning.gif); }",Echo.Control._manifest=n}(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.App"))return;Echo.App=Echo.Utils.inherit(Echo.Control),Echo.App.create=Echo.Control.create,Echo.App.manifest=function(e){var t=Echo.App.parent.constructor.manifest.apply(this,arguments);return t.inherits=t.inherits||Echo.App,t},Echo.App.isDefined=Echo.Control.isDefined,Echo.App.prototype.initComponent=function(e){this.destroyComponent(e.id),e.config=e.config||{},this.user&&(e.config.user=this.user),e.config.parent=e.config.parent||this.config.getAsHash(),e.config.parent.components&&delete e.config.parent.components,e.config.plugins=this._mergeSpecsByName(t.extend(!0,[],this.config.get("components."+e.id+".plugins",[])),e.config.plugins||[]),e.config=this._normalizeComponentConfig(t.extend(!0,{},this.config.get("components."+e.id,{}),e.config));var n=Echo.Utils.getComponent(e.component);return this.set("components."+e.id,new n(e.config)),this.getComponent(e.id)},Echo.App.prototype.getComponent=function(e){return this.get("components."+e)},Echo.App.prototype.destroyComponent=function(e){var t=this.getComponent(e);t&&(t.destroy(),this.remove("components."+e))},Echo.App.prototype.destroyComponents=function(e){var n=this;e=e||[];var r=function(n){var r=!1;return t.each(e,function(e,t){if(t===n)return r=!0,!1}),r};t.each(this.components,function(e){r(e)||n.destroyComponent(e)})},Echo.App._merge=Echo.Control._merge,Echo.App._manifest=Echo.Control._manifest,Echo.App.prototype._mergeSpecsByName=function(e){var n=this,r=function(e,n){var r=-1;return t.each(n,function(t,n){if(e.name===n.name)return r=t,!1}),r},i=t.map(Array.prototype.slice.call(arguments,1)||[],function(e){return e});return Echo.Utils.foldl(e,i,function(i){var s=r(i,e);if(!~s){e.push(i);return}i.name===e[s].name&&i.nestedPlugins&&(e[s].nestedPlugins=e[s].nestedPlugins||[],n._mergeSpecsByName(e[s].nestedPlugins,i.nestedPlugins),delete i.nestedPlugins),e[s]=t.extend(!0,{},e[s],i)})},Echo.App.prototype._normalizeComponentConfig=function(e){var n=this;Echo.Utils.foldl(e,this._manifest("config"),function(e,t,r){typeof t[r]=="undefined"&&(t[r]=n.config.get(r))});var r=function(e){return typeof e=="string"?n.substitute({template:e,strict:!0}):t.isPlainObject(e)?Echo.Utils.foldl({},e,function(e,t,n){t[n]=r(e)}):t.isArray(e)?t.map(e,function(e){return r(e)}):e};return r(e)}})(Echo.jQuery);
(function(e){"use strict";var t=e;if(Echo.Utils.isComponentDefined("Echo.Plugin"))return;Echo.Plugin=function(){},Echo.Plugin.create=function(e){var n=Echo.Plugin.getClass(e.name,e.component.name);if(n)return n;var r=Echo.Utils.inherit(Echo.Plugin,function(t){if(!t||!t.component){Echo.Utils.log({type:"error",component:e.name,message:"Unable to initialize plugin, config is invalid",args:{config:t}});return}this.name=e.name,this.component=t.component,this.cssClass=this.component.get("cssPrefix")+"plugin-"+e.name,this.cssPrefix=this.cssClass+"-",this.component.config.get("target").addClass(this.cssClass),this._init(["config"])}),i=Echo.Plugin._getClassName(e.name,e.component.name);return r.manifest=e,r.dependencies=e.dependencies,r.prototype.namespace=i,Echo.Labels.set(t.extend({},e.labels),i,!0),e.methods&&t.extend(r.prototype,e.methods),Echo.Utils.set(window,i,r),r},Echo.Plugin.manifest=function(e,t){return{name:e,component:{name:t,renderers:{}},config:{},labels:{},events:{},methods:{},renderers:{},templates:{},dependencies:[],enabled:function(){return!0},init:function(){},destroy:function(){}}},Echo.Plugin.isDefined=function(e){if(typeof e=="string"){var t=Echo.Utils.get(window,e);return!!t&&!!t.manifest}return!!Echo.Plugin.getClass(e.name,e.component.name)},Echo.Plugin.getClass=function(e,t){return Echo.Utils.get(window,Echo.Plugin._getClassName(e,t))},Echo.Plugin.prototype.init=function(){this._init(["css","events","subscriptions","labels","renderers","view","launcher"])},Echo.Plugin.prototype.enabled=function(){if(typeof this._enabled=="undefined"){var e=this.config.get("enabled",!0);switch(t.type(e)){case"string":e=e==="true";break;case"function":e=e.call(this)}this._enabled=e&&!!this._manifest("enabled").call(this)}return this._enabled},Echo.Plugin.prototype.set=function(e,t){return Echo.Utils.set(this,e,t)},Echo.Plugin.prototype.get=function(e,t){return Echo.Utils.get(this,e,t)},Echo.Plugin.prototype.remove=function(e){return Echo.Utils.remove(this,e)},Echo.Plugin.prototype.invoke=function(e,t){return Echo.Utils.invoke(e,t||this)},Echo.Plugin.prototype.enable=function(e){e&&this.config.set("enabled",!0),this._enabled=!0},Echo.Plugin.prototype.disable=function(e){e&&this.config.set("enabled",!1),this._enabled=!1},Echo.Plugin.prototype.extendTemplate=function(e,t,n){n&&(n=this.substitute({template:this.invoke(n)})),this.component.extendTemplate.call(this.component,e,t,n)},Echo.Plugin.prototype.parentRenderer=function(){return this.component.parentRenderer.apply(this.component,arguments)},Echo.Plugin.prototype.substitute=function(e){var n=this,r=this._getSubstitutionInstructions();return e.instructions=e.instructions?t.extend(r,e.instructions):r,n.component.substitute(e)},Echo.Plugin.prototype.requestDataRefresh=function(){Echo.Events.publish({topic:"Echo.Control.onDataInvalidate",context:this.component.config.get("context"),global:!1,propagation:!1,data:{}})},Echo.Plugin.prototype.log=function(e){Echo.Utils.log(t.extend(e,{component:this.namespace}))},Echo.Plugin._defineNestedClass=function(e){Echo.Plugin[e]=function(e){this.plugin=e.plugin}},Echo.Plugin.prototype._init=function(){Echo.Control.prototype._init.apply(this,arguments)},Echo.Plugin.prototype._manifest=function(e){var t=Echo.Plugin.getClass(this.name,this.component.name);return t?e?t.manifest[e]:t.manifest:undefined},Echo.Plugin.prototype._initializers={},Echo.Plugin.prototype._initializers.css=function(){if(!this._manifest("css")||Echo.Utils.hasCSS(this.namespace))return;Echo.Utils.addCSS(this.substitute({template:this._manifest("css")}),this.namespace)},Echo.Plugin.prototype._initializers.labels=function(){return new Echo.Labels(this.config.get("labels",{}),this.namespace)},Echo.Plugin.prototype._initializers.config=function(){return new Echo.Plugin.Config({plugin:this})},Echo.Plugin.prototype._initializers.events=function(){return new Echo.Plugin.Events({plugin:this})},Echo.Plugin.prototype._initializers.subscriptions=function(){var e=this;t.each(this._manifest("events"),function(n,r){r=t.isFunction(r)?{handler:r}:r,e.events.subscribe(t.extend({topic:n},r))})},Echo.Plugin.prototype._initializers.renderers=function(){var e=this;t.each(this._manifest("renderers"),function(n,r){e.component.extendRenderer.call(e.component,"plugin-"+e.name+"-"+n,t.proxy(r,e))}),t.each(this._manifest("component").renderers,function(n,r){e.component.extendRenderer.call(e.component,n,t.proxy(r,e))})},Echo.Plugin.prototype._initializers.view=function(){var e=this,t="plugin-"+this.name+"-",n=function(t,n){var r=e.component.get("view");return r[t].apply(r,n)};return{set:function(e,r){n("set",[t+e,r])},get:function(e){return n("get",[t+e])},remove:function(e){typeof e=="string"&&(e=t+e),n("remove",[e])},render:function(e){e&&e.name&&(e.name=t+e.name),n("render",[e])}}},Echo.Plugin.prototype._initializers.launcher=function(){this._manifest("init").call(this)},Echo.Plugin.prototype._getSubstitutionInstructions=function(){var e=this;return{"plugin.label":function(t){return e.labels.get(t,"")},"plugin.class":function(t){return t?e.cssPrefix+t:e.cssClass},"plugin.data":function(t){return"{self:plugins."+e.name+".data."+t+"}"},"plugin.self":function(t){return"{self:plugins."+e.name+"."+t+"}"},"plugin.config":function(t){return e.config.get(t,"")}}},Echo.Plugin._getClassName=function(e,t){return e&&t?t+".Plugins."+e:undefined},Echo.Plugin._defineNestedClass("Config"),Echo.Plugin.Config.prototype.set=function(e,t){this.plugin.component.config.set(this._normalize(e),t)},Echo.Plugin.Config.prototype.get=function(e,t,n){var r=this.plugin.component,i=r.config.get(this._normalize(e),this.plugin._manifest("config")[e]);return typeof i=="undefined"?n?r.config.get(e,t):t:i},Echo.Plugin.Config.prototype.remove=function(e){this.plugin.component.config.remove(this._normalize(e))},Echo.Plugin.Config.prototype.assemble=function(e){var t=this.plugin.component.config,n=this.plugin.component._manifest("config");e=e||{},e.user=this.plugin.component.user,e.parent=t.getAsHash(),e.plugins=(e.plugins||[]).concat(this.plugin.config.get("nestedPlugins",[])),Echo.Utils.foldl(e,n,function(n,r,i){typeof e[i]=="undefined"&&(r[i]=t.get(i))});var r={data:!0,parent:!0},i=new Echo.Configuration(e,this.plugin.config.get(),undefined,r);return i.getAsHash()},Echo.Plugin.Config.prototype._normalize=function(e){return["plugins",this.plugin.name].concat(e?e:[]).join(".")},Echo.Plugin._defineNestedClass("Events"),Echo.Plugin.Events.prototype.publish=function(e){return e.topic=["Plugins",this.plugin.name,e.topic].join("."),this.plugin.component.events.publish(e)},Echo.Plugin.Events.prototype.subscribe=function(e){return e.handler=t.proxy(e.handler,this.plugin),this.plugin.component.events.subscribe(e)},Echo.Plugin.Events.prototype.unsubscribe=function(e){this.plugin.component.events.unsubscribe(e)}})(Echo.jQuery);
(function(e){"use strict";var t=e,n=Echo.Control.manifest("Echo.Canvas");if(Echo.Control.isDefined(n))return;n.init=function(){var e,n,r=this,i=this.config.get("target"),s=t.proxy(this.parent,this);if(i.data("echo-canvas-initialized")){this._error({args:{target:i},code:"canvas_already_initialized"});return}i.data("echo-canvas-initialized",!0);var o=this._getOverrides(i,["id","useSecureAPI","mode"]);t.isEmptyObject(o)||this.config.extend(o),Echo.Loader.isDebug()&&this.config.set("mode","dev");if(!this._isManuallyConfigured()&&!this.config.get("id")){this._error({args:{target:i},code:"invalid_canvas_config"});return}this.config.get("id")&&(e=this._getIds().normalized,n=Echo.Utils.foldl("",["main","unique"],function(t,n){return n+=e[t]?r.get("cssPrefix")+e[t]+" ":""}),i.addClass(n)),this._fetchConfig(function(){var e=r.get("data.backplane");e&&Backplane.init(e),r._loadAppResources(s)})},n.config={id:"",data:{},overrides:{},mode:"prod"},n.vars={apps:[]},n.labels={error_no_apps:"No applications defined for this canvas",error_no_config:"Unable to retrieve Canvas config",error_no_suitable_app_class:"Unable to init an app, no suitable JS class found",error_unable_to_retrieve_app_config:"Unable to retrieve Canvas config from the storage",error_incomplete_app_config:"Unable to init an app, config is incomplete",error_canvas_already_initialized:"Canvas has been initialized already",error_invalid_canvas_config:"Canvas with invalid configuration found"},n.templates.main='<div class="{class:container}"></div>',n.templates.app='<div class="{class:appContainer}"><div class="{class:appHeader}">{data:caption}</div><div class="{class:appBody}"></div></div>',n.destroy=function(){t.map(this.get("apps"),t.proxy(this._destroyApp,this)),this.config.get("target").data("echo-canvas-initialized",!1),Echo.Utils.remove(Echo.Loader.canvasesConfigById,this._getIds().unique)},n.renderers.container=function(e){var n=this;return t.map(this.get("data.apps"),function(t,r){n._initApp(t,e,r)}),e},n.methods._initApp=function(e,n,r){var i=this,s=Echo.Utils.getComponent(e.component);if(!s){this._error({args:{app:e},code:"no_suitable_app_class"});return}e.id=e.id||r,e.config=e.config||{},e.config.canvasId=this.config.get("id");var o=this.view.fork({renderer:null,renderers:{appHeader:function(t){return t[e.caption?"show":"hide"]()},appBody:function(t){var n=i.get("cssPrefix")+"appId-"+e.id;return t.addClass(n)}}});n.append(o.render({data:e,template:this.templates.app})),e.config.target=o.get("appBody");var u=this.config.get("overrides")[e.id],a=u?t.extend(!0,e.config,u):e.config;this.apps.push(new s(a))},n.methods._destroyApp=function(e){e&&t.isFunction(e.destroy)&&e.destroy()},n.methods._isManuallyConfigured=function(){return!t.isEmptyObject(this.get("data"))},n.methods._getAppScriptURL=function(e){if(!e.scripts)return e.script;var t,n={dev:e.scripts.dev||e.scripts.prod,prod:e.scripts.prod||e.scripts.dev}[Echo.Loader.isDebug()?"dev":"prod"];return typeof n=="string"?n:(t=/^https/.test(window.location.protocol),n[t?"secure":"regular"])},n.methods._loadAppResources=function(e){var n=this,r=[],i=this._isManuallyConfigured();t.map(this.get("data.apps"),function(e){var t=n._getAppScriptURL(e);if(!e.component||!t||!i&&!e.id){n._error({args:{app:e},code:"incomplete_app_config"});return}r.push({url:t,loaded:function(){return Echo.Control.isDefined(e.component)}})}),Echo.Loader.download(r,e)},n.methods._getOverrides=function(e,t){return Echo.Utils.foldl({},t||[],function(t,n){var r="canvas-"+t.toLowerCase(),i=e.data(r);typeof i!="undefined"&&(n[t]=i)})},n.methods._error=function(e){e.message=e.message||this.labels.get("error_"+e.code),Echo.Events.publish({topic:"Echo.Canvas.onError",data:e}),Echo.Utils.log(t.extend(e,{type:"error",component:"Echo.Canvas"})),e.renderError&&this.showMessage({type:"error",message:e.message})},n.methods._getIds=function(){var e=this.config.get("id"),t=e.split("#"),n=function(e){return e.replace(/[^a-z\d]/ig,"-")};return{unique:e,main:t[0],normalized:{unique:n(e),main:n(t[0])}}},n.methods._fetchConfig=function(e){var n=this,r=this.config.get("target"),i=this._isManuallyConfigured();if(i){e.call(this);return}var s=this.config.get("mode"),o=function(){return Echo.Loader.canvasesConfigById[n._getIds().unique]},u=Echo.Utils.parseURL(Echo.Loader.config.storageURL[s]),a=this.substitute({template:"{data:scheme}://{data:domain}{data:path}{data:endpoint}",data:t.extend(u,{endpoint:this._getIds().main,scheme:this.config.get("useSecureAPI")?"https":u.scheme||"http"})});t.ajax({url:a,crossDomain:!0,dataType:"script",cache:s!=="dev",timeout:Echo.Loader.config.errorTimeout,success:function(){var t=o();if(!t||!t.apps||!t.apps.length){var i=n.labels.get("error_no_"+(t?"apps":"config"));n._error({args:{config:t,target:r},code:"invalid_canvas_config",message:i});return}n.set("data",t),e.call(n)},error:function(){n._error({args:arguments,code:"unable_to_retrieve_app_config",renderError:!0})}})},Echo.Control.create(n)})(Echo.jQuery);