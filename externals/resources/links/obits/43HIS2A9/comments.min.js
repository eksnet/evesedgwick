if(!window.RealTidbits)window.RealTidbits={};if(!window.RealTidbits.settings)window.RealTidbits.settings={};(function(jQuery){"use strict";var $=jQuery;var Comments=Echo.App.manifest("RTB.Apps.Comments");if(Echo.App.isDefined("RTB.Apps.Comments"))return;Comments.dependencies=[{"url":"{config:cdnBaseURL.sdk}/streamserver.pack.js","control":"Echo.StreamServer.Controls.Stream"},{"url":"{config:cdnBaseURL.sdk}/identityserver.pack.js","control":"Echo.IdentityServer.Controls.Auth"},{"url":"{config:cdnBaseURL.RTB}/comments/plugin-submit.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbCommentsSubmitPlugin"},{"url":"{config:cdnBaseURL.RTB}/comments/plugin-stream.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbCommentsStreamPlugin"},{"url":"{config:cdnBaseURL.RTB}/comments/plugins.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbCommentsEdit"},{"url":"{config:cdnBaseURL.RTB}/plugin-stream-sorting.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbStreamSortingSelector"},{"url":"{config:cdnBaseURL.RTB}/plugin-rss.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbStreamRSS"},{"url":"{config:cdnBaseURL.RTB}/plugin-email-subscribe.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitEmailSubscribe"},{"url":"{config:cdnBaseURL.RTB}/plugin-media-upload.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitAttachMedia"},{"url":"{config:cdnBaseURL.RTB}/plugin-tokbox.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitTokbox"},{"url":"{config:cdnBaseURL.RTB}/plugin-inline-media.js","plugin":"Echo.StreamServer.Controls.Stream.Item.Plugins.rtbStreamInlineMedia"},{"url":"{config:cdnBaseURL.RTB}/plugin-social-sharing.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbSocialSharing"},{"url":"{config:cdnBaseURL.RTB}/plugin-media-resolver.js","plugin":"Echo.StreamServer.Controls.Submit.Plugins.rtbMediaResolverSubmit"},{"url":"{config:cdnBaseURL.RTB}/plugin-markup.js","plugin":"Echo.StreamServer.Controls.Stream.Item.Plugins.rtbMarkup"},{"url":"{config:cdnBaseURL.RTB}/plugin-comments-widget.js","plugin":"Echo.StreamServer.Controls.Stream.Item.Plugins.rtbWidgetCommentsPlugin"},{"url":"{config:cdnBaseURL.RTB}/plugin-viewport.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbStreamViewport"},{"url":"{config:cdnBaseURL.RTB}/plugin-gofundme.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.rtbGoFundMe"},{"url":"{config:cdnBaseURL.RTB}/plugins/jquery.ba-postmessage.min.js"},{"url":"{config:cdnBaseURL.RTB}/plugins/email-auth.js","plugin":"Echo.IdentityServer.Controls.Auth.Plugins.rtbEmailUserAuth"},{"url":"{config:cdnBaseURL.RTB}/partners/items-rolling-window.js","plugin":"Echo.StreamServer.Controls.Stream.Plugins.ItemsRollingWindow"},{"url":"{config:cdnBaseURL.RTB}/app-user-profile.js","app":"RTB.Apps.UserProfile"},{"url":"{config:cdnBaseURL.RTB}/app-page-like.js","app":"RTB.Apps.PageLike"},{"url":"{config:cdnBaseURL.RTB}/analytics.js","loaded":function(){return!!(RealTidbits&&RealTidbits.Analytics);}},{"url":"{config:cdnBaseURL.RTB}/utils.js","loaded":function(){return!!(RTB&&RTB.Utils);}},{"url":"{config:cdnBaseURL.sdk}/gui.pack.js","loaded":function(){return!!Echo.GUI;}},{"url":"{config:cdnBaseURL.sdk}/gui.pack.css","loaded":function(){return!!Echo.GUI;}},{"url":"{config:cssURL}"}];if(typeof cdnBaseUrlRTB=="undefined"){var cdnBaseUrlRTB=(window.location.protocol==="https:"?"https://ssl.":"http://cdn.")+"realtidbits.com/libs/v3";};Comments.config={"cdnBaseURL":{"RTB":cdnBaseUrlRTB},"components":{"Stream":{"flashColor":"transparent","item":{"reTag":false,"viaLabel":{"icon":true,"text":false},"contentTransformations":{"text":["urls","newlines"],"html":["urls","newlines"],"xhtml":["urls"]}},"plugins":[],"state":{"label":{"icon":false,"text":false},"toggleBy":"mouseover","layout":"compact"},"useSecureAPI":true},"Submit":{"actionString":"Leave a comment...","plugins":[],"useSecureAPI":true}},"cssURL":cdnBaseUrlRTB+"/comments/comments.min.css","labels":{},"settings":{"attachMedia":{"enabled":true},"auth":{"formAuth":true,"loginButton":true,"loginTerms":{"text":null},"submitPermissions":"forceLogin","emailLogin":false},"emailSubscribe":{"enabled":true},"inlineMedia":{"enabled":true,"showVideoModal":false},"mediaResolver":{"enabled":true},"pageLike":{"enabled":true},"plugins":{"formAuth":[],"reply":[],"stream":[],"submit":[],"topcomments":[]},"sharing":{"enabled":true},"submit":{"readOnly":false,"textLimit":500,"metaInputs":false,"textileMarkup":true,"showControlButtons":true,"render":"compact","waitToPost":true,"minChars":6,"allowedTags":[]},"stream":{"childrenItemsPerPage":3,"childrenSortOrder":"reverseChronological","bozoFilter":false,"itemsPerPage":(jQuery.support.leadingWhitespace==false?5:10),"permalinks":true,"preModeration":false,"replyLevels":2,"streamQueryURLs":[],"queryParams":{"mainDefault":{"source":"-source:Twitter,Facebook","bozo":true,"premod":true,"type":"type:'http://activitystrea.ms/schema/1.0/comment'","markers":"-markers:topcomment"},"main":{},"topcomments":{"itemsPerPage":2,"markers":"markers:'topcomment'","children":"children:0","childrenItemsPerPage":"childrenItemsPerPage:0"},"topcomments2":{"itemsPerPage":2,"sortOrder":"sortOrder:likesDescending","children":"children:0","childrenItemsPerPage":"childrenItemsPerPage:0"}},"defaultAvatar":"//cdn.echoenabled.com/sdk/v3/images/avatar-default.png","transport":"polling","flag":true,"showFlagIcon":true,"showToggleIcon":true,"removePersonalItemsAllowed":true,"moderation":true,"sanitize":false,"noUserPopover":false},"tabs":{"social":false,"community":true},"community":{"pages":5},"tokbox":{"enabled":false},"topComments":{"enabled":false,"automatic":false,"threshold":25},"viewport":{"enabled":true},"poll":{"enabled":true},"goFundMe":{"enabled":false,"url":""}},"source":{"uri":document.location.protocol+"//"+window.location.hostname},"submissionProxyURL":document.location.protocol+"//apps.echoenabled.com/v2/esp/activity","targetURL":$('head').find("link[rel='canonical']").attr('href')||location.href.split("#")[0],"streamQuery":null,"useSecureAPI":true,"inlineUserProfileStreamQuery":null};Comments.labels={"commentSubmitTitle":"","tabDiscussion":"Comments","tabReactions":"Social","tabCommunity":"Community","streamHeaderTopComments":"Top Comments","streamHeaderAllComments":"All Comments","modalTitleCommentPermalink":"Comment","alertMustLoginTitle":"Oops!","alertMustLoginMsg":"Please login to post a comment.","alertPreModTitle":"Pre-Moderation Mode","alertPreModMsg":"Comments must be approved by a moderator.","alertNoTextTitle":"Oops!","alertNoTextMsg":"Please enter some text.","alertWaitToPost":"Please wait a few seconds before you post again.","alertMinText":"Please enter at least %CHARS% characters.","labelMark":"Mark Top Comment","labelUnmark":"Unmark Top Comment","communityPopularDiscussions":"Popular Discussions on","recentCommentors":"Recent Participants","idManagerTitle":"Login with:","submitActionString":"Leave a comment...","replyActionString":"Leave a reply..."};Comments.methods.setTargetURL=function(targetURL){var app=this;app.config.set("targetURL",targetURL);var _submit=app.get("_submit");_submit.config.set("targetURL",targetURL);_submit.refresh();};Comments.methods.setTargetQuery=function(queryURLs){var app=this;app.setTargetURL(queryURLs[0]);app.setQueryURLs(queryURLs);app.config.set("targetURL",queryURLs[0]);app.render();};Comments.methods.setQueryURLs=function(queryURLs){var app=this;app.config.set("settings.stream.streamQueryURLs",queryURLs);app.setStreamQuery(this.getQuery({"bozo":true,"premod":true}));};Comments.methods.setStreamQuery=function(query){var app=this;var stream=app.config.get("_stream");stream.config.set("query",query);stream.refresh();};Comments.methods.getQuery=function(params){var params=params||{};var app=this;if(typeof params.state!="undefined"){var defaultState=params.state;var defaultChildrenState=params.state;}else{var defaultState='state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved';var defaultChildrenState='state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved';};var streamQueryURLs=this.config.get("settings.stream.streamQueryURLs");var childrenofUrls="(";$.map(streamQueryURLs,function(x,i){childrenofUrls+="childrenof:'"+streamQueryURLs[i]+"'";if(streamQueryURLs.length!=i+1)childrenofUrls+=" OR ";});childrenofUrls+=") ";var premod="";if(params.premod==true&&this.config.get("settings.stream.preModeration")==true){premod+='(user.id:'+Echo.UserSession.get("identityUrl")+' '+childrenofUrls+' '+defaultState+') OR ';defaultState='state:ModeratorApproved user.state:Untouched,ModeratorApproved';defaultChildrenState=defaultState;};var bozo="";if(params.bozo==true&&this.config.get("settings.stream.bozoFilter")==true&&this.user.is("logged")&&this.config.get("settings.stream.preModeration")==false){defaultState="((user.id:'"+Echo.UserSession.get("identityUrl")+"' -state:SystemFlagged,CommunityFlagged,ModeratorFlagged,UserDeleted) OR ("+defaultState+")) ";};if(app.config.get("settings.auth.submitPermissions")=="forceLogin"&&!("source"in params)){defaultState+=' -user.id:http://js-kit.com/ECHO/user/fake_user ';};var query=''
+premod
+childrenofUrls
+("type"in params?params.type:'')+' '
+'itemsPerPage:'+("itemsPerPage"in params?params.itemsPerPage:this.config.get("settings.stream.itemsPerPage"))+' '
+("source"in params?params.source:'')+' '
+("markers"in params?params.markers:'')+' '
+("filter"in params?params.filter:'')+' '
+("after"in params?params.after:'')+' '
+("sortOrder"in params?params.sortOrder:'sortOrder:reverseChronological')+' '
+' '+defaultState
+' safeHTML:permissive'+' '
+("children"in params?params.children:'children:'+this.config.get("settings.stream.replyLevels")+' ')+' '
+("children"in params&&params.children=="children:0"?'':defaultChildrenState)+' '
+("childrenItemsPerPage"in params?params.childrenItemsPerPage:'childrenItemsPerPage:'+this.config.get("settings.stream.childrenItemsPerPage"))+' '
+' childrenSortOrder:'+this.config.get("settings.stream.childrenSortOrder")+' '
+'';return query;};Comments.templates.main='<div class="{class:container}">'+'<div class="{class:alertMessages}"></div>'+'<div class="{class:appHeader} clearfix">'+'</div>'+'<div class="{class:submit}"></div>'+'<div class="{class:streamHeader} clearfix">'+'<div class="{class:streamNav}">'+'<div class="stream-sort-wrapper pull-right"></div>'+'<ul class="nav nav-tabs">'+'<li class="active" data-value="discussion"><a href="javascript:void(0);">{label:tabDiscussion} (<span class="{class:commentsCount}">0</span>)<span class="tabDiscussionCaret"></span></a></li>'+'<li data-value="reactions" class="{class:tabReactions}"><a href="javascript:void(0);">{label:tabReactions} (<span class="{class:reactionsCount}">0</span>)</a></li>'+'<li data-value="community"><a href="javascript:void(0);">{label:tabCommunity}</a></li>'+'</ul>'+'</div>'+'</div>'+'<div class="{class:streamWrapper}">'+'<div class="{class:streamTopComments}" style="display:none;"></div>'+'<div class="{class:stream}"></div>'+'</div>'+'<div class="{class:streamAlternate}"></div>'+'</div>';Comments.renderers.streamNav=function(element){var app=this;if(app.config.get("settings.tabs.social")==false){element.find(".nav-tabs li:eq(1)").hide();};if(app.config.get("settings.tabs.community")==false){element.find(".nav-tabs li:eq(2)").hide();};var _c=app.get("_streamsToDestroy",[]);element.find(".nav-tabs li").click(function(){element.find(".nav-tabs li").removeClass("active");$(this).addClass("active");$(this).find("a").blur();var tab=$(this).data("value");var caret=app.view.get("streamNav").find(".tabDiscussionCaret");if(app.get("_currentTab")==tab)return;$.map(_c,function(e,i){e.destroy();});switch(tab){case'discussion':caret.show();app.view.get("streamWrapper").show();app.view.get("streamAlternate").empty();break;case'reactions':caret.hide();app.view.get("streamWrapper").hide();app.view.get("streamAlternate").empty();var s=app.initComponent({"id":"StreamSocialTab","component":"Echo.StreamServer.Controls.Stream","config":{"target":app.view.get("streamAlternate"),"useSecureAPI":app.config.get("useSecureAPI"),"submissionProxyURL":app.config.get("submissionProxyURL"),"apiBaseURL":app.config.get("apiBaseURL"),"query":app.getQuery({"source":"source:Twitter,Facebook","children":"children:2"}),"liveUpdates":{"enabled":false,"polling":{"timeout":999},"transport":app.config.get("settings.stream.transport")},"plugins":[{"name":"ItemsRollingWindow","moreButton":true},{"name":"TwitterIntents"},{"name":"rtbStreamInlineMedia"},{"name":"Moderation","removePersonalItemsAllowed":app.config.get("settings.stream.removePersonalItemsAllowed")},{"name":"CommunityFlag","showUserList":true}],"flashColor":"transparent","item":{"reTag":false,"viaLabel":{"icon":true,"text":false},"contentTransformations":{"text":["urls","newlines"],"html":["urls","newlines"],"xhtml":["urls"]}},"state":{"label":{"icon":false,"text":false},"toggleBy":"mouseover","layout":"compact"}}});_c.push(s);break;case'community':caret.hide();app.view.get("streamWrapper").hide();app.view.get("streamAlternate").empty();var divTopComments=$('<div class="tab-community-wrapper clearfix"></div>');var tt=$('<div class="tab-community-column1"></div>');var tt2=$('<div class="tab-community-column2"></div>');divTopComments.append(tt).append(tt2);tt.append($('<div class="tab-community-title">'+app.labels.get("communityPopularDiscussions")+" "+RTB.Utils.getDomain(app.config.get("targetURL"))+'</div>'));var tt2_1=$('<div class="tab-community-column2-wrapper"></div>');tt2_1.append($('<div class="tab-community-title">'+app.labels.get("recentCommentors")+'</div>'));tt2.append(tt2_1);var tt2_2=$('<div></div>');tt2_1.append(tt2_2);app.view.get("streamAlternate").append(divTopComments);var facePile=app.initComponent({"id":"CommunityFacePile","component":"Echo.StreamServer.Controls.FacePile","config":{"target":tt2_2,"appkey":app.config.get("appkey"),"apiBaseURL":app.config.get("apiBaseURL"),"liveUpdates":{"enabled":true,"transport":app.config.get("settings.stream.transport")},"useSecureAPI":app.config.get("useSecureAPI"),"query":app.getQuery({"itemsPerPage":100}),"item":{"avatar":true,"text":false,"targetURL":app.config.get("targetURL")},"actorCommentQuery":"childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive","plugins":[{"name":"rtbFacepileUserProfiles","placement":"right","handler":function(actor){app.openModalItem("user.id:"+actor.id+" childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 children:0",actor.title);}}]}});var facePile=new Echo.StreamServer.Controls.FacePile({"target":tt2_2,"appkey":app.config.get("appkey"),"apiBaseURL":app.config.get("apiBaseURL"),"useSecureAPI":app.config.get("useSecureAPI"),"liveUpdates":{"enabled":true,"transport":app.config.get("settings.stream.transport")},"query":app.getQuery({"itemsPerPage":100}),"item":{"avatar":true,"text":false},"plugins":[{"name":"rtbFacepileUserProfiles","placement":"right","handler":function(actor){app.openModalItem("user.id:"+actor.id+" childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 children:0",actor.title);}}]});_c.push(facePile);var request=Echo.StreamServer.API.request({"endpoint":"search","apiBaseURL":app.config.get("apiBaseURL"),"data":{"q":"childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/RTB/pages/*' sortOrder:likesDescending itemsPerPage:100 -state:ModeratorDeleted children:0","appkey":app.config.get("appkey")},"liveUpdatesTimeout":999,"secure":app.config.get("useSecureAPI"),"recurring":false,"onError":function(data,extra){},"onData":function(data,extra){var items=data.entries;var _arrayUrls=[];if(items.length>0){$.map(items,function(x,i){var item=items[i];var marker=RTB.Utils.getMarker("permalink",item.object.markers,false);if(!marker)return;var stats=item.object.accumulators;var likesCount=(stats&&stats.likesCount?stats.likesCount:0);var contextUrl=marker;contextUrl=contextUrl.replace('www.','');if($.inArray(contextUrl,_arrayUrls)>-1)return;if(_arrayUrls.length>=app.config.get("settings.community.pages"))return;_arrayUrls.push(contextUrl);var itemContent=$('<span>'+item.object.content+'</span>');var contextTitle=itemContent.find("div:eq(0)").html();var contextDesc=itemContent.find("div:eq(1)").html();var contentItem=$('<div class="stream-community-page-item"><blockquote>'+'<div class="stream-community-page-item-title">'+'<a href="'+contextUrl+'">'+contextTitle+'</a>'+'</div>'+'<div class="stream-community-page-item-desc">'+contextDesc+'</div>'+'<div class="stream-community-page-item-likes"><span>'+likesCount+'</span> <span class="icon-rtb-star-comment"></span></div>'+'</blockquote></div>');tt.append(contentItem);});};}});request.send();break;};app.set("_currentTab",tab);app.set("_streamsToDestroy",_c);});};Comments.renderers.commentsCount=function(element){var app=this;Echo.StreamServer.API.request({"endpoint":"count","apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":(app.config.get("streamQuery")?app.config.get("streamQuery"):app.getQuery(app.config.get("settings.stream.queryParams.main"))),"appkey":this.config.get("appkey")},"secure":this.config.get("useSecureAPI"),"liveUpdatesTimeout":60,"recurring":true,"onError":function(data,extra){if(data.errorMessage===5000){var count="5000+";element.html(count);};},"onData":function(data,extra){if(data.count){var count=parseInt(data.count);}else if(data.errorMessage===5000){var count="5000+";};element.html(count);if(app.config.get("settings.topComments.enabled")==true){if(app.get("isTopCommentsRendered")==true){}else{var tt=app.view.get("streamTopComments");app.streamTopComments(tt);app.set("isTopCommentsRendered",true);};};app.events.publish({"topic":"onCommentCount","data":{"repliesCount":count,"rsp":data,"el":element}});}}).send();};Comments.renderers.reactionsCount=function(element){var app=this;if(app.config.get("settings.tabs.social")==false){return;};Echo.StreamServer.API.request({"endpoint":"count","apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":app.getQuery({"source":"source:Twitter,Facebook","children":"children:0"}),"appkey":this.config.get("appkey")},"secure":this.config.get("useSecureAPI"),"liveUpdatesTimeout":999999,"recurring":false,"onError":function(data,extra){app.doReactionCount(data,element);},"onData":function(data,extra){app.doReactionCount(data,element);}}).send();};Comments.methods.doReactionCount=function(data,element){if(data.count){var count=parseInt(data.count);}else if(data.errorMessage===5000){var count="5000+";}else{var count=null;};element.html(count);if(!count||count==0){element.parent().parent().hide();}else{element.parent().parent().show();};};Comments.renderers.stream=function(element){var app=this;var plugins=[];if(app.config.get("settings.stream.sanitize")==true){plugins.push({"name":"rtbStreamSanitize","allowedTags":this.config.get("settings.submit.allowedTags")});};plugins.push(app.pluginEnabled("settings.inlineMedia.enabled","rtbStreamInlineMedia"));plugins.push(app.pluginEnabled("settings.goFundMe.enabled","rtbGoFundMe",{"rtbCommentsApp":app,"url":app.config.get("settings.goFundMe.url")}));plugins=plugins.concat([{"name":"ItemsRollingWindow","moreButton":true},{"name":"Edit","nestedPlugins":[{"name":"rtbCommentsEdit"}]},{"name":"rtbCommentsStreamPlugin"},{"name":"rtbCommentsStreamPermalinkPlugin","app":this},{"name":"rtbCommentsStreamPluginItem","app":this,"noUserPopover":app.config.get("settings.stream.noUserPopover")},{"name":"rtbStreamItemTokbox"},{"name":"rtbStreamSortingSelector","origQuery":(app.config.get("streamQuery")?app.config.get("streamQuery"):app.getQuery(app.config.get("settings.stream.queryParams.main"))),"target":this.view._elements["rtb-apps-comments-streamHeader"].find(".tabDiscussionCaret"),"events":{"onQueryChange":function(stream,sortOrder,markers,after,source){var a=app.config.get("settings.stream.queryParams.main");var b=jQuery.extend({},a);b.sortOrder=sortOrder;b.markers=b.markers+" "+markers;b.after=after;if(source!=null)b.source=source;if(app.config.get("streamQuery")){b=app.config.get("streamQuery")+' '+sortOrder+' '+markers+' '+after;if(source!=null)b+=' '+source;stream.config.set("query",b);}else{stream.config.set("query",app.getQuery(b));}
stream.refresh();},"onChange":function(idx,value){var elTopComments=app.view.get("streamTopComments");if(idx==0){if(elTopComments.data("hasItems")==1){elTopComments.show();};}else{elTopComments.hide();};}}},{"name":"rtbStreamEmailSubscribe","renderButton":false},{"name":"rtbStreamRSS","renderButton":false}]);if(app.config.get("settings.stream.moderation")==true){plugins.push({"name":"Moderation","removePersonalItemsAllowed":app.config.get("settings.stream.removePersonalItemsAllowed")});};if(app.config.get("settings.stream.flag")==true){plugins.push({"name":"CommunityFlag","showUserList":true});};var nestedLikePlugins=[{"name":"Facepile","nestedPlugins":[{"name":"rtbFacepileUserProfiles"}]}];if(this.config.get("settings.plugins.like"))
$.merge(nestedLikePlugins,this.config.get("settings.plugins.like"));plugins.push({"name":"Like","nestedPlugins":nestedLikePlugins,"item":{"defaultAvatar":this.config.get("settings.stream.defaultAvatar")}});if(app.config.get("settings.topComments.enabled")==true){plugins.push({"name":"rtbCommentsStreamTitle","title":app.labels.get("streamHeaderAllComments")});plugins.push({"name":"MetadataManager","controls":[{"marker":"topcomment","labelMark":app.labels.get("labelMark"),"labelUnmark":app.labels.get("labelUnmark")}]});};if(app.config.get("settings.viewport.enabled")==true){plugins.push({"name":"rtbStreamViewport","target":this.config.get("target"),"RTBurl":this.config.get("cdnBaseURL.RTB")})};if(app.config.get("settings.sharing.enabled")==true){plugins.push({"name":"rtbSocialSharing","appName":this.config.get("janrain.app"),"appUrl":this.config.get("janrain.appUrl")});plugins.push({"name":"rtbSocialSharingStreamItem","appName":this.config.get("janrain.app"),"appUrl":this.config.get("janrain.appUrl")});};var nestedPluginsFormAuth=[];if(app.config.get("settings.auth.formAuth")){nestedPluginsFormAuth.push({"name":"rtbCommentsFormAuthPlugin","app":this});}
if(app.config.get("settings.auth.trackIP"))nestedPluginsFormAuth.push({"name":"rtbTrackIP","app":app});if(app.config.get("settings.auth.emailLogin"))nestedPluginsFormAuth.push({"name":"rtbEmailUserAuth"});$.merge(nestedPluginsFormAuth,app.config.get("settings.plugins.formAuth"));var replyPluginNested=[{"name":"FormAuth","submitPermissions":this.config.get("settings.auth.submitPermissions"),"identityManager":this.config.get("identityManager"),"nestedPlugins":nestedPluginsFormAuth},{"name":"rtbSubmitSanitize","allowedTags":this.config.get("settings.submit.allowedTags")},{"name":"rtbCommentsSubmitPlugin","app":this,"isReply":true,"targetURL":this.config.get("targetURL"),"showControlButtons":this.config.get("settings.submit.showControlButtons"),"submitPermissions":this.config.get("settings.auth.submitPermissions"),"render":this.config.get("settings.submit.render"),"waitToPost":this.config.get("settings.submit.waitToPost")}];replyPluginNested.push(app.pluginEnabled("settings.attachMedia.enabled","rtbSubmitAttachMedia",{"cdnBaseURL":this.config.get("cdnBaseURL")}));replyPluginNested.push(app.pluginEnabled("settings.mediaResolver.enabled","rtbMediaResolverSubmit"));replyPluginNested.push(app.pluginEnabled("settings.tokbox.enabled","rtbSubmitTokbox"));replyPluginNested.push(app.pluginEnabled("settings.poll.enabled","SlimSurveys",{"url":"https://8a894ed82966de594302-db6813f2295a29da7ae1834f8bc01832.ssl.cf1.rackcdn.com/rtb/plugin.slimsurveys.min.js"}));replyPluginNested.push(app.pluginEnabled("settings.emailSubscribe.enabled","rtbSubmitEmailSubscribe"));$.merge(replyPluginNested,this.config.get("settings.plugins.reply"));if(app.config.get("settings.submit.readOnly")!=true){plugins.push({"name":"Reply","actionString":this.labels.get("replyActionString"),"nestedPlugins":replyPluginNested});};plugins.push(app.pluginEnabled("settings.poll.enabled","SlimSurveysItems",{"url":"https://8a894ed82966de594302-db6813f2295a29da7ae1834f8bc01832.ssl.cf1.rackcdn.com/rtb/plugin.slimsurveys.min.js"}));var pluginsStream=app.config.get("settings.plugins.stream");for(var key in pluginsStream){pluginsStream[key]["rtbCommentsApp"]=app;}
$.merge(plugins,pluginsStream);var cfgStreamItem={"submissionProxyURL":app.config.get("submissionProxyURL"),"defaultAvatar":this.config.get("settings.stream.defaultAvatar")};$.extend(cfgStreamItem,app.config.get("components.Stream.item"));var stream=this.initComponent({"id":"Stream","component":"Echo.StreamServer.Controls.Stream","config":{"target":element,"apiBaseURL":app.config.get("apiBaseURL"),"useSecureAPI":app.config.get("useSecureAPI"),"submissionProxyURL":app.config.get("submissionProxyURL"),"query":(app.config.get("streamQuery")?app.config.get("streamQuery"):app.getQuery(app.config.get("settings.stream.queryParams.main"))),"plugins":plugins,"liveUpdates":{"enabled":true,"polling":{"timeout":60},"transport":app.config.get("settings.stream.transport")},"item":cfgStreamItem}});this.config.set("_stream",stream);return element;};Comments.methods.pluginEnabled=function(coreConfig,plugin,data){var app=this;if(app.config.get(coreConfig)==true){var p={"name":plugin};$.extend(p,app.config.get(coreConfig));if(data)$.extend(p,data);return p;};return{};};Comments.methods.streamTopComments=function(element){var app=this;if(this.config.get("settings.topComments.automatic")==false){var q=this.getQuery(app.config.get("settings.stream.queryParams.topcomments"));}else{var q=this.getQuery(app.config.get("settings.stream.queryParams.topcomments2"));};var plugins=[{"name":"Edit","nestedPlugins":[{"name":"rtbCommentsEdit"}]},{"name":"rtbCommentsStreamPlugin"},{"name":"rtbCommentsStreamPluginItem","app":this,"showVideoModal":app.config.get("settings.media.showVideoModal"),"noUserPopover":app.config.get("settings.stream.noUserPopover")},{"name":"rtbStreamItemTokbox"},{"name":"rtbCommentsStreamTitle","title":this.labels.get("streamHeaderTopComments"),"noMore":true},{"name":"rtbCommentsStreamTopComments","app":this,"target":element},{"name":"rtbCommentsStreamTopCommentsItem","app":this,"target":element}];if(app.config.get("settings.stream.moderation")==true){plugins.push({"name":"Moderation","removePersonalItemsAllowed":app.config.get("settings.stream.removePersonalItemsAllowed")});};var nestedLikePlugins=[{"name":"Facepile","plugins":[{"name":"rtbFacepileUserProfiles"}]}];if(this.config.get("settings.plugins.like"))
$.merge(nestedLikePlugins,this.config.get("settings.plugins.like"));plugins.push({"name":"Like","nestedPlugins":nestedLikePlugins,"item":{"defaultAvatar":this.config.get("settings.stream.defaultAvatar")}});plugins.push(app.pluginEnabled("settings.poll.enabled","SlimSurveysItems",{"url":"https://8a894ed82966de594302-db6813f2295a29da7ae1834f8bc01832.ssl.cf1.rackcdn.com/rtb/plugin.slimsurveys.min.js"}));if(app.config.get("settings.topComments.enabled")==true){plugins.push({"name":"MetadataManager","controls":[{"marker":"topcomment","labelMark":app.labels.get("labelMark"),"labelUnmark":app.labels.get("labelUnmark")}]});};plugins.push(app.pluginEnabled("settings.submit.textileMarkup","rtbMarkup"));plugins.push(app.pluginEnabled("settings.inlineMedia.enabled","rtbStreamInlineMedia"));if(app.config.get("settings.plugins.topcomments"))
$.merge(plugins,app.config.get("settings.plugins.topcomments"));var stream=this.initComponent({"id":"StreamTopComments","component":"Echo.StreamServer.Controls.Stream","config":{"cdnBaseURL":this.config.get("cdnBaseURL"),"apiBaseURL":app.config.get("apiBaseURL"),"useSecureAPI":app.config.get("useSecureAPI"),"submissionProxyURL":app.config.get("submissionProxyURL"),"target":element,"flashColor":"transparent","infoMessages":{"enabled":false},"liveUpdates":{"enabled":true,"polling":{"timeout":60},"transport":app.config.get("settings.stream.transport")},"item":{"reTag":false,"viaLabel":{"icon":true,"text":false},"contentTransformations":{"text":["urls","newlines"],"html":["urls","newlines"],"xhtml":["urls"]},"defaultAvatar":this.config.get("settings.stream.defaultAvatar")},"query":q,"state":{"label":{"icon":false,"text":false}},"plugins":plugins}});return element;};Comments.renderers.submit=function(element){var app=this;var app=this;var plugins=[];plugins.push({"name":"TextCounter","limit":app.config.get("settings.submit.textLimit")});plugins.push({"name":"rtbSubmitSanitize","allowedTags":app.config.get("settings.submit.allowedTags")});plugins.push(app.pluginEnabled("settings.attachMedia.enabled","rtbSubmitAttachMedia",{"rtbCDN":this.config.get("cdnBaseURL.RTB")}));plugins.push(app.pluginEnabled("settings.mediaResolver.enabled","rtbMediaResolverSubmit"));plugins.push(app.pluginEnabled("settings.tokbox.enabled","rtbSubmitTokbox"));plugins.push(app.pluginEnabled("settings.poll.enabled","SlimSurveys",{"url":"https://8a894ed82966de594302-db6813f2295a29da7ae1834f8bc01832.ssl.cf1.rackcdn.com/rtb/plugin.slimsurveys.min.js"}));plugins.push(app.pluginEnabled("settings.emailSubscribe.enabled","rtbSubmitEmailSubscribe"));plugins.push({"name":"rtbCommentsSubmitPlugin","app":this,"showControlButtons":this.config.get("settings.submit.showControlButtons"),"submitPermissions":this.config.get("settings.auth.submitPermissions"),"render":this.config.get("settings.submit.render"),"waitToPost":this.config.get("settings.submit.waitToPost")});var nestedPluginsFormAuth=[];if(app.config.get("settings.auth.formAuth")){nestedPluginsFormAuth.push({"name":"rtbCommentsFormAuthPlugin","app":this});}
if(app.config.get("settings.auth.trackIP"))nestedPluginsFormAuth.push({"name":"rtbTrackIP","app":app});if(app.config.get("settings.auth.emailLogin"))nestedPluginsFormAuth.push({"name":"rtbEmailUserAuth"});$.merge(nestedPluginsFormAuth,app.config.get("settings.plugins.formAuth"));var formAuthPlugin={"name":"FormAuth","submitPermissions":this.config.get("settings.auth.submitPermissions"),"identityManager":this.config.get("identityManager"),"nestedPlugins":nestedPluginsFormAuth};if(app.config.get("settings.auth.loginTerms.text")!=null){formAuthPlugin.nestedPlugins.push({"name":"rtbLoginTerms","text":app.config.get("settings.auth.loginTerms.text")});};plugins.push(formAuthPlugin);$.merge(plugins,app.config.get("settings.plugins.submit"));var targetURL=this.config.get("targetURL");var submitConfig={"plugins":plugins,"target":element,"targetURL":targetURL,"useSecureAPI":app.config.get("useSecureAPI"),"submissionProxyURL":app.config.get("submissionProxyURL"),"infoMessages":{"enabled":false},"actionString":this.labels.get("submitActionString"),"data":{"object":{"content":Echo.Utils.get(Echo.Variables,targetURL,"")}},"ready":function(){this.view.get("text").on("change",function(){Echo.Utils.set(Echo.Variables,targetURL,$(this).val());});}};var _submit=this.initComponent({"id":"Submit","component":"Echo.StreamServer.Controls.Submit","config":submitConfig});app.set("_submit",_submit);return element;};Comments.methods.openModalItem=function(query,title){var app=this;var modalBody=$('<div class="rtb-apps-comments"></div>');var plugins=[{"name":"Edit","nestedPlugins":[{"name":"rtbCommentsEdit"}]},{"name":"rtbCommentsStreamPlugin"},{"name":"rtbCommentsStreamPluginItem","app":this,"noUserPopover":true}];if(app.config.get("settings.stream.moderation")==true){plugins.push({"name":"Moderation","removePersonalItemsAllowed":app.config.get("settings.stream.removePersonalItemsAllowed")});};var nestedLikePlugins=[{"name":"Facepile","plugins":[{"name":"rtbFacepileUserProfiles"}]}];if(this.config.get("settings.plugins.like"))
$.merge(nestedLikePlugins,this.config.get("settings.plugins.like"));plugins.push({"name":"Like","nestedPlugins":nestedLikePlugins,"item":{"defaultAvatar":this.config.get("settings.stream.defaultAvatar")}});plugins.push(app.pluginEnabled("settings.submit.textileMarkup","rtbMarkup"));plugins.push(app.pluginEnabled("settings.inlineMedia.enabled","rtbStreamInlineMedia"));plugins.push(app.pluginEnabled("settings.tokbox.enabled","rtbStreamItemTokbox"));if(app.config.get("settings.sharing.enabled")==true){plugins.push({"name":"rtbSocialSharing","appName":this.config.get("janrain.app"),"appUrl":this.config.get("janrain.appUrl")});plugins.push({"name":"rtbSocialSharingStreamItem","appName":this.config.get("janrain.app"),"appUrl":this.config.get("janrain.appUrl")});};var nestedPluginsFormAuth=[];if(app.config.get("settings.auth.formAuth")){nestedPluginsFormAuth.push({"name":"rtbCommentsFormAuthPlugin","app":this});}
if(app.config.get("settings.auth.trackIP"))nestedPluginsFormAuth.push({"name":"rtbTrackIP","app":app});if(app.config.get("settings.auth.emailLogin"))nestedPluginsFormAuth.push({"name":"rtbEmailUserAuth"});$.merge(nestedPluginsFormAuth,app.config.get("settings.plugins.formAuth"));var replyPluginNested=[{"name":"FormAuth","submitPermissions":app.config.get("settings.auth.submitPermissions"),"identityManager":app.config.get("identityManager"),"nestedPlugins":nestedPluginsFormAuth},{"name":"rtbSubmitSanitize","allowedTags":this.config.get("settings.submit.allowedTags")},{"name":"rtbCommentsSubmitPlugin","app":this,"isReply":true,"showControlButtons":this.config.get("settings.submit.showControlButtons"),"submitPermissions":this.config.get("settings.auth.submitPermissions"),"render":this.config.get("settings.submit.render"),"waitToPost":this.config.get("settings.submit.waitToPost")}];replyPluginNested.push(app.pluginEnabled("settings.attachMedia.enabled","rtbSubmitAttachMedia",{"cdnBaseURL":this.config.get("cdnBaseURL")}));replyPluginNested.push(app.pluginEnabled("settings.mediaResolver.enabled","rtbMediaResolverSubmit"));replyPluginNested.push(app.pluginEnabled("settings.tokbox.enabled","rtbSubmitTokbox"));replyPluginNested.push(app.pluginEnabled("settings.emailSubscribe.enabled","rtbSubmitEmailSubscribe"));$.merge(replyPluginNested,app.config.get("settings.plugins.reply"));if(app.config.get("settings.submit.readOnly")!=true){plugins.push({"name":"Reply","actionString":this.labels.get("replyActionString"),"nestedPlugins":replyPluginNested});};plugins.push(app.pluginEnabled("settings.poll.enabled","SlimSurveysItems",{"url":"https://8a894ed82966de594302-db6813f2295a29da7ae1834f8bc01832.ssl.cf1.rackcdn.com/rtb/plugin.slimsurveys.min.js"}));$.merge(plugins,app.config.get("settings.plugins.stream"));var modalStream=this.initComponent({"id":"modalStream","component":"Echo.StreamServer.Controls.Stream","config":{"appkey":app.config.get("appkey"),"target":modalBody,"query":query,"apiBaseURL":app.config.get("apiBaseURL"),"submissionProxyURL":app.config.get("submissionProxyURL"),"plugins":plugins,"flashColor":"transparent","liveUpdates":{"enabled":false,"polling":{"timeout":60},"transport":app.config.get("settings.stream.transport")},"useSecureAPI":app.config.get("useSecureAPI"),"item":{"reTag":false,"contentTransformations":{"text":["urls","newlines"],"html":["urls","newlines"],"xhtml":["urls"]}},"state":{"label":{"icon":false,"text":false},"toggleBy":"mouseover","layout":"compact"}}});var modal=new Echo.GUI.Modal({"data":{"title":title,"body":modalBody,"buttons":[]},"extraClass":"rtb-apps-comments","header":true,"footer":false,"fade":true,"show":true,"onHide":function(self,element){modalStream.destroy();}});};Comments.methods.setIdentityManager=function(){var app=this;var idW=app.config.get("settings.auth.idModalWidth",240);var idH=app.config.get("settings.auth.idModalHeight",285);var x=app.config.get("janrain.appUrl","");x=x.replace('https://','').split('.')[0];app.config.set("janrain.app",x);var identityManager={"title":app.labels.get("idManagerTitle"),"width":idW,"height":idH,"url":app.config.get("cdnBaseURL.RTB")+"/janrain_login.html?"+"providersPerPage=6&width="+(idW-15)+"&app="+this.config.get("janrain.app")+"&token_url=https%3A%2F%2Fapps.echoenabled.com%2Fapps%2Fjanrain%2Fwaiting.html&bp_channel="};this.config.set("identityManager",{"login":identityManager,"edit":identityManager,"signup":identityManager});};Comments.css="";Comments.init=function(){var app=this;app.setIdentityManager();if(this.config.get("settings.stream.streamQueryURLs").length==0){this.config.set("settings.stream.streamQueryURLs",[this.config.get("targetURL")]);};var a=$.extend({},this.config.get("settings.stream.queryParams.mainDefault"),this.config.get("settings.stream.queryParams.main"));this.config.set("settings.stream.queryParams.main",a);$(app.config.get("target")).addClass("rtb-gui");Echo.Labels.set(app.config.get("labels"));this.render();this.ready();RTB.Utils.initAnalytics(app.config.get("appkey"));setTimeout(function(){var anchorName=location.href.split("#")[1];if(typeof anchorName!="undefined"&&anchorName.indexOf("comment-")===0){var item_id=anchorName.split("comment-")[1];item_id=RTB.Utils.decode64(item_id);app.openModalItem("url:"+item_id+" state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved "+"children state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved safeHTML:permissive",app.labels.get("modalTitleCommentPermalink"));location.href=location.href.split("#")[0]+"#";};},1500);};Echo.App.create(Comments);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsStreamPlugin","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.labels={"facePileSuffixTextPlural":"people talking","stateSpanFix":"Show "};plugin.templatePeopleListening='<div class="{class:peopleListening}"></div>';plugin.init=function(){var plugin=this;};plugin.component.renderers.header=function(element){var plugin=this,component=plugin.component;this.parentRenderer("header",arguments);return element;};plugin.component.renderers.peopleListening=function(element){var plugin=this,component=plugin.component;var facePile=new Echo.StreamServer.Controls.FacePile({"target":element,"appkey":component.config.get("appkey"),"apiBaseURL":app.config.get("apiBaseURL"),"useSecureAPI":this.config.get("useSecureAPI",false,true),"query":component.config.get("query"),"liveUpdates":app.config.get("settings.stream.transport"),"item":{"avatar":true,"text":false},"suffixText":" "+plugin.labels.get("facePileSuffixTextPlural")});return element;};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsStreamPluginItem","Echo.StreamServer.Controls.Stream.Item");plugin.config={"likesLevel":2,"repliesLevel":3};plugin.labels={"likes":"likes","like":"like","iconLikes":"Top Comment","iconReplies":"Popular","ttFlag":"Flag item","ttToggle":"Toggle item","modalFlagTitle":"Flag Status","modalFlagMsg":"Item has been flagged.","modalBtnOK":"OK","noUserPopover":false};plugin.templates.itemTopControls='<div class="{class:itemContainerControls} item-container-controls"></div>';plugin.init=function(){this.extendTemplate("insertAsFirstChild","container",plugin.templates.itemTopControls);};plugin.component.renderers.text=function(element){var plugin=this,component=plugin.component;this.parentRenderer("text",arguments);element.addClass('echo-item-type-comment');return element;};plugin.component.renderers.date=function(element){var plugin=this,item=this.component,app=this.config.get("app");this.parentRenderer("date",arguments);var html=element.text();var item_id=RTB.Utils.encode64(item.data.object.id);var uri=item.data.object.context[0].uri;if(app.config.get("settings.stream.permalinks")==true){html=$('<a href="#comment-'+item_id+'">'+html+'</a>');}else{html=$('<span>'+html+'</span>');};if(item.depth==0){var stats=item.get("data.object.accumulators");if(stats.likesCount>=this.config.get("likesLevel")||$.inArray('topcomment',item.data.object.markers)!=-1){var iconLikes=$('<span class="icon-likes-comment" title="'+this.labels.get("iconLikes")+'"></span>');iconLikes.tooltip();html=html.after(iconLikes);};if(stats.repliesCount>=this.config.get("repliesLevel")||$.inArray('popular',item.data.object.markers)!=-1){var iconReplies=$('<span class="icon-replies-comment" title="'+this.labels.get("iconReplies")+'"></span>');iconReplies.tooltip();html=html.after(iconReplies);};};element.html(html);var elAuthorName=this.component.view.get("authorName");elAuthorName.after(element);if(plugin.component.user.is("admin")){var elAuthorUserID=elAuthorName.find(".echo-item-user-id-wrapper");var elAuthorUsernameWrapper=elAuthorName.find(".echo-item-username-wrapper");elAuthorName.hover(function(){elAuthorUsernameWrapper.hide()
elAuthorUserID.show();},function(){elAuthorUsernameWrapper.show()
elAuthorUserID.hide();});};return element;};plugin.component.renderers.avatar=function(element){var item=this.component,app=this.config.get("app");this.parentRenderer("avatar",arguments);if(this.config.get("noUserPopover")!=true){new RTB.Apps.UserProfile(this.config.assemble({"appkey":item.config.get("appkey"),"target":$('<div></div>'),"element":element,"actor":item.data.actor,"actorCommentQuery":"childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive","handler":function(actor){var q=app.config.get("inlineUserProfileStreamQuery");q=(q!=null?"user.id:"+actor.id+" "+q:"user.id:"+actor.id+" childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive");app.openModalItem(q,actor.title);}}));};return element;};plugin.component.renderers.sourceIcon=function(element){var item=this.component;this.parentRenderer("sourceIcon",arguments);if(!element.attr("src")||element.attr("src").indexOf("comments.png")>-1){element.remove();};};plugin.component.renderers.authorName=function(element){var plugin=this,item=this.component;var el=this.parentRenderer("authorName",arguments).html();var authorName=$('<span>'+el+'</span>');if(plugin.component.user.is("admin")){var label="UserID: "+item.data.actor.id;var el=$('<span class="echo-item-user-id-wrapper">'+label+"</span>");el.hide()
var text='<span class="echo-item-username-wrapper">'+element.html()+'</span>';element.addClass("echo-clickable");element.html(text);element.append(el);};var arr=item.data.actor.roles||[];$.map(arr,function(x,i){$(element).addClass(arr[i]);var r=$('<span class="echo-author-role">'+arr[i]+'</span>');});return element;};plugin.component.renderers.content=function(element){var item=this.component;this.parentRenderer("content",arguments);};plugin.component.renderers.modeSwitch=function(element){var item=this.component;this.parentRenderer("modeSwitch",arguments);element.remove();};plugin.component.renderers.container=function(element){var plugin=this,item=this.component,app=this.config.get("app");this.parentRenderer("container",arguments);var isRoot=!item.depth;var wrapper=element.find('.item-container-controls');wrapper.empty();if(!RTB.Utils.is_touch_device()&&Echo.UserSession._isLogged()&&app.config.get("settings.stream.showFlagIcon")==true){var btn=$('<div class="icon-flag item-display-flag item-container-control"></div>');element.find('.item-display-flag').remove();wrapper.append(btn);btn.attr("title",this.labels.get("ttFlag"));btn.click(function(){element.find(".echo-streamserver-controls-stream-item-button-Flag span").trigger("click");var html=new Echo.GUI.Modal({"data":{"title":plugin.labels.get("modalFlagTitle"),"body":plugin.labels.get("modalFlagMsg"),"buttons":[{"title":plugin.labels.get("modalBtnOK"),"extraClass":"btn-primary","handler":function(){html.hide();}}]},"extraClass":"rtb-apps-comments","header":true,"footer":true,"fade":true,"show":true});});};if(isRoot&&app.config.get("settings.stream.showToggleIcon")==true){var btn=$('<div class="icon-minus item-display-toggle item-container-control"></div>');element.find('.item-display-toggle').remove();wrapper.append(btn);btn.attr("title",this.labels.get("ttToggle"));btn.click(function(){if($(this).hasClass("icon-minus")){$(this).removeClass("icon-minus").addClass("icon-plus");item.view.get('data').slideUp();item.view.get('footer').slideUp();item.view.get('children').slideUp();item.view.get('expandChildren').slideUp();element.parent().find('.echo-streamserver-controls-stream-item-plugin-Reply-replyForm').slideUp();}else{$(this).removeClass("icon-plus").addClass("icon-minus");item.view.get('data').slideDown();item.view.get('footer').slideDown();item.view.get('children').slideDown();item.view.get('expandChildren').slideDown();element.parent().find('.echo-streamserver-controls-stream-item-plugin-Reply-replyForm').slideDown();};plugin.events.publish({"topic":"onToggleItem","data":{"item":item}});});};element.find('.item-container-control').css("opacity",0);element.on("mouseover",function(){element.find('.item-container-control').css("opacity",1);element.find('.echo-streamserver-controls-stream-item-button').css("opacity",1);});element.on("mouseout",function(){element.find('.item-container-control').css("opacity",0);element.find('.echo-streamserver-controls-stream-item-button').css("opacity",0.3);});return element;};plugin.component.renderers.body=function(element){var item=this.component;this.parentRenderer("body",arguments);element.addClass("clearfix");return element;};plugin.component.renderers.markers=function(element){var item=this.component;this.parentRenderer("markers",arguments);element.hide();};plugin.component.renderers.buttons=function(element){var item=this.component,app=this.config.get("app");this.parentRenderer("buttons",arguments);element.css("float","none");element.find('.echo-streamserver-controls-stream-item-button').css("opacity",0.3);var isRoot=!item.depth;if(!isRoot){setTimeout(function(){var el=element.find(".echo-streamserver-controls-stream-item-button-MarkAsTopcomment");el.next().remove();el.remove();},500);};if(!RTB.Utils.is_touch_device()&&app.config.get("settings.stream.showFlagIcon")==true){element.find(".echo-streamserver-controls-stream-item-button-Flag").hide();};var likesCount=item.get("data.object.accumulators").likesCount;var likesEl=item.view.get("container").find('.echo-streamserver-controls-stream-item-plugin-Like-likedBy');likesEl.wrap('<div class="echo-streamserver-controls-stream-item-plugin-Like-wrapper"></div>');if(likesCount>0)likesEl.parent().prepend($('<span>'+likesCount+'</span>'+' <span class="icon-rtb-star-comment"></span>'));this.component.view.get("footer").prepend(likesEl.parent());return element;};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsStreamTitle","Echo.StreamServer.Controls.Stream");plugin.labels={};plugin.streamHeaderTitle='<div class="{plugin.class:streamHeaderTitle}"></div>';plugin.init=function(){this.extendTemplate("insertAsFirstChild","header",plugin.streamHeaderTitle);};plugin.renderers.streamHeaderTitle=function(element){var plugin=this,component=plugin.component;element.html(plugin.config.get("title"));return element;};plugin.component.renderers.more=function(element){var plugin=this,component=plugin.component;this.parentRenderer("more",arguments);if(plugin.config.get("noMore")==true){element.remove();};};plugin.css='.{plugin.class:streamHeaderTitle} {color: #777;font-size: 12px;font-weight:bold;text-transform: uppercase;}';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsStreamTopCommentsItem","Echo.StreamServer.Controls.Stream.Item");plugin.labels={"labelControlMore":"View"};plugin.init=function(){var self=this,item=this.component;item.addButtonSpec("ReadMore",this._assembleButton());};plugin.component.renderers.content=function(element){var plugin=this,app=this.config.get("app"),item=plugin.component;if(app.config.get("settings.topComments.automatic")==true){var stats=item.get("data.object.accumulators");if(stats.likesCount&&stats.likesCount>=app.config.get("settings.topComments.threshold")){plugin.config.get("target").show();app.set("hasTopItems",true);}else{element.hide();};}else{app.set("hasTopItems",true);};return element;};plugin.component.renderers.text=function(element){var plugin=this,component=plugin.component;this.parentRenderer("text",arguments);};plugin.methods._assembleButton=function(){var plugin=this,item=this.component,app=this.config.get("app");var callback=function(){app.openModalItem("url:"+item.data.object.id+" -state:ModeratorDeleted,SystemFlagged user.state:Untouched,ModeratorApproved children state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved safeHTML:permissive",app.labels.get("modalTitleCommentPermalink"));jQuery(document).on("mouseover",".modal-body .nav a, .modal-body .nav a i",function(){jQuery(this).unbind('mouseover').unbind('mousedown').unbind('mousemove').unbind('mouseout').unbind('mouseleave');jQuery(this).attr({'data-original-title':''});});};return function(){var item=this;return{"name":"ReadMore","label":plugin.labels.get("labelControlMore"),"visible":true,"callback":callback};};};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsStreamTopComments","Echo.StreamServer.Controls.Stream");plugin.init=function(){};plugin.events={"Echo.StreamServer.Controls.Stream.onDataReceive":function(topic,args){var plugin=this,component=plugin.component;plugin.showHideTopComments();},"Echo.StreamServer.Controls.Stream.Item.onRender":function(topic,args){var plugin=this,component=plugin.component;plugin.showHideTopComments();}};plugin.methods.showHideTopComments=function(){var plugin=this,app=this.config.get("app"),component=plugin.component;if(!$.isEmptyObject(component.items)){}else{};var t=plugin.config.get("target");if(app.get("hasTopItems")==true){if(!t.is(":visible")){t.show();};}else{t.hide();};};plugin.component.renderers.messageText=function(element){var plugin=this,component=plugin.component;this.parentRenderer("messageText",arguments);if($.isEmptyObject(component.items)){plugin.config.get("target").hide()};return element;};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsCommunityStream","Echo.StreamServer.Controls.Stream");plugin.init=function(){};plugin.events={"Echo.StreamServer.Controls.Stream.onDataReceive":function(topic,args){var plugin=this,component=plugin.component;},"Echo.StreamServer.Controls.Stream.Item.onRender":function(topic,args){var plugin=this,component=plugin.component;}};plugin.component.renderers.more=function(element){var plugin=this,component=plugin.component;this.parentRenderer("more",arguments);element.remove();};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsCommunityStreamItem","Echo.StreamServer.Controls.Stream.Item");plugin.labels={};plugin.templateStats='<div class="{class:pageStats}"></div>';plugin.init=function(){var control=this.component;this.extendTemplate("insertAsFirstChild","container",plugin.templateStats);$.map(["global",control.config.get("context")],function(context){control.events.unsubscribe({"topic":"Echo.Control.onDataInvalidate","context":context});});};plugin.component.renderers.pageStats=function(element){var item=this.component;var stats=item.get("data.object.accumulators");var likesCount=this.config.get("likesCount");var repliesCount=stats.repliesCount;element.html(likesCount+' <i class="icon-rtb-star-comment"></i>');return element;};plugin.component.renderers.re=function(element){var plugin=this,item=this.component;this.parentRenderer("re",arguments);this.component.view.get("container").prepend(element);var title=item.data.object.context[0].title||plugin.config.get("title");element.html($('<a href="'+item.data.object.context[0].uri+'">'+title+'</a>'));element.show();return element;};plugin.component.renderers.text=function(element){var plugin=this,component=plugin.component;this.parentRenderer("text",arguments);element.text(RTB.Utils.truncate(element.text(),100));return element;};plugin.component.renderers.date=function(element){var item=this.component,app=this.config.get("app");this.parentRenderer("date",arguments);var html=element.text();var item_id=RTB.Utils.encode64(item.data.object.id);var uri=item.data.object.context[0].uri;if(app.config.get("settings.stream.permalinks")==true){html=$('<a href="#comment-'+item_id+'">'+html+'</a>');};element.html(html);this.component.view.get("authorName").after(element);return element;};plugin.component.renderers.avatar=function(element){var item=this.component,app=this.config.get("app");this.parentRenderer("avatar",arguments);new RTB.Apps.UserProfile(this.config.assemble({"appkey":item.config.get("appkey"),"target":$('<div></div>'),"element":element,"actor":item.data.actor,"actorCommentQuery":"childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive","handler":function(actor){var q=app.config.get("inlineUserProfileStreamQuery");q=(q!=null?"user.id:"+actor.id+" "+q:"user.id:"+actor.id+" childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive");app.openModalItem(q,actor.title);}}));};plugin.component.renderers.sourceIcon=function(element){var item=this.component;this.parentRenderer("sourceIcon",arguments);if(!element.attr("src")||element.attr("src").indexOf("comments.png")>-1){element.remove();};};plugin.component.renderers.modeSwitch=function(element){var item=this.component;this.parentRenderer("modeSwitch",arguments);element.remove();};plugin.component.renderers.body=function(element){var item=this.component;this.parentRenderer("body",arguments);element.addClass("clearfix");};plugin.component.renderers.markers=function(element){var item=this.component;this.parentRenderer("markers",arguments);element.hide();};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsSubmitPlugin","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.labels={"menuSharePage":"Share page","menuSubscribeEmail":"Follow via email","menuSubscribeRSS":"Subscribe via RSS"};plugin.config={"textExpandedH":88,"textCompactH":32,"showControlButtons":true,"submitPermissions":"forceLogin","render":"compact","waitToPost":true};plugin.templateNavbar='<div class="navbar {plugin.class:navbar}">'+'<div class="navbar-inner">'+'<div class="navbar-wrapper">'+'<ul class="nav">'+'</ul>'+'</div>'+'</div>'+'</div>';plugin.init=function(){this.extendTemplate("insertAsFirstChild","controls",plugin.templateNavbar);this.component.addPostValidator(this._validator());};plugin.events={"Echo.StreamServer.Controls.Submit.onRerender":function(topic,args){var plugin=this;plugin.fixTextWidths();},"Echo.StreamServer.Controls.Submit.onRender":function(topic,args){var plugin=this;plugin.fixTextWidths();if(this.config.get("isReply"))return;var target=$(args.target);var app=this.config.get("app");var tt=$("<span></span>");target.find(".echo-streamserver-controls-submit-plugin-FormAuth-auth > div").prepend(tt);if(app.config.get("settings.pageLike.enabled")==true){var ddOptions=[];if(app.config.get("settings.sharing.enabled")==true){ddOptions.push({"label":plugin.labels.get("menuSharePage"),"callback":function(){var title=$("meta[property='og:title']").attr("content")||document.title;var description=$("meta[property='og:description']").attr("content")||'';var _stream=app.config.get("_stream");var _plugin=_stream.plugins.rtbSocialSharing;_plugin.doShare({"appName":_plugin.config.get("appName"),"activity":_plugin.config.get("activity"),"content":title+" "+description,"context":_stream.config.get("context"),"topic":"Echo.StreamServer.Controls.Stream.Item.Plugins.rtbSocialSharing.onShare","target":RTB.Utils.getProp("url")});}});ddOptions.push({"label":"divider"});};if(Echo.UserSession._isLogged()&&app.config.get("settings.emailSubscribe.enabled")==true){ddOptions.push({"label":this.labels.get("menuSubscribeEmail"),"callback":function(){Echo.Events.publish({"topic":"RTB.Apps.PageLike.onPageSubscribeEmail"});app.config.get("_stream").plugins.rtbStreamEmailSubscribe.emailSubscribe(app.config.get("msgTarget"));}});};ddOptions.push({"label":this.labels.get("menuSubscribeRSS"),"callback":function(){Echo.Events.publish({"topic":"RTB.Apps.PageLike.onPageSubscribeRSS"});var href=app.config.get("_stream").plugins.rtbStreamRSS.getRSSLink();window.open(href);}});var appC=app.initComponent({"id":"AppPageLikeComments","component":"RTB.Apps.PageLike","config":{"appkey":app.config.get("appkey"),"useSecureAPI":app.config.get("useSecureAPI"),"submissionProxyURL":app.config.get("submissionProxyURL"),"apiBaseURL":app.config.get("apiBaseURL"),"transport":app.config.get("settings.stream.transport"),"target":tt,"msgTarget":target.parent().find(".rtb-apps-comments-alertMessages"),"appName":"Comments","targetURL":$('head').find("link[rel='canonical']").attr('href')||location.href.split("#")[0],"dropdown":ddOptions}})};},"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,data){var plugin=this,submit=plugin.component;this.component.view.get("postButton").blur();var depth=0;if(data.inReplyTo&&data.inReplyTo.object){depth=1;if(data.inReplyTo.object.markers){var d=RTB.Utils.getMarker("depth",data.inReplyTo.object.markers,false);if(d!=null){var d=parseInt(d);depth=d+1;};}};var m="depth:"+depth;var pushM=true;$.map(data.postData.content,function(x,i){if(x.object&&x.object.objectTypes[0]==submit._getASURL("marker")){x.object.content+=","+m;pushM=false;};});if(pushM)data.postData.content.push(submit._getActivity("tag",submit._getASURL("marker"),m));var app=plugin.config.get('app');if(app.config.get("components.Submit.tags")){var pushT=true;var tags=app.config.get("components.Submit.tags").join(',');$.map(data.postData.content,function(x,i){if(x.object&&x.object.objectTypes[0]==submit._getASURL("tag")){x.object.content+=","+tags;pushT=false;};});if(pushT)data.postData.content.push(submit._getActivity("tag",submit._getASURL("tag"),tags));};if(app.config.get("components.Submit.markers")){var pushT=true;var tags=app.config.get("components.Submit.markers").join(',');$.map(data.postData.content,function(x,i){if(x.object&&x.object.objectTypes[0]==submit._getASURL("marker")){x.object.content+=","+tags;pushT=false;};});if(pushT)data.postData.content.push(submit._getActivity("tag",submit._getASURL("marker"),tags));};},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,component=this.component,app=plugin.config.get("app");var ts=Math.round(new Date().getTime()/1000);plugin.set("lastPostTimestamp",ts);plugin.set("postinProgress",false);if(plugin.config.get("render")=="compact"){this.toggleText(false);};if(app.config.get("settings.stream.preModeration")==true){var alertEl=$(component.config.data.target);RTB.Utils.Alert(alertEl,app.labels.get("alertPreModTitle"),app.labels.get("alertPreModMsg"),"info");};plugin.events.publish({"topic":"onPostComplete","data":{"args":args}});}};plugin.methods.fixTextWidths=function(){var plugin=this;var setWidths=function(){var element=plugin.component.view.get("container").parent();var elText=plugin.component.view.get("text");elText.show();var offset=12;elText.css('width',function(){return element.width()-offset;})
var name=plugin.component.view.get("nameContainer");if(name){name.css('width',function(){return element.width()-offset;});};};};plugin.methods.toggleText=function(show){var plugin=this;plugin.component.view.get("content").removeClass("textinput-compact").removeClass("textinput-expanded");if(show){plugin.component.view.get("content").addClass("textinput-expanded");if(plugin.component.view.get("text").height()<plugin.config.get("textExpandedH")){plugin.component.view.get("text").animate({"height":plugin.config.get("textExpandedH")+"px"});};plugin.component.view.get("text").TextAreaExpander(plugin.config.get("textExpandedH"),500);plugin.component.view.get("controls").slideDown("fast");if(Echo.UserSession._isAdmin()){plugin.component.view.get("markersContainer").slideDown("fast");plugin.component.view.get("tagsContainer").slideDown("fast");};}else{plugin.component.view.get("content").addClass("textinput-compact");plugin.component.view.get("text").unbind('.TextAreaExpander');plugin.component.view.get("text").animate({"height":plugin.config.get("textCompactH")+"px"});plugin.component.view.get("controls").slideUp("fast");if(Echo.UserSession._isAdmin()){plugin.component.view.get("markersContainer").slideUp("fast");plugin.component.view.get("tagsContainer").slideUp("fast");};};plugin.events.publish({"topic":"onToggleSubmitArea","data":{"show":show,"element":plugin.component.view.get("text")}});};plugin.component.renderers.header=function(element){var plugin=this;plugin.parentRenderer("header",arguments);if(!Echo.UserSession._isLogged()){$(element).hide();var name=this.component.view.get("nameContainer");if(name){this.component.view.get("body").prepend(name);};};};plugin.component.renderers.text=function(element){var plugin=this;plugin.parentRenderer("text",arguments);if(plugin.config.get("render")=="compact"){element.css({"height":plugin.config.get("textCompactH")+"px"})
plugin.toggleText(false);element.on("focus",function(){plugin.toggleText(true);});}else{element.css({"height":plugin.config.get("textExpandedH")+"px"})
plugin.toggleText(true);};return element;};plugin.component.renderers.container=function(element){var plugin=this;plugin.parentRenderer("container",arguments);return element;};plugin.component.renderers.body=function(element){var plugin=this,app=this.config.get("app");plugin.parentRenderer("body",arguments);if(app.config.get("settings.submit.readOnly")==true){element.remove();};return element;};plugin.component.renderers.markersContainer=function(element){var plugin=this,app=this.config.get("app");plugin.parentRenderer("markersContainer",arguments);element.hide();if(app.config.get("settings.submit.metaInputs")==false&&Echo.UserSession._isAdmin()){var w=$("<div></div>");w.hide();element.wrap(w);};if(!Echo.UserSession._isAdmin()){element.remove();};return element;};plugin.component.renderers.tagsContainer=function(element){var plugin=this,app=this.config.get("app");plugin.parentRenderer("tagsContainer",arguments);element.hide();if(app.config.get("settings.submit.metaInputs")==false&&Echo.UserSession._isAdmin()){var w=$("<div></div>");w.hide();element.wrap(w);};if(!Echo.UserSession._isAdmin()){element.remove();};return element;};plugin.component.renderers.navbar=function(element){var plugin=this;};plugin.component.renderers.controls=function(element){var plugin=this;plugin.parentRenderer("controls",arguments);if(plugin.config.get("render")=="compact"){element.hide();};var navbarUl=element.find('.nav');element.find('.navbar-btn').each(function(){var li=$('<li></li>');li.append($(this))
$(this).tooltip().on('show',function(e){e.stopPropagation();}).on('hidden',function(e){e.stopPropagation();});li.hover(function(){},function(){navbarUl.find(".tooltip").each(function(){$(this).remove();});});li.appendTo(navbarUl);$('<li class="divider-vertical"></li>').appendTo(navbarUl);});if(element.find('.navbar-btn').length>0){if(plugin.config.get("showControlButtons")==false){var ttoggle=$('<div class="toolbar-toggle"><a href="javascript:void(0);"><i class="icon-rtb-plus"></i></a></div>');navbarUl.before(ttoggle);$('<li class="divider-vertical"></li>').prependTo(navbarUl);navbarUl.hide();var hiConfig={sensitivity:2,interval:200,timeout:500,over:function(){},out:function(){navbarUl.hide();navbarUl.find(".tooltip").each(function(){$(this).tooltip("hide");});}}
ttoggle.find('a').hover(function(){if(!navbarUl.is(":visible")){navbarUl.animate({width:'toggle'});};},function(){}).click(function(){$(this).blur();if(!navbarUl.is(":visible")){navbarUl.animate({width:'toggle'});};});ttoggle.parent().hoverIntent(hiConfig);}else{navbarUl.show();};};var btn=plugin.component.view.get("postContainer");btn.appendTo($(element).find('.navbar-inner'));return element;};plugin.component.renderers.postButton=function(element){var plugin=this,component=this.component;var app=plugin.config.get("app");plugin.parentRenderer("postButton",arguments);element.click(function(){var alertEl=$(plugin.component.config.data.target);if(!Echo.UserSession._isLogged()&&plugin.config.get("submitPermissions")=="forceLogin"){RTB.Utils.Alert(alertEl,app.labels.get("alertMustLoginTitle"),app.labels.get("alertMustLoginMsg"),"error");plugin.events.publish({"topic":"onPostMustLogin","data":{}});plugin.set("postinProgress",false);};});return element;};plugin.methods._validator=function(){var plugin=this,submit=this.component;return function(){if(plugin.get("postinProgress")==true)return false;plugin.set("postinProgress",true);var alertEl=$(submit.config.data.target);var app=plugin.config.get("app");var ts=Math.round(new Date().getTime()/1000);var ts2=plugin.get("lastPostTimestamp",0);if((ts-ts2)<10&&plugin.config.get('waitToPost')){RTB.Utils.Alert(alertEl,app.labels.get("alertNoTextTitle"),app.labels.get("alertWaitToPost"),"error");plugin.set("postinProgress",false);return false;}else if($.trim(plugin.component.view.get("text").val())==""){RTB.Utils.Alert(alertEl,app.labels.get("alertNoTextTitle"),app.labels.get("alertNoTextMsg"),"error");plugin.set("postinProgress",false);return false;}else if($.trim(plugin.component.view.get("text").val()).length<app.config.get("settings.submit.minChars")){RTB.Utils.Alert(alertEl,app.labels.get("alertNoTextTitle"),app.labels.get("alertMinText").replace("%CHARS%",app.config.get("settings.submit.minChars")),"error");plugin.set("postinProgress",false);return false;}else{};return true;}};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSubmitSanitize","Echo.StreamServer.Controls.Submit");plugin.config={"allowedTags":[]};plugin.init=function(){};plugin.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,args){var plugin=this,submit=plugin.component;var text=args.postData.content[0].object.content;var aTags=plugin.config.get("allowedTags");aTags.push("br");text=text.replace(/(\r\n)/gm,"<br/><br/>");text=text.replace(/(\n|\r)/gm,"<br/>")
var textStripped=$.htmlClean(text,{allowedTags:aTags});args.postData.content[0].object.content=textStripped;},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){}};plugin.methods.safe_tags=function(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamSanitize","Echo.StreamServer.Controls.Stream.Item");plugin.config={"allowedTags":[]};plugin.init=function(){};plugin.component.renderers.text=function(element){var plugin=this,component=plugin.component;this.parentRenderer("text",arguments);var c=this.component.data.object.content.split('<div class="echo-item-files">');var aTags=plugin.config.get("allowedTags");aTags.push("br");var textStripped=$.htmlClean(c[0],{allowedTags:aTags});element.html(textStripped);if(c.length>1){var d='<div class="echo-item-files">'+c[1];element.append(d);};return element;};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;$.fn.TextAreaExpander=function(minHeight,maxHeight){var hCheck=!(/msie|opera/.test(navigator.userAgent.toLowerCase()));function ResizeTextarea(e){e=e.target||e;var vlen=e.value.length,ewidth=e.offsetWidth;if(vlen!=e.valLength||ewidth!=e.boxWidth){if(hCheck&&(vlen<e.valLength||ewidth!=e.boxWidth))e.style.height="0px";var h=Math.max(e.expandMin,Math.min(e.scrollHeight,e.expandMax));e.style.overflow=(e.scrollHeight>h?"auto":"hidden");e.style.height=h+"px";e.valLength=vlen;e.boxWidth=ewidth;}
return true;};function CheckContent(e){var $elem=$(e);if(hCheck)e.style.height="0px";var h=Math.max(e.expandMin,Math.min(e.scrollHeight,e.expandMax));e.style.overflow=(e.scrollHeight>h?"auto":"hidden");$elem.height(h);}
this.each(function(){if(this.nodeName.toLowerCase()!="textarea")return;var p=this.className.match(/expand(\d+)\-*(\d+)*/i);this.expandMin=minHeight||(p?parseInt('0'+p[1],10):0);this.expandMax=maxHeight||(p?parseInt('0'+p[2],10):99999);$(this).bind("keyup.TextAreaExpander",function(){CheckContent(this);})});return this;};})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;$.fn.hoverIntent=function(f,g){var cfg={sensitivity:7,interval:100,timeout:0};cfg=$.extend(cfg,g?{over:f,out:g}:f);var cX,cY,pX,pY;var track=function(ev){cX=ev.pageX;cY=ev.pageY};var compare=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);if((Math.abs(pX-cX)+Math.abs(pY-cY))<cfg.sensitivity){$(ob).unbind("mousemove",track);ob.hoverIntent_s=1;return cfg.over.apply(ob,[ev])}else{pX=cX;pY=cY;ob.hoverIntent_t=setTimeout(function(){compare(ev,ob)},cfg.interval)}};var delay=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);ob.hoverIntent_s=0;return cfg.out.apply(ob,[ev])};var handleHover=function(e){var ev=jQuery.extend({},e);var ob=this;if(ob.hoverIntent_t){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t)}if(e.type=="mouseenter"){pX=ev.pageX;pY=ev.pageY;$(ob).bind("mousemove",track);if(ob.hoverIntent_s!=1){ob.hoverIntent_t=setTimeout(function(){compare(ev,ob)},cfg.interval)}}else{$(ob).unbind("mousemove",track);if(ob.hoverIntent_s==1){ob.hoverIntent_t=setTimeout(function(){delay(ev,ob)},cfg.timeout)}}};return this.bind('mouseenter',handleHover).bind('mouseleave',handleHover)}})(Echo.jQuery);(function($){$.fn.htmlClean=function(options){return this.each(function(){if(this.value){this.value=$.htmlClean(this.value,options)}else{this.innerHTML=$.htmlClean(this.innerHTML,options)}})};$.htmlClean=function(html,options){options=$.extend({},$.htmlClean.defaults,options);options.allowEmpty=tagAllowEmpty.concat(options.allowEmpty);var tagsRE=/(<(\/)?(\w+:)?([\w]+)([^>]*)>)|<!--(.*?--)>/gi;var attrsRE=/([\w\-]+)\s*=\s*(".*?"|'.*?'|[^\s>\/]*)/gi;var tagMatch;var root=new Element();var stack=[root];var container=root;if(options.bodyOnly){if(tagMatch=/<body[^>]*>((\n|.)*)<\/body>/i.exec(html)){html=tagMatch[1]}}html=html.concat("<xxx>");var lastIndex;while(tagMatch=tagsRE.exec(html)){var tag=tagMatch[6]?new Tag("--",null,tagMatch[6],options):new Tag(tagMatch[4],tagMatch[2],tagMatch[5],options);var text=html.substring(lastIndex,tagMatch.index);if(text.length>0){var child=container.children[container.children.length-1];if(container.children.length>0&&isText(child=container.children[container.children.length-1])){container.children[container.children.length-1]=child.concat(text)}else{container.children.push(text)}}lastIndex=tagsRE.lastIndex;if(tag.isClosing){if(popToTagName(stack,[tag.name])){stack.pop();container=stack[stack.length-1]}}else{var element=new Element(tag);var attrMatch;while(attrMatch=attrsRE.exec(tag.rawAttributes)){if(attrMatch[1].toLowerCase()=="style"&&options.replaceStyles){var renderParent=!tag.isInline;for(var i=0;i<options.replaceStyles.length;i++){if(options.replaceStyles[i][0].test(attrMatch[2])){if(!renderParent){tag.render=false;renderParent=true}container.children.push(element);stack.push(element);container=element;tag=new Tag(options.replaceStyles[i][1],"","",options);element=new Element(tag)}}}if(tag.allowedAttributes!=null&&(tag.allowedAttributes.length==0||$.inArray(attrMatch[1],tag.allowedAttributes)>-1)){element.attributes.push(new Attribute(attrMatch[1],attrMatch[2]))}}$.each(tag.requiredAttributes,function(){var name=this.toString();if(!element.hasAttribute(name)){element.attributes.push(new Attribute(name,""))}});for(var repIndex=0;repIndex<options.replace.length;repIndex++){for(var tagIndex=0;tagIndex<options.replace[repIndex][0].length;tagIndex++){var byName=typeof(options.replace[repIndex][0][tagIndex])=="string";if((byName&&options.replace[repIndex][0][tagIndex]==tag.name)||(!byName&&options.replace[repIndex][0][tagIndex].test(tagMatch))){tag.rename(options.replace[repIndex][1]);repIndex=options.replace.length;break}}}var add=true;if(!container.isRoot){if(container.tag.isInline&&!tag.isInline){if(add=popToContainer(stack)){container=stack[stack.length-1]}}else{if(container.tag.disallowNest&&tag.disallowNest&&!tag.requiredParent){add=false}else{if(tag.requiredParent){if(add=popToTagName(stack,tag.requiredParent)){container=stack[stack.length-1]}}}}}if(add){container.children.push(element);if(tag.toProtect){var tagMatch2;while(tagMatch2=tagsRE.exec(html)){var tag2=new Tag(tagMatch2[4],tagMatch2[1],tagMatch2[5],options);if(tag2.isClosing&&tag2.name==tag.name){element.children.push(RegExp.leftContext.substring(lastIndex));lastIndex=tagsRE.lastIndex;break}}}else{if(!tag.isSelfClosing&&!tag.isNonClosing){stack.push(element);container=element}}}}}return $.htmlClean.trim(render(root,options).join(""))};$.htmlClean.defaults={bodyOnly:true,allowedTags:[],removeTags:["basefont","center","dir","font","frame","frameset","iframe","isindex","menu","noframes","s","strike","u"],allowedAttributes:[],removeAttrs:[],allowedClasses:[],format:false,formatIndent:0,replace:[[["b","big"],"strong"],[["i"],"em"]],replaceStyles:[[/font-weight:\s*bold/i,"strong"],[/font-style:\s*italic/i,"em"],[/vertical-align:\s*super/i,"sup"],[/vertical-align:\s*sub/i,"sub"]],allowComments:false,allowEmpty:[]};function applyFormat(element,options,output,indent){if(element.tag.format&&output.length>0){output.push("\n");for(var i=0;i<indent;i++){output.push("\t")}}}function render(element,options){var output=[],empty=element.attributes.length==0,indent=0;if(element.tag.isComment){if(options.allowComments){output.push("<!--");output.push(element.tag.rawAttributes);output.push(">");if(options.format){applyFormat(element,options,output,indent-1)}}}else{var renderTag=element.tag.render&&(options.allowedTags.length==0||$.inArray(element.tag.name,options.allowedTags)>-1)&&(options.removeTags.length==0||$.inArray(element.tag.name,options.removeTags)==-1);if(!element.isRoot&&renderTag){output.push("<");output.push(element.tag.name);$.each(element.attributes,function(){if($.inArray(this.name,options.removeAttrs)==-1){var m=RegExp(/^(['"]?)(.*?)['"]?$/).exec(this.value);var value=m[2];var valueQuote=m[1]||"'";if(this.name=="class"&&options.allowedClasses.length>0){value=$.grep(value.split(" "),function(c){return $.grep(options.allowedClasses,function(a){return a==c||(a[0]==c&&(a.length==1||$.inArray(element.tag.name,a[1])>-1))}).length>0}).join(" ")}if(value!=null&&(value.length>0||$.inArray(this.name,element.tag.requiredAttributes)>-1)){output.push(" ");output.push(this.name);output.push("=");output.push(valueQuote);output.push(value);output.push(valueQuote)}}})}if(element.tag.isSelfClosing){if(renderTag){output.push(" />")}empty=false}else{if(element.tag.isNonClosing){empty=false}else{if(!element.isRoot&&renderTag){output.push(">")}indent=options.formatIndent++;if(element.tag.toProtect){outputChildren=$.htmlClean.trim(element.children.join("")).replace(/<br>/ig,"\n");output.push(outputChildren);empty=outputChildren.length==0}else{var outputChildren=[];for(var i=0;i<element.children.length;i++){var child=element.children[i];var text=$.htmlClean.trim(textClean(isText(child)?child:child.childrenToString()));if(isInline(child)){if(i>0&&text.length>0&&(startsWithWhitespace(child)||endsWithWhitespace(element.children[i-1]))){outputChildren.push(" ")}}if(isText(child)){if(text.length>0){outputChildren.push(text)}}else{if(i!=element.children.length-1||child.tag.name!="br"){if(options.format){applyFormat(child,options,outputChildren,indent)}outputChildren=outputChildren.concat(render(child,options))}}}options.formatIndent--;if(outputChildren.length>0){if(options.format&&outputChildren[0]!="\n"){applyFormat(element,options,output,indent)}output=output.concat(outputChildren);empty=false}}if(!element.isRoot&&renderTag){if(options.format){applyFormat(element,options,output,indent-1)}output.push("</");output.push(element.tag.name);output.push(">")}}}if(!element.tag.allowEmpty&&empty){return[]}}return output}function popToTagName(stack,tagNameArray){return pop(stack,function(element){return $.inArray(element.tag.nameOriginal,tagNameArray)>-1})}function popToContainer(stack){return pop(stack,function(element){return element.isRoot||!element.tag.isInline})}function pop(stack,test,index){index=index||1;var element=stack[stack.length-index];if(test(element)){return true}else{if(stack.length-index>0&&pop(stack,test,index+1)){stack.pop();return true}}return false}function Element(tag){if(tag){this.tag=tag;this.isRoot=false}else{this.tag=new Tag("root");this.isRoot=true}this.attributes=[];this.children=[];this.hasAttribute=function(name){for(var i=0;i<this.attributes.length;i++){if(this.attributes[i].name==name){return true}}return false};this.childrenToString=function(){return this.children.join("")};return this}function Attribute(name,value){this.name=name;this.value=value;return this}function Tag(name,close,rawAttributes,options){this.name=name.toLowerCase();this.nameOriginal=this.name;this.render=true;this.init=function(){if(this.name=="--"){this.isComment=true;this.isSelfClosing=true;this.format=true}else{this.isComment=false;this.isSelfClosing=$.inArray(this.name,tagSelfClosing)>-1;this.isNonClosing=$.inArray(this.name,tagNonClosing)>-1;this.isClosing=(close!=undefined&&close.length>0);this.isInline=$.inArray(this.name,tagInline)>-1;this.disallowNest=$.inArray(this.name,tagDisallowNest)>-1;this.requiredParent=tagRequiredParent[$.inArray(this.name,tagRequiredParent)+1];this.allowEmpty=options&&$.inArray(this.name,options.allowEmpty)>-1;this.toProtect=$.inArray(this.name,tagProtect)>-1;this.format=$.inArray(this.name,tagFormat)>-1||!this.isInline}this.rawAttributes=rawAttributes;this.requiredAttributes=tagAttributesRequired[$.inArray(this.name,tagAttributesRequired)+1];if(options){if(!options.tagAttributesCache){options.tagAttributesCache=[]}if($.inArray(this.name,options.tagAttributesCache)==-1){var cacheItem=tagAttributes[$.inArray(this.name,tagAttributes)+1].slice(0);for(var i=0;i<options.allowedAttributes.length;i++){var attrName=options.allowedAttributes[i][0];if((options.allowedAttributes[i].length==1||$.inArray(this.name,options.allowedAttributes[i][1])>-1)&&$.inArray(attrName,cacheItem)==-1){cacheItem.push(attrName)}}options.tagAttributesCache.push(this.name);options.tagAttributesCache.push(cacheItem)}this.allowedAttributes=options.tagAttributesCache[$.inArray(this.name,options.tagAttributesCache)+1]}};this.init();this.rename=function(newName){this.name=newName;this.init()};return this}function startsWithWhitespace(item){while(isElement(item)&&item.children.length>0){item=item.children[0]}if(!isText(item)){return false}var text=textClean(item);return text.length>0&&$.htmlClean.isWhitespace(text.charAt(0))}function endsWithWhitespace(item){while(isElement(item)&&item.children.length>0){item=item.children[item.children.length-1]}if(!isText(item)){return false}var text=textClean(item);return text.length>0&&$.htmlClean.isWhitespace(text.charAt(text.length-1))}function isText(item){return item.constructor==String}function isInline(item){return isText(item)||item.tag.isInline}function isElement(item){return item.constructor==Element}function textClean(text){return text.replace(/&nbsp;|\n/g," ").replace(/\s\s+/g," ")}$.htmlClean.trim=function(text){return $.htmlClean.trimStart($.htmlClean.trimEnd(text))};$.htmlClean.trimStart=function(text){return text.substring($.htmlClean.trimStartIndex(text))};$.htmlClean.trimStartIndex=function(text){for(var start=0;start<text.length-1&&$.htmlClean.isWhitespace(text.charAt(start));start++){}return start};$.htmlClean.trimEnd=function(text){return text.substring(0,$.htmlClean.trimEndIndex(text))};$.htmlClean.trimEndIndex=function(text){for(var end=text.length-1;end>=0&&$.htmlClean.isWhitespace(text.charAt(end));end--){}return end+1};$.htmlClean.isWhitespace=function(c){return $.inArray(c,whitespace)!=-1};var tagInline=["a","abbr","acronym","address","b","big","br","button","caption","cite","code","del","em","font","hr","i","input","img","ins","label","legend","map","q","s","samp","select","option","param","small","span","strike","strong","sub","sup","tt","u","var"];var tagFormat=["address","button","caption","code","input","label","legend","select","option","param"];var tagDisallowNest=["h1","h2","h3","h4","h5","h6","p","th","td","object"];var tagAllowEmpty=["th","td"];var tagRequiredParent=[null,"li",["ul","ol"],"dt",["dl"],"dd",["dl"],"td",["tr"],"th",["tr"],"tr",["table","thead","tbody","tfoot"],"thead",["table"],"tbody",["table"],"tfoot",["table"],"param",["object"]];var tagProtect=["script","style","pre","code"];var tagSelfClosing=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var tagNonClosing=["!doctype","?xml"];var tagAttributes=[["class"],"?xml",[],"!doctype",[],"a",["accesskey","class","href","name","title","rel","rev","type","tabindex"],"abbr",["class","title"],"acronym",["class","title"],"blockquote",["cite","class"],"button",["class","disabled","name","type","value"],"del",["cite","class","datetime"],"form",["accept","action","class","enctype","method","name"],"iframe",["class","height","name","sandbox","seamless","src","srcdoc","width"],"input",["accept","accesskey","alt","checked","class","disabled","ismap","maxlength","name","size","readonly","src","tabindex","type","usemap","value"],"img",["alt","class","height","src","width"],"ins",["cite","class","datetime"],"label",["accesskey","class","for"],"legend",["accesskey","class"],"link",["href","rel","type"],"meta",["content","http-equiv","name","scheme","charset"],"map",["name"],"optgroup",["class","disabled","label"],"option",["class","disabled","label","selected","value"],"q",["class","cite"],"script",["src","type"],"select",["class","disabled","multiple","name","size","tabindex"],"style",["type"],"table",["class","summary"],"th",["class","colspan","rowspan"],"td",["class","colspan","rowspan"],"textarea",["accesskey","class","cols","disabled","name","readonly","rows","tabindex"],"param",["name","value"],"embed",["height","src","type","width"]];var tagAttributesRequired=[[],"img",["alt"]];var whitespace=[" "," ","\t","\n","\r","\f"]})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbTrackIP","Echo.IdentityServer.Controls.Auth");plugin.init=function(){var plugin=this,app=this.config.get("app");if(typeof window._rtbWasTracked=="undefined"){window._rtbWasTracked=true;Echo.Events.subscribe({"topic":"Echo.UserSession.onInit","handler":function(topic,data){if(Echo.UserSession._isLogged()){$.ajax({url:"http://api.realtidbits.com/iptrack_track",dataType:'jsonp',data:{"appkey":app.config.get("appkey"),"user_id":Echo.UserSession.get("id")},success:function(rsp){}});};}});};};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsFormAuthPlugin","Echo.IdentityServer.Controls.Auth");plugin.init=function(){};plugin.labels={"switchAccounts":"Switch Accounts","logout":"Sign Out"};plugin.templateDropdown='<div class="dropdown echo-identityserver-controls-auth-dropdown">'+'<a data-toggle="dropdown" class="dropdown-toggle" href="#"><i class="caret"></i></a>'+'<ul aria-labelledby="controls-auth" role="menu" class="dropdown-menu">'+'<li><a href="javascript:void(0);" class="auth-logout">{label:logout}</a></li>'+'</ul>'+'</div>';plugin.component.renderers.userAnonymous=function(element){var plugin=this,component=this.component;this.parentRenderer("userAnonymous",arguments);this.component.view.get("or").hide();this.component.view.get("signup").hide();this.component.view.get("login").addClass('btn').addClass('btn-small');if(plugin.config.get("app").config.get("settings.auth.loginButton")==false)this.component.view.get("login").hide();this.component.view.get("login").click(function(){plugin.fixIFrame();plugin.events.publish({"topic":"onLoginClick","data":{}});});};plugin.methods.fixIFrame=function(){var interval1=setInterval(function(){var iframe=$.find(".echo-modal-iframe");if(iframe.length){clearInterval(interval1);$(iframe).attr("scrolling","no");};},100);};plugin.component.renderers.userLogged=function(element){var self=this;this.parentRenderer("userLogged",arguments);var name=this.component.view.get("name");var dd=$(plugin.templateDropdown);name.after(dd);name.prependTo(element.find('.dropdown-toggle'));element.find('.dropdown-toggle').dropdown();var logOut=this.component.view.get("logout");logOut.hide();var edit=this.component.view.get("edit");edit.hide();$(dd.find('li .auth-logout')).html(this.labels.get("logout")).click(function(){self.events.publish({"topic":"onLogoutClick","data":{}});logOut.trigger('click');});if(this.config.get("app").config.get("settings.auth.loginButton")==false){dd.find("i").hide();dd.find("ul").remove();};};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbLoginTerms","Echo.IdentityServer.Controls.Auth");plugin.init=function(){};plugin.labels={"modalTitle":"Terms & Conditions","agreeButton":"I agree","cancelButton":"Cancel"};plugin.component.renderers.userAnonymous=function(element){var plugin=this,component=this.component;this.parentRenderer("userAnonymous",arguments);var el_login=this.component.view.get("login");var el_prompt=el_login.clone(false);el_login.hide();el_login.before(el_prompt);el_prompt.click(function(event){var html=new Echo.GUI.Modal({"data":{"title":plugin.labels.get("modalTitle"),"body":plugin.config.get("text"),"buttons":[{"title":plugin.labels.get("cancelButton"),"handler":function(){plugin.events.publish({"topic":"onCancelClick","data":{}});html.hide();}},{"title":plugin.labels.get("agreeButton"),"extraClass":"btn-primary","handler":function(){plugin.events.publish({"topic":"onAcceptClick","data":{}});html.hide();el_login.trigger('click');}}]},"extraClass":"rtb-apps-comments","header":true,"footer":true,"fade":true,"show":true});});};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbCommentsEdit","Echo.StreamServer.Controls.Submit");plugin.init=function(){};plugin.component.renderers.text=function(element){var plugin=this,component=this.component;this.parentRenderer("text",arguments);var setWidths=function(){var offset=11;plugin.component.view.get("text").css('width',function(){return element.parent().width()-offset;});};setTimeout(function(){setWidths();setTimeout(function(){setWidths()},500);},50);return element;};plugin.component.renderers.markersContainer=function(element){var plugin=this,app=this.config.get("app");plugin.parentRenderer("markersContainer",arguments);if(!Echo.UserSession._isAdmin())element.hide();return element;};plugin.component.renderers.tagsContainer=function(element){var plugin=this,app=this.config.get("app");plugin.parentRenderer("tagsContainer",arguments);if(!Echo.UserSession._isAdmin())element.hide();return element;};plugin.events={"Echo.StreamServer.Controls.Submit.onRender":function(topic,args){var c=args.data.object.content.split('<div class="echo-item-files">');this.config.set("_nonEditContent",(c.length>1?'<div class="echo-item-files">'+c[1]:''));this.component.view.get("text").val(c[0]);},"Echo.StreamServer.Controls.Submit.Plugins.Edit.onEditInit":function(topic,args){var plugin=this,submit=plugin.component;var idx=RTB.Utils.getPostDataContent(args.postData.content,"http://activitystrea.ms/schema/1.0/comment");var text=args.postData.content[idx].object.content;text=text+plugin.config.get("_nonEditContent");plugin.config.set("_nonEditContent",'');args.postData.content[idx].object.content=text;},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,component=this.component;plugin.events.publish({"topic":"onUpdateComplete","data":{"args":args}});}};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;if(!window.RealTidbits)window.RealTidbits={};if(!window.RealTidbits.settings)window.RealTidbits.settings={};RealTidbits.Analytics=function(config,callback){var self=this;var defaults={"domain":document.domain.replace('www.',''),"gaTrackers":[],"mixpanelTrackers":[],"ga":"UA-20691440-1","mixpanel":"948b359d7741fa246376d95399585cc3","ignoreAppkeys":["prod.wwe","dev.wwe","echo::3ones::comments::sportsmansparadiseonline::dev","echo.3ones.comments.cwtv.dev"]};this.config=$.extend(defaults,config);if(RealTidbits.settings.analytics==false)return;if(typeof RealTidbits.settings.domain!="undefined"){this.config.domain=RealTidbits.settings.domain;};$(document).ready(function(){if(RealTidbits.settings.gaDisable==true){}else{setTimeout(function(){if(typeof _gat=='undefined'||typeof _gaq=='undefined'||RealTidbits.settings.gaDisableLoad==true){$.getScript(window.location.protocol+'//www.google-analytics.com/ga.js',function(data,textStatus){self.loadGoogleAnalyticTrackers();self.pageTracker=_gat._getTracker(self.config.googleAnalyticsAccount);self.pageTracker._trackPageview(self.config.appkey+"/"+window.location.hostname);});}else{self.loadGoogleAnalyticTrackers();}},1500);};if(typeof mixpanel=='undefined'){(function(d,c){var a,b,g,e;a=d.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===d.location.protocol?"https:":"http:")+'//api.mixpanel.com/site_media/js/api/mixpanel.2.js';b=d.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b);c._i=[];c.init=function(a,d,f){var b=c;"undefined"!==typeof f?b=c[f]=[]:f="mixpanel";g="disable track track_pageview track_links track_forms register register_once unregister identify name_tag set_config".split(" ");for(e=0;e<g.length;e++)(function(a){b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,0)))}})(g[e]);c._i.push([a,d,f])};window.mixpanel=c})(document,[]);self.loadMixpanelTrackers();}else{self.loadMixpanelTrackers();};self.listenEvents();});};RealTidbits.Analytics.prototype.listenEvents=function(){var app=this;var events=[["RTB.Apps.PageLike.onPageSubscribeEmail","PageEmailSubscribe"],["RTB.Apps.PageLike.onPageSubscribeRSS","PageRSSClick"],["Echo.UserSession.onInit","Login",function(){return Echo.UserSession._isLogged();}],["Echo.StreamServer.Controls.Submit.onPostComplete","Post"],["Echo.StreamServer.Controls.Stream.Item.Plugins.CommunityFlag.onFlagComplete","Flag"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Like.onLikeComplete","Like"],["Echo.StreamServer.Controls.Stream.Plugins.rtbSocialSharing.onShare","PageShare"],["Echo.StreamServer.Controls.Stream.Item.Plugins.rtbUpDownVote.onVoteUp","VoteUp"],["Echo.StreamServer.Controls.Stream.Item.Plugins.rtbUpDownVote.onVoteDown","VoteDown"],["Echo.StreamServer.Controls.Stream.Item.Plugins.rtbSocialSharingStream.onShare","PostShare"],["Echo.StreamServer.Controls.Stream.Item.Plugins.rtbSocialSharingStreamItem.onShare","PostShare"],["Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitTokbox.onTokboxVideoSave","TokboxVideoDownload"],["Echo.StreamServer.Controls.Stream.Item.Plugins.rtbStreamItemTokbox.onTokboxVideoPlay","TokboxVideoPlay"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onUserUpdate","ModerationOnUserUpdate"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onApproveComplete","ModerationOnApproveComplete"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onSpamComplete","ModerationOnSpamComplete"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onDeleteComplete","ModerationOnDeleteComplete"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onUntouchComplete","ModerationOnUntouchComplete"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onBanComplete","ModerationOnBanComplete"],["Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onUserPermissionsComplete","ModerationOnUserPermissionsComplete"]];$.map(events,function(spec){Echo.Events.subscribe({"topic":spec[0],"handler":function(topic,data){if(typeof spec[2]!='undefined'){if(spec[2]()==false)return;};app.track(spec[1],data,{});Echo.Events.publish({"topic":"rtbAnalytics","data":{"event":spec[1],"data":data}});}});});};RealTidbits.Analytics.prototype.loadGoogleAnalyticTrackers=function(){var self=this;_gaq.push(['_setDomain','.'+self.config.domain]);_gaq.push(['b._setAccount',self.config.ga]);_gaq.push(['b._setDomainName','.'+self.config.domain]);if(typeof RealTidbits.settings.googleAnalytics=="string"&&RealTidbits.settings.googleAnalytics.length>0){_gaq.push(['c._setAccount',RealTidbits.settings.googleAnalytics]);_gaq.push(['c._setDomainName','.'+self.config.domain]);self.config.gaTrackers.push('c');};_gaq.push(['b._trackPageview',self.config.appkey+"/"+window.location.hostname]);self.config.gaTrackers.push('b');};RealTidbits.Analytics.prototype.loadMixpanelTrackers=function(){var self=this;mixpanel.init(self.config.mixpanel,{track_pageview:false},"rtbp2");self.config.mixpanelTrackers.push("rtbp2");if(typeof RealTidbits.settings.mixpanelAnalytics=="string"&&RealTidbits.settings.mixpanelAnalytics.length>0){mixpanel.init(RealTidbits.settings.mixpanelAnalytics,{track_pageview:false},"rtbp3");self.config.mixpanelTrackers.push("rtbp3");};};RealTidbits.Analytics.prototype.track=function(eventName,args,eventParams){var app=this;var user_id=Echo.UserSession.get("identityUrl");var eventValue=(typeof eventParams.value=="undefined"?1:eventParams.value);var product=(typeof eventParams.product=="undefined"?null:eventParams.product);var category="RealTidbits";var action=eventName;var opt_label=this.config.appkey;var opt_value=eventValue;var opt_noninteraction=true;var payload={"event":eventName,"value":eventValue,"appkey":this.config.appkey,"domain":this.config.domain,"identityUrl":Echo.UserSession.get("identityUrl"),"name":Echo.UserSession.get("name"),"avatar":Echo.UserSession.get("avatar"),"userRoles":Echo.UserSession.get("roles"),"userState":Echo.UserSession.get("state"),"pageTitle":document.title,"url":window.location.href};try{payload.item_id=args.request.response.objectID;}catch(e){};try{payload.item_id=args.response.objectID;}catch(e){};try{payload.item_id=args.item.data.object.id;}catch(e){};if(payload.name==""||payload.name==null){try{payload.name=args.postData.content[0].actor.name;}catch(e){};};try{payload.item_content=args.postData.content[0].object.content;}catch(e){};try{payload.item_reply=(args.postData.content[1].object.content=="depth:1"?true:false)}catch(e){};$.ajax({url:"http://api.realtidbits.com/events/track",dataType:'jsonp',data:{"payload":payload},success:function(rsp){}});$.map(this.config.gaTrackers,function(e,x){_gaq.push([app.config.gaTrackers[x]+'._trackEvent',category,action,opt_label,opt_value,opt_noninteraction]);});var opts={"appkey":this.config.appkey,"domain":this.config.domain,"product":product,"user":user_id,"url":window.location.href,"value":eventValue};if(typeof eventParams!="undefined"){$.merge(opts,eventParams);};$.map(this.config.mixpanelTrackers,function(e,x){var mp=app.config.mixpanelTrackers[x];if((mp=="rtbp2"&&$.inArray(app.config.appkey,app.config.ignoreAppkeys)==-1)||(mp!="rtbp2")){mixpanel[app.config.mixpanelTrackers[x]].identify(user_id);mixpanel[app.config.mixpanelTrackers[x]].name_tag(user_id);mixpanel[app.config.mixpanelTrackers[x]].track(eventName,opts);}});};})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var PageLike=Echo.App.manifest("RTB.Apps.PageLike");if(Echo.App.isDefined("RTB.Apps.PageLike"))return;PageLike.config={"useSecureAPI":true,"echoItemPath":null,"submissionProxyURL":window.location.protocol+"//apps.echoenabled.com/v2/esp/activity","transport":""};PageLike.labels={"ttBtnPageLike":"Like this page","pageLike":"Like","pageUnlike":"Unlike","alertLoginToLikeTitle":"Oops!","alertLoginToLikeMsg":"You must login to like this page."};PageLike.templates.main='<div class="nav-tabs-action-btn pull-right {class:appPageLike}">'+'<div class="btn-group">'+'<button class="btn dropdown-toggle-main-btn {class:pageLikeButton}">'+'<span class="page-likes-count"></span>'+'<span class="icon-rtb-star-comment"></span>'+'</button>'+'<button class="btn dropdown-toggle dropdown-toggle-caret {class:dropDown}" id="dLabel222" data-toggle="dropdown">'+'<span class="caret"></span>'+'</button>'+'<ul class="dropdown-menu pull-right {class:ul}" aria-labelledby="dLabel222">'+'</ul>'+'</div>'+'</div>';PageLike.renderers.dropDown=function(element){var app=this;element.dropdown();return element;};PageLike.renderers.ul=function(element){var app=this;$.map(app.config.get("dropdown"),function(e,i){if(e.label=="divider"){var li='<li class="divider"></li>';}else{var li=$('<li><a href="javascript:void(0);" class="">'+e.label+'</a><li>');li.find("a").click(function(){e.callback();});};element.append(li);});return element;};PageLike.renderers.pageLikeButton=function(element){var app=this;if(this.config.get("echoItemPath")==null){this.config.set("echoItemPath",window.location.protocol+"//"+RTB.Utils.getDomain(app.config.get("targetURL"))+"/RTB/pages");};this.doRender(element,1);};PageLike.templates.query="childrenof:'{data:url}' itemsPerPage:1 -state:ModeratorDeleted children:0 sortOrder:reverseChronological";PageLike.methods.doRender=function(element,tryCheck){var app=this;var targetPageURL=app.config.get("echoItemPath");var targetURL=app.config.get("targetURL");var targetPageMarker="";if(targetURL.match(/\/ECHO\/item\/0-9$/)){var query="url:'"+targetURL+"'";var markers=['item'];}else{targetPageURL=targetPageURL+"/"+RTB.Utils.encode64(targetURL);var query=this.substitute({"template":PageLike.templates.query,"data":{"url":targetPageURL}});var markers=['page'];};markers.push("permalink:'"+location.href.split("#")[0]+"'")
Echo.StreamServer.API.request({"endpoint":"search","apiBaseURL":app.config.get("apiBaseURL"),"data":{"q":query,"appkey":app.config.get("appkey")},"liveUpdatesTimeout":999,"secure":app.config.get("useSecureAPI"),"recurring":false,"onError":function(data,extra){},"onData":function(data,extra){var response=data;if("entries"in response&&response.entries.length>=1){var item=response.entries[0];var stats=item.object.accumulators||{"likesCount":0,"repliesCount":0};var labelCount=stats.likesCount==0?"":stats.likesCount;element.find(".page-likes-count").text(labelCount);app.set("targetID",item.object.id);app.addLikeButtonRecurring(element,item.object.id);app.addLikeClickEvent(element);var action="Like";if(item.object.likes){action=($.map(item.object.likes,function(entry){if(app.user.has("identity",entry.actor.id))return entry;})).length>0?"Unlike":"Like";if(action=="Unlike")element.find(".icon-rtb-star-comment").addClass("active");}
app.set("pageLikeAction",action);app.events.publish({"topic":"onLikesCount","data":{"stats":stats}});}else{if(tryCheck>=3)setTimeout(function(){app.doRender(element,tryCheck++);},1000);if(app.user.is("logged")){var content='<div class="title">'+RTB.Utils.getProp('title')+'</div>'+'<div class="description">'+RTB.Utils.getProp('description')+'</div>';RTB.Utils.newEchoItem(app.config.get("appkey"),targetPageURL,"realtidbits",content,targetPageMarker+",ignore,"+(markers.join(',')),function(response){app.set("targetID",response.objectID);app.set("pageLikeAction",app.labels.get("pageLike"));app.addLikeButtonRecurring(element,response.objectID);;app.addLikeClickEvent(element);},function(data){},app.config.get("submissionProxyURL"))};app.events.publish({"topic":"onLikesCount","data":{"stats":{"likesCount":0,"repliesCount":0}}});};}}).send();};PageLike.methods.setTitle=function(element,title,delay){element.attr("title",title).tooltip({delay:delay||1250});};PageLike.methods.addLikeClickEvent=function(element){var app=this;element.click(function(){$(this).blur();var likeAction=app.get("pageLikeAction");if(app.user.is("logged")){var activity={"verbs":["http://activitystrea.ms/schema/1.0/"+likeAction.toLowerCase()],"targets":[{"id":app.get("targetID")}]};Echo.StreamServer.API.request({"endpoint":"submit","apiBaseURL":app.config.get("apiBaseURL"),"submissionProxyURL":app.config.get("submissionProxyURL"),"secure":app.config.get("useSecureAPI"),"recurring":false,"onData":function(){if(likeAction=="Like"){var change=1;app.set("pageLikeAction","Unlike");element.find(".icon-rtb-star-comment").addClass("active");}else{var change=-1;app.set("pageLikeAction","Like");element.find(".icon-rtb-star-comment").removeClass("active");};var int=parseInt(element.find(".page-likes-count").text());if(isNaN(int))int=0;var newCount=int+change;element.find(".page-likes-count").html(newCount>0?newCount:'');app.events.publish({"topic":"onLikesCount","data":{"stats":{"likesCount":newCount}}});},"onError":function(){},"data":{"content":activity,"appkey":app.config.get("appkey"),"sessionID":Backplane.getChannelID()}}).send();}else{var target=app.config.get("msgTarget");target.empty();RTB.Utils.Alert(target,app.labels.get("alertLoginToLikeTitle"),app.labels.get("alertLoginToLikeMsg"),"info");};});};PageLike.methods.addLikeButtonRecurring=function(element,id){var query="url:"+id+" itemsPerPage:1 children:0 sortOrder:reverseChronological";var request=Echo.StreamServer.API.request({"endpoint":"search","apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":query,"appkey":this.config.get("appkey")},"secure":this.config.get("useSecureAPI"),"liveUpdates":{"transport":this.config.get("transport")},"liveUpdatesTimeout":180,"recurring":true,"onError":function(data,extra){},"onData":function(data,extra){var item=data.entries[0];if(item){var stats=item.object.accumulators||{"likesCount":0};var labelCount=stats.likesCount==0?"":stats.likesCount;element.find(".page-likes-count").html(labelCount);};}});setTimeout(function(){request.send();},60000);this.config.set("_likeButtonRequest",request);};PageLike.css='.{plugin.class:appPageLike} {margin-left:5px;}'+'.{plugin.class:appPageLike} .page-likes-count {font-size:14px;font-weight:bold;margin-right:4px;color:#555;}'+'.{plugin.class:appPageLike} .icon-rtb-star-comment {}'+'.{plugin.class:appPageLike} .dropdown-toggle-main-btn {line-height:14px !important;height:28px;border-radius:4px 0 0 4px !important;}'+'.{plugin.class:appPageLike} .dropdown-toggle-caret {height:28px;border-radius:0 4px 4px 0 !important;padding:0px !important;position:relative;width:25px;}'+'.{plugin.class:appPageLike} .dropdown-toggle-caret .caret {margin-top:0px !important;border-bottom-color: #555 !important;border-top-color: #555 !important;position:absolute;top:12px;left:8px;}';Echo.App.create(PageLike);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;if(typeof window.RTB!=='object')window.RTB={};RTB.Common={};RTB.Common.getActorCard=function(actor){var fav='';if(actor.id.indexOf(location.hostname)==-1){var t=actor.id.split('/');fav='<img src="//'+t[2]+'/favicon.ico" />';};var avatar=actor.avatar||Echo.Loader.getURL("images/avatar-default.png",false);var a=$('<div class="clearfix rtb-actor-card">'+'<img src="'+avatar+'" class="rtb-actor-card-avatar" />'+'<div class="rtb-actor-card-content">'+'<div class="rtb-actor-card-title">'+fav+' '+actor.title+'</div>'+'<div class="rtb-actor-card-text"></div>'+'</div>'+'</div>');return a;};var UserProfile=Echo.App.manifest("RTB.Apps.UserProfile");if(Echo.App.isDefined("RTB.Apps.UserProfile"))return;UserProfile.config={"target":$('<div></div>'),"actor":undefined,"placement":"right"};UserProfile.labels={"streamTitle":"User's recent comments","labelViewProfile":"View Comments","actorCardComments":"Comments"};UserProfile.templates.main='';UserProfile.templates.popover='<div class="{class:container}">'+'</div>';UserProfile.templates.modalBody='<div class="rtb-userprofile-popover-content">'+'<div class="rtb-apps-user-profile-stream"></div>'+'</div>'
UserProfile.css='.echo-streamserver-controls-facepile-item-container .popover-title, .echo-streamserver-controls-facepile .popover-title {display:none;}'+'.echo-streamserver-controls-facepile-item-container .popover-content {white-space:nowrap;}'+'.rtb-apps-user-profile-avatar {}'+'.rtb-apps-user-profile-stream {}';UserProfile.init=function(){var app=this,actor=this.config.get("actor");function enableLink(){setTimeout(function(){if($('.popover-content').find('a').length){$('.popover-content').find('a').unbind("click").bind("click",function(e){e.stopPropagation();userModalClick();});}else{enableLink();};},500);};var avatar=actor.avatar||Echo.Loader.getURL("images/avatar-default.png",false);var element=this.config.get("element");var isOnElement=false;var cardElement=RTB.Common.getActorCard(actor);var cardText=cardElement.find('.rtb-actor-card-text');var text=$('<p>'+($.inArray('administrator',actor.roles)>=0?'Administrator':'')+'</p>');cardText.append(text);cardText.append($('<a style="font-size:12px;white-space:nowrap;" class="btn btn-small" href="javascript:void(0);">'+app.labels.get("labelViewProfile")+'</a>'));element.parent().css("position","relative");element.popover({placement:this.config.get("placement"),offset:15,trigger:'manual',html:true,content:cardElement,delay:{show:500,hide:0}}).click(function(e){e.preventDefault();}).mouseenter(function(){enableLink();isOnElement=true;});var timer,popover_parent;function hidePopover(elem){if(!isOnElement)$(elem).popover('hide');}
element.hover(function(){var self=this;clearTimeout(timer);$('.popover').hide();popover_parent=self;isOnElement=true;setTimeout(function(){if(isOnElement==true)$(self).popover('show');},750);},function(){var self=this;isOnElement=false;timer=setTimeout(function(){hidePopover(self)},0);});$(document).on({mouseenter:function(){clearTimeout(timer);},mouseleave:function(){var self=this;timer=setTimeout(function(){hidePopover(popover_parent)},300);}},'.popover');this.config.get("element").css("cursor","pointer").click(function(){Echo.Events.publish({"topic":"RTB.Apps.UserProfile.onUserProfileClick"});userModalClick();});function userModalClick(){app.config.get("handler")(actor);};this.render();this.ready();if(app.config.get("fire")==true){isOnElement=true;setTimeout(function(){clearTimeout(timer);$('.popover').hide();popover_parent=element;if(isOnElement==true){element.popover('show');enableLink();};},750);};};Echo.App.create(UserProfile);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbFacepileUserProfiles","Echo.StreamServer.Controls.FacePile.Item");plugin.init=function(){};plugin.config={"defaultAvatar":null};plugin.component.renderers.avatar=function(element){var item=this.component;this.parentRenderer("avatar",arguments);new RTB.Apps.UserProfile(this.config.assemble({"appkey":item.config.get("appkey"),"target":$('<div></div>'),"element":element,"actor":item.data,"placement":this.config.get("placement")||"right","handler":this.config.get("handler"),"actorCommentQuery":"childrenof:'"+window.location.protocol+"//"+RTB.Utils.getDomain(item.config.get("targetURL"))+"/*' -markers:ignore state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved itemsPerPage:10 sortOrder:reverseChronological children:0 safeHTML:permissive"}));return element;};Echo.Plugin.create(plugin);
/*!
 * hoverIntent r7 // 2013.03.11 // jQuery 1.9.1+
 * http://cherne.net/brian/resources/jquery.hoverIntent.html
 *
 * You may use hoverIntent under the terms of the MIT license.
 * Copyright 2007, 2013 Brian Cherne
 */
(function(e){e.fn.hoverIntent=function(t,n,r){var i={interval:100,sensitivity:7,timeout:0};if(typeof t==="object"){i=e.extend(i,t)}else if(e.isFunction(n)){i=e.extend(i,{over:t,out:n,selector:r})}else{i=e.extend(i,{over:t,out:t,selector:n})}var s,o,u,a;var f=function(e){s=e.pageX;o=e.pageY};var l=function(t,n){n.hoverIntent_t=clearTimeout(n.hoverIntent_t);if(Math.abs(u-s)+Math.abs(a-o)<i.sensitivity){e(n).off("mousemove.hoverIntent",f);n.hoverIntent_s=1;return i.over.apply(n,[t])}else{u=s;a=o;n.hoverIntent_t=setTimeout(function(){l(t,n)},i.interval)}};var c=function(e,t){t.hoverIntent_t=clearTimeout(t.hoverIntent_t);t.hoverIntent_s=0;return i.out.apply(t,[e])};var h=function(t){var n=jQuery.extend({},t);var r=this;if(r.hoverIntent_t){r.hoverIntent_t=clearTimeout(r.hoverIntent_t)}if(t.type=="mouseenter"){u=n.pageX;a=n.pageY;e(r).on("mousemove.hoverIntent",f);if(r.hoverIntent_s!=1){r.hoverIntent_t=setTimeout(function(){l(n,r)},i.interval)}}else{e(r).off("mousemove.hoverIntent",f);if(r.hoverIntent_s==1){r.hoverIntent_t=setTimeout(function(){c(n,r)},i.timeout)}}};return this.on({"mouseenter.hoverIntent":h,"mouseleave.hoverIntent":h},i.selector)}})(jQuery)})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbWidgetCommentsPlugin","Echo.StreamServer.Controls.Stream.Item");plugin.templates.badgeWrapper='<div class="{class:badgeWrapper}"></div>';plugin.init=function(){this.extendTemplate("insertAsFirstChild","frame",plugin.templates.badgeWrapper);};plugin.component.renderers.badgeWrapper=function(element){var item=this.component;var user_id=item.data.actor.id;jQuery(item.view.get("authorName")).hide();jQuery(item.view.get("authorName")).before('<a href="'+item.data.target.id+'" class="echo-streamserver-controls-stream-item-authorName">'+item.data.actor.title+'</a>');return element;};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSubmitEmailSubscribe","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){};plugin.config={"followConversation":false};plugin.template='<a href="javascript:void(0);" title="{plugin.label:tooltipFollow}" class="navbar-btn {plugin.class:btn} {plugin.class:followbutton}">'+'<i class="icon-rtb-unfollow"></i>'+'<i class="icon-rtb-follow"></i>'+'</a>';plugin.init=function(){if(Echo.UserSession._isLogged())this.extendTemplate("insertBefore","postContainer",plugin.template);};plugin.labels={"buttonToggle":"Follow","buttonToggleOn":"Unfollow","tooltipFollow":"Follow this conversation via email","tooltipUnfollow":"Unfollow this conversation","enterEmail":"Subscribe to New Comments","userEmail":"Email:","userName":"Name:","noEmail":"No email available to subscribe you to replies to this comment.","notValid":"Email address is not valid.","subscribeButton":"Subscribe","cancelButton":"Cancel","alertSubsribeSuccessTitle":"Yay!","alertSubsribeSuccessMsg":"Post your comment to follow this conversation by email.","alertInvalidEmailTitle":"Oops!","alertInvalidEmailMsg":"Please enter a valid email address.","nowFollowingT":"Yay!","nowFollowingM":"You have enabled following this conversation via email.","nowUnfollowingT":"OK","nowUnfollowingM":"You have disabled following this conversation."};plugin.css='.echo-sdk-ui .navbar .nav > li > a .tooltip {text-shadow:0 0 0 !important;}'+'.{plugin.class:btn} {}'+'.{plugin.class:btn} .icon-rtb-unfollow {background-position:-75px 0 !important;width:17px !important;height:16px !important;}'+'.{plugin.class:btn} .icon-rtb-follow {background-position:-95px 0 !important;width:17px !important;height:16px !important;}'+'';plugin.renderers.followbutton=function(element){var plugin=this,submit=plugin.component;element.find('.icon-rtb-follow').hide();element.find('.icon-rtb-unfollow');var tt=$(submit.config.data.target);var email=plugin.component.user.get("email");element.click(function(event){$(this).blur();element.find('.icon-rtb-follow').hide();element.find('.icon-rtb-unfollow').hide();if(plugin.config.get("followConversation")==true){element.find('.icon-rtb-unfollow').show();plugin.config.set("followConversation",false);RTB.Utils.Alert(submit.view.get("body"),plugin.labels.get("nowUnfollowingT"),plugin.labels.get("nowUnfollowingM"),"success",true,true);}else{element.find('.icon-rtb-follow').show();plugin.config.set("followConversation",true);if(typeof email=="undefined"||email==""||email==null){RTB.Utils.Alert(submit.view.get("body"),plugin.labels.get("nowFollowingT"),plugin.labels.get("nowFollowingM"),"success",true,true);}else{RTB.Utils.Alert(submit.view.get("body"),plugin.labels.get("nowFollowingT"),plugin.labels.get("nowFollowingM"),"success",true,true);}}});};plugin.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,submit=plugin.component;if(plugin.config.get("followConversation")){var email=plugin.component.user.get("email");if(typeof email=="undefined"||email==""||email==null){var modalBody='<div class="echo-email-error"></div>'+
plugin.labels.get("userEmail")+'<br> '+'<input type="text" id="em_email" name="email" style="width:225px;" /><br> '+
plugin.labels.get("userName")+'<br> '+'<input type="text" id="em_name" name="displayName" style="width:225px;" value="'+
(plugin.component.user.get("name")?plugin.component.user.get("name"):'')+'" /> <p>';var html=new Echo.GUI.Modal({"data":{"title":plugin.labels.get("enterEmail"),"body":modalBody,"buttons":[{"title":plugin.labels.get("cancelButton"),"extraClass":"","handler":function(){html.hide();}},{"title":plugin.labels.get("subscribeButton"),"extraClass":"btn-primary","handler":function(){var el=html.element;var email=el.find('#em_email').val();var displayName=el.find('#em_name').val();if(plugin.isEmail(email)){html.hide();plugin.sendSubscribe(email,displayName,args);}else{var tt=el.find('.echo-email-error');RTB.Utils.Alert(tt,plugin.labels.get("alertInvalidEmailTitle"),plugin.labels.get("alertInvalidEmailMsg"),"error");}}}]},"extraClass":"rtb-apps-comments","header":true,"footer":true,"fade":true,"show":true});}else{plugin.sendSubscribe(email,Echo.UserSession.get("name"),args);};};plugin.config.set("followConversation",false);$(submit.config.data.target).find(".echo-streamserver-controls-submit-plugin-rtbSubmitEmailSubscribe-followbutton").removeClass("active");}};var _reEmail=/^(?:[a-zA-Z0-9_.-])+@(?:(?:[a-zA-Z0-9-])+.)+(?:[a-zA-Z0-9]{2,4})+$/;plugin.methods.isEmail=function(str){return _reEmail.test(str);};plugin.methods.sendSubscribe=function(email,name,args){var plugin=this,submit=plugin.component;var isReply=(typeof submit.plugins.Reply!="undefined"?true:false);var query="childrenof:"+args.targetURL+" itemsPerPage:25 sortOrder:reverseChronological -state:ModeratorDeleted -user.state:ModeratorBanned,ModeratorDeleted children:2 -state:ModeratorDeleted -user.state:ModeratorBanned,ModeratorDeleted";var rxEmail=/\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;if(rxEmail.test(email)){var hurl=$(location).attr("href");var hname=$(document).attr("title");var cmd="subscribe";var params={"query":query,"appkey":submit.config.get("appkey"),"email":email,"displayName":name,"cmd":cmd,"hurl":hurl,"hname":hname,"expire":"999","format":"jsonp"};try{var EBURL="https://api.embarke.com";$.get(EBURL+"/v1/public/echosubscribe",params,function(data){},"jsonp");}catch(e){}
if(plugin.config.get("msgTarget")){var alertEl=$(plugin.config.get("msgTarget"));}else{var alertEl=submit.view.get("body");};RTB.Utils.Alert(alertEl,plugin.labels.get("alertSubsribeSuccessTitle"),plugin.labels.get("alertSubsribeSuccessMsg"),"success");plugin.events.publish({"topic":"onSubscribe","data":{}});}};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamEmailSubscribe","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){};plugin.config={"renderButton":true};plugin.template='<div class="{plugin.class:emaillink}"><a href="javascript:void(0);"><button class="btn btn-mini {plugin.class:emailbutton}" title="{plugin.label:buttonLabel}"><i class="icon-envelope"></i></button></a></div>';plugin.init=function(){var plugin=this;if(plugin.config.get("renderButton")==true){plugin.extendTemplate("insertAsFirstChild","header",plugin.template);}};plugin.labels={"buttonLabel":"Subscribe via email","enterEmail":"Subscribe to New Comments","userEmail":"Email:","userName":"Name:","noEmail":"No email available to subscribe you to replies to this comment.","notValid":"Email address is not valid.","subscribeButton":"Subscribe","cancelButton":"Cancel","success":"You are now following this conversation.","goodJob":"Good job!","alertInvalidEmailTitle":"Oops!","alertInvalidEmailMsg":"Please enter a valid email address."};plugin.css='.{plugin.class:emaillink} { margin-left:5px; float: right; }';plugin.renderers.emailbutton=function(element){element;};plugin.renderers.emaillink=function(element){var plugin=this,stream=plugin.component;element.find('a').click(function(){plugin.emailSubscribe();});};plugin.methods.emailSubscribe=function(alertTarget){var plugin=this,stream=plugin.component;var email=plugin.component.user.get("email");if(typeof email=="undefined"||email==""||email==null){var modalBody='<div class="echo-email-error"></div>'+
plugin.labels.get("userEmail")+'<br> '+'<input type="text" id="em_email" name="email" style="width:225px;" /><br> '+
plugin.labels.get("userName")+'<br> '+'<input type="text" id="em_name" name="displayName" style="width:225px;" value="'+
(plugin.component.user.get("name")?plugin.component.user.get("name"):'')+'" /> <p>';var html=new Echo.GUI.Modal({"data":{"title":plugin.labels.get("enterEmail"),"body":modalBody,"buttons":[{"title":plugin.labels.get("cancelButton"),"extraClass":"","handler":function(){html.hide();}},{"title":plugin.labels.get("subscribeButton"),"extraClass":"btn-primary","handler":function(){var el=html.element;var email=el.find('#em_email').val();var displayName=el.find('#em_name').val();if(plugin.isEmail(email)){html.hide();plugin.sendSubscribe(email,displayName,alertTarget);}else{var tt=el.find('.echo-email-error');RTB.Utils.Alert(tt,plugin.labels.get("alertInvalidEmailTitle"),plugin.labels.get("alertInvalidEmailMsg"),"error");}}}]},"extraClass":"rtb-apps-comments","header":true,"footer":true,"fade":true,"show":true});}else{plugin.sendSubscribe(email,Echo.UserSession.get("name"),alertTarget);};};plugin.methods.isEmail=function(str){var re=/^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;if(str.match(re)){return true;}else{return false;};};plugin.methods.sendSubscribe=function(email,name,alertTarget){var plugin=this,stream=plugin.component;var rxEmail=/\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;if(rxEmail.test(email)){var hurl=$(location).attr("href");var hname=$(document).attr("title");var cmd="subscribe";var params={"query":stream.config.get("query"),"appkey":stream.config.get("appkey"),"email":email,"displayName":name,"cmd":cmd,"hurl":hurl,"hname":hname,"expire":"999","format":"jsonp"};try{var EBURL="https://api.embarke.com";$.get(EBURL+"/v1/public/echosubscribe",params,function(data){},"jsonp");}catch(e){}
var alertMsg=$('<div class="alert alert-success">'+'<button type="button" class="close" data-dismiss="alert">\u2715</button>'+'<strong>'+plugin.labels.get("goodJob")+'</strong> '+plugin.labels.get("success")+'</div>');alertMsg.hide();if(alertTarget){$(alertTarget).append(alertMsg);}else{$(stream.config.data.target).before(alertMsg);};alertMsg.slideDown("slow");setTimeout(function(){try{alertMsg.slideUp("slow");}catch(e){};},7500);plugin.events.publish({"topic":"onSubscribe","data":{}});}};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbGoFundMe","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"rtbCommentsApp":{},"url":""};plugin.labels={};plugin.init=function(){var plugin=this,component=plugin.component;var rtbComments=plugin.config.get("rtbCommentsApp");var scheme=window.location.protocol==="https:"?window.location.protocol:"http:";var _c=rtbComments.get("_streamsToDestroy",[]);jQuery(jQuery(rtbComments.view.get("streamNav")).find('.nav-tabs')[0]).append(jQuery('<li>').attr({'data-value':'gofundme'}).append(jQuery('<a>').attr({href:'javascript:void(0);'}).html('Local Giving')));jQuery(rtbComments.view.get("streamNav")).find('li').each(function(){jQuery(this).click(function(){var element=rtbComments.view.get("streamNav");element.find(".nav-tabs li").removeClass("active");jQuery(this).addClass("active");jQuery(this).find("a").blur();var tab=jQuery(this).data("value");var caret=rtbComments.view.get("streamNav").find(".tabDiscussionCaret");$.map(_c,function(e,i){e.destroy();});switch(tab){case'discussion':jQuery('#rtb-comments-gofundme').hide();break;case'community':jQuery('#rtb-comments-gofundme').hide();break;case'gofundme':caret.hide();if(jQuery('#rtb-comments-gofundme').length){jQuery('#rtb-comments-gofundme').show();}else{var iframe_src="http://www.gofundme.com/mvc.php?route=localgiving/vosd&nocache=1&url="+plugin.config.get("url")+"&aff=rtb_vosd&domain="+encodeURIComponent(scheme+"//"+document.domain);var iframe=jQuery('<iframe width="100%" height="500" frameborder="0" src="'+iframe_src+'" id="rtb-comments-gofundme"></iframe>');rtbComments.view.get("streamWrapper").before(iframe);var if_height;jQuery.receiveMessage(function(e){var h=Number(e.data.replace('height|',''));if(isNaN(h)){h=Number(e.data.replace('scroll|',''));}
if(!isNaN(h)&&h>0&&h!==if_height){iframe.height(if_height=h);}},'http://www.gofundme.com');}
rtbComments.view.get("streamWrapper").hide();rtbComments.view.get("streamAlternate").empty();break;};rtbComments.set("_currentTab",tab);rtbComments.set("_streamsToDestroy",_c);})})};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamInlineMedia","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"carousel":{},"showVideoModal":true,"thumbnail":{"height":80}};plugin.dependencies=[];plugin.init=function(){};plugin.labels={"imageOnError":"Image could not load.","labelDownload":"Download"};plugin.component.renderers.text=function(element){var plugin=this,item=this.component;this.parentRenderer("text",arguments);var itemType=RTB.Utils.getMarker("itemType",item.data.object.markers||[],true);if(!itemType)itemType="comment";element.addClass("echo-item-type-"+itemType);var arr=plugin.config.get("carousel");var arrEl=[];element.find('.echo-item-files').children().each(function(){if($(this).hasClass("echo-item-video")||$(this).hasClass("echo-item-richmedia")){var dataEncode=$(this).data('encoded');if(dataEncode){var decodedX=RTB.Utils.decode64(dataEncode);$(this).html(decodedX);};};if($(this).hasClass("echo-item-video")){var mediaSrc=$(this).attr("data-media-src");if(mediaSrc){var newMediaObject=plugin.getEmbed(mediaSrc,400,'100%');$(this).find('object').replaceWith($(newMediaObject));};};});element.find('.echo-item-files').children().each(function(){if($(this).hasClass("echo-item-richmedia")&&$(this).find('.twitter-tweet').length>0){$(this).append('<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>');};});element.find('.echo-item-photo, .echo-item-video').each(function(){if($(this).hasClass("echo-item-photo")||$(this).hasClass("echo-item-video")){var idx=arrEl.length;var caption=$(this).find("img").attr("title");if($(this).find('a > img').length==1){$(this).find("img").attr("width","").attr("height","");var imgSrc=$(this).find("a").attr("href");var imgSrc2=$(this).find("img").attr("src");if(imgSrc2.indexOf("pbs.twimg.com"))imgSrc2=imgSrc2.replace(":thumb","");var itemHtml='<a href="'+imgSrc+'" target="_blank">'+'<img src="'+imgSrc+'" onerror="this.src=\''+imgSrc2+'\';" /></a>';}else{var itemHtml=$(this).html();};arrEl.push({'idx':idx,'html':itemHtml,'caption':caption});$(this).data("idx",idx);};if($(this).hasClass("echo-item-media-page")){var img_src=$($(this).find('img')[0]);if(typeof img_src.attr('src')=="undefined"){$(img_src).attr('src',$(this).data('thumbnail'));}}});arr[item.data.id]=arrEl;plugin.config.set("carousel",arr);element.find('.echo-item-video').each(function(){var itemOrigHtml=$(this).html();var thumbnail=$(this).data("thumbnail");if(thumbnail&&plugin.config.get("showVideoModal")){$(this).html('<a href="javascript:void(0);"><img data-type="video" src="'+thumbnail+'" /><span></span></a>');};var n=itemOrigHtml.match(/"http:\/\/www\.youtube\.com\/v\/.+?"/g);if(n&&Echo.UserSession._isAdmin()){var el_download=$('<div><small><a href="" target="_blank">'+plugin.labels.get("labelDownload")+'</a></small></div>');var dUrl2=n[0].replace('"','');dUrl2=dUrl2.split('?')[0];dUrl2=dUrl2.split('&')[0];var dUrl="http://www.clipconverter.cc/?format=mp4&url="+encodeURIComponent(dUrl2)+"#uploadurl";el_download.find("a").attr("href",dUrl);$(this).append(el_download);};});element.find('a > img').each(function(){var self=this;$(this).css("height",plugin.config.get("thumbnail").height+"px");var image=$(this);if($(this).data("type")=="video"){var defaultMinWidth=150;var wSet=null;var imageResize=setInterval(function(){var container=plugin.component.view.get("body");var w=container.width();if(wSet==w)clearInterval(imageResize);wSet=w;if(itemType=="video"){var w2=w;}else{var nWidth=(w/2)-30;var w2=nWidth<defaultMinWidth?w:nWidth;};image.css("height","").css("width",w2);},250);$(this).parent().click(function(){var idx=$(this).parent().data("idx");plugin.events.publish({"topic":"onMediaOpen","data":{"video":$(this)}});var arr=plugin.config.get("carousel");var itemMedia=arr[item.data.id][idx];var elVideo=$(itemMedia.html);$(this).parent().empty().append(elVideo);if(elVideo.prop('tagName')=="IFRAME"){var itemBodyWidth=plugin.component.view.get("body").width();if(itemType=="video"){elVideo.attr("width",itemBodyWidth).attr("height",(itemBodyWidth*169/300));}else{var iWidth=elVideo.attr("width");var iHeight=elVideo.attr("height");var newWidth=itemBodyWidth-25;elVideo.animate({width:newWidth,height:newWidth*iHeight/iWidth},1000,function(){});};};return false;});}else{$(this).parent().click(function(){var idx=$(this).parent().data("idx");var destination=element.offset().top-75;plugin.events.publish({"topic":"onMediaOpen","data":{"img":$(this)}});plugin.launchLightbox(item.data.id,parseInt(idx),destination);return false;});};$(this).error(function(){var parent=$(this).parent();var a=$('<div class="icon-minus-sign">&nbsp;</div>');parent.append(a);$(this).remove();a.attr("title",plugin.labels.get("imageOnError"));});});var numberPhotos=element.find('.echo-item-photo').length;if(itemType=="photo"&&numberPhotos>0){var wSet=null;var imageResize=setInterval(function(){var container=plugin.component.view.get("body");var w=container.width();if(wSet==w){clearInterval(imageResize);var elItemPhoto=$(element.find('.echo-item-photo')[0]);var elImage1=elItemPhoto.find('a > img');var w5=Math.floor(w/100);var w6=(w/w5);element.find('.echo-item-photo').each(function(){var elImage=$(this).find('a > img');elImage.css("height","").css("width",w6);});var isImage1Chute=(elImage1.attr("src").indexOf("chute.com")==-1?false:true);if(!isImage1Chute){if(elImage1.attr("data-src-full")){elImage1.attr("src",elImage1.attr("data-src-full"));};};var image1WidthVal=w;var image1HeightVal=200;if(numberPhotos==1){elImage1.css("width",w);image1HeightVal=250;}else{image1WidthVal=Math.round(w*0.66);elImage1.css("width",image1WidthVal).css("max-width","inherit");elItemPhoto.css("width",image1WidthVal);if(!isImage1Chute&&elImage1.height()<image1HeightVal){elImage1.css("width","").css("height",image1HeightVal).css("max-width","inherit").css("margin-left","-"+((elImage1.width()-image1WidthVal)/2)+"px");};var elItemPhoto2=elItemPhoto.next();var elImage2=elItemPhoto2.find('a > img');var isImage2Chute=(elImage2.attr("src").indexOf("chute.com")==-1?false:true);var halfImageW=elImage2.width()/2;elImage2.css("height",'200px').css("width","").css("max-width","inherit");if(!isImage2Chute){elImage2.css("margin-left","-"+halfImageW+"px");};elItemPhoto2.css("width",w-image1WidthVal).css("height",image1HeightVal).css("overflow","hidden").css("background","#000");if(!isImage2Chute&&elImage2.attr("data-src-full")){elImage2.attr("src",elImage2.attr("data-src-full"));};if(isImage2Chute){elImage2.attr("src",elImage2.attr("data-src-full")+"/"+(w-image1WidthVal)+"x"+image1HeightVal);};};if(isImage1Chute){elImage1.attr("src",elImage1.attr("data-src-full")+"/"+image1WidthVal+"x"+image1HeightVal);};elItemPhoto.css("height",image1HeightVal).css("overflow","hidden").css("background","#000");};wSet=w;},250);};element.find('a').attr('target','_blank');return element;};plugin.methods.launchLightbox=function(itemId,idx,destination){var plugin=this;var arr=plugin.config.get("carousel");arr=arr[itemId];var a2=arr.slice(idx);var a3=arr.slice(0,idx);var arr=a2.concat(a3);var modalBody='<div id="this-carousel-id" class="carousel slide">'+'<div class="carousel-inner">';$.map(arr,function(x,i){var itemHtml=$('<span>'+arr[i].html+'</span>');itemHtml.find(">:first-child").css("margin","0 auto").css("display","block");var hasIframe=(itemHtml.find("iframe").length==1?true:false);itemHtml.find("iframe").attr("height",375).attr("width",500);modalBody+='<div class="item'+(i==0?' active':'')+'">'+
itemHtml.html()+
(hasIframe==false&&arr[i].caption?'<div class="carousel-caption">'+'<p>'+arr[i].caption+'</p>'+'</div>':'')+'</div>';});modalBody+='</div>'+
(arr.length>1?'<a class="carousel-control left" href="#this-carousel-id" data-slide="prev">&lsaquo;</a>'+'<a class="carousel-control right" href="#this-carousel-id" data-slide="next">&rsaquo;</a>':'')+'</div>';modalBody=$('<span>'+modalBody+'</span>');modalBody.find('.item a').each(function(){$(this).click(function(){return false;});});var html=new Echo.GUI.Modal({"data":{"body":modalBody},"extraClass":"rtb-plugin-media fade in","header":false,"footer":false,"fade":true,"show":true,"onShow":function(self,element){var el=modalBody.find(".carousel");el.carousel('pause');el.bind('slid',function(e){});}});};plugin.methods.getEmbed=function(url,height,width){return'<object width="'+width+'" height="'+height+'"><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="wmode" value="transparent" /><param name="movie" value="'+url+'" /><embed src="'+url+'" allowFullScreen="true" allowScriptAccess="always" type="application/x-shockwave-flash" width="'+width+'" height="'+height+'"></embed></object>';}
plugin.css='.echo-item-files {margin-top:5px;clear:both;}'+'.echo-item-files a {}'+'.echo-item-type-comment .echo-item-photo, .echo-item-type-comment .echo-item-video {border-radius: 5px;border-top:1px solid #EEE;border-right: 1px solid #DDDDDD;border-bottom: 1px solid #BBB;border-left: 1px solid #DDDDDD;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);overflow:hidden;background-color:#fff;padding:8px;}'+'.echo-item-video {position:relative;float:left;}'+'.echo-item-video span {position: absolute;display: block;background: url(http://dev.realtidbits.com/libs/v3/img/play.png);height: 48px;width: 48px;top: 50%;left: 50%;margin-left: -24px;margin-top: -24px;opacity:0.8}'+'.echo-item-type-comment .echo-item-video img, .echo-item-type-comment .echo-item-photo img {max-width:inherit;border:1px solid #BBB;border-radius:2px;}'+'.echo-item-type-comment .echo-item-photo, .echo-item-richmedia, .echo-item-type-comment .echo-item-video {margin: 0 8px 8px 0;float:left;}'+'.echo-item-photo {float:left;}'+'.echo-item-richmedia {}'+'.echo-item-media-page {background-color:#f4f4f4;overflow:hidden;padding:8px;}'+'.echo-item-media-page {font-size:12px; width:100%;line-height: 1.4em;float: left;margin:0 8px 8px 0;padding:0;}'+'.echo-item-media-page-details {padding:8px;}'+'.echo-item-media-page img {width:80px;border:1px solid #BBB;border-radius:2px;float:left;margin:8px;}'+'.echo-item-media-page .echo-item-media-page-image {margin-left:88px;}'+'.echo-item-media-page .echo-item-media-title {font-weight:bold;}'+'.echo-item-media-page .echo-item-media-url a {color:#999;font-weight:normal;}'+'.carousel-inner .item img {display:block;margin:0 auto;}'+'.echo-sdk-ui .rtb-plugin-media.modal {border-radius: 10px;}'+'.echo-sdk-ui .rtb-plugin-media .carousel {margin-bottom:0px;}'+'.rtb-plugin-media .carousel-inner .item {background-color:#000;}'+'.rtb-plugin-media .carousel-inner .item img {max-height: 400px;min-height:200px;}'+'.echo-sdk-ui .rtb-plugin-media .modal-body {border-radius: 6px;padding: 0px;max-height: inherit;}'+'.echo-streamserver-controls-stream-item-markers {clear:both;}'+'.echo-streamserver-controls-stream-item-tags {clear:both;}';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbMarkup","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.component.renderers.text=function(element){var plugin=this,item=this.component;this.parentRenderer("text",arguments);var text=element.html();var text_cloned=element.find('.echo-item-files').clone(true);var t=text.split('<div class="echo-item-files"');element.html(t[0]);element.append(text_cloned);return element;};Echo.Plugin.create(plugin);function superTextile(s){var r=s;var qtags=[['\\*','strong'],['\\?\\?','cite'],['\\+','ins'],['~','sub'],['\\^','sup'],['@','code']];for(var i=0;i<qtags.length;i++){var ttag=qtags[i][0];var htag=qtags[i][1];var re=new RegExp(ttag+'\\b(.+?)\\b'+ttag,'g');r=r.replace(re,'<'+htag+'>'+'$1'+'</'+htag+'>');}
re=new RegExp('\\b_(.+?)_\\b','g');r=r.replace(re,'<em>$1</em>');re=new RegExp('(.*)\n([^#\*\n].*)','g');r=r.replace(re,'$1<br />$2');re=new RegExp('\n<br />','g');r=r.replace(re,'\n');re=new RegExp('\n<br>','g');r=r.replace(re,'\n');r=r.replace(/<br>/g,'<br />');re=new RegExp('<br />','g');r=r.replace(re,'\n');var lines=r.split('\n');var nr='';for(var i=0;i<lines.length;i++){var line=lines[i].replace(/\s*$/,'');var changed=0;if(line.search(/^\s*bq\.\s+/)!=-1){line=line.replace(/^\s*bq\.\s+/,'\t<blockquote>')+'</blockquote>';changed=1;}
if(line.search(/^\s*h[1|2|3|4|5|6]\.\s+/)!=-1){var re=new RegExp('h([1|2|3|4|5|6])\.(.+)','g');line=line.replace(re,'<h$1>$2</h$1>');changed=1;}
if(line.search(/^\s*\*\s+/)!=-1){line=line.replace(/^\s*\*\s+/,'\t<liu>')+'</liu>';changed=1;}
if(line.search(/^\s*#\s+/)!=-1){line=line.replace(/^\s*#\s+/,'\t<lio>')+'</lio>';changed=1;}
if(!changed&&(line.replace(/\s/g,'').length>0))line=line+'<br />';lines[i]=line+'\n';}
var inlist=0;var listtype='';for(var i=0;i<lines.length;i++){var line=lines[i];if(inlist&&listtype=='ul'&&!line.match(/^\t<liu/)){line='</ul>\n'+line;inlist=0;}
if(inlist&&listtype=='ol'&&!line.match(/^\t<lio/)){line='</ol>\n'+line;inlist=0;}
if(!inlist&&line.match(/^\t<liu/)){line='<ul>'+line;inlist=1;listtype='ul';}
if(!inlist&&line.match(/^\t<lio/)){line='<ol>'+line;inlist=1;listtype='ol';}
lines[i]=line;}
r=lines.join('\n');r=r.replace(/li[o|u]>/g,'li>');return r;}})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbMediaResolverSubmit","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"apiKey":"af85c8b8b62d11e1b9d24040aae4d8c9","mediaList":[],"limit":5};plugin.init=function(){this.config.set("mediaList",[]);this.extendTemplate("insertAfter","body",plugin.templateMedia);this.extendTemplate("insertBefore","postContainer",plugin.template);this.extendTemplate("insertAsLastChild","content",plugin.submitMediaInputWrapper);};plugin.template='<a href="javascript:void(0);" class="{plugin.class:attachURLs} navbar-btn" title="{plugin.label:tooltip}"><i class="icon-rtb-link"></i></a>';plugin.templateMedia='<div class="{plugin.class:submitMediaWrapper} clearfix"></div>';plugin.submitMediaInputWrapper='<div class="{plugin.class:submitMediaInputWrapper} rtb-submit-field-bottom clearfix"></div>';plugin.labels={"tooltip":"Attach a URL","titleRemove":"Remove","alertValidUrlT":"Oops!","alertValidUrlM":"Please enter a valid URL.","urlInput":"URL","cancel":"Cancel","ok":"Add"};plugin.renderers.attachURLs=function(element){var plugin=this,submit=plugin.component;element.click(function(event){plugin.doLinkBox();});};plugin.methods.hideLinkBox=function(){var plugin=this,submit=plugin.component;var elementWrapper=plugin.view.get('submitMediaInputWrapper');elementWrapper.empty().hide();};plugin.methods.doLinkBox=function(label){var plugin=this,submit=plugin.component;var elementWrapper=plugin.view.get('submitMediaInputWrapper');if(elementWrapper.is(":visible")){elementWrapper.empty().hide();}else{var form=$('<input type="text" value="" /><a href="javascript:void(0);">OK</a>');elementWrapper.append(form);elementWrapper.slideToggle();elementWrapper.find("input").iHint({"text":label||plugin.labels.get("urlInput"),"className":"echo-secondaryColor"});var fnInputEnter=function(){var val=elementWrapper.find('input').val();if(RTB.Utils.isUrlValid(val)){var urlsToGet=[];var arr=plugin.config.get("mediaList",[]);var urls=[val];$.map(urls,function(x,i){var isInArray=false;$.map(arr,function(x2,i2){if(x2.urlOrig==x)isInArray=true;});if(!isInArray)urlsToGet.push(x);});if(urlsToGet.length>0){plugin.processUrls(urlsToGet);};elementWrapper.find('input').val("").blur();}else{RTB.Utils.Alert(submit.view.get("body"),plugin.labels.get("alertValidUrlT"),plugin.labels.get("alertValidUrlM"),"error");};};elementWrapper.find("input").keypress(function(e){if(e.which==13)fnInputEnter();});elementWrapper.find("a").html(plugin.labels.get("ok")).click(function(){fnInputEnter();});};};plugin.renderers.submitMediaWrapper=function(element){var plugin=this,submit=plugin.component;element.hide();};plugin.renderers.submitMediaInputWrapper=function(element){var plugin=this,submit=plugin.component;element.hide();};plugin.component.renderers.text=function(element){var plugin=this,submit=plugin.component;plugin.parentRenderer("text",arguments);element.bind('paste',function(e){var self=this;setTimeout(function(){var val=$(self).val();var urls=plugin.getURLs(val);urls=jQuery.unique(urls);var urlsToGet=[];var arr=plugin.config.get("mediaList",[]);$.map(urls,function(x,i){var isInArray=false;$.map(arr,function(x2,i2){if(x2.urlOrig==x)isInArray=true;});if(!isInArray)urlsToGet.push(x);});var urlsToGet=urlsToGet.slice(0,plugin.config.get('limit'));if(urlsToGet.length)plugin.processUrls(urlsToGet);},250);});};plugin.methods.processUrls=function(urls){var plugin=this;plugin.getEmbedly(urls,function(response){$.map(response,function(x,i){if(x.type=="error")return;var asset={"rsp":x,"url":urls[i]};plugin.addEmbedItem(asset);});});};plugin.methods.addEmbedItem=function(response){var plugin=this,submit=plugin.component;if(response.url.indexOf('#!/post/')>0){var itemUrl='http://'+RTB.Utils.getDomain(response.url)+'/ECHO/item/'+response.url.split('/').pop();var request=Echo.StreamServer.API.request({"endpoint":"search","apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":"url:"+itemUrl+" itemsPerPage:1 children:0 safeHTML:permissive","appkey":submit.config.get("appkey")},"liveUpdatesTimeout":999,"secure":true,"recurring":false,"onError":function(data,extra){},"onData":function(data,extra){var items=data.entries;if(items.length>0){var c=$('<span>'+items[0].object.content+'</span>');c.find(".echo-item-files").remove();var fData=c.find('.echo-item-data');var object_title="";if(fData.length>0){object_title=fData.data('title');}else{object_title=c.text();};object_title=object_title.replace(/(\r\n|\n|\r)/gm,"");object_title=RTB.Utils.truncate(object_title,75);response.rsp.title=object_title;response.rsp.description=c.text();plugin.addEmbedItem2(response);};}}).send();}else{plugin.addEmbedItem2(response);};};plugin.methods.addEmbedItem2=function(response){var plugin=this,submit=plugin.component;plugin.events.publish({"topic":"onAttach","data":{"rsp":response.rsp}});var added_url=response.url;var response=response.rsp;var id=Math.floor(Math.random()*10000001);response.id=id;response.urlOrig=added_url;var embedURL=('url'in response?response.url:added_url);response.url=embedURL;switch(response.type){case"photo":var itemEl=$('<div class="echo-media-preview echo-media-preview-photo" data-id="'+response.id+'">'+'<img src="'+('thumbnail_url'in response?response.thumbnail_url:response.url)+'" />'+'</div>');break;case"video":var itemEl=$('<div class="echo-media-preview echo-media-preview-video" data-id="'+response.id+'">'+'<img src="'+response.thumbnail_url+'" />'+'</div>');break;case"rich":if(response.provider_name=="Twitter")response.html=this.fixTwitterEmbed(response);var itemEl=$('<div class="echo-media-preview echo-media-preview-rich" data-id="'+response.id+'">'+
response.html+'</div>');break;case"link":var title=("title"in response?response.title:response.provider_name);var pageImage=("thumbnail_url"in response?response.thumbnail_url:null);var pageDesc=("description"in response?RTB.Utils.truncate(response.description,250):null);response.html=(pageImage?'<img src="'+pageImage+'" />':'')+'<div class="echo-item-media-page-details '+(pageImage?'echo-item-media-page-image':'')+'">'+'<div class="echo-item-media-title">'+'<a href="'+response.urlOrig+'">'+title+'</a>'+'<div class="echo-item-media-url">'+response.urlOrig+'</div>'+'</div>'+
(pageDesc?'<div class="echo-item-media-description">'+pageDesc+'</div>':'')+'</div>';var itemEl=$('<div class="echo-media-preview echo-media-preview-page" data-id="'+response.id+'">'+
response.html+'</div>');break;default:return;break;};itemEl.addClass(response.provider_name);var element=plugin.view.get('submitMediaWrapper');var btn=$('<span class="btn-remove" data-id="'+response.id+'"></span>');btn.on('click',function(){var id=$(this).attr("data-id");var arr=plugin.config.get("mediaList");arr=jQuery.grep(arr,function(value){return value.id!=id;});plugin.config.set("mediaList",arr);itemEl.slideUp('slow',function(){itemEl.remove();});if(arr.length<=0)element.slideUp().empty();});btn.hide();itemEl.prepend(btn);itemEl.bind('mouseover',function(){btn.show();}).bind('mouseout',function(){btn.hide();});var arr=plugin.config.get("mediaList");arr.push(response);plugin.config.set("mediaList",arr);if(arr.length>0)element.slideDown();itemEl.hide().appendTo(element).slideDown();};plugin.methods.toggleWrapper=function(show){var plugin=this;var element=plugin.view.get('submitMediaWrapper');if(show){if(!element.is(":visible"))element.slideDown();}else{var arr=plugin.config.get("mediaList");if(arr.length<=0)element.slideUp().empty();};};plugin.methods.toggleLoader=function(show){var plugin=this;var element=plugin.view.get('submitMediaWrapper');if(show&&!element.find('.media-resolver-loader').length){plugin.toggleWrapper(true);element.prepend($('<div class="media-resolver-loader"><img src="'+Echo.Loader.getURL("images/loading.gif",false)+'" /></div>'));}else{element.find('.media-resolver-loader').slideUp('slow',function(){$(this).remove();});};};plugin.methods.getEmbedly=function(urls,callback){var plugin=this;plugin.toggleLoader(true);var endpoint=window.location.protocol+"//api.embed.ly/1/oembed?"+"urls="+urls.map(escape).join(',');$.get(endpoint,{"maxwidth":300,"wmode":"opaque","format":"json","key":plugin.config.get('apiKey')},function(response){response=response||{};callback(response);plugin.toggleLoader(false);},"jsonp");};plugin.methods.getURLs=function(objTxt){var urlpatt=new RegExp(/((https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|!])/ig);var objArray=objTxt.split(' ');var arr=[];$.each(objArray,function(key,value){var result=value.match(urlpatt);if(result!==null)arr.push(result[0]);});arr=arr.reverse();return arr;};plugin.methods.fixTwitterEmbed=function(response){var tmp=$(response.html);var a=tmp.find('.embedly_timestamp a').eq(0);var tmp_url=a.attr("href");var tmp_ts=a.attr("title");var tmp_ts2=a.html();var b=tmp.find('.author a').eq(1).html();var tmp2=tmp.find('.author');tmp2.find('a').remove();var c=tmp2.text();var new_html='<blockquote class="twitter-tweet"><p>'+response.description+'</p>'+'&mdash; '+c+' ('+b+') <a href="'+tmp_url+'" data-datetime="'+tmp_ts+'">'+tmp_ts2+'</a></blockquote>'+'<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>';return new_html;};plugin.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,args){var plugin=this,submit=plugin.component;var text=args.postData.content[0].object.content;if(plugin.config.get("mediaList").length>0){var marker="";text+='<div class="echo-item-files">';$.map(plugin.config.get("mediaList"),function(response){if(response.type=="photo"){text+='<div class="echo-item-photo" '+'title="'+response.title+'" '+'data-src-full="'+response.url+'" '+'data-title="'+response.title+'" '+'>'+'<a href="'+response.url+'" target="_blank">'+'<img src="'+('thumbnail_url'in response?response.thumbnail_url:response.url)+'" />'+'</a>'+'</div>';marker="image";}else if(response.type=="video"){var itemHtml=response.html;var encodedHtml=null;if(itemHtml.indexOf("<iframe")!=-1){encodedHtml=RTB.Utils.encode64(itemHtml);};var title=plugin._e(response.title);var desc=plugin._e(("description"in response?response.description:''));text+='<div class="echo-item-video" '+'title="'+response.title+'" '+'data-thumbnail="'+response.thumbnail_url+'" '+'data-url="'+response.url+'" '+'data-title="'+title+'" '+'data-description="'+desc+'" '+
(encodedHtml?'data-encoded="'+encodedHtml+'" ':'')+'>'+
itemHtml+'</div>';marker="video";}else if(response.type=="rich"){var itemHtml=response.html;var encodedHtml=null;if(itemHtml.indexOf("<iframe")!=-1||itemHtml.indexOf("<object")!=-1){encodedHtml=RTB.Utils.encode64(itemHtml);};text+='<div class="echo-item-richmedia" '+'title="'+response.title+'" '+'data-thumbnail="'+response.thumbnail_url+'" '+'data-title="'+response.title+'" '+
(encodedHtml?'data-encoded="'+encodedHtml+'" ':'')+'>'+
itemHtml+'</div>';marker="richmedia";}else if(response.type=="link"){var thumbnail=('thumbnail_url'in response?response.thumbnail_url:null);text+='<div class="echo-item-media-page" '+'title="'+response.title+'" '+'data-url="'+response.urlOrig+'" '+
(thumbnail?'data-thumbnail="'+response.thumbnail_url+'" ':'')+'data-title="'+response.title+'" '+'>'+
response.html+'</div>';marker="page";};});text+='</div>';var pushM=true;$.map(args.postData.content,function(x,i){if(x.object&&x.object.objectTypes[0]==submit._getASURL("marker")){x.object.content+=","+marker;pushM=false;};});if(pushM)args.postData.content.push(submit._getActivity("tag",submit._getASURL("marker"),marker));};args.postData.content[0].object.content=text;},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,submit=plugin.component;plugin.cleanUp();},"Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitPlugin.onToggleSubmitArea":function(topic,args){var plugin=this,submit=plugin.component;if(args.show==false){plugin.config.set("mediaList",[]);this.view.get("submitMediaWrapper").slideUp("fast").empty();plugin.hideLinkBox();};}};plugin.methods._e=function(t){return t.replace(/</g,'&lt;').replace(/"/g,'&quot;');};plugin.methods.cleanUp=function(){var plugin=this,submit=plugin.component;plugin.config.set("mediaList",[]);this.view.get("submitMediaWrapper").slideUp("fast").empty();plugin.hideLinkBox();};plugin.css='.{plugin.class:submitMediaWrapper} {border: 1px solid #CCCCCC;border-top:0;margin-top: 0;background-color:#f4f4f4;padding:10px 10px 5px 10px;border-bottom:1px solid #ddd;}'+'.{plugin.class:submitMediaInputWrapper} {}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview {float:left;background-color:#fff;position:relative;border-radius: 5px;border-top:1px solid #EEE;border-right: 1px solid #DDDDDD;border-bottom: 1px solid #BBB;border-left: 1px solid #DDDDDD;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);padding:8px;overflow:hidden;margin:0 8px 8px 0;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview span.btn-remove{position:absolute;right:4px;top:4px;cursor:pointer;background: url(http://dev.realtidbits.com/libs/v3/img/delete.png) no-repeat;height: 32px;width: 32px;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-photo img, .{plugin.class:submitMediaWrapper} .echo-media-preview-video img {height:80px;overflow: hidden;border:1px solid #BBB;border-radius:2px;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-rich {float:left;background-color:#fff;position:relative;border:0;box-shadow:none;padding:0;border-radius:0;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-rich.Twitter {background-color:transparent !important;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-page {font-size:12px; width:100%;;color:#555;line-height: 1.4em;padding:0;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-page img {height:80px;overflow: hidden;border-radius:2px;margin:10px;}'+'.{plugin.class:submitMediaWrapper} .echo-item-media-page-details {padding:8px;}'+'.{plugin.class:submitMediaWrapper} .echo-item-media-page-image {margin-left:10px 10px 10px 93px;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-page .echo-item-media-title {font-weight:bold;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-page .echo-item-media-url {color:#999;font-weight:normal;}'+'.{plugin.class:submitMediaWrapper} .echo-media-preview-page img {float:left;margin-right:5px;margin-bottom:5px;height: auto;width: 80px;}'+'.{plugin.class:submitMediaWrapper} .media-resolver-loader { margin:5px 0 12px;}'+'.{plugin.class:submitMediaInputWrapper} input {width:85% !important;}'+'.{plugin.class:submitMediaInputWrapper} a {float:right;font-weight:bold;margin-right:5px;}';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSubmitAttachMedia","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"apiKey":"50749903cc72f82571000016","mediaList":[],"limit":10};plugin.labels={"modalTitle":"Attach Photos","tooltip":"Attach photos","titleRemove":"Remove","alertMaxHitTitle":"Warning!","alertMaxHitMsg":"There is a max limit of 10 photos.","clickMeLabel":"Photo"};plugin.init=function(){this.config.set("mediaList",[]);this.extendTemplate("insertAfter","body",plugin.templateMedia);this.extendTemplate("insertBefore","postContainer",plugin.template);};plugin.templateMedia='<div class="{plugin.class:mediaWrapper} clearfix"></div>';plugin.template='<a href="javascript:void(0);" class="{plugin.class:attachMedia} navbar-btn" title="{plugin.label:tooltip}"><i class="icon-rtb-camera"></i></a>';plugin.renderers.mediaWrapper=function(element){var plugin=this,submit=plugin.component;element.hide();};plugin.renderers.attachMedia=function(element){var plugin=this,submit=plugin.component;element.click(function(event){plugin.doChute();});};plugin.methods.doChute=function(){var plugin=this,submit=plugin.component;var txt=submit.view.get('text');if(txt.val()=="")txt.val(' ');var id='chute-'+Math.floor(Math.random()*10000001);plugin.initChuteDialog(id,"null");};plugin.methods.initChuteDialog=function(id,dialog){var plugin=this,submit=plugin.component,txt=submit.view.get('text');var scheme=window.location.protocol==="https:"?"https://ssl.":"http://cdn.";Echo.Loader.download([{"url":scheme+"realtidbits.com/libs/v3/partners/chute-media-chooser.js","loaded":function(){return!!window.Chute;}}],function(){Chute.setApp(plugin.config.get('apiKey'));Chute.MediaChooser.choose({"limit":plugin.config.get('limit'),"picker_version":"v2","captions":"optional","css":scheme+'realtidbits.com/libs/v3/comments/chute.css'},function(urls,data){if(dialog!="null"){dialog.hide();}
if(data.assets.length){plugin.events.publish({"topic":"onUpload","data":{"rsp":data.assets}});var arr=plugin.config.get("mediaList");var hitLimit=false;$.map(data.assets,function(asset,i){var photo={"id":asset.id,"original":asset.source_url,"full":asset.url,"thumbnail":Chute.fill(100,100,asset.url),"type":asset.type,"name":asset.name};if(arr.length<plugin.config.get('limit')){plugin.addPhoto(photo);}else{hitLimit=true;};});if(hitLimit){RTB.Utils.Alert(submit.view.get("body"),plugin.labels.get("alertMaxHitTitle"),plugin.labels.get("alertMaxHitMsg"),"default");hitLimit=false;};};if(txt.val()==" ")txt.val('');txt.blur();});});};plugin.methods.showWrapper=function(){var plugin=this,submit=plugin.component;var element=plugin.view.get('mediaWrapper');if(!element.is(":visible"))element.slideDown();var a=$('<div class="media-attach-clickme">'+'<i class="icon-rtb-plus-large"></i>'+plugin.labels.get("clickMeLabel")+'</div>');element.find('.media-attach-clickme').remove();a.hide().appendTo(element).slideDown();a.click(function(){plugin.doChute();});};plugin.methods.hideWrapper=function(){var plugin=this,submit=plugin.component;var element=plugin.view.get('mediaWrapper');element.slideUp();};plugin.methods.addPhoto=function(response){var plugin=this,submit=plugin.component;var element=plugin.view.get('mediaWrapper');var itemEl=$('<div class="echo-media-preview" data-id="'+response.id+'">'+'<img src="'+response.thumbnail+'" />'+'</div>');plugin.showWrapper();var btn=$('<span data-id="'+response.id+'"></span>');btn.on('click',function(){var id=$(this).attr("data-id");var arr=plugin.config.get("mediaList");arr=jQuery.grep(arr,function(value){return value.id!=id;});plugin.config.set("mediaList",arr);itemEl.slideUp('slow',function(){itemEl.remove();});if(arr.length<=0)element.slideUp().empty();});btn.hide();itemEl.prepend(btn);itemEl.bind('mouseover',function(){btn.show();}).bind('mouseout',function(){btn.hide();});itemEl.hide();element.find('.media-attach-clickme').before(itemEl);itemEl.slideDown();var arr=plugin.config.get("mediaList");arr.push(response);plugin.config.set("mediaList",arr);};plugin.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,args){var plugin=this,submit=plugin.component;var text=args.postData.content[0].object.content;if(plugin.config.get("mediaList").length>0){text+='<div class="echo-item-files">';$.map(plugin.config.get("mediaList"),function(photo){if(photo.type=="image"){text+='<div class="echo-item-photo">'+'<a href="'+photo.full+'" target="_blank">'+'<img src="'+photo.thumbnail+'" '+
(photo.name!=null?' title="'+photo.name+'"':'')+' data-src-web="'+photo.full+'"'+' data-src-preview="'+photo.thumbnail+'"'+' data-src-full="'+photo.full+'" />'+'</a>'+'</div>';};});text+='</div>';};args.postData.content[0].object.content=text;},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,submit=plugin.component;plugin.cleanUp();}};plugin.methods.cleanUp=function(){var plugin=this,submit=plugin.component;plugin.config.set("mediaList",[]);plugin.view.get("mediaWrapper").slideUp("fast").empty();};plugin.css='.{plugin.class:mediaWrapper} {border: 1px solid #CCCCCC;border-top:0;margin-top: 0;background-color:#f4f4f4;padding:10px 10px 5px 10px;border-bottom:1px solid #ddd;}'+'.{plugin.class:mediaWrapper} .echo-media-preview {float:left;background-color:#fff;position:relative;border-radius: 5px;border-top:1px solid #EEE;border-right: 1px solid #DDDDDD;border-bottom: 1px solid #BBB;border-left: 1px solid #DDDDDD;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);padding:8px;overflow:hidden;margin:0 8px 8px 0;}'+'.{plugin.class:mediaWrapper} .echo-media-preview span {position:absolute;right:4px;top:4px;cursor:pointer;background: url(http://dev.realtidbits.com/libs/v3/img/delete.png) no-repeat;height: 32px;width: 32px;}'+'.{plugin.class:mediaWrapper} .echo-media-preview img {height:80px;overflow: hidden;max-width: inherit;min-width: 40px;}'+'.{plugin.class:mediaWrapper} .echo-media-preview-video img {}'+'.{plugin.class:mediaWrapper} .media-attach-clickme {float:left; height:100px; width:80px; overflow:hidden; margin:0 8px 8px 0; text-align:center; color:#999; font-weight:bold;font-size:14px; cursor: pointer;}'+'.{plugin.class:mediaWrapper} .media-attach-clickme i {display:block;margin:25px auto 5px;}';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamRSS","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"renderButton":true,"apiBaseURL":window.location.protocol+"//api.realtidbits.com"};plugin.template='<div class="{plugin.class:rsslink}"><a href="javascript:void(0);" target="_blank"><button class="btn btn-mini {plugin.class:rssbutton}" title="{plugin.label:rssLabel}">{plugin.label:rssLinkLabel}</button></a></div>';plugin.init=function(){var plugin=this;if(plugin.config.get("renderButton")==true){plugin.extendTemplate("insertAsFirstChild","header",plugin.template);};};plugin.labels={"rssLabel":"Subscribe to RSS Feed","rssLinkLabel":"rss"};plugin.renderers.rssbutton=function(element){element.tooltip({"delay":1250});};plugin.renderers.rsslink=function(element){var plugin=this,stream=plugin.component;element.find('a').attr("href",plugin.getRSSLink()).on('click',function(){});};plugin.methods.getRSSLink=function(){var plugin=this,stream=plugin.component;var params={"query":encodeURIComponent(stream.config.get("query")),"appkey":encodeURIComponent(stream.config.get("appkey")),"title":encodeURIComponent(document.title),"link":'',"permalink":encodeURIComponent(location.href.split('#')[0])};return plugin.config.get("apiBaseURL")+"/rss?"+$.param(params);};plugin.css='.{plugin.class:rsslink} { margin-left:5px; float: right; }';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSocialSharing","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;var truncate=function(text,limit){return limit>0&&text.length>limit?text.substring(0,limit)+"...":text;};var prepareContent=function(data){var plugin=this;var activity=data.activity||{};var text=$('<span>'+data.content+'</span>').text();var customShareMessagePattern=activity.shareContent;if(customShareMessagePattern){return Echo.Utils.substitute({"template":customShareMessagePattern,"data":{"domain":window.location.host,"content":plugin.truncate(text,30)}});}
return truncate(text,300);};var loadJanRain=function(appName,callback){if(window._rtbJanRainLoaded){callback&&callback();return;}
window._rtbJanRainLoaded=true;if(typeof window.janrain!=='object')window.janrain={};if(typeof window.janrain.settings!=='object')window.janrain.settings={};if(typeof window.janrain.settings.share!=='object')window.janrain.settings.share={};if(typeof window.janrain.settings.packages!=='object')janrain.settings.packages=[];window.janrain.settings.packages.push('share');var share=window.janrain.settings.share;share.modes=["broadcast"];share.attributionDisplay=false;share.message="";share.title="";share.url="";share.description="";share.modalBackgroundColor="#000000";share.modalBorderRadius="5";share.modalOpacity="0.5";share.modalWidth="5";share.bodyBackgroundColor="#009DDC";share.bodyBackgroundColorOverride=false;share.bodyColor="#333333";share.bodyContentBackgroundColor="#ffffff";share.bodyFontFamily="Helvetica";share.bodyTabBackgroundColor="#f8f8f8";share.bodyTabColor="#000000";share.elementBackgroundColor="#f6f6f6";share.elementBorderColor="#cccccc";share.elementBorderRadius="3";share.elementButtonBorderRadius="6";share.elementButtonBoxShadow="3";share.elementColor="#cccccc";share.elementHoverBackgroundColor="#eeeeee";share.elementLinkColor="#009DDC";var rpxJsHost=("https:"==document.location.protocol)?"https://rpxnow.com/js/lib/"+appName+"/widget.js":"http://widget-cdn.rpxnow.com/js/lib/"+appName+"/widget.js";if(callback){var foreignOnload=window.janrainShareOnload;window.janrainShareOnload=function(){if(foreignOnload){foreignOnload();window.janrainShareOnload=foreignOnload;}
callback();};}
$.getScript(rpxJsHost,function(){window.janrain.ready=true;});if("object"===typeof console){var x=console.error;console.error=function(msg){if(msg.indexOf("WARNING ID:")>-1)return;x(msg);};};};plugin.methods.doShare=function(data){var plugin=this,component=this.component;loadJanRain(data.appName,function(){var share=janrain.engage.share;var activity=data.activity||{};var title=activity.itemTitle||$("meta[property='og:title']").attr("content")||document.title;var description=activity.itemDescription||$("meta[property='og:description']").attr("content")||"";var pageImage=(activity.pageImage&&activity.pageImage.src)||$("meta[property='og:image']").attr("content")||null;share.reset();share.setUrl(data.target);share.setMessage(prepareContent(data));share.setTitle(title);share.setDescription(description);share.setActionLink({"name":title,"link":RTB.Utils.getProp("url")});if(pageImage){share.setImage(pageImage);};share.show();Echo.Events.publish({"topic":data.topic,"context":data.context,"data":{"target":data.target,"title":title,"description":description,"link":RTB.Utils.getProp("url"),"image":pageImage}});});};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSocialSharingStreamItem","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"contentMaxLength":300};plugin.labels={"shareControl":"Share"};plugin.init=function(){this.component.addButtonSpec("Share",this._assembleButton());};plugin.methods._assembleButton=function(){var plugin=this,item=this.component;var callback=function(){var _plugin=Echo.StreamServer.Controls.Stream.Plugins.rtbSocialSharing;_plugin.prototype.doShare({"appName":plugin.config.get("appName"),"content":item.data.object.content,"activity":plugin.config.get("activity"),"topic":"Echo.StreamServer.Controls.Stream.Item.Plugins.rtbSocialSharingStreamItem.onShare","context":item.config.get("context"),"target":RTB.Utils.getProp("url")+"#comment-"+RTB.Utils.encode64(item.data.object.id)});};return function(){var item=this;return{"name":"Share","label":plugin.labels.get("shareControl"),"visible":true,"callback":callback};};};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamSortingSelector","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"selectedIdx":0,"orders":[{"label":"reverseChronologicalSortOrder","sortBy":"reverseChronological","markers":"","after":""},{"label":"likesDescendingSortOrder","sortBy":"likesDescending","markers":"","after":""},{"label":"popularSortOrder","sortBy":"repliesDescending","markers":"","after":"after:'7 days ago'"},{"label":"repliesDescendingSortOrder","sortBy":"repliesDescending","markers":"","after":""},{"label":"videosSortOrder","sortBy":"reverseChronological","markers":"(markers:video OR markers:tokbox)","after":"","source":""},{"label":"chronologicalSortOrder","sortBy":"chronological","markers":"","after":""}],"origQuery":""};plugin.init=function(){this.extendTemplate("insertAsFirstChild","header",plugin.template);};plugin.labels={"sortOrderSelection":"Sort: ","reverseChronologicalSortOrder":"Newest","likesDescendingSortOrder":"Most Likes","popularSortOrder":"Popular","repliesDescendingSortOrder":"Popular All Time","imagesSortOrder":"Images","videosSortOrder":"Videos","chronologicalSortOrder":"Oldest","flagsDescendingSortOrder":"Flags"};plugin.template=function(){var plugin=this;var current=plugin.config.get("selectedIdx");var options=$.map(plugin.config.get("orders"),function(order,i){return plugin.substitute({"template":'<li class="{data:isActive}"><a href="javascript:void(0);" tabindex="-1" data-value-idx="{data:idx}" data-selected="{data:selected}">{data:label}</a></li>',"data":{"idx":i,"order":order.sortBy,"markers":order.markers,"after":order.after,"label":plugin.labels.get(order.label),"selected":current===i?"selected":"","isActive":current===i?"active":""}});}).join("");return'<div class="{plugin.class:wrapper}">'+'<div class="dropdown echo-streamserver-controls-stream-plugin-StreamSortingSelector-dropdown">'+'<a data-toggle="dropdown" class="dropdown-toggle" href="#">'+'<span class="{plugin.class:label}">{plugin.label:sortOrderSelection}</span>'+'<span class="dropdownSelected {plugin.class:labelWrapper}"></span>&nbsp;'+'<i class="{plugin.class:dropDownCaret} caret"></i>'+'</a>'+'<ul aria-labelledby="controls-auth" role="menu" class="dropdown-menu {plugin.class:selector}">'+options+'</ul>'+'</div>'+'</div>';};plugin.renderers.wrapper=function(element){var plugin=this;element.find('.dropdown-toggle').dropdown();element.find('li a').each(function(){if($(this).attr('data-selected')=='selected')element.find('.dropdownSelected').html($(this).html());});if(plugin.config.get("target")){if(plugin.config.get("showLabel")){}else{element.find("span").remove();};plugin.config.get("target").empty().append(element);};};plugin.renderers.selector=function(element){var plugin=this,stream=plugin.component;return element.find('a').on("click",function(){var idx=$(this).attr('data-value-idx');element.find('.dropdownSelected').html($(this).html());plugin._setSortOrder(idx);plugin.events.publish({"topic":"onSortChange","data":{"idx":idx,"html":$(this).html()}});if(plugin.config.get("events.onChange"))plugin.config.get("events.onChange")(idx,$(this).html());});};plugin.methods._updateQuery=function(query){this.config.set("origQuery",query);};plugin.methods._getSortOrder=function(){var stream=this.component;var regex=new RegExp("sortOrder:("+this.config.get("orders").join("|")+")");var result=stream.config.get("query").match(regex);return result&&result[1];};plugin.methods._setSortManual=function(idx){var plugin=this;plugin.config.set("selectedIdx",idx);var o=plugin.config.get("orders")[idx];var l=plugin.labels.get(o.label);plugin.view.get("labelWrapper").html(l);var a=this.view.get("selector")
a.find("li").removeClass("active");a.find("li:eq("+idx+")").addClass("active");}
plugin.methods._setSortOrder=function(idx){var plugin=this;this.config.set("selectedIdx",parseInt(idx));var selectedOption=this.config.get("orders")[parseInt(idx)];var stream=this.component;var _query=this.config.get("origQuery");var _order=this._getSortOrder();var replaceWith="sortOrder:"+selectedOption.sortBy+
("markers"in selectedOption?" "+selectedOption.markers+" ":'')+
("after"in selectedOption?" "+selectedOption.after+" ":'');if(plugin.config.get("events.onQueryChange")){plugin.config.get("events.onQueryChange")(stream,"sortOrder:"+selectedOption.sortBy,selectedOption.markers,selectedOption.after,("source"in selectedOption?selectedOption.source:null));}else{var query=_query.replace(new RegExp(/sortOrder:[a-zA-Z]+\s/i),"");query=replaceWith+" "+query;stream.config.set("query",query);stream.refresh();};};plugin.css='.echo-sdk-ui .{plugin.class:label} { margin-left: 5px; font-size:14px; }'+'.echo-sdk-ui .{plugin.class:wrapper}, .echo-sdk-ui .{plugin.class:wrapper} a, .echo-sdk-ui .{plugin.class:wrapper} a:hover { color:#555;font-size:14px; text-decoration:none !important; }'+'.echo-sdk-ui .{plugin.class:wrapper} .dropdown-toggle { padding-right:5px; background:transparent !important; }';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbSubmitTokbox","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"apikey":14576382,"apisecret":"","archiveIds":[],"postMarkers":["tokbox","video"],"itemLimit":3,"recordTimeLimit":60000}
plugin.labels={"tooltip":"Record a video comment","modalTitle":"Record Video Comment","titlePlayback":"Comment Playback:","buttonCancel":"Cancel","buttonDelete":"Record Again","download":"Download Video","saveButton":"Save","cancelButton":"Cancel","alertTimeLimitTitle":"Warning!","alertTimeLimitMsg":"There is a 1 minute record time limit.","alertMaxLimitTitle":"Warning!","alertMaxLimitMsg":"You may only record a max of 3 videos per comment.","clickMeLabel":"Record Video"};plugin.templateSubmitWrapper='<div class="{plugin.class:tokboxWrapper} clearfix"></div>';plugin.template='<a href="javascript:void(0);" class="{plugin.class:recordTokbox} navbar-btn" title="{plugin.label:tooltip}"><i class="icon-rtb-facetime-video"></i></a>';plugin.init=function(){this.config.set("archiveIds",[]);this.extendTemplate("insertAfter","body",plugin.templateSubmitWrapper);this.extendTemplate("insertBefore","postContainer",plugin.template);};plugin.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,args){var plugin=this,submit=plugin.component;var text=args.postData.content[0].object.content;if(plugin.config.get("archiveIds").length>0){var wrapper=plugin.view.get("tokboxWrapper");$.map(plugin.config.get("postMarkers"),function(i){var pushM=true;$.map(args.postData.content,function(x,i2){if(x.object&&x.object.objectTypes[0]==submit._getASURL("marker")){x.object.content+=","+i;pushM=false;};});if(pushM)args.postData.content.push(submit._getActivity("tag",submit._getASURL("marker"),i));});text+='<div class="echo-item-files">';$.map(plugin.config.get("archiveIds"),function(i){text+='<div class="echo-item-tokbox echo-item-video" data-archive-id="'+i.id+'">'+
i.html+'</div>';});text+='</div>';};args.postData.content[0].object.content=text;},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this,submit=plugin.component;plugin.cleanUp();}};plugin.methods.cleanUp=function(){var plugin=this,submit=plugin.component;plugin.config.set("archiveIds",[]);plugin.view.get("tokboxWrapper").slideUp("fast").empty();};plugin.renderers.recordTokbox=function(element){var plugin=this,submit=plugin.component;element.click(function(){plugin.doTokbox();});return element;};plugin.methods.doTokbox=function(element){var plugin=this,submit=plugin.component;var modalBody='<div class="echo-submit-tokbox">'+'<div class="recorderContainer">'+'<div class="recorderWrapper">Loading...</div>'+'</div>'+'</div>';var showedModal=false;var modal=new Echo.GUI.Modal({"data":{"title":plugin.labels.get("modalTitle"),"body":modalBody,"buttons":[{"title":plugin.labels.get("cancelButton"),"extraClass":"","handler":function(){modal.hide();}},{"title":plugin.labels.get("saveButton"),"extraClass":"btn-primary idtokboxSave","handler":function(){}}]},"extraClass":"rtb-apps-comments","header":true,"footer":true,"fade":true,"show":true,"onShow":function(){if(showedModal)return;showedModal=true;var container=this.element;Echo.Loader.download([{"loaded":function(){return!!window.TB;},"url":window.location.protocol=="https:"?"https://swww.tokbox.com/v1.1/js/TB.min.js":"http://static.opentok.com/v1.1/js/TB.min.js"}],function(){container.find(".recorderWrapper").empty();plugin.initTokbox(container);});},"onHide":function(){showedModal=false;}});};plugin.methods.hideWrapper=function(){var plugin=this,submit=plugin.component;var element=plugin.view.get('tokboxWrapper');element.empty().slideUp();};plugin.methods.showWrapper=function(){var plugin=this;var element=plugin.view.get("tokboxWrapper");var a=$('<div class="video-record-clickme">'+'<i class="icon-rtb-plus-large"></i>'+plugin.labels.get("clickMeLabel")+'</div>');element.find('.video-record-clickme').remove();a.hide().appendTo(element).slideDown();a.click(function(){plugin.doTokbox();});if(!element.is(":visible"))element.slideDown();};plugin.methods.initTokbox=function(target){var plugin=this;plugin.getTokboxToken({"apikey":plugin.config.get("apikey"),"apisecret":plugin.config.get("apisecret")},function(data){var recorderManager;var recorder;var player;var recImgData;var API_KEY=plugin.config.get("apikey");var TOKEN=data.token;var width=$(target).find('.echo-submit-tokbox').width();width=(width/2);var VIDEO_HEIGHT=((width-50)<200?200:width-50);var VIDEO_WIDTH=width;var btnSave=$(target).find(".idtokboxSave");btnSave.hide().click(function(){recorder.saveArchive();});function saveVideoArchive(archiveId){if(archiveId!=null){if(plugin.config.get("archiveIds").length>=plugin.config.get("itemLimit")){var alertEl=$(target).find(".echo-submit-tokbox");RTB.Utils.Alert(alertEl,plugin.labels.get("alertMaxLimitTitle"),plugin.labels.get("alertMaxLimitMsg"),"error");}else{target.modal("hide");var wrapper=plugin.view.get("tokboxWrapper");plugin.showWrapper();var itemEl=$('<div class="echo-media-preview"></div>');var playerDiv=document.createElement('div');playerDiv.setAttribute('id',Math.floor(Math.random()*10000001));var objWrapper=$('<div id="'+archiveId+'"></div>');itemEl.append(objWrapper);objWrapper.append(playerDiv);setTimeout(function(){var x=window._tokboxRecorderManager.displayPlayer(archiveId,TOKEN,playerDiv.id,{"height":150,"width":200});var arr=plugin.config.get("archiveIds");arr.push({"id":archiveId,"html":objWrapper.html(),"thumbnail":recImgData});plugin.config.set("archiveIds",arr);},750);var btn=$('<span data-id="'+archiveId+'"></span>');btn.on('click',function(){var id=$(this).data("id");var arr=plugin.config.get("archiveIds");arr=jQuery.grep(arr,function(value){return value.id!=id;});plugin.config.set("archiveIds",arr);itemEl.slideUp('slow',function(){itemEl.remove();});if(arr.length<=0)wrapper.slideUp().empty();});btn.hide();itemEl.prepend(btn);itemEl.bind('mouseover',function(){btn.show();}).bind('mouseout',function(){btn.hide();});wrapper.prepend(itemEl.hide().slideDown());};};};function init(){if(typeof window._tokboxRecorderManager=="undefined"){window._tokboxRecorderManager=TB.initRecorderManager(API_KEY);};createRecorder();}
function createRecorder(){var recDiv=document.createElement('div');recDiv.setAttribute('id','recorderElement');$(target).find(".recorderWrapper").append($(recDiv));recorder=window._tokboxRecorderManager.displayRecorder(TOKEN,recDiv.id,{"style":{"showSaveButton":false},"height":VIDEO_HEIGHT,"width":VIDEO_WIDTH});recorder.addEventListener('recordingStarted',recStartedHandler);recorder.addEventListener("recordingStopped",recordingStoppedHandler);recorder.addEventListener('archiveSaved',archiveSavedHandler);}
function getImg(imgData){var img=document.createElement('img');img.setAttribute('src','data:image/png;base64,'+imgData);return img;}
function recStartedHandler(event){recImgData=recorder.getImgData().replace(/(\r\n|\n|\r)/gm,"");setTimeout(function(){var alertEl=$(target).find(".echo-submit-tokbox");RTB.Utils.Alert(alertEl,plugin.labels.get("alertTimeLimitTitle"),plugin.labels.get("alertTimeLimitMsg"),"error");recordingStoppedHandler(event);},plugin.config.get("recordTimeLimit"));}
function recordingStoppedHandler(event){btnSave.show();}
function archiveSavedHandler(event){saveVideoArchive(event.archives[0].archiveId);}
function archiveLoadedHandler(event){archive=event.archives[0];archive.startPlayback();}
function exceptionHandler(event){alert('Exception: '+event.code+'::'+event.message);}
init();});};plugin.methods.getTokboxToken=function(params,callback){var token=Echo.Cookie.get("tokboxToken");if(token){callback({"token":token});return;};$.ajax({url:window.location.protocol+"//api.realtidbits.com/tokbox_getToken",type:"get",dataType:"jsonp",data:params,success:function(data){if(data&&data.token){Echo.Cookie.set("tokboxToken",data.token,{"domain":window.location.host,"expires":1});}
callback(data);}});}
plugin.css='.recorderWrapper object {margin-left:20%;}'+'.{plugin.class:tokboxWrapper} {display:none; border: 1px solid #CCCCCC;border-top:0;margin-top: 0;background-color:#f4f4f4;padding:10px 10px 5px 10px;border-bottom:1px solid #ddd;}'+'.{plugin.class:tokboxWrapper} .echo-media-preview {background-color:#fff;position:relative;border-radius: 5px;border-top:1px solid #EEE;border-right: 1px solid #DDDDDD;border-bottom: 1px solid #BBB;border-left: 1px solid #DDDDDD;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);padding:8px;overflow:hidden;margin:0 8px 8px 0;}'+'.{plugin.class:tokboxWrapper} .echo-media-preview {float:left;}'+'.{plugin.class:tokboxWrapper} .echo-media-preview span {position:absolute;right:4px;top:4px;cursor:pointer;background: url(http://dev.realtidbits.com/libs/v3/img/delete.png) no-repeat;height: 32px;width: 32px;}'+'.{plugin.class:tokboxWrapper} .video-record-clickme {float:left; height:100px; width:80px; overflow:hidden; margin:0 8px 8px 0; text-align:center; color:#999; font-weight:bold;font-size:14px; cursor: pointer;}'+'.{plugin.class:tokboxWrapper} .video-record-clickme i {display:block;margin:25px auto 5px;}';Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamItemTokbox","Echo.StreamServer.Controls.Stream.Item");plugin.config={"apikey":14576382,"apisecret":"679c6689be6e3105c82cfa878a8dc691ccd58364","token":null};plugin.labels={"labelDownload":"Download"};plugin.init=function(){this.config.set('hasFlash',this.flashEnabled());};plugin.methods.flashEnabled=function(){var hasFlash=false;try{var fo=(navigator.mimeTypes&&navigator.mimeTypes['application/x-shockwave-flash'])?navigator.mimeTypes['application/x-shockwave-flash'].enabledPlugin:0;if(fo)hasFlash=true;}catch(e){if(navigator.mimeTypes['application/x-shockwave-flash']!=undefined)hasFlash=true;};return hasFlash;};plugin.component.renderers.body=function(element){var plugin=this,item=this.component;this.parentRenderer("body",arguments);var videos=element.find('.echo-item-tokbox');if(!videos.length)return element;if(plugin.config.get('hasFlash')==false){videos.each(function(i){var el_tokbox=element.find('.echo-item-tokbox:eq('+i+')');el_tokbox.empty();var archive_id=el_tokbox.attr('data-archive-id');setTimeout(function(){var width=(element.width()/2)-20;var height=width*0.75;var v=$('<video width="'+width+'" height="'+height+'" controls></video>');var s=$('<source src="http://api.realtidbits.com/tokbox_downloadVideo/?archive_id='+archive_id+'" type="video/mp4">');v.append(s);el_tokbox.append(v);if(item.user.is("admin")){var el_download=$('<div><small><a href="" target="_blank">'+plugin.labels.get("labelDownload")+'</a></small></div>');el_download.find("a").attr("href",window.location.protocol+"//api.realtidbits.com/tokbox_downloadVideo/?archive_id="+archive_id);el_tokbox.append(el_download);};el_tokbox.click(function(){plugin.events.publish({"topic":"onTokboxVideoPlay"});$(this).unbind("click");});},500);});}else{plugin.initTokboxEnvironment(function(){var token=window._tokboxToken;if(typeof token==="undefined")return;videos.each(function(i){setTimeout(function(){var el_tokbox=element.find('.echo-item-tokbox:eq('+i+')');var width=(element.width()/2)-20;var height=width*0.75;el_tokbox.css("min-height","175px").width(width);var el_object=el_tokbox.empty();var archive_id=el_tokbox.attr('data-archive-id');var el_tokbox_id='tokbox-'+archive_id;var el_tokbox_video_wrapper=$('<div class="rtb-tokbox-stream-wrapper">Loading...</div>');el_tokbox_video_wrapper.attr('id',el_tokbox_id);el_tokbox.prepend(el_tokbox_video_wrapper);setTimeout(function(){if(typeof window._tokboxRecorderManager=="undefined"){window._tokboxRecorderManager=TB.initRecorderManager(plugin.config.get("apikey"));};window._tokboxRecorderManager.displayPlayer(archive_id,token,el_tokbox_id,{"height":height,"width":width});},100);if(item.user.is("admin")){var el_download=$('<div><small><a href="" target="_blank">'+plugin.labels.get("labelDownload")+'</a></small></div>');el_download.find("a").attr("href",window.location.protocol+"//api.realtidbits.com/tokbox_downloadVideo/?archive_id="+archive_id);el_tokbox.append(el_download);};el_tokbox.click(function(){plugin.events.publish({"topic":"onTokboxVideoPlay"});$(this).unbind("click");});},500);});});};return element;};plugin.methods.initTokboxEnvironment=function(callback){var plugin=this;if(window._tokboxToken){callback();return;}
window._tokboxQueue=window._tokboxQueue||[];window._tokboxQueue.push(callback);if(window._tokboxInProcess)return;Echo.Loader.download([{"loaded":function(){return!!window.TB;},"url":window.location.protocol=="https:"?"https://swww.tokbox.com/v1.1/js/TB.min.js":"http://static.opentok.com/v1.1/js/TB.min.js"}],function(){if(typeof window._tokboxToken=="undefined"&&window._tokboxInProcess!=true){window._tokboxInProcess=true;var parent=Echo.Utils.getComponent("Echo.StreamServer.Controls.Submit.Plugins.rtbSubmitTokbox");if(!parent)return;parent.prototype.getTokboxToken.call(plugin,{"apikey":plugin.config.get("apikey"),"apisecret":plugin.config.get("apisecret")},function(data){window._tokboxToken=data.token;$.map(window._tokboxQueue,function(cb){cb();});window._tokboxQueue=[];});}});};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("rtbStreamViewport","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;var scheme=window.location.protocol==="https:"?"https://ssl.":"http://cdn.";plugin.dependencies=[{"loaded":function(){return(!!$.fn.notify);},"url":scheme+"realtidbits.com/libs/v3/partners/bootstrap-notify/bootstrap-notify.js"},{"loaded":function(){return false;},"url":scheme+"realtidbits.com/libs/v3/partners/bootstrap-notify/bootstrap-notify.css"}];plugin.labels={"notificationTitle":"New Comment Posted"};plugin.init=function(){var notifyEl=$('<div class="rtb-notification notifications bottom-left echo-sdk-ui rtb-gui"></div>');var id='rtb-notification-'+(new Date().getTime());notifyEl.attr('id',id);this.set('notifyEl',id);$("body").prepend(notifyEl);};plugin.events={"Echo.StreamServer.Controls.Stream.onItemReceive":function(topic,args){var plugin=this;var tt=plugin.config.get("target")||args.target;if($.inViewport($(tt))==0){var actor=args.item.data.actor;var username=actor.title;var avatar=actor.avatar||Echo.Loader.getURL("images/avatar-default.png",false);var img='<img class="notification-avatar" src="'+avatar+'" />';var item=args.item.data.object;var title=plugin.labels.get("notificationTitle");var description=$('<span>'+item.content+'</span>').text();var content=$('<div class="notification-title">'+title+'</div>'+'<p class="clearfix">'+
img+RTB.Utils.truncate(description,100)+'</p>');content.click(function(){$(this).parent().remove();$('html,body').animate({scrollTop:tt.offset().top},'slow');});setTimeout(function(){try{content.parent().remove();}catch(e){};},10000);$('#'+plugin.get('notifyEl')).notify({'type':'success','message':{html:content},'fadeOut':{enabled:true,delay:8000}}).show();};}};plugin.css='.rtb-notification {cursor:pointer;width:250px;}'+'.rtb-notification .notification-title {font-weight:bold;font-size:16px;margin-bottom:8px;}'+'.rtb-notification p {}'+'.rtb-notification .notification-avatar {height:32px !important; border-radius:4px; margin-right:8px;float:left;}';Echo.Plugin.create(plugin);
/*!
* jQuery Viewport Plugin
*
* Date: Jul 29 2011
*
* Copyright 2011, Koen Punt / http://www.koenpunt.nl
* Dual licensed under the MIT and GPL licenses (just like jQuery):
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
*/
$.fn.extend({inViewport:function(){var visibleElements=[];this.each(function(){if($.inViewport(this)){visibleElements.push(this);}});return this.pushStack(visibleElements);},mostVisible:function(){var visibleElements=this.inViewport(),mostVisible=null,highestVisibility=0;$.each(visibleElements,function(index,element){if(elementVisibility=$(element).data('vpVisibility')){if(elementVisibility>highestVisibility){highestVisibility=elementVisibility;mostVisible=$(element);}}});return mostVisible;}});$.inViewport=function(element){var element=$(element),scrollTop=$(window).scrollTop(),windowHeight=$(window).height(),offset=element.offset(),elementBottom=offset.top+element.height()-scrollTop,elementTop=offset.top-scrollTop,a,b;a=elementTop-(windowHeight-element.height())>element.height()?element.height():elementTop-(windowHeight-element.height());a=a>0?a:0;b=elementBottom>element.height()?element.height():elementBottom;b=b>0?b:0;var vpVisibility=(b-a)/element.height();element.data('vpVisibility',vpVisibility);return vpVisibility;};})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;if(typeof window.RTB!=='object')window.RTB={};RTB.Utils={};RTB.Utils.is_touch_device=function(){return'ontouchstart'in window||'onmsgesturechange'in window;};RTB.Utils.charCount=function(element,counterCallback){var length=$(element).val().length;$(element).keyup(function(){var new_length=$(this).val().length;counterCallback(new_length);});};RTB.Utils.getDomain=function(data){var a=document.createElement('a');a.href=data;return a.hostname;}
RTB.Utils.addTags=function(data,tagMarker,tags,submit){var pushT=true;$.map(data.postData.content,function(x,i){if(x.object&&x.object.objectTypes[0]==submit._getASURL(tagMarker)){x.object.content+=","+tags;pushT=false;};});if(pushT)data.postData.content.push(submit._getActivity("tag",submit._getASURL(tagMarker),tags));return data;};RTB.Utils.query=function(params){var params=params||{};if(typeof params.state!="undefined"){var defaultState=params.state;var defaultChildrenState=params.state;}else{var defaultState='state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved';var defaultChildrenState='state:Untouched,ModeratorApproved user.state:Untouched,ModeratorApproved';};var streamQueryURLs=params.queryURLs;var childrenofUrls="(";$.map(streamQueryURLs,function(x,i){childrenofUrls+=("childrenof"in params?params.childrenof:'childrenof')+":'"+streamQueryURLs[i]+"'";if(streamQueryURLs.length!=i+1)childrenofUrls+=" OR ";});childrenofUrls+=") ";if(params.premod==true){defaultState='state:ModeratorApproved user.state:Untouched,ModeratorApproved';defaultChildrenState=defaultState};if(params.bozo==true&&Echo.UserSession._isLogged()&&params.premod!=true){defaultState="((user.id:'"+Echo.UserSession.get("identityUrl")+"' -state:SystemFlagged,CommunityFlagged,ModeratorFlagged,UserDeleted) OR ("+defaultState+")) ";};if(params.submitPermissions=="forceLogin"&&params.filterFake==true&&!("source"in params)){defaultState+=" -user.id:'http://js-kit.com/ECHO/user/fake_user' ";};var query=''
+("userID"in params?params.userID:'')+' '
+childrenofUrls
+("type"in params?params.type:'')+' '
+'itemsPerPage:'+("itemsPerPage"in params?params.itemsPerPage:'10')+' '
+("source"in params?params.source:'')+' '
+("tags"in params?params.tags:'')+' '
+("markers"in params?params.markers:'')+' '
+("filter"in params?params.filter:'')+' '
+("after"in params?params.after:'')+' '
+("sortOrder"in params?params.sortOrder:'sortOrder:reverseChronological')+' '
+defaultState+' '
+'safeHTML:permissive'+' '
+("children"in params?params.children:'children')+' '
+("children"in params&&params.children=="children:0"?'':defaultChildrenState)+' '
+("childrenItemsPerPage"in params?params.childrenItemsPerPage:'')+' '
+("childrenSortOrder"in params?params.childrenSortOrder:'')+' '
+'';return query;};RTB.Utils.getPostDataContent=function(postData,type){var output=null;$.map(postData,function(x,i){if(x.object.objectTypes[0]==type){output=i;};});return output;};RTB.Utils.isMobile=function(){if($(window).width()<800)return true;return false};RTB.Utils.hideAllTooltips=function(el){$(el).find('.tooltip').tool("hide");};RTB.Utils.initAnalytics=function(appkey){if(typeof window.RealTidbits!="undefined"&&typeof window.RealTidbits.analyticsApp=="undefined"){setTimeout(function(){window.RealTidbits.analyticsApp=new RealTidbits.Analytics({"appkey":appkey});},1000);};};RTB.Utils.getProp=function(prop){switch(prop){case'title':return $("meta[property='og:title']").attr("content")||document.title;break;case'description':return $("meta[property='og:description']").attr("content")||($("meta[name='description']").attr("content")||'');break;case'url':return $("meta[property='og:url']").attr("content")||location.href.replace(/([#\?][^#\?]*)+$/,'')
break;};};RTB.Utils.getMarker=function(key,array,toLower){if(!array||!array.length)return null;function stripEndQuotes(s){var t=s.length;if(s.charAt(0)=='"'||s.charAt(0)=="'")s=s.substring(1,t--);var l=t-1;if(s.charAt(l)=='"'||s.charAt(l)=="'")s=s.substring(0,l);return s;}
var output=$.map(array,function(x,i){var row=array[i].split(':');var row_key=row.shift();var row_value=row.join(':');var row_value=(isNaN(row_value)||row_value.length>10?row_value:parseFloat(row_value));if(row_key.toLowerCase()==key.toLowerCase()){if(toLower)return row_value.toLowerCase();return row_value;}});if(output.length==0)return null;if(output.length==1){var output=output[0];};if(typeof output=="string")return stripEndQuotes(output);return output;};RTB.Utils.truncate=function(text,limit){return limit>0&&text.length>limit?text.substring(0,limit)+"...":text;};RTB.Utils.updatePost=function(config){var activity=[];$.map(config.activities,function(x,i){var a={"targets":[{"id":x.target}],"verbs":["http://activitystrea.ms/schema/1.0/update"],"object":{}};a.object[x.field]=x.value;activity.push(a);});var data={"content":activity,"appkey":config.appkey,"sessionID":Backplane.getChannelID()};Echo.StreamServer.API.request({"endpoint":"submit","submissionProxyURL":config.submissionProxyURL,"secure":config.useSecureAPI,"onData":config.callback,"onError":config.errorCallback,"data":data}).send();};RTB.Utils.submitPost=function(config){var activity=[{"avatar":config.avatar||null,"targets":[{"id":config.target}],"verbs":["http://activitystrea.ms/schema/1.0/post"],"object":{"objectTypes":config.objectTypes||["http://activitystrea.ms/schema/1.0/comment"],"content":config.content}}];if(config.markers){activity.push({"avatar":config.avatar||null,"targets":[{"id":config.target}],"verbs":["http://activitystrea.ms/schema/1.0/tag"],"object":{"objectTypes":["http://activitystrea.ms/schema/1.0/marker"],"content":config.markers}});};var data={"content":activity,"appkey":config.appkey,"sessionID":Backplane.getChannelID()};Echo.StreamServer.API.request({"endpoint":"submit","submissionProxyURL":config.submissionProxyURL,"secure":config.useSecureAPI,"onData":config.callback,"onError":config.errorCallback,"data":data}).send();};RTB.Utils.newEchoItem=function(appkey,target,contentName,entryContent,markers,callback,errorCallback,submissionProxyURL){if(typeof submissionProxyURL=="undefined"){submissionProxyURL=window.location.protocol+"//apps.echoenabled.com/v2/esp/activity";};var activity=[{"targets":[{"id":target}],"verbs":["http://activitystrea.ms/schema/1.0/post"],"object":{"objectTypes":["http://activitystrea.ms/schema/1.0/comment"],"content":entryContent}}];if(markers){activity.push({"targets":[{"id":target}],"verbs":["http://activitystrea.ms/schema/1.0/tag"],"object":{"objectTypes":["http://activitystrea.ms/schema/1.0/marker"],"content":markers}});};var data={"content":activity,"appkey":appkey,"sessionID":Backplane.getChannelID()};Echo.StreamServer.API.request({"endpoint":"submit","submissionProxyURL":submissionProxyURL,"onData":callback,"onError":errorCallback,"data":data}).send();};RTB.Utils.Alert=function(element,title,msg,type,allowMultiple,removeOthers,permanent){if(allowMultiple!=true){if(element.find('.rtb-alert-msg').length>0)return;};if(removeOthers==true){element.find('.rtb-alert-msg').parent().remove();};var typeClasses={'default':'','success':'alert-success','error':'alert-error','info':'alert-info'};var alertMsg=$('<div style="margin-bottom:5px;">'+'<div class="rtb-alert-msg alert '+typeClasses[type]+'">'+'<button type="button" class="close" data-dismiss="alert">&times;</button>'+'<strong>'+title+'</strong> '+msg+'</div>'+'</div>');element.prepend(alertMsg);var h=alertMsg.height();alertMsg.hide().css({"overflow":"hidden","height":h});alertMsg.slideDown();if(permanent){alertMsg.find('button.close').hide();return;};alertMsg.find('button.close').click(function(){removeAlert($(this).parent().parent());});setTimeout(function(){removeAlert(alertMsg);},10000);function removeAlert(el){el.slideUp("slow",function(){$(this).remove();});};};RTB.Utils.isUrlValid=function(value){return /^((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)$/i.test(value);}
RTB.Utils.isEmailValid=function(emailAddress){var pattern=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);return pattern.test(emailAddress);};RTB.Utils.encode64=function(input){var keyStr="ABCDEFGHIJKLMNOP"+"QRSTUVWXYZabcdef"+"ghijklmnopqrstuv"+"wxyz0123456789+/"+"=";input=escape(input);var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
keyStr.charAt(enc1)+
keyStr.charAt(enc2)+
keyStr.charAt(enc3)+
keyStr.charAt(enc4);chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return output;}
RTB.Utils.decode64=function(input){var keyStr="ABCDEFGHIJKLMNOP"+"QRSTUVWXYZabcdef"+"ghijklmnopqrstuv"+"wxyz0123456789+/"+"=";var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;var base64test=/[^A-Za-z0-9\+\/\=]/g;if(base64test.exec(input)){alert("There were invalid base64 characters in the input text.\n"+"Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\n"+"Expect errors in decoding.");}
input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=keyStr.indexOf(input.charAt(i++));enc2=keyStr.indexOf(input.charAt(i++));enc3=keyStr.indexOf(input.charAt(i++));enc4=keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return unescape(output);}})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var plugin=Echo.Plugin.manifest("ItemsRollingWindow","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.config={"moreButton":false};plugin.events={"Echo.StreamServer.Controls.Stream.Item.onRender":function(){var self=this;var maxCount=this.get("maxCount");$.map(this.component.get("threads").slice(maxCount),function(item){self.component._spotUpdates.remove.call(self.component,item);});if(this.config.get("moreButton")){this._updateNextPageAfter();}},"Echo.StreamServer.Controls.Stream.onRerender":function(){this._setMaxCount();},"Echo.StreamServer.Controls.Stream.onDataReceive":function(topic,args){if(args.type==="children"||args.type==="live")return;this._setMaxCount(args.type==="more");}};plugin.component.renderers.more=function(element){var item=this.component;if(!this.config.get("moreButton")){return element.empty().hide();}
return item.parentRenderer("more",arguments);};plugin.methods._setMaxCount=function(incremental){var maxCount=parseInt(this.component.config.get("itemsPerPage"));if(incremental){maxCount+=this.get("maxCount");}
this.set("maxCount",maxCount);};plugin.methods._updateNextPageAfter=function(){var lastItem=this.component.get("threads")[this.component.threads.length-1];if(lastItem.get("data.pageAfter")){this.component.set("nextPageAfter",lastItem.get("data.pageAfter"));}};Echo.Plugin.create(plugin);})(Echo.jQuery);(function(jQuery){"use strict";var $=jQuery;var Notification=function(element,options){this.$element=$(element);this.$note=$('<div class="alert"></div>');this.options=$.extend(true,$.fn.notify.defaults,options,this.$element.data());if(this.options.transition)
if(this.options.transition=='fade')
this.$note.addClass('in').addClass(this.options.transition);else this.$note.addClass(this.options.transition);else this.$note.addClass('fade').addClass('in');if(this.options.type)
this.$note.addClass('alert-'+this.options.type);else this.$note.addClass('alert-success');if(this.options.message)
if(typeof this.options.message==='string')
this.$note.html(this.options.message);else if(typeof this.options.message==='object')
if(this.options.message.html)
this.$note.html(this.options.message.html);else if(this.options.message.text)
this.$note.text(this.options.message.text);if(this.options.closable)
var link=$('<a class="close pull-right">&times;</a>');$(link).on('click',$.proxy(onClose,this));this.$note.prepend(link);return this;};var onClose=function(){this.options.onClose();$(this.$note).remove();this.options.onClosed();};Notification.prototype.show=function(){if(this.options.fadeOut.enabled)
this.$note.delay(this.options.fadeOut.delay||3000).fadeOut('slow',$.proxy(onClose,this));this.$element.append(this.$note);this.$note.alert();};Notification.prototype.hide=function(){if(this.options.fadeOut.enabled)
this.$note.delay(this.options.fadeOut.delay||3000).fadeOut('slow',$.proxy(onClose,this));else onClose.call(this);};$.fn.notify=function(options){return new Notification(this,options);};$.fn.notify.defaults={type:'success',closable:true,transition:'fade',fadeOut:{enabled:true,delay:3000},message:null,onClose:function(){},onClosed:function(){}}})(Echo.jQuery);
